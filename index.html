<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TourTicket Pro - Sistem Penjualan Tiket Wisata</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.25/jspdf.plugin.autotable.min.js"></script>
    <style>
        :root {
            --primary-color: #2c3e50;
            --secondary-color: #3498db;
            --accent-color: #e74c3c;
            --light-color: #ecf0f1;
            --dark-color: #2c3e50;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: #f5f5f5;
            color: var(--dark-color);
        }
        
        .navbar-brand {
            font-weight: 700;
            color: var(--light-color);
        }
        
        .card {
            border-radius: 10px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
            margin-bottom: 20px;
            border: none;
        }
        
        .card-header {
            background-color: var(--primary-color);
            color: white;
            border-radius: 10px 10px 0 0 !important;
            font-weight: 600;
        }
        
        .btn-primary {
            background-color: var(--secondary-color);
            border-color: var(--secondary-color);
        }
        
        .btn-danger {
            background-color: var(--accent-color);
            border-color: var(--accent-color);
        }
        
        .ticket {
            background: linear-gradient(135deg, #ffffff 0%, #f8f9fa 100%);
            border: 2px solid var(--secondary-color);
            border-radius: 15px;
            padding: 20px;
            margin: 10px 0;
            position: relative;
            overflow: hidden;
        }
        
        .ticket:before {
            content: "";
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 5px;
            background: linear-gradient(90deg, var(--secondary-color) 0%, var(--accent-color) 100%);
        }
        
        .ticket-code {
            font-family: 'Courier New', monospace;
            font-size: 1.5rem;
            font-weight: bold;
            color: var(--primary-color);
            letter-spacing: 2px;
        }
        
        .sidebar {
            background-color: var(--primary-color);
            color: white;
            min-height: 100vh;
            padding: 20px 0;
        }
        
        .sidebar .nav-link {
            color: rgba(255, 255, 255, 0.8);
            margin-bottom: 5px;
            border-radius: 5px;
            padding: 10px 15px;
        }
        
        .sidebar .nav-link:hover, .sidebar .nav-link.active {
            background-color: rgba(255, 255, 255, 0.1);
            color: white;
        }
        
        .sidebar .nav-link i {
            margin-right: 10px;
        }
        
        .login-container {
            max-width: 400px;
            margin: 100px auto;
            padding: 30px;
            background-color: white;
            border-radius: 10px;
            box-shadow: 0 0 20px rgba(0, 0, 0, 0.1);
        }
        
        @media print {
            .no-print {
                display: none !important;
            }
            
            body {
                background-color: white !important;
            }
            
            .ticket {
                page-break-inside: avoid;
                margin: 10px 0;
            }
        }
        
        @media (max-width: 768px) {
            .sidebar {
                min-height: auto;
                padding: 10px 0;
            }
            
            .login-container {
                margin: 50px auto;
                padding: 20px;
            }
        }
    </style>
</head>
<body>
    <!-- Login Modal -->
    <div id="loginModal" class="modal fade" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header bg-primary text-white">
                    <h5 class="modal-title">Login Sistem</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <form id="loginForm">
                        <div class="mb-3">
                            <label for="username" class="form-label">Username</label>
                            <input type="text" class="form-control" id="username" required>
                        </div>
                        <div class="mb-3">
                            <label for="password" class="form-label">Password</label>
                            <input type="password" class="form-control" id="password" required>
                        </div>
                        <button type="submit" class="btn btn-primary w-100">Login</button>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <!-- Main Layout -->
    <div class="container-fluid" id="appContainer" style="display: none;">
        <div class="row">
            <!-- Sidebar -->
            <div class="col-md-3 col-lg-2 d-md-block sidebar collapse no-print" id="sidebarMenu">
                <div class="position-sticky pt-3">
                    <div class="text-center mb-4">
                        <h4 class="text-white">TourTicket Pro</h4>
                        <hr class="bg-light">
                    </div>
                    <ul class="nav flex-column">
                        <li class="nav-item">
                            <a class="nav-link active" href="#" data-section="dashboard">
                                <i class="fas fa-tachometer-alt"></i> Dashboard
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="#" data-section="generateTickets">
                                <i class="fas fa-ticket-alt"></i> Generate Tiket
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="#" data-section="sellTickets">
                                <i class="fas fa-cash-register"></i> Penjualan
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="#" data-section="stockTickets">
                                <i class="fas fa-boxes"></i> Stok Tiket
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="#" data-section="transactions">
                                <i class="fas fa-history"></i> Transaksi
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="#" data-section="reports">
                                <i class="fas fa-chart-bar"></i> Laporan
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="#" data-section="users">
                                <i class="fas fa-users-cog"></i> Pengguna
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="#" data-section="settings">
                                <i class="fas fa-cog"></i> Pengaturan
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="#" id="logoutBtn">
                                <i class="fas fa-sign-out-alt"></i> Logout
                            </a>
                        </li>
                    </ul>
                </div>
            </div>

            <!-- Main Content -->
            <main class="col-md-9 ms-sm-auto col-lg-10 px-md-4">
                <!-- Dashboard Section -->
                <div class="section-content" id="dashboardSection">
                    <div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
                        <h1 class="h2">Dashboard</h1>
                    </div>
                    
                    <div class="row">
                        <div class="col-md-4">
                            <div class="card">
                                <div class="card-body">
                                    <h5 class="card-title">Stok Tiket Tersedia</h5>
                                    <h2 class="card-text" id="availableTicketsCount">0</h2>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="card">
                                <div class="card-body">
                                    <h5 class="card-title">Tiket Terjual Hari Ini</h5>
                                    <h2 class="card-text" id="soldTodayCount">0</h2>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="card">
                                <div class="card-body">
                                    <h5 class="card-title">Pendapatan Hari Ini</h5>
                                    <h2 class="card-text" id="todayRevenue">Rp 0</h2>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="row mt-4">
                        <div class="col-md-6">
                            <div class="card">
                                <div class="card-header">
                                    <h5 class="mb-0">Transaksi Terakhir</h5>
                                </div>
                                <div class="card-body">
                                    <div class="table-responsive">
                                        <table class="table table-hover" id="recentTransactionsTable">
                                            <thead>
                                                <tr>
                                                    <th>ID</th>
                                                    <th>Tanggal</th>
                                                    <th>Jumlah</th>
                                                    <th>Total</th>
                                                </tr>
                                            </thead>
                                            <tbody>
                                                <!-- Will be filled by JS -->
                                            </tbody>
                                        </table>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="card">
                                <div class="card-header">
                                    <h5 class="mb-0">Stok Tiket Terbatas</h5>
                                </div>
                                <div class="card-body">
                                    <div class="table-responsive">
                                        <table class="table table-hover" id="lowStockTable">
                                            <thead>
                                                <tr>
                                                    <th>Kode Tiket</th>
                                                    <th>Tipe</th>
                                                    <th>Stok</th>
                                                </tr>
                                            </thead>
                                            <tbody>
                                                <!-- Will be filled by JS -->
                                            </tbody>
                                        </table>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Generate Tickets Section -->
                <div class="section-content" id="generateTicketsSection" style="display: none;">
                    <div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
                        <h1 class="h2">Generate Tiket</h1>
                    </div>
                    
                    <div class="card mb-4">
                        <div class="card-header">
                            <h5 class="mb-0">Buat Tiket Baru</h5>
                        </div>
                        <div class="card-body">
                            <form id="generateTicketForm">
                                <div class="row">
                                    <div class="col-md-4">
                                        <div class="mb-3">
                                            <label for="ticketType" class="form-label">Tipe Tiket</label>
                                            <select class="form-select" id="ticketType" required>
                                                <option value="Reguler">Reguler</option>
                                                <option value="VIP">VIP</option>
                                                <option value="Family">Family Package</option>
                                                <option value="Group">Group</option>
                                            </select>
                                        </div>
                                    </div>
                                    <div class="col-md-4">
                                        <div class="mb-3">
                                            <label for="ticketPrice" class="form-label">Harga (Rp)</label>
                                            <input type="number" class="form-control" id="ticketPrice" min="1000" required>
                                        </div>
                                    </div>
                                    <div class="col-md-4">
                                        <div class="mb-3">
                                            <label for="ticketQuantity" class="form-label">Jumlah Tiket</label>
                                            <input type="number" class="form-control" id="ticketQuantity" min="1" max="1000" value="1" required>
                                        </div>
                                    </div>
                                </div>
                                <div class="mb-3">
                                    <label for="ticketNote" class="form-label">Catatan (Opsional)</label>
                                    <textarea class="form-control" id="ticketNote" rows="2"></textarea>
                                </div>
                                <button type="submit" class="btn btn-primary">Generate Tiket</button>
                            </form>
                        </div>
                    </div>
                    
                    <div class="card">
                        <div class="card-header d-flex justify-content-between align-items-center">
                            <h5 class="mb-0">Hasil Generate</h5>
                            <div>
                                <button id="printTicketsBtn" class="btn btn-sm btn-outline-secondary me-2">
                                    <i class="fas fa-print"></i> Cetak
                                </button>
                                <button id="downloadTicketsBtn" class="btn btn-sm btn-outline-primary">
                                    <i class="fas fa-download"></i> Download PDF
                                </button>
                            </div>
                        </div>
                        <div class="card-body">
                            <div id="generatedTicketsContainer">
                                <p class="text-muted">Belum ada tiket yang digenerate.</p>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Sell Tickets Section -->
                <div class="section-content" id="sellTicketsSection" style="display: none;">
                    <div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
                        <h1 class="h2">Penjualan Tiket</h1>
                    </div>
                    
                    <div class="row">
                        <div class="col-md-8">
                            <div class="card mb-4">
                                <div class="card-header">
                                    <h5 class="mb-0">Kasir</h5>
                                </div>
                                <div class="card-body">
                                    <form id="sellTicketForm">
                                        <div class="row mb-3">
                                            <div class="col-md-8">
                                                <label for="ticketCodeInput" class="form-label">Kode Tiket</label>
                                                <div class="input-group">
                                                    <input type="text" class="form-control" id="ticketCodeInput" placeholder="Scan atau masukkan kode tiket" required>
                                                    <button class="btn btn-outline-secondary" type="button" id="scanTicketBtn">
                                                        <i class="fas fa-barcode"></i>
                                                    </button>
                                                </div>
                                            </div>
                                            <div class="col-md-4">
                                                <label for="ticketQuantityInput" class="form-label">Jumlah</label>
                                                <input type="number" class="form-control" id="ticketQuantityInput" min="1" value="1" required>
                                            </div>
                                        </div>
                                        <div class="mb-3">
                                            <button type="submit" class="btn btn-primary">Tambahkan ke Keranjang</button>
                                        </div>
                                    </form>
                                    
                                    <div class="table-responsive mt-4">
                                        <table class="table table-hover" id="cartTable">
                                            <thead>
                                                <tr>
                                                    <th>Kode Tiket</th>
                                                    <th>Tipe</th>
                                                    <th>Harga</th>
                                                    <th>Jumlah</th>
                                                    <th>Subtotal</th>
                                                    <th>Aksi</th>
                                                </tr>
                                            </thead>
                                            <tbody>
                                                <!-- Will be filled by JS -->
                                            </tbody>
                                        </table>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="card mb-4">
                                <div class="card-header">
                                    <h5 class="mb-0">Ringkasan Pembelian</h5>
                                </div>
                                <div class="card-body">
                                    <div class="mb-3">
                                        <label for="customerName" class="form-label">Nama Pelanggan (Opsional)</label>
                                        <input type="text" class="form-control" id="customerName">
                                    </div>
                                    <div class="mb-3">
                                        <label for="paymentMethod" class="form-label">Metode Pembayaran</label>
                                        <select class="form-select" id="paymentMethod">
                                            <option value="Cash">Cash</option>
                                            <option value="Debit Card">Kartu Debit</option>
                                            <option value="Credit Card">Kartu Kredit</option>
                                            <option value="QRIS">QRIS</option>
                                            <option value="Transfer">Transfer Bank</option>
                                        </select>
                                    </div>
                                    <hr>
                                    <div class="d-flex justify-content-between mb-2">
                                        <span>Total Item:</span>
                                        <span id="totalItems">0</span>
                                    </div>
                                    <div class="d-flex justify-content-between mb-2">
                                        <span>Total Harga:</span>
                                        <span id="totalPrice">Rp 0</span>
                                    </div>
                                    <div class="mb-3">
                                        <label for="cashReceived" class="form-label">Uang Diterima (Rp)</label>
                                        <input type="number" class="form-control" id="cashReceived" min="0" value="0">
                                    </div>
                                    <div class="d-flex justify-content-between mb-3 fw-bold">
                                        <span>Kembalian:</span>
                                        <span id="changeAmount">Rp 0</span>
                                    </div>
                                    <div class="d-grid gap-2">
                                        <button id="completeSaleBtn" class="btn btn-success">Selesaikan Transaksi</button>
                                        <button id="cancelSaleBtn" class="btn btn-danger">Batalkan Transaksi</button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Stock Tickets Section -->
                <div class="section-content" id="stockTicketsSection" style="display: none;">
                    <div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
                        <h1 class="h2">Stok Tiket</h1>
                        <div class="btn-toolbar mb-2 mb-md-0">
                            <div class="btn-group me-2">
                                <button type="button" class="btn btn-sm btn-outline-secondary" id="exportStockBtn">
                                    <i class="fas fa-file-export"></i> Export
                                </button>
                                <button type="button" class="btn btn-sm btn-outline-primary" id="printStockBtn">
                                    <i class="fas fa-print"></i> Cetak
                                </button>
                            </div>
                        </div>
                    </div>
                    
                    <div class="card mb-4">
                        <div class="card-header">
                            <h5 class="mb-0">Filter Stok Tiket</h5>
                        </div>
                        <div class="card-body">
                            <form id="stockFilterForm">
                                <div class="row">
                                    <div class="col-md-4">
                                        <div class="mb-3">
                                            <label for="filterTicketType" class="form-label">Tipe Tiket</label>
                                            <select class="form-select" id="filterTicketType">
                                                <option value="">Semua Tipe</option>
                                                <option value="Reguler">Reguler</option>
                                                <option value="VIP">VIP</option>
                                                <option value="Family">Family Package</option>
                                                <option value="Group">Group</option>
                                            </select>
                                        </div>
                                    </div>
                                    <div class="col-md-4">
                                        <div class="mb-3">
                                            <label for="filterStockStatus" class="form-label">Status Stok</label>
                                            <select class="form-select" id="filterStockStatus">
                                                <option value="">Semua Status</option>
                                                <option value="available">Tersedia</option>
                                                <option value="sold">Terjual</option>
                                            </select>
                                        </div>
                                    </div>
                                    <div class="col-md-4">
                                        <div class="mb-3">
                                            <label for="filterDateRange" class="form-label">Tanggal Generate</label>
                                            <select class="form-select" id="filterDateRange">
                                                <option value="">Semua Tanggal</option>
                                                <option value="today">Hari Ini</option>
                                                <option value="week">Minggu Ini</option>
                                                <option value="month">Bulan Ini</option>
                                            </select>
                                        </div>
                                    </div>
                                </div>
                                <button type="submit" class="btn btn-primary">Terapkan Filter</button>
                                <button type="reset" class="btn btn-secondary">Reset Filter</button>
                            </form>
                        </div>
                    </div>
                    
                    <div class="card">
                        <div class="card-header d-flex justify-content-between align-items-center">
                            <h5 class="mb-0">Daftar Stok Tiket</h5>
                            <span class="badge bg-primary" id="totalStockCount">Total: 0 tiket</span>
                        </div>
                        <div class="card-body">
                            <div class="table-responsive">
                                <table class="table table-hover" id="stockTicketsTable">
                                    <thead>
                                        <tr>
                                            <th>Kode Tiket</th>
                                            <th>Tipe</th>
                                            <th>Harga</th>
                                            <th>Status</th>
                                            <th>Tanggal Generate</th>
                                            <th>Catatan</th>
                                            <th>Aksi</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <!-- Will be filled by JS -->
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Transactions Section -->
                <div class="section-content" id="transactionsSection" style="display: none;">
                    <div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
                        <h1 class="h2">Riwayat Transaksi</h1>
                        <div class="btn-toolbar mb-2 mb-md-0">
                            <div class="btn-group me-2">
                                <button type="button" class="btn btn-sm btn-outline-secondary" id="exportTransactionsBtn">
                                    <i class="fas fa-file-export"></i> Export
                                </button>
                                <button type="button" class="btn btn-sm btn-outline-primary" id="printTransactionsBtn">
                                    <i class="fas fa-print"></i> Cetak
                                </button>
                            </div>
                        </div>
                    </div>
                    
                    <div class="card mb-4">
                        <div class="card-header">
                            <h5 class="mb-0">Filter Transaksi</h5>
                        </div>
                        <div class="card-body">
                            <form id="transactionFilterForm">
                                <div class="row">
                                    <div class="col-md-3">
                                        <div class="mb-3">
                                            <label for="filterTransactionDateFrom" class="form-label">Dari Tanggal</label>
                                            <input type="date" class="form-control" id="filterTransactionDateFrom">
                                        </div>
                                    </div>
                                    <div class="col-md-3">
                                        <div class="mb-3">
                                            <label for="filterTransactionDateTo" class="form-label">Sampai Tanggal</label>
                                            <input type="date" class="form-control" id="filterTransactionDateTo">
                                        </div>
                                    </div>
                                    <div class="col-md-3">
                                        <div class="mb-3">
                                            <label for="filterTransactionPayment" class="form-label">Metode Pembayaran</label>
                                            <select class="form-select" id="filterTransactionPayment">
                                                <option value="">Semua Metode</option>
                                                <option value="Cash">Cash</option>
                                                <option value="Debit Card">Kartu Debit</option>
                                                <option value="Credit Card">Kartu Kredit</option>
                                                <option value="QRIS">QRIS</option>
                                                <option value="Transfer">Transfer Bank</option>
                                            </select>
                                        </div>
                                    </div>
                                    <div class="col-md-3">
                                        <div class="mb-3">
                                            <label for="filterTransactionUser" class="form-label">Kasir</label>
                                            <select class="form-select" id="filterTransactionUser">
                                                <option value="">Semua Kasir</option>
                                                <!-- Will be filled by JS -->
                                            </select>
                                        </div>
                                    </div>
                                </div>
                                <button type="submit" class="btn btn-primary">Terapkan Filter</button>
                                <button type="reset" class="btn btn-secondary">Reset Filter</button>
                            </form>
                        </div>
                    </div>
                    
                    <div class="card">
                        <div class="card-header d-flex justify-content-between align-items-center">
                            <h5 class="mb-0">Daftar Transaksi</h5>
                            <span class="badge bg-primary" id="totalTransactionCount">Total: 0 transaksi</span>
                        </div>
                        <div class="card-body">
                            <div class="table-responsive">
                                <table class="table table-hover" id="transactionsTable">
                                    <thead>
                                        <tr>
                                            <th>ID Transaksi</th>
                                            <th>Tanggal</th>
                                            <th>Pelanggan</th>
                                            <th>Jumlah Item</th>
                                            <th>Total</th>
                                            <th>Metode</th>
                                            <th>Kasir</th>
                                            <th>Aksi</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <!-- Will be filled by JS -->
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Reports Section -->
                <div class="section-content" id="reportsSection" style="display: none;">
                    <div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
                        <h1 class="h2">Laporan</h1>
                        <div class="btn-toolbar mb-2 mb-md-0">
                            <div class="btn-group me-2">
                                <button type="button" class="btn btn-sm btn-outline-primary" id="printReportBtn">
                                    <i class="fas fa-print"></i> Cetak
                                </button>
                                <button type="button" class="btn btn-sm btn-outline-success" id="downloadReportBtn">
                                    <i class="fas fa-download"></i> Download PDF
                                </button>
                            </div>
                        </div>
                    </div>
                    
                    <div class="card mb-4">
                        <div class="card-header">
                            <h5 class="mb-0">Parameter Laporan</h5>
                        </div>
                        <div class="card-body">
                            <form id="reportForm">
                                <div class="row">
                                    <div class="col-md-4">
                                        <div class="mb-3">
                                            <label for="reportType" class="form-label">Jenis Laporan</label>
                                            <select class="form-select" id="reportType" required>
                                                <option value="daily">Harian</option>
                                                <option value="weekly">Mingguan</option>
                                                <option value="monthly">Bulanan</option>
                                                <option value="custom">Custom</option>
                                            </select>
                                        </div>
                                    </div>
                                    <div class="col-md-4" id="reportDateContainer">
                                        <div class="mb-3">
                                            <label for="reportDate" class="form-label">Tanggal</label>
                                            <input type="date" class="form-control" id="reportDate" required>
                                        </div>
                                    </div>
                                    <div class="col-md-4" id="reportWeekContainer" style="display: none;">
                                        <div class="mb-3">
                                            <label for="reportWeek" class="form-label">Minggu</label>
                                            <input type="week" class="form-control" id="reportWeek" required>
                                        </div>
                                    </div>
                                    <div class="col-md-4" id="reportMonthContainer" style="display: none;">
                                        <div class="mb-3">
                                            <label for="reportMonth" class="form-label">Bulan</label>
                                            <input type="month" class="form-control" id="reportMonth" required>
                                        </div>
                                    </div>
                                    <div class="col-md-4" id="reportCustomFromContainer" style="display: none;">
                                        <div class="mb-3">
                                            <label for="reportCustomFrom" class="form-label">Dari Tanggal</label>
                                            <input type="date" class="form-control" id="reportCustomFrom">
                                        </div>
                                    </div>
                                    <div class="col-md-4" id="reportCustomToContainer" style="display: none;">
                                        <div class="mb-3">
                                            <label for="reportCustomTo" class="form-label">Sampai Tanggal</label>
                                            <input type="date" class="form-control" id="reportCustomTo">
                                        </div>
                                    </div>
                                </div>
                                <button type="submit" class="btn btn-primary">Generate Laporan</button>
                            </form>
                        </div>
                    </div>
                    
                    <div class="card">
                        <div class="card-header">
                            <h5 class="mb-0">Hasil Laporan</h5>
                        </div>
                        <div class="card-body">
                            <div id="reportResultContainer">
                                <div class="alert alert-info">
                                    Silahkan pilih parameter laporan dan klik "Generate Laporan" untuk melihat hasil.
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Users Section -->
                <div class="section-content" id="usersSection" style="display: none;">
                    <div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
                        <h1 class="h2">Manajemen Pengguna</h1>
                        <div class="btn-toolbar mb-2 mb-md-0">
                            <button type="button" class="btn btn-sm btn-primary" data-bs-toggle="modal" data-bs-target="#addUserModal">
                                <i class="fas fa-user-plus"></i> Tambah Pengguna
                            </button>
                        </div>
                    </div>
                    
                    <div class="card">
                        <div class="card-header">
                            <h5 class="mb-0">Daftar Pengguna</h5>
                        </div>
                        <div class="card-body">
                            <div class="table-responsive">
                                <table class="table table-hover" id="usersTable">
                                    <thead>
                                        <tr>
                                            <th>Username</th>
                                            <th>Nama Lengkap</th>
                                            <th>Role</th>
                                            <th>Terakhir Login</th>
                                            <th>Status</th>
                                            <th>Aksi</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <!-- Will be filled by JS -->
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Settings Section -->
                <div class="section-content" id="settingsSection" style="display: none;">
                    <div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
                        <h1 class="h2">Pengaturan Sistem</h1>
                    </div>
                    
                    <div class="row">
                        <div class="col-md-6">
                            <div class="card mb-4">
                                <div class="card-header">
                                    <h5 class="mb-0">Informasi Tempat Wisata</h5>
                                </div>
                                <div class="card-body">
                                    <form id="venueInfoForm">
                                        <div class="mb-3">
                                            <label for="venueName" class="form-label">Nama Tempat Wisata</label>
                                            <input type="text" class="form-control" id="venueName" required>
                                        </div>
                                        <div class="mb-3">
                                            <label for="venueAddress" class="form-label">Alamat</label>
                                            <textarea class="form-control" id="venueAddress" rows="2" required></textarea>
                                        </div>
                                        <div class="mb-3">
                                            <label for="venuePhone" class="form-label">Telepon</label>
                                            <input type="text" class="form-control" id="venuePhone">
                                        </div>
                                        <div class="mb-3">
                                            <label for="venueEmail" class="form-label">Email</label>
                                            <input type="email" class="form-control" id="venueEmail">
                                        </div>
                                        <button type="submit" class="btn btn-primary">Simpan Perubahan</button>
                                    </form>
                                </div>
                            </div>
                            
                            <div class="card mb-4">
                                <div class="card-header">
                                    <h5 class="mb-0">Backup & Restore Data</h5>
                                </div>
                                <div class="card-body">
                                    <div class="mb-4">
                                        <h6>Backup Data</h6>
                                        <p>Buat cadangan semua data sistem termasuk tiket, transaksi, dan pengguna.</p>
                                        <button id="backupDataBtn" class="btn btn-outline-primary">
                                            <i class="fas fa-download"></i> Buat Backup
                                        </button>
                                    </div>
                                    
                                    <div class="mb-4">
                                        <h6>Restore Data</h6>
                                        <p>Mengembalikan data dari file backup sebelumnya.</p>
                                        <div class="input-group mb-3">
                                            <input type="file" class="form-control" id="restoreFileInput" accept=".json">
                                            <button class="btn btn-outline-secondary" type="button" id="restoreDataBtn">Restore</button>
                                        </div>
                                    </div>
                                    
                                    <div>
                                        <h6>Reset Data</h6>
                                        <p class="text-danger">Hati-hati! Ini akan menghapus semua data dan mengembalikan sistem ke pengaturan awal.</p>
                                        <button id="resetDataBtn" class="btn btn-outline-danger" data-bs-toggle="modal" data-bs-target="#resetDataModal">
                                            <i class="fas fa-trash-alt"></i> Reset Semua Data
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="col-md-6">
                            <div class="card mb-4">
                                <div class="card-header">
                                    <h5 class="mb-0">Pengaturan Tiket</h5>
                                </div>
                                <div class="card-body">
                                    <form id="ticketSettingsForm">
                                        <div class="mb-3">
                                            <label for="defaultTicketPrefix" class="form-label">Prefix Kode Tiket</label>
                                            <input type="text" class="form-control" id="defaultTicketPrefix" maxlength="3" required>
                                            <small class="text-muted">3 huruf awal untuk kode tiket (contoh: TKT)</small>
                                        </div>
                                        <div class="mb-3">
                                            <label for="defaultTicketPrice" class="form-label">Harga Tiket Default (Rp)</label>
                                            <input type="number" class="form-control" id="defaultTicketPrice" min="1000" required>
                                        </div>
                                        <div class="mb-3">
                                            <label for="ticketValidityDays" class="form-label">Masa Berlaku Tiket (hari)</label>
                                            <input type="number" class="form-control" id="ticketValidityDays" min="1" value="30" required>
                                        </div>
                                        <button type="submit" class="btn btn-primary">Simpan Perubahan</button>
                                    </form>
                                </div>
                            </div>
                            
                            <div class="card">
                                <div class="card-header">
                                    <h5 class="mb-0">Pengaturan Cetak Struk</h5>
                                </div>
                                <div class="card-body">
                                    <form id="receiptSettingsForm">
                                        <div class="mb-3">
                                            <label for="receiptHeaderText" class="form-label">Teks Header Struk</label>
                                            <textarea class="form-control" id="receiptHeaderText" rows="2" required></textarea>
                                        </div>
                                        <div class="mb-3">
                                            <label for="receiptFooterText" class="form-label">Teks Footer Struk</label>
                                            <textarea class="form-control" id="receiptFooterText" rows="2" required></textarea>
                                        </div>
                                        <div class="mb-3 form-check">
                                            <input type="checkbox" class="form-check-input" id="showCustomerNameOnReceipt">
                                            <label class="form-check-label" for="showCustomerNameOnReceipt">Tampilkan nama pelanggan di struk</label>
                                        </div>
                                        <div class="mb-3 form-check">
                                            <input type="checkbox" class="form-check-input" id="showDateOnReceipt" checked>
                                            <label class="form-check-label" for="showDateOnReceipt">Tampilkan tanggal di struk</label>
                                        </div>
                                        <button type="submit" class="btn btn-primary">Simpan Perubahan</button>
                                    </form>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </main>
        </div>
    </div>

    <!-- Add User Modal -->
    <div class="modal fade" id="addUserModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header bg-primary text-white">
                    <h5 class="modal-title">Tambah Pengguna Baru</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <form id="addUserForm">
                        <div class="mb-3">
                            <label for="newUsername" class="form-label">Username</label>
                            <input type="text" class="form-control" id="newUsername" required>
                        </div>
                        <div class="mb-3">
                            <label for="newFullName" class="form-label">Nama Lengkap</label>
                            <input type="text" class="form-control" id="newFullName" required>
                        </div>
                        <div class="mb-3">
                            <label for="newUserRole" class="form-label">Role</label>
                            <select class="form-select" id="newUserRole" required>
                                <option value="admin">Admin</option>
                                <option value="kasir">Kasir</option>
                                <option value="manager">Manager</option>
                            </select>
                        </div>
                        <div class="mb-3">
                            <label for="newPassword" class="form-label">Password</label>
                            <input type="password" class="form-control" id="newPassword" required>
                        </div>
                        <div class="mb-3">
                            <label for="confirmPassword" class="form-label">Konfirmasi Password</label>
                            <input type="password" class="form-control" id="confirmPassword" required>
                        </div>
                        <div class="mb-3 form-check">
                            <input type="checkbox" class="form-check-input" id="newUserActive" checked>
                            <label class="form-check-label" for="newUserActive">Aktif</label>
                        </div>
                        <button type="submit" class="btn btn-primary">Simpan</button>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <!-- Edit User Modal -->
    <div class="modal fade" id="editUserModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header bg-primary text-white">
                    <h5 class="modal-title">Edit Pengguna</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <form id="editUserForm">
                        <input type="hidden" id="editUserId">
                        <div class="mb-3">
                            <label for="editUsername" class="form-label">Username</label>
                            <input type="text" class="form-control" id="editUsername" readonly>
                        </div>
                        <div class="mb-3">
                            <label for="editFullName" class="form-label">Nama Lengkap</label>
                            <input type="text" class="form-control" id="editFullName" required>
                        </div>
                        <div class="mb-3">
                            <label for="editUserRole" class="form-label">Role</label>
                            <select class="form-select" id="editUserRole" required>
                                <option value="admin">Admin</option>
                                <option value="kasir">Kasir</option>
                                <option value="manager">Manager</option>
                            </select>
                        </div>
                        <div class="mb-3">
                            <label for="editPassword" class="form-label">Password Baru (kosongkan jika tidak diubah)</label>
                            <input type="password" class="form-control" id="editPassword">
                        </div>
                        <div class="mb-3 form-check">
                            <input type="checkbox" class="form-check-input" id="editUserActive">
                            <label class="form-check-label" for="editUserActive">Aktif</label>
                        </div>
                        <button type="submit" class="btn btn-primary">Simpan Perubahan</button>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <!-- Reset Data Modal -->
    <div class="modal fade" id="resetDataModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header bg-danger text-white">
                    <h5 class="modal-title">Konfirmasi Reset Data</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div class="alert alert-danger">
                        <strong>Peringatan!</strong> Ini akan menghapus semua data termasuk tiket, transaksi, dan pengguna (kecuali admin utama).
                    </div>
                    <p>Masukkan password admin untuk melanjutkan:</p>
                    <form id="resetDataForm">
                        <div class="mb-3">
                            <label for="adminPassword" class="form-label">Password Admin</label>
                            <input type="password" class="form-control" id="adminPassword" required>
                        </div>
                        <button type="submit" class="btn btn-danger">Reset Semua Data</button>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <!-- View Transaction Modal -->
    <div class="modal fade" id="viewTransactionModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header bg-primary text-white">
                    <h5 class="modal-title">Detail Transaksi</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div class="row mb-3">
                        <div class="col-md-6">
                            <p><strong>ID Transaksi:</strong> <span id="viewTransactionId"></span></p>
                            <p><strong>Tanggal:</strong> <span id="viewTransactionDate"></span></p>
                            <p><strong>Pelanggan:</strong> <span id="viewTransactionCustomer"></span></p>
                        </div>
                        <div class="col-md-6">
                            <p><strong>Kasir:</strong> <span id="viewTransactionCashier"></span></p>
                            <p><strong>Metode Pembayaran:</strong> <span id="viewTransactionPayment"></span></p>
                            <p><strong>Total:</strong> <span id="viewTransactionTotal"></span></p>
                        </div>
                    </div>
                    
                    <div class="table-responsive">
                        <table class="table table-bordered" id="viewTransactionItemsTable">
                            <thead>
                                <tr>
                                    <th>Kode Tiket</th>
                                    <th>Tipe</th>
                                    <th>Harga</th>
                                    <th>Jumlah</th>
                                    <th>Subtotal</th>
                                </tr>
                            </thead>
                            <tbody>
                                <!-- Will be filled by JS -->
                            </tbody>
                        </table>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Tutup</button>
                    <button type="button" class="btn btn-primary" id="printTransactionBtn">
                        <i class="fas fa-print"></i> Cetak Ulang
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Scripts -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.29.1/moment.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.29.1/locale/id.min.js"></script>
    <script>
        // Initialize the application when DOM is loaded
        document.addEventListener('DOMContentLoaded', function() {
            // Check if this is first run
            if (!localStorage.getItem('appInitialized')) {
                initializeApplication();
            }
            
            // Show login modal
            const loginModal = new bootstrap.Modal(document.getElementById('loginModal'));
            loginModal.show();
            
            // Setup event listeners
            setupEventListeners();
        });
        
        // Initialize application data structure
        function initializeApplication() {
            const defaultAdmin = {
                username: 'admin',
                password: '13579', // Default password for admin
                fullName: 'Administrator',
                role: 'admin',
                isActive: true,
                lastLogin: null,
                createdAt: new Date().toISOString()
            };
            
            const defaultSettings = {
                venueName: 'Nama Tempat Wisata',
                venueAddress: 'Alamat tempat wisata',
                venuePhone: '',
                venueEmail: '',
                defaultTicketPrefix: 'TKT',
                defaultTicketPrice: 25000,
                ticketValidityDays: 30,
                receiptHeaderText: 'Terima kasih telah berkunjung',
                receiptFooterText: 'Tiket tidak dapat dikembalikan atau ditukar',
                showCustomerNameOnReceipt: false,
                showDateOnReceipt: true
            };
            
            const initialData = {
                version: '1.0',
                initializedAt: new Date().toISOString(),
                users: [defaultAdmin],
                tickets: [],
                transactions: [],
                settings: defaultSettings,
                currentUser: null
            };
            
            localStorage.setItem('ticketSystemData', JSON.stringify(initialData));
            localStorage.setItem('appInitialized', 'true');
        }
        
        // Get application data
        function getAppData() {
            const data = localStorage.getItem('ticketSystemData');
            return data ? JSON.parse(data) : null;
        }
        
        // Save application data
        function saveAppData(data) {
            localStorage.setItem('ticketSystemData', JSON.stringify(data));
        }
        
        // Update application data with partial data
        function updateAppData(updates) {
            const data = getAppData();
            const updatedData = {...data, ...updates};
            saveAppData(updatedData);
            return updatedData;
        }
        
        // Setup event listeners
        function setupEventListeners() {
            // Login form
            document.getElementById('loginForm').addEventListener('submit', function(e) {
                e.preventDefault();
                handleLogin();
            });
            
            // Logout button
            document.getElementById('logoutBtn').addEventListener('click', function() {
                handleLogout();
            });
            
            // Navigation links
            document.querySelectorAll('[data-section]').forEach(link => {
                link.addEventListener('click', function(e) {
                    e.preventDefault();
                    showSection(this.getAttribute('data-section'));
                });
            });
            
            // Generate ticket form
            document.getElementById('generateTicketForm').addEventListener('submit', function(e) {
                e.preventDefault();
                generateTickets();
            });
            
            // Print tickets button
            document.getElementById('printTicketsBtn').addEventListener('click', function() {
                printTickets();
            });
            
            // Download tickets button
            document.getElementById('downloadTicketsBtn').addEventListener('click', function() {
                downloadTicketsAsPDF();
            });
            
            // Sell ticket form
            document.getElementById('sellTicketForm').addEventListener('submit', function(e) {
                e.preventDefault();
                addToCart();
            });
            
            // Complete sale button
            document.getElementById('completeSaleBtn').addEventListener('click', function() {
                completeSale();
            });
            
            // Cancel sale button
            document.getElementById('cancelSaleBtn').addEventListener('click', function() {
                cancelSale();
            });
            
            // Cash received input
            document.getElementById('cashReceived').addEventListener('input', function() {
                calculateChange();
            });
            
            // Stock filter form
            document.getElementById('stockFilterForm').addEventListener('submit', function(e) {
                e.preventDefault();
                filterStockTickets();
            });
            
            // Stock filter reset
            document.getElementById('stockFilterForm').addEventListener('reset', function() {
                setTimeout(() => {
                    filterStockTickets();
                }, 0);
            });
            
            // Export stock button
            document.getElementById('exportStockBtn').addEventListener('click', function() {
                exportStockData();
            });
            
            // Print stock button
            document.getElementById('printStockBtn').addEventListener('click', function() {
                printStockData();
            });
            
            // Transaction filter form
            document.getElementById('transactionFilterForm').addEventListener('submit', function(e) {
                e.preventDefault();
                filterTransactions();
            });
            
            // Transaction filter reset
            document.getElementById('transactionFilterForm').addEventListener('reset', function() {
                setTimeout(() => {
                    filterTransactions();
                }, 0);
            });
            
            // Export transactions button
            document.getElementById('exportTransactionsBtn').addEventListener('click', function() {
                exportTransactionsData();
            });
            
            // Print transactions button
            document.getElementById('printTransactionsBtn').addEventListener('click', function() {
                printTransactionsData();
            });
            
            // Report type change
            document.getElementById('reportType').addEventListener('change', function() {
                updateReportDateFields();
            });
            
            // Report form
            document.getElementById('reportForm').addEventListener('submit', function(e) {
                e.preventDefault();
                generateReport();
            });
            
            // Print report button
            document.getElementById('printReportBtn').addEventListener('click', function() {
                printReport();
            });
            
            // Download report button
            document.getElementById('downloadReportBtn').addEventListener('click', function() {
                downloadReportAsPDF();
            });
            
            // Add user form
            document.getElementById('addUserForm').addEventListener('submit', function(e) {
                e.preventDefault();
                addNewUser();
            });
            
            // Edit user form
            document.getElementById('editUserForm').addEventListener('submit', function(e) {
                e.preventDefault();
                saveUserChanges();
            });
            
            // Venue info form
            document.getElementById('venueInfoForm').addEventListener('submit', function(e) {
                e.preventDefault();
                saveVenueInfo();
            });
            
            // Ticket settings form
            document.getElementById('ticketSettingsForm').addEventListener('submit', function(e) {
                e.preventDefault();
                saveTicketSettings();
            });
            
            // Receipt settings form
            document.getElementById('receiptSettingsForm').addEventListener('submit', function(e) {
                e.preventDefault();
                saveReceiptSettings();
            });
            
            // Backup data button
            document.getElementById('backupDataBtn').addEventListener('click', function() {
                backupData();
            });
            
            // Restore data button
            document.getElementById('restoreDataBtn').addEventListener('click', function() {
                restoreData();
            });
            
            // Reset data form
            document.getElementById('resetDataForm').addEventListener('submit', function(e) {
                e.preventDefault();
                resetSystemData();
            });
            
            // Print transaction button
            document.getElementById('printTransactionBtn').addEventListener('click', function() {
                printTransactionReceipt();
            });
            
            // Scan ticket button
            document.getElementById('scanTicketBtn').addEventListener('click', function() {
                simulateScan();
            });
        }
        
        // Handle user login
        function handleLogin() {
            const username = document.getElementById('username').value;
            const password = document.getElementById('password').value;
            
            const data = getAppData();
            const user = data.users.find(u => u.username === username && u.isActive);
            
            if (user && user.password === password) {
                // Update last login
                user.lastLogin = new Date().toISOString();
                data.currentUser = {
                    username: user.username,
                    fullName: user.fullName,
                    role: user.role
                };
                saveAppData(data);
                
                // Hide login modal
                const loginModal = bootstrap.Modal.getInstance(document.getElementById('loginModal'));
                loginModal.hide();
                
                // Show main app
                document.getElementById('appContainer').style.display = 'block';
                
                // Initialize dashboard
                initializeDashboard();
                
                // Show dashboard section
                showSection('dashboard');
            } else {
                alert('Username atau password salah!');
            }
        }
        
        // Handle user logout
        function handleLogout() {
            const data = getAppData();
            data.currentUser = null;
            saveAppData(data);
            
            // Hide app container
            document.getElementById('appContainer').style.display = 'none';
            
            // Show login modal
            const loginModal = new bootstrap.Modal(document.getElementById('loginModal'));
            loginModal.show();
            
            // Clear login form
            document.getElementById('loginForm').reset();
        }
        
        // Show specific section
        function showSection(sectionId) {
            // Hide all sections
            document.querySelectorAll('.section-content').forEach(section => {
                section.style.display = 'none';
            });
            
            // Show selected section
            document.getElementById(`${sectionId}Section`).style.display = 'block';
            
            // Update active nav link
            document.querySelectorAll('.nav-link').forEach(link => {
                link.classList.remove('active');
            });
            document.querySelector(`[data-section="${sectionId}"]`).classList.add('active');
            
            // Initialize section if needed
            switch(sectionId) {
                case 'dashboard':
                    initializeDashboard();
                    break;
                case 'generateTickets':
                    initializeGenerateTickets();
                    break;
                case 'sellTickets':
                    initializeSellTickets();
                    break;
                case 'stockTickets':
                    initializeStockTickets();
                    break;
                case 'transactions':
                    initializeTransactions();
                    break;
                case 'reports':
                    initializeReports();
                    break;
                case 'users':
                    initializeUsers();
                    break;
                case 'settings':
                    initializeSettings();
                    break;
            }
        }
        
        // Initialize dashboard
        function initializeDashboard() {
            const data = getAppData();
            
            // Count available tickets
            const availableTickets = data.tickets.filter(t => t.status === 'available').length;
            document.getElementById('availableTicketsCount').textContent = availableTickets;
            
            // Count today's sales and revenue
            const today = new Date().toISOString().split('T')[0];
            const todayTransactions = data.transactions.filter(t => t.date.split('T')[0] === today);
            const soldToday = todayTransactions.reduce((sum, t) => sum + t.items.reduce((s, i) => s + i.quantity, 0), 0);
            const todayRevenue = todayTransactions.reduce((sum, t) => sum + t.total, 0);
            
            document.getElementById('soldTodayCount').textContent = soldToday;
            document.getElementById('todayRevenue').textContent = formatCurrency(todayRevenue);
            
            // Recent transactions
            const recentTransactionsTable = document.getElementById('recentTransactionsTable').getElementsByTagName('tbody')[0];
            recentTransactionsTable.innerHTML = '';
            
            const recentTransactions = [...data.transactions].reverse().slice(0, 5);
            recentTransactions.forEach(t => {
                const row = recentTransactionsTable.insertRow();
                row.insertCell(0).textContent = t.id;
                row.insertCell(1).textContent = formatDate(t.date);
                row.insertCell(2).textContent = t.items.reduce((sum, i) => sum + i.quantity, 0);
                row.insertCell(3).textContent = formatCurrency(t.total);
            });
            
            // Low stock tickets
            const lowStockTable = document.getElementById('lowStockTable').getElementsByTagName('tbody')[0];
            lowStockTable.innerHTML = '';
            
            // Group available tickets by type
            const ticketTypes = {};
            data.tickets.filter(t => t.status === 'available').forEach(t => {
                if (!ticketTypes[t.type]) {
                    ticketTypes[t.type] = [];
                }
                ticketTypes[t.type].push(t);
            });
            
            // Show types with less than 10 tickets
            Object.entries(ticketTypes).forEach(([type, tickets]) => {
                if (tickets.length < 10) {
                    const row = lowStockTable.insertRow();
                    row.insertCell(0).textContent = tickets[0].code.substring(0, 8) + '...'; // Show sample code
                    row.insertCell(1).textContent = type;
                    row.insertCell(2).textContent = tickets.length;
                }
            });
        }
        
        // Initialize generate tickets section
        function initializeGenerateTickets() {
            const data = getAppData();
            
            // Set default price from settings
            document.getElementById('ticketPrice').value = data.settings.defaultTicketPrice;
            
            // Clear generated tickets container
            document.getElementById('generatedTicketsContainer').innerHTML = '<p class="text-muted">Belum ada tiket yang digenerate.</p>';
        }
        
        // Generate tickets
        function generateTickets() {
            const type = document.getElementById('ticketType').value;
            const price = parseInt(document.getElementById('ticketPrice').value);
            const quantity = parseInt(document.getElementById('ticketQuantity').value);
            const note = document.getElementById('ticketNote').value;
            
            if (price < 1000) {
                alert('Harga tiket minimal Rp 1.000');
                return;
            }
            
            if (quantity < 1 || quantity > 1000) {
                alert('Jumlah tiket harus antara 1-1000');
                return;
            }
            
            const data = getAppData();
            const prefix = data.settings.defaultTicketPrefix;
            const newTickets = [];
            
            // Generate tickets
            for (let i = 0; i < quantity; i++) {
                const code = generateTicketCode(prefix);
                newTickets.push({
                    code: code,
                    type: type,
                    price: price,
                    status: 'available',
                    generatedAt: new Date().toISOString(),
                    generatedBy: data.currentUser.username,
                    note: note,
                    soldAt: null,
                    soldBy: null,
                    transactionId: null
                });
            }
            
            // Add to data
            data.tickets = [...data.tickets, ...newTickets];
            saveAppData(data);
            
            // Display generated tickets
            displayGeneratedTickets(newTickets);
        }
        
        // Generate unique ticket code
        function generateTicketCode(prefix) {
            const chars = 'ABCDEFGHJKLMNPQRSTUVWXYZ23456789'; // Exclude confusing chars
            let code = prefix;
            
            for (let i = 0; i < 9; i++) {
                code += chars.charAt(Math.floor(Math.random() * chars.length));
            }
            
            return code;
        }
        
        // Display generated tickets
        function displayGeneratedTickets(tickets) {
            const container = document.getElementById('generatedTicketsContainer');
            container.innerHTML = '';
            
            if (tickets.length === 0) {
                container.innerHTML = '<p class="text-muted">Belum ada tiket yang digenerate.</p>';
                return;
            }
            
            const row = document.createElement('div');
            row.className = 'row';
            
            tickets.forEach((ticket, index) => {
                const col = document.createElement('div');
                col.className = 'col-md-6 col-lg-4';
                
                const ticketElement = document.createElement('div');
                ticketElement.className = 'ticket';
                ticketElement.innerHTML = `
                    <div class="d-flex justify-content-between align-items-center mb-2">
                        <span class="badge bg-primary">${ticket.type}</span>
                        <small class="text-muted">${formatDate(ticket.generatedAt)}</small>
                    </div>
                    <div class="text-center my-3">
                        <div class="ticket-code">${ticket.code}</div>
                        <div class="fw-bold">${formatCurrency(ticket.price)}</div>
                    </div>
                    <div class="d-flex justify-content-between align-items-center">
                        <small class="text-success">Tersedia</small>
                        <small>${index + 1}/${tickets.length}</small>
                    </div>
                `;
                
                col.appendChild(ticketElement);
                row.appendChild(col);
            });
            
            container.appendChild(row);
        }
        
        // Print tickets
        function printTickets() {
            window.print();
        }
        
        // Download tickets as PDF
        function downloadTicketsAsPDF() {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();
            
            const tickets = document.querySelectorAll('.ticket');
            if (tickets.length === 0) {
                alert('Tidak ada tiket untuk didownload');
                return;
            }
            
            const data = getAppData();
            const date = new Date().toISOString().split('T')[0];
            
            // Add header
            doc.setFontSize(16);
            doc.text(`Daftar Tiket - ${data.settings.venueName}`, 105, 15, { align: 'center' });
            doc.setFontSize(12);
            doc.text(`Tanggal Generate: ${formatDate(date)} | Jumlah: ${tickets.length} tiket`, 105, 22, { align: 'center' });
            
            // Add tickets
            let y = 40;
            tickets.forEach((ticket, index) => {
                if (y > 270) {
                    doc.addPage();
                    y = 20;
                }
                
                const code = ticket.querySelector('.ticket-code').textContent;
                const type = ticket.querySelector('.badge').textContent;
                const price = ticket.querySelector('.fw-bold').textContent;
                const date = ticket.querySelector('small.text-muted').textContent;
                
                doc.setFontSize(14);
                doc.text(code, 20, y);
                doc.setFontSize(10);
                doc.text(`Tipe: ${type} | Harga: ${price} | ${date}`, 20, y + 7);
                
                // Add separator
                doc.line(20, y + 12, 190, y + 12);
                
                y += 20;
            });
            
            // Save PDF
            doc.save(`tiket_wisata_${date}.pdf`);
        }
        
        // Initialize sell tickets section
        function initializeSellTickets() {
            // Clear cart
            clearCart();
            
            // Set today's date as default
            document.getElementById('customerName').value = '';
            document.getElementById('paymentMethod').value = 'Cash';
            document.getElementById('cashReceived').value = '0';
        }
        
        // Add ticket to cart
        function addToCart() {
            const code = document.getElementById('ticketCodeInput').value.trim().toUpperCase();
            const quantity = parseInt(document.getElementById('ticketQuantityInput').value);
            
            if (quantity < 1) {
                alert('Jumlah tiket minimal 1');
                return;
            }
            
            const data = getAppData();
            const ticket = data.tickets.find(t => t.code === code && t.status === 'available');
            
            if (!ticket) {
                alert('Kode tiket tidak valid atau sudah digunakan');
                return;
            }
            
            // Check if ticket already in cart
            const cartTable = document.getElementById('cartTable').getElementsByTagName('tbody')[0];
            const existingRow = Array.from(cartTable.rows).find(row => row.cells[0].textContent === code);
            
            if (existingRow) {
                // Update quantity
                const newQuantity = parseInt(existingRow.cells[3].textContent) + quantity;
                existingRow.cells[3].textContent = newQuantity;
                existingRow.cells[4].textContent = formatCurrency(ticket.price * newQuantity);
                existingRow.cells[5].innerHTML = `<button class="btn btn-sm btn-danger remove-item-btn" data-code="${code}"><i class="fas fa-trash-alt"></i></button>`;
            } else {
                // Add new row
                const row = cartTable.insertRow();
                row.insertCell(0).textContent = code;
                row.insertCell(1).textContent = ticket.type;
                row.insertCell(2).textContent = formatCurrency(ticket.price);
                row.insertCell(3).textContent = quantity;
                row.insertCell(4).textContent = formatCurrency(ticket.price * quantity);
                row.insertCell(5).innerHTML = `<button class="btn btn-sm btn-danger remove-item-btn" data-code="${code}"><i class="fas fa-trash-alt"></i></button>`;
            }
            
            // Add event listener to remove button
            document.querySelectorAll('.remove-item-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    removeFromCart(this.getAttribute('data-code'));
                });
            });
            
            // Update summary
            updateCartSummary();
            
            // Clear input
            document.getElementById('ticketCodeInput').value = '';
            document.getElementById('ticketQuantityInput').value = '1';
            document.getElementById('ticketCodeInput').focus();
        }
        
        // Remove ticket from cart
        function removeFromCart(code) {
            const cartTable = document.getElementById('cartTable').getElementsByTagName('tbody')[0];
            const row = Array.from(cartTable.rows).find(r => r.cells[0].textContent === code);
            
            if (row) {
                cartTable.removeChild(row);
                updateCartSummary();
            }
        }
        
        // Update cart summary
        function updateCartSummary() {
            const cartTable = document.getElementById('cartTable').getElementsByTagName('tbody')[0];
            const rows = Array.from(cartTable.rows);
            
            const totalItems = rows.reduce((sum, row) => sum + parseInt(row.cells[3].textContent), 0);
            const totalPrice = rows.reduce((sum, row) => {
                const price = parseCurrency(row.cells[2].textContent);
                const quantity = parseInt(row.cells[3].textContent);
                return sum + (price * quantity);
            }, 0);
            
            document.getElementById('totalItems').textContent = totalItems;
            document.getElementById('totalPrice').textContent = formatCurrency(totalPrice);
            
            // Update change
            calculateChange();
        }
        
        // Calculate change
        function calculateChange() {
            const totalPrice = parseCurrency(document.getElementById('totalPrice').textContent);
            const cashReceived = parseInt(document.getElementById('cashReceived').value) || 0;
            
            const change = cashReceived - totalPrice;
            document.getElementById('changeAmount').textContent = formatCurrency(change > 0 ? change : 0);
        }
        
        // Clear cart
        function clearCart() {
            document.getElementById('cartTable').getElementsByTagName('tbody')[0].innerHTML = '';
            updateCartSummary();
        }
        
        // Complete sale
        function completeSale() {
            const cartTable = document.getElementById('cartTable').getElementsByTagName('tbody')[0];
            const rows = Array.from(cartTable.rows);
            
            if (rows.length === 0) {
                alert('Keranjang belanja kosong');
                return;
            }
            
            const totalPrice = parseCurrency(document.getElementById('totalPrice').textContent);
            const cashReceived = parseInt(document.getElementById('cashReceived').value) || 0;
            
            if (cashReceived < totalPrice) {
                alert('Uang yang diterima kurang');
                return;
            }
            
            const customerName = document.getElementById('customerName').value;
            const paymentMethod = document.getElementById('paymentMethod').value;
            
            const data = getAppData();
            const currentUser = data.currentUser;
            
            // Create transaction
            const transactionId = 'TRX-' + Date.now().toString().slice(-8);
            const transactionDate = new Date().toISOString();
            
            const items = [];
            rows.forEach(row => {
                const code = row.cells[0].textContent;
                const type = row.cells[1].textContent;
                const price = parseCurrency(row.cells[2].textContent);
                const quantity = parseInt(row.cells[3].textContent);
                
                items.push({
                    code: code,
                    type: type,
                    price: price,
                    quantity: quantity
                });
                
                // Update ticket status
                const ticket = data.tickets.find(t => t.code === code);
                if (ticket) {
                    ticket.status = 'sold';
                    ticket.soldAt = transactionDate;
                    ticket.soldBy = currentUser.username;
                    ticket.transactionId = transactionId;
                }
            });
            
            const transaction = {
                id: transactionId,
                date: transactionDate,
                customer: customerName,
                items: items,
                total: totalPrice,
                paymentMethod: paymentMethod,
                cashReceived: cashReceived,
                cashier: currentUser.username
            };
            
            // Save transaction
            data.transactions.push(transaction);
            saveAppData(data);
            
            // Print receipt
            printReceipt(transaction);
            
            // Clear cart
            clearCart();
            
            // Reset form
            document.getElementById('customerName').value = '';
            document.getElementById('paymentMethod').value = 'Cash';
            document.getElementById('cashReceived').value = '0';
            
            // Show success message
            alert(`Transaksi ${transactionId} berhasil disimpan!`);
        }
        
        // Cancel sale
        function cancelSale() {
            if (confirm('Batalkan transaksi ini?')) {
                clearCart();
                document.getElementById('customerName').value = '';
                document.getElementById('paymentMethod').value = 'Cash';
                document.getElementById('cashReceived').value = '0';
            }
        }
        
        // Print receipt
        function printReceipt(transaction) {
            const data = getAppData();
            const settings = data.settings;
            
            const receiptWindow = window.open('', '_blank');
            receiptWindow.document.write(`
                <!DOCTYPE html>
                <html>
                <head>
                    <title>Struk Pembayaran</title>
                    <style>
                        body {
                            font-family: Arial, sans-serif;
                            font-size: 14px;
                            width: 80mm;
                            margin: 0;
                            padding: 10px;
                        }
                        .header {
                            text-align: center;
                            margin-bottom: 10px;
                            border-bottom: 1px dashed #000;
                            padding-bottom: 10px;
                        }
                        .header h2 {
                            margin: 0;
                            font-size: 18px;
                        }
                        .info {
                            margin-bottom: 10px;
                        }
                        table {
                            width: 100%;
                            border-collapse: collapse;
                            margin-bottom: 10px;
                        }
                        th, td {
                            padding: 5px 0;
                            border-bottom: 1px dashed #ddd;
                        }
                        th {
                            text-align: left;
                        }
                        .total {
                            font-weight: bold;
                            border-top: 1px dashed #000;
                            border-bottom: 1px dashed #000;
                            margin: 10px 0;
                            padding: 10px 0;
                        }
                        .footer {
                            text-align: center;
                            margin-top: 10px;
                            font-size: 12px;
                            border-top: 1px dashed #000;
                            padding-top: 10px;
                        }
                        .text-right {
                            text-align: right;
                        }
                    </style>
                </head>
                <body>
                    <div class="header">
                        <h2>${settings.venueName}</h2>
                        <p>${settings.venueAddress}</p>
                        ${settings.showDateOnReceipt ? `<p>${formatDate(transaction.date, true)}</p>` : ''}
                    </div>
                    
                    <div class="info">
                        <p><strong>ID Transaksi:</strong> ${transaction.id}</p>
                        ${settings.showCustomerNameOnReceipt && transaction.customer ? `<p><strong>Pelanggan:</strong> ${transaction.customer}</p>` : ''}
                        <p><strong>Kasir:</strong> ${transaction.cashier}</p>
                    </div>
                    
                    <table>
                        <thead>
                            <tr>
                                <th>Item</th>
                                <th class="text-right">Harga</th>
                                <th class="text-right">Subtotal</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${transaction.items.map(item => `
                                <tr>
                                    <td>${item.type} (${item.quantity}x)</td>
                                    <td class="text-right">${formatCurrency(item.price)}</td>
                                    <td class="text-right">${formatCurrency(item.price * item.quantity)}</td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                    
                    <div class="total">
                        <div style="display: flex; justify-content: space-between;">
                            <span>Total:</span>
                            <span>${formatCurrency(transaction.total)}</span>
                        </div>
                        <div style="display: flex; justify-content: space-between;">
                            <span>Tunai:</span>
                            <span>${formatCurrency(transaction.cashReceived)}</span>
                        </div>
                        <div style="display: flex; justify-content: space-between;">
                            <span>Kembali:</span>
                            <span>${formatCurrency(transaction.cashReceived - transaction.total)}</span>
                        </div>
                    </div>
                    
                    <div class="footer">
                        ${settings.receiptFooterText}
                    </div>
                    
                    <script>
                        setTimeout(() => {
                            window.print();
                            ${data.settings.autoCloseReceipt ? 'setTimeout(() => window.close(), 500);' : ''}
                        }, 100);
                    </script>
                </body>
                </html>
            `);
            receiptWindow.document.close();
        }
        
        // Simulate barcode scan
        function simulateScan() {
            const data = getAppData();
            const availableTickets = data.tickets.filter(t => t.status === 'available');
            
            if (availableTickets.length > 0) {
                const randomIndex = Math.floor(Math.random() * availableTickets.length);
                document.getElementById('ticketCodeInput').value = availableTickets[randomIndex].code;
                document.getElementById('ticketCodeInput').focus();
            } else {
                alert('Tidak ada tiket tersedia untuk discan');
            }
        }
        
        // Initialize stock tickets section
        function initializeStockTickets() {
            filterStockTickets();
        }
        
        // Filter stock tickets
        function filterStockTickets() {
            const typeFilter = document.getElementById('filterTicketType').value;
            const statusFilter = document.getElementById('filterStockStatus').value;
            const dateFilter = document.getElementById('filterDateRange').value;
            
            const data = getAppData();
            let filteredTickets = [...data.tickets];
            
            // Apply filters
            if (typeFilter) {
                filteredTickets = filteredTickets.filter(t => t.type === typeFilter);
            }
            
            if (statusFilter) {
                filteredTickets = filteredTickets.filter(t => t.status === statusFilter);
            }
            
            if (dateFilter) {
                const now = new Date();
                let startDate;
                
                switch(dateFilter) {
                    case 'today':
                        startDate = new Date(now.setHours(0, 0, 0, 0));
                        break;
                    case 'week':
                        startDate = new Date(now.setDate(now.getDate() - now.getDay()));
                        startDate.setHours(0, 0, 0, 0);
                        break;
                    case 'month':
                        startDate = new Date(now.getFullYear(), now.getMonth(), 1);
                        break;
                }
                
                filteredTickets = filteredTickets.filter(t => new Date(t.generatedAt) >= startDate);
            }
            
            // Display filtered tickets
            displayStockTickets(filteredTickets);
        }
        
        // Display stock tickets
        function displayStockTickets(tickets) {
            const table = document.getElementById('stockTicketsTable').getElementsByTagName('tbody')[0];
            table.innerHTML = '';
            
            document.getElementById('totalStockCount').textContent = `Total: ${tickets.length} tiket`;
            
            tickets.forEach(ticket => {
                const row = table.insertRow();
                row.insertCell(0).textContent = ticket.code;
                row.insertCell(1).textContent = ticket.type;
                row.insertCell(2).textContent = formatCurrency(ticket.price);
                
                const statusCell = row.insertCell(3);
                if (ticket.status === 'available') {
                    statusCell.innerHTML = '<span class="badge bg-success">Tersedia</span>';
                } else {
                    statusCell.innerHTML = '<span class="badge bg-secondary">Terjual</span>';
                }
                
                row.insertCell(4).textContent = formatDate(ticket.generatedAt);
                row.insertCell(5).textContent = ticket.note || '-';
                
                const actionCell = row.insertCell(6);
                if (ticket.status === 'available') {
                    actionCell.innerHTML = `<button class="btn btn-sm btn-danger delete-ticket-btn" data-code="${ticket.code}"><i class="fas fa-trash-alt"></i></button>`;
                } else {
                    actionCell.innerHTML = `<button class="btn btn-sm btn-info view-transaction-btn" data-id="${ticket.transactionId}"><i class="fas fa-eye"></i></button>`;
                }
            });
            
            // Add event listeners
            document.querySelectorAll('.delete-ticket-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    deleteTicket(this.getAttribute('data-code'));
                });
            });
            
            document.querySelectorAll('.view-transaction-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    viewTransaction(this.getAttribute('data-id'));
                });
            });
        }
        
        // Delete ticket
        function deleteTicket(code) {
            if (confirm(`Hapus tiket ${code}?`)) {
                const data = getAppData();
                data.tickets = data.tickets.filter(t => t.code !== code);
                saveAppData(data);
                filterStockTickets();
            }
        }
        
        // View transaction
        function viewTransaction(transactionId) {
            const data = getAppData();
            const transaction = data.transactions.find(t => t.id === transactionId);
            
            if (transaction) {
                document.getElementById('viewTransactionId').textContent = transaction.id;
                document.getElementById('viewTransactionDate').textContent = formatDate(transaction.date);
                document.getElementById('viewTransactionCustomer').textContent = transaction.customer || '-';
                document.getElementById('viewTransactionCashier').textContent = transaction.cashier;
                document.getElementById('viewTransactionPayment').textContent = transaction.paymentMethod;
                document.getElementById('viewTransactionTotal').textContent = formatCurrency(transaction.total);
                
                // Populate items table
                const table = document.getElementById('viewTransactionItemsTable').getElementsByTagName('tbody')[0];
                table.innerHTML = '';
                
                transaction.items.forEach(item => {
                    const row = table.insertRow();
                    row.insertCell(0).textContent = item.code;
                    row.insertCell(1).textContent = item.type;
                    row.insertCell(2).textContent = formatCurrency(item.price);
                    row.insertCell(3).textContent = item.quantity;
                    row.insertCell(4).textContent = formatCurrency(item.price * item.quantity);
                });
                
                // Show modal
                const modal = new bootstrap.Modal(document.getElementById('viewTransactionModal'));
                modal.show();
            }
        }
        
        // Export stock data
        function exportStockData() {
            const data = getAppData();
            const filteredTickets = getFilteredStockTickets();
            
            if (filteredTickets.length === 0) {
                alert('Tidak ada data untuk diexport');
                return;
            }
            
            // Convert to CSV
            let csv = 'Kode Tiket,Tipe,Harga,Status,Tanggal Generate,Catatan\n';
            
            filteredTickets.forEach(ticket => {
                csv += `"${ticket.code}","${ticket.type}",${ticket.price},"${ticket.status === 'available' ? 'Tersedia' : 'Terjual'}","${formatDate(ticket.generatedAt)}","${ticket.note || ''}"\n`;
            });
            
            // Create download link
            const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
            const url = URL.createObjectURL(blob);
            const link = document.createElement('a');
            link.href = url;
            link.download = `stok_tiket_${new Date().toISOString().split('T')[0]}.csv`;
            link.click();
            
            // Clean up
            setTimeout(() => {
                URL.revokeObjectURL(url);
            }, 100);
        }
        
        // Print stock data
        function printStockData() {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();
            
            const filteredTickets = getFilteredStockTickets();
            if (filteredTickets.length === 0) {
                alert('Tidak ada data untuk dicetak');
                return;
            }
            
            const data = getAppData();
            const date = new Date().toISOString().split('T')[0];
            
            // Add header
            doc.setFontSize(16);
            doc.text(`Laporan Stok Tiket - ${data.settings.venueName}`, 105, 15, { align: 'center' });
            doc.setFontSize(12);
            doc.text(`Tanggal: ${formatDate(date)} | Jumlah: ${filteredTickets.length} tiket`, 105, 22, { align: 'center' });
            
            // Prepare table data
            const tableData = filteredTickets.map(ticket => [
                ticket.code,
                ticket.type,
                formatCurrency(ticket.price),
                ticket.status === 'available' ? 'Tersedia' : 'Terjual',
                formatDate(ticket.generatedAt),
                ticket.note || '-'
            ]);
            
            // Add table
            doc.autoTable({
                head: [['Kode Tiket', 'Tipe', 'Harga', 'Status', 'Tanggal Generate', 'Catatan']],
                body: tableData,
                startY: 30,
                margin: { horizontal: 10 },
                styles: { fontSize: 8 },
                columnStyles: {
                    2: { cellWidth: 20 },
                    3: { cellWidth: 15 }
                }
            });
            
            // Save PDF
            doc.save(`stok_tiket_${date}.pdf`);
        }
        
        // Get filtered stock tickets
        function getFilteredStockTickets() {
            const typeFilter = document.getElementById('filterTicketType').value;
            const statusFilter = document.getElementById('filterStockStatus').value;
            const dateFilter = document.getElementById('filterDateRange').value;
            
            const data = getAppData();
            let filteredTickets = [...data.tickets];
            
            // Apply filters
            if (typeFilter) {
                filteredTickets = filteredTickets.filter(t => t.type === typeFilter);
            }
            
            if (statusFilter) {
                filteredTickets = filteredTickets.filter(t => t.status === statusFilter);
            }
            
            if (dateFilter) {
                const now = new Date();
                let startDate;
                
                switch(dateFilter) {
                    case 'today':
                        startDate = new Date(now.setHours(0, 0, 0, 0));
                        break;
                    case 'week':
                        startDate = new Date(now.setDate(now.getDate() - now.getDay()));
                        startDate.setHours(0, 0, 0, 0);
                        break;
                    case 'month':
                        startDate = new Date(now.getFullYear(), now.getMonth(), 1);
                        break;
                }
                
                filteredTickets = filteredTickets.filter(t => new Date(t.generatedAt) >= startDate);
            }
            
            return filteredTickets;
        }
        
        // Initialize transactions section
        function initializeTransactions() {
            // Populate cashiers dropdown
            const data = getAppData();
            const cashiersSelect = document.getElementById('filterTransactionUser');
            cashiersSelect.innerHTML = '<option value="">Semua Kasir</option>';
            
            const cashiers = [...new Set(data.transactions.map(t => t.cashier))];
            cashiers.forEach(cashier => {
                const option = document.createElement('option');
                option.value = cashier;
                option.textContent = cashier;
                cashiersSelect.appendChild(option);
            });
            
            // Filter transactions
            filterTransactions();
        }
        
        // Filter transactions
        function filterTransactions() {
            const dateFrom = document.getElementById('filterTransactionDateFrom').value;
            const dateTo = document.getElementById('filterTransactionDateTo').value;
            const paymentMethod = document.getElementById('filterTransactionPayment').value;
            const cashier = document.getElementById('filterTransactionUser').value;
            
            const data = getAppData();
            let filteredTransactions = [...data.transactions];
            
            // Apply filters
            if (dateFrom) {
                const fromDate = new Date(dateFrom);
                fromDate.setHours(0, 0, 0, 0);
                filteredTransactions = filteredTransactions.filter(t => new Date(t.date) >= fromDate);
            }
            
            if (dateTo) {
                const toDate = new Date(dateTo);
                toDate.setHours(23, 59, 59, 999);
                filteredTransactions = filteredTransactions.filter(t => new Date(t.date) <= toDate);
            }
            
            if (paymentMethod) {
                filteredTransactions = filteredTransactions.filter(t => t.paymentMethod === paymentMethod);
            }
            
            if (cashier) {
                filteredTransactions = filteredTransactions.filter(t => t.cashier === cashier);
            }
            
            // Display filtered transactions
            displayTransactions(filteredTransactions);
        }
        
        // Display transactions
        function displayTransactions(transactions) {
            const table = document.getElementById('transactionsTable').getElementsByTagName('tbody')[0];
            table.innerHTML = '';
            
            document.getElementById('totalTransactionCount').textContent = `Total: ${transactions.length} transaksi`;
            
            transactions.forEach(transaction => {
                const row = table.insertRow();
                row.insertCell(0).textContent = transaction.id;
                row.insertCell(1).textContent = formatDate(transaction.date);
                row.insertCell(2).textContent = transaction.customer || '-';
                row.insertCell(3).textContent = transaction.items.reduce((sum, item) => sum + item.quantity, 0);
                row.insertCell(4).textContent = formatCurrency(transaction.total);
                row.insertCell(5).textContent = transaction.paymentMethod;
                row.insertCell(6).textContent = transaction.cashier;
                
                const actionCell = row.insertCell(7);
                actionCell.innerHTML = `
                    <button class="btn btn-sm btn-info view-transaction-btn" data-id="${transaction.id}">
                        <i class="fas fa-eye"></i>
                    </button>
                    <button class="btn btn-sm btn-primary print-transaction-btn" data-id="${transaction.id}">
                        <i class="fas fa-print"></i>
                    </button>
                `;
            });
            
            // Add event listeners
            document.querySelectorAll('.view-transaction-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    viewTransaction(this.getAttribute('data-id'));
                });
            });
            
            document.querySelectorAll('.print-transaction-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    const transactionId = this.getAttribute('data-id');
                    const data = getAppData();
                    const transaction = data.transactions.find(t => t.id === transactionId);
                    if (transaction) {
                        printReceipt(transaction);
                    }
                });
            });
        }
        
        // Export transactions data
        function exportTransactionsData() {
            const data = getAppData();
            const filteredTransactions = getFilteredTransactions();
            
            if (filteredTransactions.length === 0) {
                alert('Tidak ada data untuk diexport');
                return;
            }
            
            // Convert to CSV
            let csv = 'ID Transaksi,Tanggal,Pelanggan,Jumlah Item,Total,Metode Pembayaran,Kasir\n';
            
            filteredTransactions.forEach(transaction => {
                csv += `"${transaction.id}","${formatDate(transaction.date)}","${transaction.customer || ''}",${transaction.items.reduce((sum, item) => sum + item.quantity, 0)},${transaction.total},"${transaction.paymentMethod}","${transaction.cashier}"\n`;
            });
            
            // Create download link
            const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
            const url = URL.createObjectURL(blob);
            const link = document.createElement('a');
            link.href = url;
            link.download = `transaksi_tiket_${new Date().toISOString().split('T')[0]}.csv`;
            link.click();
            
            // Clean up
            setTimeout(() => {
                URL.revokeObjectURL(url);
            }, 100);
        }
        
        // Print transactions data
        function printTransactionsData() {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();
            
            const filteredTransactions = getFilteredTransactions();
            if (filteredTransactions.length === 0) {
                alert('Tidak ada data untuk dicetak');
                return;
            }
            
            const data = getAppData();
            const date = new Date().toISOString().split('T')[0];
            
            // Add header
            doc.setFontSize(16);
            doc.text(`Laporan Transaksi - ${data.settings.venueName}`, 105, 15, { align: 'center' });
            doc.setFontSize(12);
            doc.text(`Tanggal: ${formatDate(date)} | Jumlah: ${filteredTransactions.length} transaksi`, 105, 22, { align: 'center' });
            
            // Prepare table data
            const tableData = filteredTransactions.map(transaction => [
                transaction.id,
                formatDate(transaction.date),
                transaction.customer || '-',
                transaction.items.reduce((sum, item) => sum + item.quantity, 0),
                formatCurrency(transaction.total),
                transaction.paymentMethod,
                transaction.cashier
            ]);
            
            // Add table
            doc.autoTable({
                head: [['ID Transaksi', 'Tanggal', 'Pelanggan', 'Jumlah Item', 'Total', 'Metode', 'Kasir']],
                body: tableData,
                startY: 30,
                margin: { horizontal: 10 },
                styles: { fontSize: 8 },
                columnStyles: {
                    0: { cellWidth: 25 },
                    3: { cellWidth: 15 },
                    4: { cellWidth: 20 }
                }
            });
            
            // Add summary
            const totalItems = filteredTransactions.reduce((sum, t) => sum + t.items.reduce((s, i) => s + i.quantity, 0), 0);
            const totalRevenue = filteredTransactions.reduce((sum, t) => sum + t.total, 0);
            
            let y = doc.lastAutoTable.finalY + 10;
            doc.setFontSize(10);
            doc.text(`Total Item Terjual: ${totalItems}`, 14, y);
            doc.text(`Total Pendapatan: ${formatCurrency(totalRevenue)}`, 14, y + 5);
            
            // Save PDF
            doc.save(`transaksi_tiket_${date}.pdf`);
        }
        
        // Get filtered transactions
        function getFilteredTransactions() {
            const dateFrom = document.getElementById('filterTransactionDateFrom').value;
            const dateTo = document.getElementById('filterTransactionDateTo').value;
            const paymentMethod = document.getElementById('filterTransactionPayment').value;
            const cashier = document.getElementById('filterTransactionUser').value;
            
            const data = getAppData();
            let filteredTransactions = [...data.transactions];
            
            // Apply filters
            if (dateFrom) {
                const fromDate = new Date(dateFrom);
                fromDate.setHours(0, 0, 0, 0);
                filteredTransactions = filteredTransactions.filter(t => new Date(t.date) >= fromDate);
            }
            
            if (dateTo) {
                const toDate = new Date(dateTo);
                toDate.setHours(23, 59, 59, 999);
                filteredTransactions = filteredTransactions.filter(t => new Date(t.date) <= toDate);
            }
            
            if (paymentMethod) {
                filteredTransactions = filteredTransactions.filter(t => t.paymentMethod === paymentMethod);
            }
            
            if (cashier) {
                filteredTransactions = filteredTransactions.filter(t => t.cashier === cashier);
            }
            
            return filteredTransactions;
        }
        
        // Print transaction receipt
        function printTransactionReceipt() {
            const transactionId = document.getElementById('viewTransactionId').textContent;
            const data = getAppData();
            const transaction = data.transactions.find(t => t.id === transactionId);
            
            if (transaction) {
                printReceipt(transaction);
            }
            
            // Close modal
            const modal = bootstrap.Modal.getInstance(document.getElementById('viewTransactionModal'));
            modal.hide();
        }
        
        // Initialize reports section
        function initializeReports() {
            // Set default date to today
            document.getElementById('reportDate').value = new Date().toISOString().split('T')[0];
            
            // Clear report result
            document.getElementById('reportResultContainer').innerHTML = `
                <div class="alert alert-info">
                    Silahkan pilih parameter laporan dan klik "Generate Laporan" untuk melihat hasil.
                </div>
            `;
        }
        
        // Update report date fields based on report type
        function updateReportDateFields() {
            const reportType = document.getElementById('reportType').value;
            
            // Hide all date fields
            document.getElementById('reportDateContainer').style.display = 'none';
            document.getElementById('reportWeekContainer').style.display = 'none';
            document.getElementById('reportMonthContainer').style.display = 'none';
            document.getElementById('reportCustomFromContainer').style.display = 'none';
            document.getElementById('reportCustomToContainer').style.display = 'none';
            
            // Show relevant fields
            switch(reportType) {
                case 'daily':
                    document.getElementById('reportDateContainer').style.display = 'block';
                    break;
                case 'weekly':
                    document.getElementById('reportWeekContainer').style.display = 'block';
                    break;
                case 'monthly':
                    document.getElementById('reportMonthContainer').style.display = 'block';
                    break;
                case 'custom':
                    document.getElementById('reportCustomFromContainer').style.display = 'block';
                    document.getElementById('reportCustomToContainer').style.display = 'block';
                    break;
            }
        }
        
        // Generate report
        function generateReport() {
            const reportType = document.getElementById('reportType').value;
            let dateFrom, dateTo;
            
            // Set date range based on report type
            switch(reportType) {
                case 'daily':
                    dateFrom = new Date(document.getElementById('reportDate').value);
                    dateFrom.setHours(0, 0, 0, 0);
                    dateTo = new Date(dateFrom);
                    dateTo.setHours(23, 59, 59, 999);
                    break;
                case 'weekly':
                    const weekInput = document.getElementById('reportWeek').value;
                    dateFrom = new Date(weekInput);
                    dateFrom.setHours(0, 0, 0, 0);
                    dateTo = new Date(dateFrom);
                    dateTo.setDate(dateTo.getDate() + 6);
                    dateTo.setHours(23, 59, 59, 999);
                    break;
                case 'monthly':
                    const monthInput = document.getElementById('reportMonth').value;
                    dateFrom = new Date(monthInput);
                    dateFrom.setHours(0, 0, 0, 0);
                    dateTo = new Date(dateFrom.getFullYear(), dateFrom.getMonth() + 1, 0);
                    dateTo.setHours(23, 59, 59, 999);
                    break;
                case 'custom':
                    dateFrom = new Date(document.getElementById('reportCustomFrom').value);
                    dateFrom.setHours(0, 0, 0, 0);
                    dateTo = new Date(document.getElementById('reportCustomTo').value);
                    dateTo.setHours(23, 59, 59, 999);
                    break;
            }
            
            // Validate dates
            if (isNaN(dateFrom.getTime()) || isNaN(dateTo.getTime())) {
                alert('Tanggal tidak valid');
                return;
            }
            
            if (dateFrom > dateTo) {
                alert('Tanggal mulai tidak boleh lebih besar dari tanggal akhir');
                return;
            }
            
            const data = getAppData();
            
            // Filter transactions by date range
            const filteredTransactions = data.transactions.filter(t => {
                const transactionDate = new Date(t.date);
                return transactionDate >= dateFrom && transactionDate <= dateTo;
            });
            
            // Filter tickets by date range
            const filteredTickets = data.tickets.filter(t => {
                const ticketDate = new Date(t.generatedAt);
                return ticketDate >= dateFrom && ticketDate <= dateTo;
            });
            
            // Generate report HTML
            const reportHTML = generateReportHTML(reportType, dateFrom, dateTo, filteredTransactions, filteredTickets);
            
            // Display report
            document.getElementById('reportResultContainer').innerHTML = reportHTML;
        }
        
        // Generate report HTML
        function generateReportHTML(reportType, dateFrom, dateTo, transactions, tickets) {
            const data = getAppData();
            let dateRangeText = '';
            
            switch(reportType) {
                case 'daily':
                    dateRangeText = formatDate(dateFrom);
                    break;
                case 'weekly':
                    dateRangeText = `${formatDate(dateFrom)} s/d ${formatDate(dateTo)}`;
                    break;
                case 'monthly':
                    dateRangeText = new Date(dateFrom).toLocaleDateString('id-ID', { month: 'long', year: 'numeric' });
                    break;
                case 'custom':
                    dateRangeText = `${formatDate(dateFrom)} s/d ${formatDate(dateTo)}`;
                    break;
            }
            
            // Calculate statistics
            const totalTransactions = transactions.length;
            const totalTicketsSold = transactions.reduce((sum, t) => sum + t.items.reduce((s, i) => s + i.quantity, 0), 0);
            const totalRevenue = transactions.reduce((sum, t) => sum + t.total, 0);
            
            const totalTicketsGenerated = tickets.length;
            const totalTicketsAvailable = tickets.filter(t => t.status === 'available').length;
            const totalTicketsSoldFromGenerated = tickets.filter(t => t.status === 'sold').length;
            
            // Group by ticket type
            const ticketTypes = {};
            tickets.forEach(t => {
                if (!ticketTypes[t.type]) {
                    ticketTypes[t.type] = {
                        generated: 0,
                        sold: 0,
                        available: 0,
                        revenue: 0
                    };
                }
                ticketTypes[t.type].generated++;
                
                if (t.status === 'sold') {
                    ticketTypes[t.type].sold++;
                    // Find the transaction to get the actual sale price
                    const transaction = transactions.find(tr => tr.id === t.transactionId);
                    if (transaction) {
                        const item = transaction.items.find(i => i.code === t.code);
                        if (item) {
                            ticketTypes[t.type].revenue += item.price;
                        }
                    }
                } else {
                    ticketTypes[t.type].available++;
                }
            });
            
            // Group by payment method
            const paymentMethods = {};
            transactions.forEach(t => {
                if (!paymentMethods[t.paymentMethod]) {
                    paymentMethods[t.paymentMethod] = {
                        count: 0,
                        amount: 0
                    };
                }
                paymentMethods[t.paymentMethod].count++;
                paymentMethods[t.paymentMethod].amount += t.total;
            });
            
            // Group by cashier
            const cashiers = {};
            transactions.forEach(t => {
                if (!cashiers[t.cashier]) {
                    cashiers[t.cashier] = {
                        count: 0,
                        amount: 0
                    };
                }
                cashiers[t.cashier].count++;
                cashiers[t.cashier].amount += t.total;
            });
            
            return `
                <div class="report-content">
                    <h4 class="mb-4">Laporan ${reportType === 'daily' ? 'Harian' : reportType === 'weekly' ? 'Mingguan' : reportType === 'monthly' ? 'Bulanan' : 'Custom'} - ${data.settings.venueName}</h4>
                    <p class="mb-4"><strong>Periode:</strong> ${dateRangeText}</p>
                    
                    <div class="row mb-4">
                        <div class="col-md-4">
                            <div class="card">
                                <div class="card-body">
                                    <h5 class="card-title">Total Transaksi</h5>
                                    <h2 class="card-text">${totalTransactions}</h2>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="card">
                                <div class="card-body">
                                    <h5 class="card-title">Tiket Terjual</h5>
                                    <h2 class="card-text">${totalTicketsSold}</h2>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="card">
                                <div class="card-body">
                                    <h5 class="card-title">Total Pendapatan</h5>
                                    <h2 class="card-text">${formatCurrency(totalRevenue)}</h2>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="card mb-4">
                        <div class="card-header">
                            <h5 class="mb-0">Ringkasan Tiket</h5>
                        </div>
                        <div class="card-body">
                            <div class="table-responsive">
                                <table class="table table-bordered">
                                    <thead>
                                        <tr>
                                            <th>Tipe Tiket</th>
                                            <th>Digenerate</th>
                                            <th>Terjual</th>
                                            <th>Tersedia</th>
                                            <th>Pendapatan</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        ${Object.entries(ticketTypes).map(([type, stats]) => `
                                            <tr>
                                                <td>${type}</td>
                                                <td>${stats.generated}</td>
                                                <td>${stats.sold}</td>
                                                <td>${stats.available}</td>
                                                <td>${formatCurrency(stats.revenue)}</td>
                                            </tr>
                                        `).join('')}
                                        <tr class="table-secondary fw-bold">
                                            <td>Total</td>
                                            <td>${totalTicketsGenerated}</td>
                                            <td>${totalTicketsSoldFromGenerated}</td>
                                            <td>${totalTicketsAvailable}</td>
                                            <td>${formatCurrency(totalRevenue)}</td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                    
                    <div class="row">
                        <div class="col-md-6">
                            <div class="card mb-4">
                                <div class="card-header">
                                    <h5 class="mb-0">Metode Pembayaran</h5>
                                </div>
                                <div class="card-body">
                                    <div class="table-responsive">
                                        <table class="table table-bordered">
                                            <thead>
                                                <tr>
                                                    <th>Metode</th>
                                                    <th>Jumlah</th>
                                                    <th>Total</th>
                                                </tr>
                                            </thead>
                                            <tbody>
                                                ${Object.entries(paymentMethods).map(([method, stats]) => `
                                                    <tr>
                                                        <td>${method}</td>
                                                        <td>${stats.count}</td>
                                                        <td>${formatCurrency(stats.amount)}</td>
                                                    </tr>
                                                `).join('')}
                                            </tbody>
                                        </table>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="card mb-4">
                                <div class="card-header">
                                    <h5 class="mb-0">Performa Kasir</h5>
                                </div>
                                <div class="card-body">
                                    <div class="table-responsive">
                                        <table class="table table-bordered">
                                            <thead>
                                                <tr>
                                                    <th>Kasir</th>
                                                    <th>Transaksi</th>
                                                    <th>Total</th>
                                                </tr>
                                            </thead>
                                            <tbody>
                                                ${Object.entries(cashiers).map(([cashier, stats]) => `
                                                    <tr>
                                                        <td>${cashier}</td>
                                                        <td>${stats.count}</td>
                                                        <td>${formatCurrency(stats.amount)}</td>
                                                    </tr>
                                                `).join('')}
                                            </tbody>
                                        </table>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="card">
                        <div class="card-header">
                            <h5 class="mb-0">Transaksi Harian</h5>
                        </div>
                        <div class="card-body">
                            <div class="table-responsive">
                                <table class="table table-bordered">
                                    <thead>
                                        <tr>
                                            <th>Tanggal</th>
                                            <th>Transaksi</th>
                                            <th>Tiket Terjual</th>
                                            <th>Pendapatan</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        ${generateDailyTransactionRows(transactions)}
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }
        
        // Generate daily transaction rows for report
        function generateDailyTransactionRows(transactions) {
            // Group transactions by date
            const transactionsByDate = {};
            transactions.forEach(t => {
                const date = t.date.split('T')[0];
                if (!transactionsByDate[date]) {
                    transactionsByDate[date] = {
                        count: 0,
                        tickets: 0,
                        revenue: 0
                    };
                }
                transactionsByDate[date].count++;
                transactionsByDate[date].tickets += t.items.reduce((sum, i) => sum + i.quantity, 0);
                transactionsByDate[date].revenue += t.total;
            });
            
            // Convert to array and sort by date
            const dates = Object.keys(transactionsByDate).sort();
            
            // Generate rows
            return dates.map(date => `
                <tr>
                    <td>${formatDate(date)}</td>
                    <td>${transactionsByDate[date].count}</td>
                    <td>${transactionsByDate[date].tickets}</td>
                    <td>${formatCurrency(transactionsByDate[date].revenue)}</td>
                </tr>
            `).join('');
        }
        
        // Print report
        function printReport() {
            const reportContent = document.querySelector('.report-content');
            if (!reportContent) {
                alert('Tidak ada laporan untuk dicetak');
                return;
            }
            
            const printWindow = window.open('', '_blank');
            printWindow.document.write(`
                <!DOCTYPE html>
                <html>
                <head>
                    <title>Laporan Tiket Wisata</title>
                    <style>
                        body {
                            font-family: Arial, sans-serif;
                            margin: 20px;
                        }
                        h4 {
                            color: #2c3e50;
                            margin-bottom: 20px;
                        }
                        table {
                            width: 100%;
                            border-collapse: collapse;
                            margin-bottom: 20px;
                        }
                        th, td {
                            border: 1px solid #ddd;
                            padding: 8px;
                            text-align: left;
                        }
                        th {
                            background-color: #f2f2f2;
                        }
                        .card {
                            border: 1px solid #ddd;
                            border-radius: 5px;
                            padding: 15px;
                            margin-bottom: 20px;
                        }
                        .card-title {
                            font-size: 16px;
                            color: #3498db;
                            margin-bottom: 10px;
                        }
                        .card-text {
                            font-size: 24px;
                            font-weight: bold;
                        }
                        .table-secondary {
                            background-color: #f8f9fa;
                        }
                        .fw-bold {
                            font-weight: bold;
                        }
                        @media print {
                            .no-print {
                                display: none !important;
                            }
                        }
                    </style>
                </head>
                <body>
                    ${reportContent.innerHTML}
                    <script>
                        setTimeout(() => {
                            window.print();
                            setTimeout(() => window.close(), 500);
                        }, 200);
                    </script>
                </body>
                </html>
            `);
            printWindow.document.close();
        }
        
        // Download report as PDF
        function downloadReportAsPDF() {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();
            
            const reportContent = document.querySelector('.report-content');
            if (!reportContent) {
                alert('Tidak ada laporan untuk didownload');
                return;
            }
            
            const data = getAppData();
            const title = reportContent.querySelector('h4').textContent;
            
            // Add title
            doc.setFontSize(16);
            doc.text(title, 105, 15, { align: 'center' });
            
            // Add period
            doc.setFontSize(12);
            doc.text(reportContent.querySelector('p').textContent, 105, 22, { align: 'center' });
            
            // Add summary cards
            const cards = reportContent.querySelectorAll('.card-body');
            let y = 35;
            
            // First row of cards
            doc.setFontSize(14);
            doc.text(cards[0].querySelector('.card-title').textContent, 30, y);
            doc.setFontSize(18);
            doc.text(cards[0].querySelector('.card-text').textContent, 30, y + 10);
            
            doc.setFontSize(14);
            doc.text(cards[1].querySelector('.card-title').textContent, 105, y);
            doc.setFontSize(18);
            doc.text(cards[1].querySelector('.card-text').textContent, 105, y + 10);
            
            doc.setFontSize(14);
            doc.text(cards[2].querySelector('.card-title').textContent, 180, y);
            doc.setFontSize(18);
            doc.text(cards[2].querySelector('.card-text').textContent, 180, y + 10);
            
            y += 30;
            
            // Ticket summary table
            const ticketTable = cards[3].querySelector('table');
            const ticketTableData = [];
            
            Array.from(ticketTable.querySelectorAll('tbody tr')).forEach(row => {
                const cells = Array.from(row.querySelectorAll('td'));
                ticketTableData.push(cells.map(cell => cell.textContent));
            });
            
            doc.autoTable({
                head: [['Tipe Tiket', 'Digenerate', 'Terjual', 'Tersedia', 'Pendapatan']],
                body: ticketTableData,
                startY: y,
                margin: { horizontal: 10 },
                styles: { fontSize: 8 },
                columnStyles: {
                    0: { cellWidth: 30 },
                    4: { cellWidth: 25 }
                }
            });
            
            y = doc.lastAutoTable.finalY + 10;
            
            // Payment methods and cashiers tables (side by side)
            const paymentTable = cards[4].querySelector('table');
            const paymentTableData = [];
            
            Array.from(paymentTable.querySelectorAll('tbody tr')).forEach(row => {
                const cells = Array.from(row.querySelectorAll('td'));
                paymentTableData.push(cells.map(cell => cell.textContent));
            });
            
            const cashierTable = cards[5].querySelector('table');
            const cashierTableData = [];
            
            Array.from(cashierTable.querySelectorAll('tbody tr')).forEach(row => {
                const cells = Array.from(row.querySelectorAll('td'));
                cashierTableData.push(cells.map(cell => cell.textContent));
            });
            
            // Payment methods table (left)
            doc.autoTable({
                head: [['Metode', 'Jumlah', 'Total']],
                body: paymentTableData,
                startY: y,
                margin: { left: 10, right: 105 },
                styles: { fontSize: 8 },
                columnStyles: {
                    2: { cellWidth: 25 }
                }
            });
            
            // Cashiers table (right)
            doc.autoTable({
                head: [['Kasir', 'Transaksi', 'Total']],
                body: cashierTableData,
                startY: y,
                margin: { left: 105, right: 10 },
                styles: { fontSize: 8 },
                columnStyles: {
                    2: { cellWidth: 25 }
                }
            });
            
            y = doc.lastAutoTable.finalY + 10;
            
            // Daily transactions table
            const dailyTable = cards[6].querySelector('table');
            const dailyTableData = [];
            
            Array.from(dailyTable.querySelectorAll('tbody tr')).forEach(row => {
                const cells = Array.from(row.querySelectorAll('td'));
                dailyTableData.push(cells.map(cell => cell.textContent));
            });
            
            doc.autoTable({
                head: [['Tanggal', 'Transaksi', 'Tiket Terjual', 'Pendapatan']],
                body: dailyTableData,
                startY: y,
                margin: { horizontal: 10 },
                styles: { fontSize: 8 },
                columnStyles: {
                    0: { cellWidth: 25 },
                    3: { cellWidth: 25 }
                }
            });
            
            // Save PDF
            const date = new Date().toISOString().split('T')[0];
            doc.save(`laporan_tiket_${date}.pdf`);
        }
        
        // Initialize users section
        function initializeUsers() {
            displayUsers();
        }
        
        // Display users
        function displayUsers() {
            const data = getAppData();
            const table = document.getElementById('usersTable').getElementsByTagName('tbody')[0];
            table.innerHTML = '';
            
            data.users.forEach(user => {
                const row = table.insertRow();
                row.insertCell(0).textContent = user.username;
                row.insertCell(1).textContent = user.fullName;
                row.insertCell(2).textContent = user.role === 'admin' ? 'Admin' : user.role === 'kasir' ? 'Kasir' : 'Manager';
                
                const lastLoginCell = row.insertCell(3);
                lastLoginCell.textContent = user.lastLogin ? formatDate(user.lastLogin) : 'Belum pernah';
                
                const statusCell = row.insertCell(4);
                if (user.isActive) {
                    statusCell.innerHTML = '<span class="badge bg-success">Aktif</span>';
                } else {
                    statusCell.innerHTML = '<span class="badge bg-secondary">Nonaktif</span>';
                }
                
                const actionCell = row.insertCell(5);
                if (user.username !== 'admin') { // Prevent editing main admin
                    actionCell.innerHTML = `
                        <button class="btn btn-sm btn-primary edit-user-btn" data-username="${user.username}">
                            <i class="fas fa-edit"></i>
                        </button>
                        <button class="btn btn-sm btn-danger delete-user-btn" data-username="${user.username}">
                            <i class="fas fa-trash-alt"></i>
                        </button>
                    `;
                } else {
                    actionCell.innerHTML = '-';
                }
            });
            
            // Add event listeners
            document.querySelectorAll('.edit-user-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    editUser(this.getAttribute('data-username'));
                });
            });
            
            document.querySelectorAll('.delete-user-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    deleteUser(this.getAttribute('data-username'));
                });
            });
        }
        
        // Edit user
        function editUser(username) {
            const data = getAppData();
            const user = data.users.find(u => u.username === username);
            
            if (user) {
                document.getElementById('editUserId').value = user.username;
                document.getElementById('editUsername').value = user.username;
                document.getElementById('editFullName').value = user.fullName;
                document.getElementById('editUserRole').value = user.role;
                document.getElementById('editUserActive').checked = user.isActive;
                
                const modal = new bootstrap.Modal(document.getElementById('editUserModal'));
                modal.show();
            }
        }
        
        // Save user changes
        function saveUserChanges() {
            const username = document.getElementById('editUserId').value;
            const fullName = document.getElementById('editFullName').value;
            const role = document.getElementById('editUserRole').value;
            const password = document.getElementById('editPassword').value;
            const isActive = document.getElementById('editUserActive').checked;
            
            const data = getAppData();
            const user = data.users.find(u => u.username === username);
            
            if (user) {
                user.fullName = fullName;
                user.role = role;
                user.isActive = isActive;
                
                if (password) {
                    user.password = password;
                }
                
                saveAppData(data);
                displayUsers();
                
                const modal = bootstrap.Modal.getInstance(document.getElementById('editUserModal'));
                modal.hide();
            }
        }
        
        // Delete user
        function deleteUser(username) {
            if (confirm(`Hapus pengguna ${username}?`)) {
                const data = getAppData();
                data.users = data.users.filter(u => u.username !== username);
                saveAppData(data);
                displayUsers();
            }
        }
        
        // Add new user
        function addNewUser() {
            const username = document.getElementById('newUsername').value;
            const fullName = document.getElementById('newFullName').value;
            const role = document.getElementById('newUserRole').value;
            const password = document.getElementById('newPassword').value;
            const confirmPassword = document.getElementById('confirmPassword').value;
            const isActive = document.getElementById('newUserActive').checked;
            
            if (password !== confirmPassword) {
                alert('Password dan konfirmasi password tidak cocok');
                return;
            }
            
            const data = getAppData();
            
            // Check if username already exists
            if (data.users.some(u => u.username === username)) {
                alert('Username sudah digunakan');
                return;
            }
            
            // Add new user
            data.users.push({
                username: username,
                password: password,
                fullName: fullName,
                role: role,
                isActive: isActive,
                lastLogin: null,
                createdAt: new Date().toISOString()
            });
            
            saveAppData(data);
            displayUsers();
            
            // Reset form and close modal
            document.getElementById('addUserForm').reset();
            const modal = bootstrap.Modal.getInstance(document.getElementById('addUserModal'));
            modal.hide();
        }
        
        // Initialize settings section
        function initializeSettings() {
            const data = getAppData();
            const settings = data.settings;
            
            // Venue info
            document.getElementById('venueName').value = settings.venueName;
            document.getElementById('venueAddress').value = settings.venueAddress;
            document.getElementById('venuePhone').value = settings.venuePhone;
            document.getElementById('venueEmail').value = settings.venueEmail;
            
            // Ticket settings
            document.getElementById('defaultTicketPrefix').value = settings.defaultTicketPrefix;
            document.getElementById('defaultTicketPrice').value = settings.defaultTicketPrice;
            document.getElementById('ticketValidityDays').value = settings.ticketValidityDays;
            
            // Receipt settings
            document.getElementById('receiptHeaderText').value = settings.receiptHeaderText;
            document.getElementById('receiptFooterText').value = settings.receiptFooterText;
            document.getElementById('showCustomerNameOnReceipt').checked = settings.showCustomerNameOnReceipt;
            document.getElementById('showDateOnReceipt').checked = settings.showDateOnReceipt;
        }
        
        // Save venue info
        function saveVenueInfo() {
            const data = getAppData();
            
            data.settings.venueName = document.getElementById('venueName').value;
            data.settings.venueAddress = document.getElementById('venueAddress').value;
            data.settings.venuePhone = document.getElementById('venuePhone').value;
            data.settings.venueEmail = document.getElementById('venueEmail').value;
            
            saveAppData(data);
            alert('Informasi tempat wisata berhasil disimpan');
        }
        
        // Save ticket settings
        function saveTicketSettings() {
            const data = getAppData();
            
            data.settings.defaultTicketPrefix = document.getElementById('defaultTicketPrefix').value;
            data.settings.defaultTicketPrice = parseInt(document.getElementById('defaultTicketPrice').value);
            data.settings.ticketValidityDays = parseInt(document.getElementById('ticketValidityDays').value);
            
            saveAppData(data);
            alert('Pengaturan tiket berhasil disimpan');
        }
        
        // Save receipt settings
        function saveReceiptSettings() {
            const data = getAppData();
            
            data.settings.receiptHeaderText = document.getElementById('receiptHeaderText').value;
            data.settings.receiptFooterText = document.getElementById('receiptFooterText').value;
            data.settings.showCustomerNameOnReceipt = document.getElementById('showCustomerNameOnReceipt').checked;
            data.settings.showDateOnReceipt = document.getElementById('showDateOnReceipt').checked;
            
            saveAppData(data);
            alert('Pengaturan struk berhasil disimpan');
        }
        
        // Backup data
        function backupData() {
            const data = getAppData();
            const backup = {
                ...data,
                currentUser: null // Don't include current user in backup
            };
            
            // Create download link
            const blob = new Blob([JSON.stringify(backup, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const link = document.createElement('a');
            link.href = url;
            link.download = `backup_tiket_wisata_${new Date().toISOString().split('T')[0]}.json`;
            link.click();
            
            // Clean up
            setTimeout(() => {
                URL.revokeObjectURL(url);
            }, 100);
        }
        
        // Restore data
        function restoreData() {
            const fileInput = document.getElementById('restoreFileInput');
            const file = fileInput.files[0];
            
            if (!file) {
                alert('Pilih file backup terlebih dahulu');
                return;
            }
            
            if (!confirm('Restore data dari backup akan mengganti semua data saat ini. Lanjutkan?')) {
                return;
            }
            
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const backupData = JSON.parse(e.target.result);
                    
                    // Validate backup data
                    if (!backupData.users || !backupData.tickets || !backupData.transactions || !backupData.settings) {
                        throw new Error('Format backup tidak valid');
                    }
                    
                    // Preserve current user if logged in
                    const currentData = getAppData();
                    if (currentData.currentUser) {
                        backupData.currentUser = currentData.currentUser;
                    }
                    
                    // Save restored data
                    saveAppData(backupData);
                    
                    // Reload the page to refresh all data
                    window.location.reload();
                } catch (error) {
                    alert('Gagal memproses file backup: ' + error.message);
                }
            };
            reader.readAsText(file);
        }
        
        // Reset system data
        function resetSystemData() {
            const password = document.getElementById('adminPassword').value;
            
            if (password !== 'Admin.13579') {
                alert('Password admin salah');
                return;
            }
            
            if (confirm('Reset semua data akan menghapus semua tiket, transaksi, dan pengguna (kecuali admin utama). Lanjutkan?')) {
                // Initialize fresh data but keep main admin
                const data = getAppData();
                const adminUser = data.users.find(u => u.username === 'admin');
                
                initializeApplication();
                
                // Restore admin user
                const newData = getAppData();
                newData.users[0] = adminUser;
                saveAppData(newData);
                
                // Close modal and reload
                const modal = bootstrap.Modal.getInstance(document.getElementById('resetDataModal'));
                modal.hide();
                
                window.location.reload();
            }
        }
        
        // Format currency
        function formatCurrency(amount) {
            return 'Rp ' + amount.toString().replace(/\B(?=(\d{3})+(?!\d))/g, '.');
        }
        
        // Parse currency
        function parseCurrency(currencyString) {
            return parseInt(currencyString.replace(/[^\d]/g, ''));
        }
        
        // Format date
        function formatDate(dateString, withTime = false) {
            const date = new Date(dateString);
            const options = { 
                day: '2-digit', 
                month: 'long', 
                year: 'numeric',
                hour: withTime ? '2-digit' : undefined,
                minute: withTime ? '2-digit' : undefined,
                hour12: false
            };
            return date.toLocaleDateString('id-ID', options);
        }
    </script>
</body>
</html>
