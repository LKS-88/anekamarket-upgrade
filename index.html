<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TourTicket Pro - Sistem Penjualan Tiket Wisata</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.25/jspdf.plugin.autotable.min.js"></script>
    <style>
        :root {
            --primary-color: #1a237e;
            --secondary-color: #303f9f;
            --accent-color: #ff5722;
            --light-color: #f5f5f5;
            --dark-color: #212121;
            --success-color: #388e3c;
            --warning-color: #ffa000;
            --danger-color: #d32f2f;
            --info-color: #1976d2;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: #f5f5f5;
            color: var(--dark-color);
        }
        
        .navbar-brand {
            font-weight: 700;
            color: white !important;
        }
        
        .navbar {
            background: linear-gradient(135deg, var(--primary-color) 0%, var(--secondary-color) 100%) !important;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        
        .sidebar {
            background: linear-gradient(135deg, var(--primary-color) 0%, var(--secondary-color) 100%);
            color: white;
            min-height: calc(100vh - 56px);
            padding: 0;
        }
        
        .sidebar .nav-link {
            color: rgba(255, 255, 255, 0.9);
            padding: 12px 20px;
            border-left: 4px solid transparent;
            transition: all 0.3s;
        }
        
        .sidebar .nav-link:hover {
            color: white;
            background-color: rgba(255, 255, 255, 0.1);
            border-left: 4px solid var(--accent-color);
        }
        
        .sidebar .nav-link.active {
            color: white;
            background-color: rgba(255, 255, 255, 0.15);
            border-left: 4px solid var(--accent-color);
        }
        
        .sidebar .nav-link i {
            margin-right: 10px;
        }
        
        .card {
            border: none;
            border-radius: 10px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.05);
            transition: transform 0.3s, box-shadow 0.3s;
            margin-bottom: 20px;
            background-color: white;
        }
        
        .card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 20px rgba(0, 0, 0, 0.1);
        }
        
        .card-header {
            background: linear-gradient(135deg, var(--primary-color) 0%, var(--secondary-color) 100%);
            color: white;
            border-radius: 10px 10px 0 0 !important;
            padding: 15px 20px;
        }
        
        .btn-primary {
            background-color: var(--primary-color);
            border-color: var(--primary-color);
        }
        
        .btn-primary:hover {
            background-color: var(--secondary-color);
            border-color: var(--secondary-color);
        }
        
        .btn-success {
            background-color: var(--success-color);
            border-color: var(--success-color);
        }
        
        .btn-warning {
            background-color: var(--warning-color);
            border-color: var(--warning-color);
        }
        
        .btn-danger {
            background-color: var(--danger-color);
            border-color: var(--danger-color);
        }
        
        .btn-info {
            background-color: var(--info-color);
            border-color: var(--info-color);
        }
        
        .ticket-card {
            background: linear-gradient(135deg, #ffffff 0%, #f8f9fa 100%);
            border: 1px solid #dee2e6;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 20px;
            position: relative;
            overflow: hidden;
        }
        
        .ticket-card::before {
            content: "";
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 5px;
            background: linear-gradient(90deg, var(--primary-color), var(--secondary-color));
        }
        
        .ticket-code {
            font-family: 'Courier New', monospace;
            font-size: 1.5rem;
            font-weight: bold;
            color: var(--primary-color);
            letter-spacing: 2px;
        }
        
        .ticket-watermark {
            position: absolute;
            opacity: 0.1;
            font-size: 8rem;
            font-weight: bold;
            color: var(--primary-color);
            transform: rotate(-30deg);
            top: 30%;
            left: 10%;
            z-index: 0;
        }
        
        @media print {
            .no-print {
                display: none !important;
            }
            
            body {
                background-color: white !important;
            }
            
            .ticket-card {
                page-break-inside: avoid;
                margin: 10px 0;
                width: 48%;
                display: inline-block;
                box-sizing: border-box;
            }
            
            @page {
                size: F4;
                margin: 10mm;
            }
        }
        
        @media (max-width: 768px) {
            .sidebar {
                min-height: auto;
            }
            
            .ticket-watermark {
                font-size: 5rem;
            }
        }
        
        /* Role-based access styling */
        .restricted {
            opacity: 0.6;
            pointer-events: none;
            position: relative;
        }
        
        .restricted::after {
            content: "â›”";
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 2rem;
            color: var(--danger-color);
            z-index: 100;
        }
        
        .access-info {
            position: absolute;
            top: 0;
            right: 0;
            background-color: var(--danger-color);
            color: white;
            padding: 2px 8px;
            font-size: 0.7rem;
            border-radius: 0 10px 0 5px;
        }
        
        /* New styles for simplified transaction report */
        .receipt-logo {
            max-width: 150px;
            height: auto;
            margin: 0 auto;
            display: block;
        }
        
        .receipt-header {
            text-align: center;
            margin-bottom: 15px;
        }
        
        .receipt-title {
            font-weight: bold;
            font-size: 1.2rem;
            margin-bottom: 5px;
            color: var(--primary-color);
        }
        
        .receipt-subtitle {
            font-size: 0.9rem;
            color: #666;
        }
        
        .receipt-transaction-id {
            font-weight: bold;
            font-size: 1.1rem;
            margin-bottom: 10px;
            text-align: center;
            color: var(--secondary-color);
        }
        
        .receipt-items {
            width: 100%;
            border-collapse: collapse;
            margin-bottom: 15px;
        }
        
        .receipt-items th {
            text-align: left;
            border-bottom: 1px solid #ddd;
            padding: 5px;
            background-color: #f5f5f5;
        }
        
        .receipt-items td {
            padding: 5px;
            border-bottom: 1px solid #eee;
        }
        
        .receipt-items .text-right {
            text-align: right;
        }
        
        .receipt-totals {
            width: 100%;
            border-collapse: collapse;
            margin-bottom: 15px;
        }
        
        .receipt-totals td {
            padding: 5px;
        }
        
        .receipt-totals .total-row {
            font-weight: bold;
            border-top: 1px solid #ddd;
            background-color: #f5f5f5;
        }
        
        .receipt-footer {
            text-align: center;
            margin-top: 20px;
            font-size: 0.8rem;
            color: #666;
            border-top: 1px solid #eee;
            padding-top: 10px;
        }
        
        /* New styles for ticket search */
        .search-container {
            position: relative;
            margin-bottom: 15px;
        }
        
        .search-results {
            position: absolute;
            top: 100%;
            left: 0;
            width: 100%;
            max-height: 300px;
            overflow-y: auto;
            background: white;
            border: 1px solid #ddd;
            border-radius: 0 0 5px 5px;
            z-index: 1000;
            display: none;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }
        
        .search-result-item {
            padding: 8px 15px;
            border-bottom: 1px solid #eee;
            cursor: pointer;
            transition: background-color 0.2s;
        }
        
        .search-result-item:hover {
            background-color: #f5f5f5;
        }
        
        .search-result-item .badge {
            margin-left: 5px;
        }
        
        /* New styles for batch selection */
        .batch-actions {
            margin-bottom: 15px;
        }
        
        .select-all-checkbox {
            margin-right: 10px;
        }
        
        .ticket-checkbox {
            margin-right: 5px;
        }
        
        /* Footer styling */
        .app-footer {
            background: linear-gradient(135deg, var(--primary-color) 0%, var(--secondary-color) 100%);
            color: white;
            padding: 15px 0;
            text-align: center;
            font-size: 0.9rem;
            margin-top: 20px;
        }
        
        .app-footer a {
            color: white;
            text-decoration: none;
        }
        
        .app-footer a:hover {
            text-decoration: underline;
        }
        
        .badge.bg-primary {
            background-color: var(--primary-color) !important;
        }
        
        .border-bottom {
            border-bottom: 1px solid rgba(0,0,0,0.1) !important;
        }
        
        .table-striped tbody tr:nth-of-type(odd) {
            background-color: #f9f9f9;
        }
        
        .toast-header {
            background: linear-gradient(135deg, var(--primary-color) 0%, var(--secondary-color) 100%);
            color: white;
        }
        
        /* Custom scrollbar */
        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }
        
        ::-webkit-scrollbar-track {
            background: #f1f1f1;
        }
        
        ::-webkit-scrollbar-thumb {
            background: var(--secondary-color);
            border-radius: 10px;
        }
        
        ::-webkit-scrollbar-thumb:hover {
            background: var(--primary-color);
        }
        
        /* Loading spinner */
        .spinner-container {
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100px;
        }
        
        .spinner {
            width: 3rem;
            height: 3rem;
            border: 0.25em solid var(--primary-color);
            border-right-color: transparent;
            border-radius: 50%;
            animation: spinner 0.75s linear infinite;
        }
        
        @keyframes spinner {
            to { transform: rotate(360deg); }
        }

        /* Virtual scroll container */
        .virtual-scroll-container {
            position: relative;
            overflow-y: auto;
            height: 400px;
        }

        .virtual-scroll-content {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
        }

        /* Loading indicator */
        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 9999;
            display: none;
        }

        .loading-content {
            background-color: white;
            padding: 20px;
            border-radius: 5px;
            text-align: center;
        }
    </style>
</head>
<body>
    <!-- Loading overlay -->
    <div class="loading-overlay" id="loadingOverlay">
        <div class="loading-content">
            <div class="spinner"></div>
            <p class="mt-3">Memproses data...</p>
        </div>
    </div>

    <!-- Navbar -->
    <nav class="navbar navbar-expand-lg navbar-dark mb-4">
        <div class="container-fluid">
            <a class="navbar-brand" href="#">
                <i class="fas fa-ticket-alt me-2"></i>TourTicket Pro
            </a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav ms-auto">
                    <li class="nav-item dropdown">
                        <a class="nav-link dropdown-toggle" href="#" id="userDropdown" role="button" data-bs-toggle="dropdown">
                            <i class="fas fa-user-circle me-1"></i>
                            <span id="currentUsername">Admin</span>
                        </a>
                        <ul class="dropdown-menu dropdown-menu-end">
                            <li><a class="dropdown-item" href="#" data-bs-toggle="modal" data-bs-target="#changePasswordModal"><i class="fas fa-key me-2"></i>Ganti Password</a></li>
                            <li><hr class="dropdown-divider"></li>
                            <li><a class="dropdown-item" href="#" id="logoutBtn"><i class="fas fa-sign-out-alt me-2"></i>Logout</a></li>
                        </ul>
                    </li>
                </ul>
            </div>
        </div>
    </nav>

    <div class="container-fluid">
        <div class="row">
            <!-- Sidebar -->
            <div class="col-lg-2 col-md-3 d-md-block sidebar collapse no-print" id="sidebarMenu">
                <div class="position-sticky pt-3">
                    <ul class="nav flex-column">
                        <li class="nav-item">
                            <a class="nav-link active" href="#" id="dashboardLink">
                                <i class="fas fa-tachometer-alt"></i> Dashboard
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="#" id="generateTicketLink">
                                <i class="fas fa-ticket-alt"></i> Generate Tiket
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="#" id="stockTicketLink">
                                <i class="fas fa-boxes"></i> Stok Tiket
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="#" id="salesLink">
                                <i class="fas fa-cash-register"></i> Penjualan
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="#" id="transactionsLink">
                                <i class="fas fa-history"></i> Transaksi
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="#" id="reportsLink">
                                <i class="fas fa-chart-bar"></i> Laporan
                            </a>
                        </li>
                        <li class="nav-item restricted-link" id="usersLinkContainer">
                            <a class="nav-link" href="#" id="usersLink">
                                <i class="fas fa-users-cog"></i> Pengguna
                            </a>
                        </li>
                        <li class="nav-item restricted-link" id="settingsLinkContainer">
                            <a class="nav-link" href="#" id="settingsLink">
                                <i class="fas fa-cog"></i> Pengaturan
                            </a>
                        </li>
                        <li class="nav-item restricted-link" id="backupLinkContainer">
                            <a class="nav-link" href="#" id="backupLink">
                                <i class="fas fa-database"></i> Backup & Restore
                            </a>
                        </li>
                    </ul>
                </div>
            </div>

            <!-- Main Content -->
            <main class="col-lg-10 col-md-9 ms-sm-auto px-md-4">
                <!-- Dashboard Section -->
                <div class="section" id="dashboardSection">
                    <div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
                        <h1 class="h2">Dashboard</h1>
                        <button class="btn btn-sm btn-outline-primary" id="refreshDashboardBtn">
                            <i class="fas fa-sync-alt me-1"></i>Refresh
                        </button>
                    </div>
                    
                    <div class="row">
                        <div class="col-md-4">
                            <div class="card">
                                <div class="card-header">
                                    <h5 class="card-title mb-0"><i class="fas fa-box-open me-2"></i>Stok Tiket</h5>
                                </div>
                                <div class="card-body">
                                    <h3 class="card-text text-center" id="stockCount">0</h3>
                                    <p class="text-muted text-center">Tiket Tersedia</p>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="card">
                                <div class="card-header">
                                    <h5 class="card-title mb-0"><i class="fas fa-money-bill-wave me-2"></i>Penjualan Hari Ini</h5>
                                </div>
                                <div class="card-body">
                                    <h3 class="card-text text-center" id="todaySalesCount">0</h3>
                                    <p class="text-muted text-center">Tiket Terjual</p>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="card">
                                <div class="card-header">
                                    <h5 class="card-title mb-0"><i class="fas fa-wallet me-2"></i>Pendapatan Hari Ini</h5>
                                </div>
                                <div class="card-body">
                                    <h3 class="card-text text-center" id="todayRevenue">Rp 0</h3>
                                    <p class="text-muted text-center">Total Pendapatan</p>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="row mt-4">
                        <div class="col-md-6">
                            <div class="card">
                                <div class="card-header">
                                    <h5 class="card-title mb-0"><i class="fas fa-chart-line me-2"></i>Penjualan 7 Hari Terakhir</h5>
                                </div>
                                <div class="card-body">
                                    <canvas id="salesChart" height="250"></canvas>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="card">
                                <div class="card-header">
                                    <h5 class="card-title mb-0"><i class="fas fa-bell me-2"></i>Aktivitas Terakhir</h5>
                                </div>
                                <div class="card-body">
                                    <div class="list-group" id="recentActivities">
                                        <div class="list-group-item">
                                            <div class="d-flex w-100 justify-content-between">
                                                <small class="text-muted">Tidak ada aktivitas terakhir</small>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Generate Ticket Section -->
                <div class="section d-none" id="generateTicketSection">
                    <div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
                        <h1 class="h2">Generate Tiket</h1>
                    </div>
                    
                    <div class="card mb-4">
                        <div class="card-header">
                            <h5 class="card-title mb-0"><i class="fas fa-cogs me-2"></i>Pengaturan Tiket</h5>
                        </div>
                        <div class="card-body">
                            <form id="generateTicketForm">
                                <div class="row mb-3">
                                    <div class="col-md-6">
                                        <label for="ticketType" class="form-label">Jenis Tiket</label>
                                        <select class="form-select" id="ticketType" required>
                                            <option value="regular">Regular</option>
                                            <option value="vip">VIP</option>
                                            <option value="family">Family Package</option>
                                            <option value="group">Group</option>
                                        </select>
                                    </div>
                                    <div class="col-md-6">
                                        <label for="ticketPrice" class="form-label">Harga Tiket (Rp)</label>
                                        <input type="number" class="form-control" id="ticketPrice" min="1000" value="50000" required>
                                    </div>
                                </div>
                                <div class="row mb-3">
                                    <div class="col-md-6">
                                        <label for="ticketQuantity" class="form-label">Jumlah Tiket</label>
                                        <input type="number" class="form-control" id="ticketQuantity" min="1" max="1000" value="10" required>
                                    </div>
                                    <div class="col-md-6">
                                        <label for="ticketPrefix" class="form-label">Prefix Kode Tiket (Opsional)</label>
                                        <input type="text" class="form-control" id="ticketPrefix" maxlength="2" placeholder="TT">
                                    </div>
                                </div>
                                <div class="mb-3">
                                    <label for="ticketExpiry" class="form-label">Tanggal Kedaluwarsa</label>
                                    <input type="date" class="form-control" id="ticketExpiry">
                                    <div class="form-text">Biarkan kosong jika tidak ada kedaluwarsa</div>
                                </div>
                                <button type="submit" class="btn btn-primary">
                                    <i class="fas fa-ticket-alt me-2"></i>Generate Tiket
                                </button>
                            </form>
                        </div>
                    </div>
                    
                    <div class="card" id="generatedTicketsCard" style="display: none;">
                        <div class="card-header d-flex justify-content-between align-items-center">
                            <h5 class="card-title mb-0"><i class="fas fa-tickets me-2"></i>Tiket yang Digenerate</h5>
                            <button class="btn btn-sm btn-success" id="printAllTicketsBtn">
                                <i class="fas fa-print me-1"></i>Cetak Semua
                            </button>
                        </div>
                        <div class="card-body" id="generatedTicketsContainer">
                            <!-- Generated tickets will appear here -->
                        </div>
                    </div>
                </div>
                
                <!-- Stock Ticket Section -->
                <div class="section d-none" id="stockTicketSection">
                    <div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
                        <h1 class="h2">Stok Tiket</h1>
                        <div class="btn-toolbar mb-2 mb-md-0">
                            <div class="btn-group me-2">
                                <button type="button" class="btn btn-sm btn-outline-secondary" id="exportStockBtn">
                                    <i class="fas fa-file-export me-1"></i>Export
                                </button>
                                <button type="button" class="btn btn-sm btn-outline-danger restricted-action" id="clearStockBtn">
                                    <i class="fas fa-trash me-1"></i>Hapus Stok
                                </button>
                            </div>
                        </div>
                    </div>
                    
                    <div class="card mb-4">
                        <div class="card-header">
                            <h5 class="card-title mb-0"><i class="fas fa-filter me-2"></i>Filter</h5>
                        </div>
                        <div class="card-body">
                            <div class="row">
                                <div class="col-md-4">
                                    <label for="filterStatus" class="form-label">Status</label>
                                    <select class="form-select" id="filterStatus">
                                        <option value="all">Semua</option>
                                        <option value="available">Tersedia</option>
                                        <option value="sold">Terjual</option>
                                        <option value="expired">Kedaluwarsa</option>
                                    </select>
                                </div>
                                <div class="col-md-4">
                                    <label for="filterType" class="form-label">Jenis Tiket</label>
                                    <select class="form-select" id="filterType">
                                        <option value="all">Semua</option>
                                        <option value="regular">Regular</option>
                                        <option value="vip">VIP</option>
                                        <option value="family">Family Package</option>
                                        <option value="group">Group</option>
                                    </select>
                                </div>
                                <div class="col-md-4">
                                    <label for="filterDate" class="form-label">Tanggal Generate</label>
                                    <input type="date" class="form-control" id="filterDate">
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="batch-actions mb-3">
                        <button class="btn btn-sm btn-primary" id="addSelectedToCartBtn">
                            <i class="fas fa-cart-plus me-1"></i>Tambahkan ke Keranjang
                        </button>
                        <div class="form-check form-check-inline ms-3">
                            <input class="form-check-input select-all-checkbox" type="checkbox" id="selectAllTickets">
                            <label class="form-check-label" for="selectAllTickets">Pilih Semua</label>
                        </div>
                    </div>
                    
                    <div class="card">
                        <div class="card-header d-flex justify-content-between align-items-center">
                            <h5 class="card-title mb-0"><i class="fas fa-boxes me-2"></i>Daftar Tiket</h5>
                            <div class="d-flex">
                                <input type="text" class="form-control form-control-sm me-2" id="searchTicketInput" placeholder="Cari kode tiket..." style="width: 200px;">
                                <button class="btn btn-sm btn-outline-primary" id="refreshStockBtn">
                                    <i class="fas fa-sync-alt"></i>
                                </button>
                            </div>
                        </div>
                        <div class="card-body">
                            <div class="table-responsive">
                                <table class="table table-striped table-hover" id="stockTable">
                                    <thead>
                                        <tr>
                                            <th></th>
                                            <th>Kode Tiket</th>
                                            <th>Jenis</th>
                                            <th>Harga</th>
                                            <th>Status</th>
                                            <th>Generate Pada</th>
                                            <th>Kedaluwarsa</th>
                                            <th>Aksi</th>
                                        </tr>
                                    </thead>
                                    <tbody id="stockTableBody">
                                        <!-- Ticket stock data will appear here -->
                                    </tbody>
                                </table>
                            </div>
                            <nav aria-label="Page navigation">
                                <ul class="pagination justify-content-center" id="stockPagination">
                                    <!-- Pagination will appear here -->
                                </ul>
                            </nav>
                        </div>
                    </div>
                </div>
                
                <!-- Sales Section -->
                <div class="section d-none" id="salesSection">
                    <div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
                        <h1 class="h2">Penjualan Tiket</h1>
                    </div>
                    
                    <div class="row">
                        <div class="col-md-8">
                            <div class="card mb-4">
                                <div class="card-header">
                                    <h5 class="card-title mb-0"><i class="fas fa-shopping-cart me-2"></i>Kasir</h5>
                                </div>
                                <div class="card-body">
                                    <div class="search-container">
                                        <label for="ticketSearchInput" class="form-label">Cari Tiket</label>
                                        <div class="input-group">
                                            <input type="text" class="form-control" id="ticketSearchInput" placeholder="Masukkan kode tiket">
                                            <button class="btn btn-outline-secondary" type="button" id="searchTicketBtn">
                                                <i class="fas fa-search"></i>
                                            </button>
                                        </div>
                                        <div class="search-results" id="ticketSearchResults"></div>
                                    </div>
                                    
                                    <div class="table-responsive mt-4">
                                        <table class="table table-striped" id="cartTable">
                                            <thead>
                                                <tr>
                                                    <th>Kode Tiket</th>
                                                    <th>Jenis</th>
                                                    <th>Harga</th>
                                                    <th>Aksi</th>
                                                </tr>
                                            </thead>
                                            <tbody id="cartTableBody">
                                                <!-- Cart items will appear here -->
                                            </tbody>
                                            <tfoot>
                                                <tr>
                                                    <td colspan="2" class="text-end fw-bold">Total:</td>
                                                    <td class="fw-bold" id="cartTotal">Rp 0</td>
                                                    <td></td>
                                                </tr>
                                            </tfoot>
                                        </table>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="card mb-4">
                                <div class="card-header">
                                    <h5 class="card-title mb-0"><i class="fas fa-money-bill-wave me-2"></i>Pembayaran</h5>
                                </div>
                                <div class="card-body">
                                    <form id="paymentForm">
                                        <div class="mb-3">
                                            <label for="paymentMethod" class="form-label">Metode Pembayaran</label>
                                            <select class="form-select" id="paymentMethod" required>
                                                <option value="cash">Tunai</option>
                                                <option value="debit">Kartu Debit</option>
                                                <option value="credit">Kartu Kredit</option>
                                                <option value="transfer">Transfer Bank</option>
                                                <option value="ewallet">E-Wallet</option>
                                            </select>
                                        </div>
                                        <div class="mb-3">
                                            <label for="customerName" class="form-label">Nama Pelanggan (Opsional)</label>
                                            <input type="text" class="form-control" id="customerName" placeholder="Nama pelanggan">
                                        </div>
                                        <div class="mb-3">
                                            <label for="totalAmount" class="form-label">Total Pembayaran</label>
                                            <input type="text" class="form-control" id="totalAmount" readonly>
                                        </div>
                                        <div class="mb-3">
                                            <label for="amountPaid" class="form-label">Jumlah Dibayar</label>
                                            <input type="number" class="form-control" id="amountPaid" min="0" required>
                                        </div>
                                        <div class="mb-3">
                                            <label for="changeAmount" class="form-label">Kembalian</label>
                                            <input type="text" class="form-control" id="changeAmount" readonly>
                                        </div>
                                        <div class="d-grid gap-2">
                                            <button type="submit" class="btn btn-success" id="completePaymentBtn">
                                                <i class="fas fa-check-circle me-2"></i>Selesaikan Pembayaran
                                            </button>
                                            <button type="button" class="btn btn-danger" id="cancelTransactionBtn">
                                                <i class="fas fa-times-circle me-2"></i>Batalkan Transaksi
                                            </button>
                                        </div>
                                    </form>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Transactions Section -->
                <div class="section d-none" id="transactionsSection">
                    <div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
                        <h1 class="h2">Riwayat Transaksi</h1>
                        <div class="btn-toolbar mb-2 mb-md-0">
                            <div class="btn-group me-2">
                                <button type="button" class="btn btn-sm btn-outline-secondary" id="exportTransactionsBtn">
                                    <i class="fas fa-file-export me-1"></i>Export
                                </button>
                                <button type="button" class="btn btn-sm btn-outline-danger restricted-action" id="clearTransactionsBtn">
                                    <i class="fas fa-trash me-1"></i>Hapus Riwayat
                                </button>
                            </div>
                        </div>
                    </div>
                    
                    <div class="card mb-4">
                        <div class="card-header">
                            <h5 class="card-title mb-0"><i class="fas fa-filter me-2"></i>Filter</h5>
                        </div>
                        <div class="card-body">
                            <div class="row">
                                <div class="col-md-3">
                                    <label for="transactionFilterDateFrom" class="form-label">Dari Tanggal</label>
                                    <input type="date" class="form-control" id="transactionFilterDateFrom">
                                </div>
                                <div class="col-md-3">
                                    <label for="transactionFilterDateTo" class="form-label">Sampai Tanggal</label>
                                    <input type="date" class="form-control" id="transactionFilterDateTo">
                                </div>
                                <div class="col-md-3">
                                    <label for="transactionFilterMethod" class="form-label">Metode Pembayaran</label>
                                    <select class="form-select" id="transactionFilterMethod">
                                        <option value="all">Semua</option>
                                        <option value="cash">Tunai</option>
                                        <option value="debit">Kartu Debit</option>
                                        <option value="credit">Kartu Kredit</option>
                                        <option value="transfer">Transfer Bank</option>
                                        <option value="ewallet">E-Wallet</option>
                                    </select>
                                </div>
                                <div class="col-md-3">
                                    <label for="transactionFilterUser" class="form-label">Kasir</label>
                                    <select class="form-select" id="transactionFilterUser">
                                        <option value="all">Semua</option>
                                        <!-- User options will be populated here -->
                                    </select>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="card">
                        <div class="card-header d-flex justify-content-between align-items-center">
                            <h5 class="card-title mb-0"><i class="fas fa-list me-2"></i>Daftar Transaksi</h5>
                            <div class="d-flex">
                                <input type="text" class="form-control form-control-sm me-2" id="searchTransactionInput" placeholder="Cari transaksi..." style="width: 200px;">
                                <button class="btn btn-sm btn-outline-primary" id="refreshTransactionsBtn">
                                    <i class="fas fa-sync-alt"></i>
                                </button>
                            </div>
                        </div>
                        <div class="card-body">
                            <div class="table-responsive">
                                <table class="table table-striped table-hover" id="transactionsTable">
                                    <thead>
                                        <tr>
                                            <th>ID Transaksi</th>
                                            <th>Tanggal</th>
                                            <th>Kasir</th>
                                            <th>Jumlah Tiket</th>
                                            <th>Total</th>
                                            <th>Metode</th>
                                            <th>Aksi</th>
                                        </tr>
                                    </thead>
                                    <tbody id="transactionsTableBody">
                                        <!-- Transactions data will appear here -->
                                    </tbody>
                                </table>
                            </div>
                            <nav aria-label="Page navigation">
                                <ul class="pagination justify-content-center" id="transactionsPagination">
                                    <!-- Pagination will appear here -->
                                </ul>
                            </nav>
                        </div>
                    </div>
                </div>
                
                <!-- Reports Section -->
                <div class="section d-none" id="reportsSection">
                    <div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
                        <h1 class="h2">Laporan</h1>
                        <div class="btn-toolbar mb-2 mb-md-0">
                            <div class="btn-group me-2">
                                <button type="button" class="btn btn-sm btn-outline-primary" id="printReportBtn">
                                    <i class="fas fa-print me-1"></i>Cetak
                                </button>
                                <button type="button" class="btn btn-sm btn-outline-success" id="exportReportBtn">
                                    <i class="fas fa-file-export me-1"></i>Export PDF
                                </button>
                            </div>
                        </div>
                    </div>
                    
                    <div class="card mb-4">
                        <div class="card-header">
                            <h5 class="card-title mb-0"><i class="fas fa-filter me-2"></i>Filter Laporan</h5>
                        </div>
                        <div class="card-body">
                            <div class="row">
                                <div class="col-md-4">
                                    <label for="reportType" class="form-label">Jenis Laporan</label>
                                    <select class="form-select" id="reportType">
                                        <option value="daily">Harian</option>
                                        <option value="weekly">Mingguan</option>
                                        <option value="monthly">Bulanan</option>
                                        <option value="yearly">Tahunan</option>
                                        <option value="custom">Custom</option>
                                    </select>
                                </div>
                                <div class="col-md-4" id="reportDateContainer">
                                    <label for="reportDate" class="form-label">Tanggal</label>
                                    <input type="date" class="form-control" id="reportDate">
                                </div>
                                <div class="col-md-4 d-none" id="reportDateRangeContainer">
                                    <div class="row">
                                        <div class="col-md-6">
                                            <label for="reportDateFrom" class="form-label">Dari</label>
                                            <input type="date" class="form-control" id="reportDateFrom">
                                        </div>
                                        <div class="col-md-6">
                                            <label for="reportDateTo" class="form-label">Sampai</label>
                                            <input type="date" class="form-control" id="reportDateTo">
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="row mt-3">
                                <div class="col-md-4">
                                    <label for="reportTicketType" class="form-label">Jenis Tiket</label>
                                    <select class="form-select" id="reportTicketType">
                                        <option value="all">Semua</option>
                                        <option value="regular">Regular</option>
                                        <option value="vip">VIP</option>
                                        <option value="family">Family Package</option>
                                        <option value="group">Group</option>
                                    </select>
                                </div>
                                <div class="col-md-4">
                                    <label for="reportUser" class="form-label">Kasir</label>
                                    <select class="form-select" id="reportUser">
                                        <option value="all">Semua</option>
                                        <!-- User options will be populated here -->
                                    </select>
                                </div>
                                <div class="col-md-4">
                                    <label for="reportPaymentMethod" class="form-label">Metode Pembayaran</label>
                                    <select class="form-select" id="reportPaymentMethod">
                                        <option value="all">Semua</option>
                                        <option value="cash">Tunai</option>
                                        <option value="debit">Kartu Debit</option>
                                        <option value="credit">Kartu Kredit</option>
                                        <option value="transfer">Transfer Bank</option>
                                        <option value="ewallet">E-Wallet</option>
                                    </select>
                                </div>
                            </div>
                            <div class="mt-3">
                                <button type="button" class="btn btn-primary" id="generateReportBtn">
                                    <i class="fas fa-chart-bar me-2"></i>Generate Laporan
                                </button>
                            </div>
                        </div>
                    </div>
                    
                    <div class="card">
                        <div class="card-header">
                            <h5 class="card-title mb-0"><i class="fas fa-chart-pie me-2"></i>Hasil Laporan</h5>
                        </div>
                        <div class="card-body">
                            <div id="reportResults">
                                <div class="text-center text-muted py-5">
                                    <i class="fas fa-chart-bar fa-3x mb-3"></i>
                                    <p>Pilih filter dan klik "Generate Laporan" untuk menampilkan data</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Users Section -->
                <div class="section d-none restricted-section" id="usersSection">
                    <div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
                        <h1 class="h2">Manajemen Pengguna</h1>
                        <div class="btn-toolbar mb-2 mb-md-0">
                            <button type="button" class="btn btn-sm btn-primary" data-bs-toggle="modal" data-bs-target="#addUserModal">
                                <i class="fas fa-user-plus me-1"></i>Tambah Pengguna
                            </button>
                        </div>
                    </div>
                    
                    <div class="card">
                        <div class="card-header d-flex justify-content-between align-items-center">
                            <h5 class="card-title mb-0"><i class="fas fa-users me-2"></i>Daftar Pengguna</h5>
                            <div class="d-flex">
                                <input type="text" class="form-control form-control-sm me-2" id="searchUserInput" placeholder="Cari pengguna..." style="width: 200px;">
                                <button class="btn btn-sm btn-outline-primary" id="refreshUsersBtn">
                                    <i class="fas fa-sync-alt"></i>
                                </button>
                            </div>
                        </div>
                        <div class="card-body">
                            <div class="table-responsive">
                                <table class="table table-striped table-hover" id="usersTable">
                                    <thead>
                                        <tr>
                                            <th>Nama Pengguna</th>
                                            <th>Nama Lengkap</th>
                                            <th>Role</th>
                                            <th>Status</th>
                                            <th>Terakhir Login</th>
                                            <th>Aksi</th>
                                        </tr>
                                    </thead>
                                    <tbody id="usersTableBody">
                                        <!-- Users data will appear here -->
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Settings Section -->
                <div class="section d-none restricted-section" id="settingsSection">
                    <div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
                        <h1 class="h2">Pengaturan Sistem</h1>
                    </div>
                    
                    <div class="card mb-4">
                        <div class="card-header">
                            <h5 class="card-title mb-0"><i class="fas fa-info-circle me-2"></i>Informasi Tempat Wisata</h5>
                        </div>
                        <div class="card-body">
                            <form id="venueInfoForm">
                                <div class="row mb-3">
                                    <div class="col-md-6">
                                        <label for="venueName" class="form-label">Nama Tempat Wisata</label>
                                        <input type="text" class="form-control" id="venueName" required>
                                    </div>
                                    <div class="col-md-6">
                                        <label for="venueLocation" class="form-label">Lokasi</label>
                                        <input type="text" class="form-control" id="venueLocation" required>
                                    </div>
                                </div>
                                <div class="mb-3">
                                    <label for="venueDescription" class="form-label">Deskripsi</label>
                                    <textarea class="form-control" id="venueDescription" rows="3"></textarea>
                                </div>
                                <div class="mb-3">
                                    <label class="form-label">Logo</label>
                                    <div class="input-group">
                                        <input type="text" class="form-control" id="venueLogo" placeholder="URL Logo" value="https://raw.githubusercontent.com/LKS-88/anekamarket/refs/heads/main/Logo-Anekamarketku.png">
                                        <button class="btn btn-outline-secondary" type="button" id="updateLogoBtn">
                                            <i class="fas fa-sync-alt"></i> Update
                                        </button>
                                    </div>
                                </div>
                                <button type="submit" class="btn btn-primary">
                                    <i class="fas fa-save me-2"></i>Simpan Perubahan
                                </button>
                            </form>
                        </div>
                    </div>
                    
                    <div class="card">
                        <div class="card-header">
                            <h5 class="card-title mb-0"><i class="fas fa-cog me-2"></i>Pengaturan Sistem</h5>
                        </div>
                        <div class="card-body">
                            <form id="systemSettingsForm">
                                <div class="row mb-3">
                                    <div class="col-md-4">
                                        <label for="currency" class="form-label">Mata Uang</label>
                                        <select class="form-select" id="currency" required>
                                            <option value="IDR">Rupiah (IDR)</option>
                                            <option value="USD">Dollar AS (USD)</option>
                                            <option value="EUR">Euro (EUR)</option>
                                            <option value="SGD">Dollar Singapura (SGD)</option>
                                        </select>
                                    </div>
                                    <div class="col-md-4">
                                        <label for="dateFormat" class="form-label">Format Tanggal</label>
                                        <select class="form-select" id="dateFormat" required>
                                            <option value="DD-MM-YYYY">DD-MM-YYYY</option>
                                            <option value="YYYY-MM-DD">YYYY-MM-DD</option>
                                            <option value="MM/DD/YYYY">MM/DD/YYYY</option>
                                        </select>
                                    </div>
                                    <div class="col-md-4">
                                        <label for="timeFormat" class="form-label">Format Waktu</label>
                                        <select class="form-select" id="timeFormat" required>
                                            <option value="24">24 Jam</option>
                                            <option value="12">12 Jam (AM/PM)</option>
                                        </select>
                                    </div>
                                </div>
                                <div class="row mb-3">
                                    <div class="col-md-6">
                                        <div class="form-check form-switch">
                                            <input class="form-check-input" type="checkbox" id="enableTax">
                                            <label class="form-check-label" for="enableTax">Aktifkan Pajak</label>
                                        </div>
                                        <div id="taxSettings" style="display: none;">
                                            <div class="row mt-2">
                                                <div class="col-md-6">
                                                    <label for="taxRate" class="form-label">Persentase Pajak (%)</label>
                                                    <input type="number" class="form-control" id="taxRate" min="0" max="100" step="0.1" value="10">
                                                </div>
                                                <div class="col-md-6">
                                                    <label for="taxName" class="form-label">Nama Pajak</label>
                                                    <input type="text" class="form-control" id="taxName" value="PPN">
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <div class="form-check form-switch">
                                            <input class="form-check-input" type="checkbox" id="enableReceiptFooter">
                                            <label class="form-check-label" for="enableReceiptFooter">Aktifkan Footer Struk</label>
                                        </div>
                                        <div id="receiptFooterSettings" style="display: none;">
                                            <div class="mt-2">
                                                <label for="receiptFooterText" class="form-label">Teks Footer Struk</label>
                                                <textarea class="form-control" id="receiptFooterText" rows="2">Terima kasih telah berkunjung!</textarea>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                <button type="submit" class="btn btn-primary">
                                    <i class="fas fa-save me-2"></i>Simpan Pengaturan
                                </button>
                            </form>
                        </div>
                    </div>
                </div>
                
                <!-- Backup & Restore Section -->
                <div class="section d-none restricted-section" id="backupSection">
                    <div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
                        <h1 class="h2">Backup & Restore Data</h1>
                    </div>
                    
                    <div class="row">
                        <div class="col-md-6">
                            <div class="card mb-4">
                                <div class="card-header">
                                    <h5 class="card-title mb-0"><i class="fas fa-database me-2"></i>Backup Data</h5>
                                </div>
                                <div class="card-body">
                                    <p>Backup semua data sistem termasuk tiket, transaksi, pengguna, dan pengaturan.</p>
                                    <div class="mb-3">
                                        <label for="backupFileName" class="form-label">Nama File Backup</label>
                                        <input type="text" class="form-control" id="backupFileName" value="TourTicketPro_Backup">
                                    </div>
                                    <div class="mb-3">
                                        <label for="backupPassword" class="form-label">Password (Opsional)</label>
                                        <input type="password" class="form-control" id="backupPassword" placeholder="Masukkan password untuk enkripsi">
                                    </div>
                                    <button type="button" class="btn btn-primary" id="createBackupBtn">
                                        <i class="fas fa-download me-2"></i>Buat Backup
                                    </button>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="card mb-4">
                                <div class="card-header">
                                    <h5 class="card-title mb-0"><i class="fas fa-upload me-2"></i>Restore Data</h5>
                                </div>
                                <div class="card-body">
                                    <p>Restore data dari file backup. Semua data saat ini akan diganti dengan data dari backup.</p>
                                    <div class="mb-3">
                                        <label for="restoreFile" class="form-label">File Backup</label>
                                        <input type="file" class="form-control" id="restoreFile" accept=".json,.txt">
                                    </div>
                                    <div class="mb-3">
                                        <label for="restorePassword" class="form-label">Password</label>
                                        <input type="password" class="form-control" id="restorePassword" placeholder="Masukkan password jika file dienkripsi">
                                    </div>
                                    <button type="button" class="btn btn-warning" id="restoreDataBtn">
                                        <i class="fas fa-upload me-2"></i>Restore Data
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="card">
                        <div class="card-header">
                            <h5 class="card-title mb-0"><i class="fas fa-exclamation-triangle me-2"></i>Reset Sistem</h5>
                        </div>
                        <div class="card-body">
                            <div class="alert alert-danger">
                                <i class="fas fa-exclamation-circle me-2"></i>
                                <strong>Peringatan!</strong> Tindakan ini akan menghapus semua data dan mengembalikan sistem ke pengaturan awal. Pastikan Anda telah membuat backup sebelum melakukan reset.
                            </div>
                            <div class="mb-3">
                                <label for="resetPassword" class="form-label">Password Admin</label>
                                <input type="password" class="form-control" id="resetPassword" placeholder="Masukkan password admin untuk konfirmasi">
                            </div>
                            <button type="button" class="btn btn-danger" id="resetSystemBtn">
                                <i class="fas fa-trash-alt me-2"></i>Reset Sistem
                            </button>
                        </div>
                    </div>
                </div>
            </main>
        </div>
    </div>
    
    <!-- Footer -->
    <footer class="app-footer no-print">
        <div class="container-fluid">
            <div class="row">
                <div class="col-12 text-center">
                    <p class="mb-0">Hak Cipta &copy; 2025 <a href="https://www.anekamarket.my.id" target="_blank">Lentera Karya Situbondo</a>. Seluruh hak dilindungi.</p>
                    <p class="mb-0">TourTicket Pro - Sistem Penjualan Tiket Wisata</p>
                </div>
            </div>
        </div>
    </footer>
    
    <!-- Modals -->
    
    <!-- Add User Modal -->
    <div class="modal fade" id="addUserModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Tambah Pengguna Baru</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <form id="addUserForm">
                        <div class="mb-3">
                            <label for="newUsername" class="form-label">Username</label>
                            <input type="text" class="form-control" id="newUsername" required>
                        </div>
                        <div class="mb-3">
                            <label for="newFullName" class="form-label">Nama Lengkap</label>
                            <input type="text" class="form-control" id="newFullName" required>
                        </div>
                        <div class="mb-3">
                            <label for="newUserRole" class="form-label">Role</label>
                            <select class="form-select" id="newUserRole" required>
                                <option value="admin">Admin</option>
                                <option value="cashier">Kasir</option>
                                <option value="manager">Manager</option>
                            </select>
                        </div>
                        <div class="mb-3">
                            <label for="newUserPassword" class="form-label">Password</label>
                            <input type="password" class="form-control" id="newUserPassword" required>
                        </div>
                        <div class="mb-3">
                            <label for="confirmUserPassword" class="form-label">Konfirmasi Password</label>
                            <input type="password" class="form-control" id="confirmUserPassword" required>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Batal</button>
                    <button type="button" class="btn btn-primary" id="saveNewUserBtn">Simpan</button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Edit User Modal -->
    <div class="modal fade" id="editUserModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Edit Pengguna</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <form id="editUserForm">
                        <input type="hidden" id="editUserId">
                        <div class="mb-3">
                            <label for="editUsername" class="form-label">Username</label>
                            <input type="text" class="form-control" id="editUsername" readonly>
                        </div>
                        <div class="mb-3">
                            <label for="editFullName" class="form-label">Nama Lengkap</label>
                            <input type="text" class="form-control" id="editFullName" required>
                        </div>
                        <div class="mb-3">
                            <label for="editUserRole" class="form-label">Role</label>
                            <select class="form-select" id="editUserRole" required>
                                <option value="admin">Admin</option>
                                <option value="cashier">Kasir</option>
                                <option value="manager">Manager</option>
                            </select>
                        </div>
                        <div class="mb-3">
                            <label for="editUserStatus" class="form-label">Status</label>
                            <select class="form-select" id="editUserStatus" required>
                                <option value="active">Aktif</option>
                                <option value="inactive">Nonaktif</option>
                            </select>
                        </div>
                        <div class="mb-3">
                            <label for="editUserPassword" class="form-label">Password Baru (Opsional)</label>
                            <input type="password" class="form-control" id="editUserPassword">
                            <div class="form-text">Biarkan kosong jika tidak ingin mengubah password</div>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Batal</button>
                    <button type="button" class="btn btn-primary" id="saveEditUserBtn">Simpan Perubahan</button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Change Password Modal -->
    <div class="modal fade" id="changePasswordModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Ganti Password</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <form id="changePasswordForm">
                        <div class="mb-3">
                            <label for="currentPassword" class="form-label">Password Saat Ini</label>
                            <input type="password" class="form-control" id="currentPassword" required>
                        </div>
                        <div class="mb-3">
                            <label for="newPassword" class="form-label">Password Baru</label>
                            <input type="password" class="form-control" id="newPassword" required>
                        </div>
                        <div class="mb-3">
                            <label for="confirmNewPassword" class="form-label">Konfirmasi Password Baru</label>
                            <input type="password" class="form-control" id="confirmNewPassword" required>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Batal</button>
                    <button type="button" class="btn btn-primary" id="savePasswordBtn">Simpan Password</button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- View Ticket Modal -->
    <div class="modal fade" id="viewTicketModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Detail Tiket</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body" id="ticketModalContent">
                    <!-- Ticket content will be loaded here -->
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Tutup</button>
                    <button type="button" class="btn btn-primary" id="printTicketBtn">
                        <i class="fas fa-print me-1"></i>Cetak
                    </button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- View Transaction Modal -->
    <div class="modal fade" id="viewTransactionModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Detail Transaksi</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body" id="transactionModalContent">
                    <!-- Transaction content will be loaded here -->
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Tutup</button>
                    <button type="button" class="btn btn-primary" id="printTransactionBtn">
                        <i class="fas fa-print me-1"></i>Cetak Struk
                    </button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Login Modal -->
    <div class="modal fade" id="loginModal" tabindex="-1" aria-hidden="false" data-bs-backdrop="static" data-bs-keyboard="false">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">
                        <i class="fas fa-ticket-alt me-2"></i>TourTicket Pro - Login
                    </h5>
                </div>
                <div class="modal-body">
                    <form id="loginForm">
                        <div class="mb-3">
                            <label for="loginUsername" class="form-label">Username</label>
                            <input type="text" class="form-control" id="loginUsername" required>
                        </div>
                        <div class="mb-3">
                            <label for="loginPassword" class="form-label">Password</label>
                            <input type="password" class="form-control" id="loginPassword" required>
                        </div>
                        <div class="mb-3 form-check">
                            <input type="checkbox" class="form-check-input" id="rememberMe">
                            <label class="form-check-label" for="rememberMe">Ingat saya</label>
                        </div>
                        <button type="submit" class="btn btn-primary w-100">
                            <i class="fas fa-sign-in-alt me-2"></i>Login
                        </button>
                    </form>
                </div>
                <div class="modal-footer">
                    <small class="text-muted">Sistem Penjualan Tiket Wisata v1.0</small>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Confirmation Modal -->
    <div class="modal fade" id="confirmationModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="confirmationModalTitle">Konfirmasi</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body" id="confirmationModalBody">
                    Apakah Anda yakin ingin melanjutkan?
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Batal</button>
                    <button type="button" class="btn btn-primary" id="confirmActionBtn">Ya, Lanjutkan</button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Alert Toast -->
    <div class="position-fixed bottom-0 end-0 p-3" style="z-index: 11">
        <div id="alertToast" class="toast" role="alert" aria-live="assertive" aria-atomic="true">
            <div class="toast-header">
                <strong class="me-auto" id="toastTitle">Notification</strong>
                <small id="toastTime">Just now</small>
                <button type="button" class="btn-close" data-bs-dismiss="toast" aria-label="Close"></button>
            </div>
            <div class="toast-body" id="toastMessage">
                This is a toast message.
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script>
        // Initialize the application when DOM is loaded
        document.addEventListener('DOMContentLoaded', function() {
            // Show login modal immediately
            const loginModal = new bootstrap.Modal(document.getElementById('loginModal'), {
                backdrop: 'static',
                keyboard: false
            });
            loginModal.show();
            
            // Initialize the app
            const app = new TicketSalesApp();
            app.init();
        });
        
        // Main Application Class
        class TicketSalesApp {
            constructor() {
                // Initialize properties
                this.currentUser = null;
                this.cart = [];
                this.ticketTypes = ['regular', 'vip', 'family', 'group'];
                this.paymentMethods = ['cash', 'debit', 'credit', 'transfer', 'ewallet'];
                this.userRoles = ['admin', 'cashier', 'manager'];
                this.selectedTickets = [];
                this.activeCharts = []; // To keep track of active charts
                this.eventListeners = {}; // To manage event listeners
                
                // Initialize data if not exists
                this.initData();
                
                // Load data from localStorage
                this.loadData();
            }
            
            init() {
                // Initialize UI components
                this.initUI();
                
                // Check if user is logged in
                this.checkAuth();
                
                // Setup event listeners
                this.setupEventListeners();
                
                // Load dashboard data
                this.loadDashboardData();
            }
            
            initData() {
                // Initialize data structure if not exists in localStorage
                if (!localStorage.getItem('ticketSalesData')) {
                    const initialData = {
                        settings: {
                            venueName: 'Tempat Wisata Contoh',
                            venueLocation: 'Jl. Contoh No. 123, Kota Contoh',
                            venueDescription: 'Tempat wisata keluarga dengan berbagai wahana menarik',
                            venueLogo: 'https://raw.githubusercontent.com/LKS-88/anekamarket/refs/heads/main/Logo-Anekamarketku.png',
                            currency: 'IDR',
                            dateFormat: 'DD-MM-YYYY',
                            timeFormat: '24',
                            enableTax: false,
                            taxRate: 10,
                            taxName: 'PPN',
                            enableReceiptFooter: true,
                            receiptFooterText: 'Terima kasih telah berkunjung!'
                        },
                        users: [
                            {
                                id: 1,
                                username: 'admin',
                                password: this.hashPassword('Admin.13579'),
                                fullName: 'Administrator',
                                role: 'admin',
                                status: 'active',
                                lastLogin: null,
                                createdAt: new Date().toISOString()
                            }
                        ],
                        tickets: [],
                        transactions: [],
                        activities: []
                    };
                    
                    localStorage.setItem('ticketSalesData', JSON.stringify(initialData));
                }
            }
            
            loadData() {
                // Load all data from localStorage
                const data = JSON.parse(localStorage.getItem('ticketSalesData'));
                
                this.settings = data.settings || {};
                this.users = data.users || [];
                this.tickets = data.tickets || [];
                this.transactions = data.transactions || [];
                this.activities = data.activities || [];
                
                // Set current date format for display
                this.setDateFormat();
            }
            
            saveData() {
                // Save all data to localStorage
                const data = {
                    settings: this.settings,
                    users: this.users,
                    tickets: this.tickets,
                    transactions: this.transactions,
                    activities: this.activities
                };
                
                localStorage.setItem('ticketSalesData', JSON.stringify(data));
            }
            
            initUI() {
                // Initialize date pickers with current date
                const today = new Date().toISOString().split('T')[0];
                document.getElementById('ticketExpiry').min = today;
                document.getElementById('reportDate').value = today;
                document.getElementById('reportDateFrom').value = today;
                document.getElementById('reportDateTo').value = today;
                document.getElementById('filterDate').value = today;
                document.getElementById('transactionFilterDateFrom').value = today;
                document.getElementById('transactionFilterDateTo').value = today;
                
                // Setup report type change
                this.addEventListener('reportType', 'change', (e) => {
                    if (e.target.value === 'custom') {
                        document.getElementById('reportDateContainer').classList.add('d-none');
		                        document.getElementById('reportDateRangeContainer').classList.remove('d-none');
                    } else {
                        document.getElementById('reportDateContainer').classList.remove('d-none');
                        document.getElementById('reportDateRangeContainer').classList.add('d-none');
                    }
                });
                
                // Initialize tooltips
                const tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'));
                tooltipTriggerList.map(function (tooltipTriggerEl) {
                    return new bootstrap.Tooltip(tooltipTriggerEl);
                });
                
                // Initialize popovers
                const popoverTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="popover"]'));
                popoverTriggerList.map(function (popoverTriggerEl) {
                    return new bootstrap.Popover(popoverTriggerEl);
                });
                
                // Initialize toast
                this.toast = new bootstrap.Toast(document.getElementById('alertToast'));
            }
            
            setDateFormat() {
                // Format dates based on settings
                const format = this.settings.dateFormat || 'DD-MM-YYYY';
                this.dateFormat = format;
                
                // Update date display format throughout the app
                // This would be implemented in methods that display dates
            }
            
            checkAuth() {
                // Check if user is logged in from sessionStorage
                const loggedInUser = sessionStorage.getItem('loggedInUser');
                if (loggedInUser) {
                    this.currentUser = JSON.parse(loggedInUser);
                    this.updateUIAfterLogin();
                }
            }
            
            updateUIAfterLogin() {
                // Hide login modal
                const loginModal = bootstrap.Modal.getInstance(document.getElementById('loginModal'));
                if (loginModal) loginModal.hide();
                
                // Update username display
                document.getElementById('currentUsername').textContent = this.currentUser.fullName || this.currentUser.username;
                
                // Show/hide restricted sections based on user role
                this.updateAccessControls();
                
                // Show dashboard by default
                this.showSection('dashboardSection');
            }
            
            updateAccessControls() {
                // Show/hide restricted sections based on user role
                const restrictedSections = document.querySelectorAll('.restricted-section');
                const restrictedLinks = document.querySelectorAll('.restricted-link');
                const restrictedActions = document.querySelectorAll('.restricted-action');
                
                const isAdmin = this.currentUser.role === 'admin';
                const isManager = this.currentUser.role === 'manager';
                
                restrictedSections.forEach(section => {
                    if (isAdmin || isManager) {
                        section.classList.remove('restricted');
                    } else {
                        section.classList.add('restricted');
                    }
                });
                
                restrictedLinks.forEach(link => {
                    if (isAdmin || isManager) {
                        link.classList.remove('restricted');
                    } else {
                        link.classList.add('restricted');
                    }
                });
                
                restrictedActions.forEach(action => {
                    if (isAdmin || isManager) {
                        action.classList.remove('restricted');
                    } else {
                        action.classList.add('restricted');
                    }
                });
            }
            
            setupEventListeners() {
                // Login form
                this.addEventListener('loginForm', 'submit', (e) => {
                    e.preventDefault();
                    this.handleLogin();
                });
                
                // Navigation links
                this.addEventListener('dashboardLink', 'click', (e) => {
                    e.preventDefault();
                    this.showSection('dashboardSection');
                    this.loadDashboardData();
                });
                
                this.addEventListener('generateTicketLink', 'click', (e) => {
                    e.preventDefault();
                    this.showSection('generateTicketSection');
                });
                
                this.addEventListener('stockTicketLink', 'click', (e) => {
                    e.preventDefault();
                    this.showSection('stockTicketSection');
                    this.loadTicketStock();
                });
                
                this.addEventListener('salesLink', 'click', (e) => {
                    e.preventDefault();
                    this.showSection('salesSection');
                    this.clearCart();
                });
                
                this.addEventListener('transactionsLink', 'click', (e) => {
                    e.preventDefault();
                    this.showSection('transactionsSection');
                    this.loadTransactions();
                });
                
                this.addEventListener('reportsLink', 'click', (e) => {
                    e.preventDefault();
                    this.showSection('reportsSection');
                });
                
                this.addEventListener('usersLink', 'click', (e) => {
                    e.preventDefault();
                    this.showSection('usersSection');
                    this.loadUsers();
                });
                
                this.addEventListener('settingsLink', 'click', (e) => {
                    e.preventDefault();
                    this.showSection('settingsSection');
                    this.loadSettings();
                });
                
                this.addEventListener('backupLink', 'click', (e) => {
                    e.preventDefault();
                    this.showSection('backupSection');
                });
                
                // Logout button
                this.addEventListener('logoutBtn', 'click', (e) => {
                    e.preventDefault();
                    this.handleLogout();
                });
                
                // Generate ticket form
                this.addEventListener('generateTicketForm', 'submit', (e) => {
                    e.preventDefault();
                    this.generateTickets();
                });
                
                // Print all tickets button
                this.addEventListener('printAllTicketsBtn', 'click', () => {
                    this.printAllTickets();
                });
                
                // Refresh buttons
                this.addEventListener('refreshDashboardBtn', 'click', () => {
                    this.loadDashboardData();
                });
                
                this.addEventListener('refreshStockBtn', 'click', () => {
                    this.loadTicketStock();
                });
                
                this.addEventListener('refreshTransactionsBtn', 'click', () => {
                    this.loadTransactions();
                });
                
                this.addEventListener('refreshUsersBtn', 'click', () => {
                    this.loadUsers();
                });
                
                // Ticket search
                this.addEventListener('ticketSearchInput', 'input', (e) => {
                    this.searchTickets(e.target.value);
                });
                
                this.addEventListener('searchTicketBtn', 'click', () => {
                    const searchValue = document.getElementById('ticketSearchInput').value;
                    if (searchValue) {
                        this.searchTickets(searchValue);
                    }
                });
                
                // Cart and payment
                this.addEventListener('paymentForm', 'submit', (e) => {
                    e.preventDefault();
                    this.completePayment();
                });
                
                this.addEventListener('amountPaid', 'input', (e) => {
                    this.calculateChange();
                });
                
                this.addEventListener('cancelTransactionBtn', 'click', () => {
                    this.clearCart();
                });
                
                // Add more event listeners as needed...
                
                // Modal close buttons
                const closeButtons = document.querySelectorAll('[data-bs-dismiss="modal"]');
                closeButtons.forEach(button => {
                    button.addEventListener('click', () => {
                        const modal = button.closest('.modal');
                        if (modal) {
                            const modalInstance = bootstrap.Modal.getInstance(modal);
                            if (modalInstance) modalInstance.hide();
                        }
                    });
                });
                
                // Cleanup charts when navigating away
                const navLinks = document.querySelectorAll('.nav-link');
                navLinks.forEach(link => {
                    link.addEventListener('click', () => {
                        this.cleanupCharts();
                    });
                });
            }
            
            addEventListener(elementId, eventType, callback) {
                const element = document.getElementById(elementId);
                if (element) {
                    // Remove existing listener if any
                    if (this.eventListeners[elementId]) {
                        element.removeEventListener(eventType, this.eventListeners[elementId]);
                    }
                    
                    // Add new listener
                    element.addEventListener(eventType, callback);
                    
                    // Store reference for cleanup
                    this.eventListeners[elementId] = callback;
                }
            }
            
            cleanupCharts() {
                // Destroy all active charts to prevent memory leaks
                this.activeCharts.forEach(chart => {
                    if (chart && typeof chart.destroy === 'function') {
                        chart.destroy();
                    }
                });
                this.activeCharts = [];
            }
            
            showSection(sectionId) {
                // Hide all sections
                const sections = document.querySelectorAll('.section');
                sections.forEach(section => {
                    section.classList.add('d-none');
                });
                
                // Show the requested section
                const section = document.getElementById(sectionId);
                if (section) {
                    section.classList.remove('d-none');
                }
                
                // Update active nav link
                const navLinks = document.querySelectorAll('.nav-link');
                navLinks.forEach(link => {
                    link.classList.remove('active');
                });
                
                // Find and activate the corresponding nav link
                const activeLink = document.querySelector(`.nav-link[data-section="${sectionId}"]`);
                if (activeLink) {
                    activeLink.classList.add('active');
                }
            }
            
            handleLogin() {
                const username = document.getElementById('loginUsername').value;
                const password = document.getElementById('loginPassword').value;
                const rememberMe = document.getElementById('rememberMe').checked;
                
                // Find user
                const user = this.users.find(u => u.username === username);
                
                if (user && this.verifyPassword(password, user.password)) {
                    // Login successful
                    this.currentUser = user;
                    
                    // Update last login
                    user.lastLogin = new Date().toISOString();
                    this.saveData();
                    
                    // Store in session
                    sessionStorage.setItem('loggedInUser', JSON.stringify(user));
                    
                    // Remember me
                    if (rememberMe) {
                        localStorage.setItem('rememberedUser', username);
                    } else {
                        localStorage.removeItem('rememberedUser');
                    }
                    
                    // Update UI
                    this.updateUIAfterLogin();
                    
                    // Show success message
                    this.showToast('Login Berhasil', `Selamat datang, ${user.fullName || user.username}!`, 'success');
                } else {
                    // Login failed
                    this.showToast('Login Gagal', 'Username atau password salah', 'error');
                }
            }
            
            handleLogout() {
                // Clear session
                sessionStorage.removeItem('loggedInUser');
                this.currentUser = null;
                
                // Reset UI
                document.getElementById('currentUsername').textContent = '';
                
                // Show login modal
                const loginModal = new bootstrap.Modal(document.getElementById('loginModal'), {
                    backdrop: 'static',
                    keyboard: false
                });
                loginModal.show();
                
                // Clear form
                document.getElementById('loginForm').reset();
                
                // Show logout message
                this.showToast('Logout Berhasil', 'Anda telah logout dari sistem', 'info');
            }
            
            hashPassword(password) {
                // Simple hash function for demo purposes
                // In a real app, use a proper hashing algorithm like bcrypt
                let hash = 0;
                for (let i = 0; i < password.length; i++) {
                    const char = password.charCodeAt(i);
                    hash = ((hash << 5) - hash) + char;
                    hash = hash & hash; // Convert to 32bit integer
                }
                return hash.toString();
            }
            
            verifyPassword(inputPassword, storedHash) {
                // Verify password against stored hash
                return this.hashPassword(inputPassword) === storedHash;
            }
            
            showToast(title, message, type = 'info') {
                // Set toast content
                document.getElementById('toastTitle').textContent = title;
                document.getElementById('toastMessage').textContent = message;
                
                // Set toast type (change header color)
                const toastHeader = document.querySelector('#alertToast .toast-header');
                toastHeader.className = 'toast-header';
                
                switch (type) {
                    case 'success':
                        toastHeader.classList.add('bg-success', 'text-white');
                        break;
                    case 'error':
                        toastHeader.classList.add('bg-danger', 'text-white');
                        break;
                    case 'warning':
                        toastHeader.classList.add('bg-warning', 'text-dark');
                        break;
                    default:
                        toastHeader.classList.add('bg-primary', 'text-white');
                }
                
                // Set current time
                const now = new Date();
                document.getElementById('toastTime').textContent = now.toLocaleTimeString();
                
                // Show toast
                this.toast.show();
            }
            
            loadDashboardData() {
                // Show loading
                this.showLoading(true);
                
                // Calculate stats
                const availableTickets = this.tickets.filter(t => t.status === 'available').length;
                const today = new Date().toISOString().split('T')[0];
                const todaySales = this.transactions
                    .filter(t => t.date.split('T')[0] === today)
                    .reduce((sum, t) => sum + t.items.length, 0);
                
                const todayRevenue = this.transactions
                    .filter(t => t.date.split('T')[0] === today)
                    .reduce((sum, t) => sum + t.totalAmount, 0);
                
                // Update UI
                document.getElementById('stockCount').textContent = availableTickets;
                document.getElementById('todaySalesCount').textContent = todaySales;
                document.getElementById('todayRevenue').textContent = this.formatCurrency(todayRevenue);
                
                // Load recent activities
                this.loadRecentActivities();
                
                // Generate sales chart
                this.generateSalesChart();
                
                // Hide loading
                this.showLoading(false);
            }
            
            loadRecentActivities() {
                const activitiesContainer = document.getElementById('recentActivities');
                activitiesContainer.innerHTML = '';
                
                // Get last 5 activities
                const recentActivities = [...this.activities]
                    .sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp))
                    .slice(0, 5);
                
                if (recentActivities.length === 0) {
                    activitiesContainer.innerHTML = `
                        <div class="list-group-item">
                            <div class="d-flex w-100 justify-content-between">
                                <small class="text-muted">Tidak ada aktivitas terakhir</small>
                            </div>
                        </div>
                    `;
                    return;
                }
                
                recentActivities.forEach(activity => {
                    const activityItem = document.createElement('div');
                    activityItem.className = 'list-group-item';
                    
                    const time = new Date(activity.timestamp).toLocaleString();
                    
                    activityItem.innerHTML = `
                        <div class="d-flex w-100 justify-content-between">
                            <h6 class="mb-1">${activity.title}</h6>
                            <small class="text-muted">${time}</small>
                        </div>
                        <p class="mb-1">${activity.description}</p>
                        <small class="text-muted">Oleh: ${activity.user}</small>
                    `;
                    
                    activitiesContainer.appendChild(activityItem);
                });
            }
            
            generateSalesChart() {
                // Cleanup existing chart
                const chartCanvas = document.getElementById('salesChart');
                if (chartCanvas) {
                    const existingChart = Chart.getChart(chartCanvas);
                    if (existingChart) {
                        existingChart.destroy();
                    }
                    
                    // Prepare data for last 7 days
                    const dates = [];
                    const salesData = [];
                    
                    for (let i = 6; i >= 0; i--) {
                        const date = new Date();
                        date.setDate(date.getDate() - i);
                        const dateStr = date.toISOString().split('T')[0];
                        dates.push(this.formatDisplayDate(dateStr));
                        
                        const dailySales = this.transactions
                            .filter(t => t.date.split('T')[0] === dateStr)
                            .reduce((sum, t) => sum + t.items.length, 0);
                        
                        salesData.push(dailySales);
                    }
                    
                    // Create new chart
                    const ctx = chartCanvas.getContext('2d');
                    const chart = new Chart(ctx, {
                        type: 'line',
                        data: {
                            labels: dates,
                            datasets: [{
                                label: 'Tiket Terjual',
                                data: salesData,
                                backgroundColor: 'rgba(26, 35, 126, 0.2)',
                                borderColor: 'rgba(26, 35, 126, 1)',
                                borderWidth: 2,
                                tension: 0.4,
                                fill: true
                            }]
                        },
                        options: {
                            responsive: true,
                            plugins: {
                                legend: {
                                    position: 'top',
                                },
                                tooltip: {
                                    callbacks: {
                                        label: function(context) {
                                            return `Tiket Terjual: ${context.raw}`;
                                        }
                                    }
                                }
                            },
                            scales: {
                                y: {
                                    beginAtZero: true,
                                    ticks: {
                                        precision: 0
                                    }
                                }
                            }
                        }
                    });
                    
                    // Store chart reference for cleanup
                    this.activeCharts.push(chart);
                }
            }
            
            generateTickets() {
                const type = document.getElementById('ticketType').value;
                const price = parseInt(document.getElementById('ticketPrice').value);
                const quantity = parseInt(document.getElementById('ticketQuantity').value);
                const prefix = document.getElementById('ticketPrefix').value || 'TT';
                const expiry = document.getElementById('ticketExpiry').value;
                
                // Validate inputs
                if (price <= 0 || isNaN(price)) {
                    this.showToast('Error', 'Harga tiket harus lebih dari 0', 'error');
                    return;
                }
                
                if (quantity <= 0 || isNaN(quantity)) {
                    this.showToast('Error', 'Jumlah tiket harus lebih dari 0', 'error');
                    return;
                }
                
                // Generate tickets
                const generatedTickets = [];
                const now = new Date().toISOString();
                
                for (let i = 0; i < quantity; i++) {
                    const code = prefix + this.generateRandomCode(8);
                    
                    const ticket = {
                        code,
                        type,
                        price,
                        status: 'available',
                        generatedAt: now,
                        expiryDate: expiry || null,
                        soldAt: null,
                        transactionId: null
                    };
                    
                    generatedTickets.push(ticket);
                    this.tickets.push(ticket);
                }
                
                // Save data
                this.saveData();
                
                // Log activity
                this.logActivity(
                    'Generate Tiket',
                    `Membuat ${quantity} tiket ${type} dengan harga Rp${price}`,
                    this.currentUser.username
                );
                
                // Show success message
                this.showToast('Berhasil', `${quantity} tiket berhasil digenerate`, 'success');
                
                // Display generated tickets
                this.displayGeneratedTickets(generatedTickets);
            }
            
            generateRandomCode(length) {
                const chars = 'ABCDEFGHJKLMNPQRSTUVWXYZ23456789'; // Exclude confusing characters
                let result = '';
                
                for (let i = 0; i < length; i++) {
                    result += chars.charAt(Math.floor(Math.random() * chars.length));
                }
                
                return result;
            }
            
            displayGeneratedTickets(tickets) {
                const container = document.getElementById('generatedTicketsContainer');
                container.innerHTML = '';
                
                tickets.forEach(ticket => {
                    const ticketElement = document.createElement('div');
                    ticketElement.className = 'ticket-card mb-3';
                    
                    ticketElement.innerHTML = `
                        <div class="ticket-watermark">${ticket.type.toUpperCase()}</div>
                        <div class="d-flex justify-content-between align-items-center mb-2">
                            <span class="ticket-code">${ticket.code}</span>
                            <span class="badge bg-primary">${this.formatTicketType(ticket.type)}</span>
                        </div>
                        <div class="row">
                            <div class="col-md-6">
                                <p class="mb-1"><strong>Harga:</strong> ${this.formatCurrency(ticket.price)}</p>
                                <p class="mb-1"><strong>Status:</strong> <span class="badge bg-success">Tersedia</span></p>
                            </div>
                            <div class="col-md-6">
                                <p class="mb-1"><strong>Generate Pada:</strong> ${this.formatDateTime(ticket.generatedAt)}</p>
                                ${ticket.expiryDate ? `<p class="mb-1"><strong>Kedaluwarsa:</strong> ${this.formatDisplayDate(ticket.expiryDate)}</p>` : ''}
                            </div>
                        </div>
                    `;
                    
                    container.appendChild(ticketElement);
                });
                
                // Show the generated tickets card
                document.getElementById('generatedTicketsCard').style.display = 'block';
            }
            
            printAllTickets() {
                // In a real app, this would open a print dialog with all tickets formatted for printing
                window.print();
            }
            
            loadTicketStock() {
                const tableBody = document.getElementById('stockTableBody');
                tableBody.innerHTML = '';
                
                // Apply filters
                const statusFilter = document.getElementById('filterStatus').value;
                const typeFilter = document.getElementById('filterType').value;
                const dateFilter = document.getElementById('filterDate').value;
                
                let filteredTickets = [...this.tickets];
                
                if (statusFilter !== 'all') {
                    filteredTickets = filteredTickets.filter(t => t.status === statusFilter);
                }
                
                if (typeFilter !== 'all') {
                    filteredTickets = filteredTickets.filter(t => t.type === typeFilter);
                }
                
                if (dateFilter) {
                    filteredTickets = filteredTickets.filter(t => 
                        t.generatedAt.split('T')[0] === dateFilter
                    );
                }
                
                // Sort by most recent first
                filteredTickets.sort((a, b) => new Date(b.generatedAt) - new Date(a.generatedAt));
                
                // Display tickets
                filteredTickets.forEach(ticket => {
                    const row = document.createElement('tr');
                    
                    // Determine status badge
                    let statusBadge;
                    switch (ticket.status) {
                        case 'available':
                            statusBadge = '<span class="badge bg-success">Tersedia</span>';
                            break;
                        case 'sold':
                            statusBadge = '<span class="badge bg-primary">Terjual</span>';
                            break;
                        case 'expired':
                            statusBadge = '<span class="badge bg-danger">Kedaluwarsa</span>';
                            break;
                        default:
                            statusBadge = '<span class="badge bg-secondary">Unknown</span>';
                    }
                    
                    row.innerHTML = `
                        <td><input type="checkbox" class="ticket-checkbox" data-code="${ticket.code}"></td>
                        <td>${ticket.code}</td>
                        <td>${this.formatTicketType(ticket.type)}</td>
                        <td>${this.formatCurrency(ticket.price)}</td>
                        <td>${statusBadge}</td>
                        <td>${this.formatDateTime(ticket.generatedAt)}</td>
                        <td>${ticket.expiryDate ? this.formatDisplayDate(ticket.expiryDate) : '-'}</td>
                        <td>
                            <button class="btn btn-sm btn-outline-primary view-ticket-btn" data-code="${ticket.code}">
                                <i class="fas fa-eye"></i>
                            </button>
                            ${ticket.status === 'available' ? `
                            <button class="btn btn-sm btn-outline-success add-to-cart-btn" data-code="${ticket.code}">
                                <i class="fas fa-cart-plus"></i>
                            </button>
                            ` : ''}
                        </td>
                    `;
                    
                    tableBody.appendChild(row);
                });
                
                // Add event listeners to view buttons
                document.querySelectorAll('.view-ticket-btn').forEach(button => {
                    button.addEventListener('click', () => {
                        const code = button.getAttribute('data-code');
                        this.viewTicketDetails(code);
                    });
                });
                
                // Add event listeners to add to cart buttons
                document.querySelectorAll('.add-to-cart-btn').forEach(button => {
                    button.addEventListener('click', () => {
                        const code = button.getAttribute('data-code');
                        this.addTicketToCart(code);
                    });
                });
                
                // Select all checkbox
                document.getElementById('selectAllTickets').addEventListener('change', (e) => {
                    const checkboxes = document.querySelectorAll('.ticket-checkbox');
                    checkboxes.forEach(checkbox => {
                        checkbox.checked = e.target.checked;
                    });
                });
            }
            
            viewTicketDetails(code) {
                const ticket = this.tickets.find(t => t.code === code);
                if (!ticket) return;
                
                const modalContent = document.getElementById('ticketModalContent');
                modalContent.innerHTML = `
                    <div class="ticket-card">
                        <div class="ticket-watermark">${ticket.type.toUpperCase()}</div>
                        <div class="d-flex justify-content-between align-items-center mb-3">
                            <span class="ticket-code">${ticket.code}</span>
                            <span class="badge bg-primary">${this.formatTicketType(ticket.type)}</span>
                        </div>
                        <div class="row">
                            <div class="col-md-6">
                                <p class="mb-2"><strong>Harga:</strong> ${this.formatCurrency(ticket.price)}</p>
                                <p class="mb-2"><strong>Status:</strong> ${this.formatTicketStatus(ticket.status)}</p>
                                <p class="mb-2"><strong>Generate Pada:</strong> ${this.formatDateTime(ticket.generatedAt)}</p>
                            </div>
                            <div class="col-md-6">
                                ${ticket.expiryDate ? `<p class="mb-2"><strong>Kedaluwarsa:</strong> ${this.formatDisplayDate(ticket.expiryDate)}</p>` : ''}
                                ${ticket.soldAt ? `<p class="mb-2"><strong>Terjual Pada:</strong> ${this.formatDateTime(ticket.soldAt)}</p>` : ''}
                                ${ticket.transactionId ? `<p class="mb-2"><strong>ID Transaksi:</strong> ${ticket.transactionId}</p>` : ''}
                            </div>
                        </div>
                    </div>
                `;
                
                // Show modal
                const modal = new bootstrap.Modal(document.getElementById('viewTicketModal'));
                modal.show();
                
                // Set print button handler
                document.getElementById('printTicketBtn').onclick = () => {
                    this.printTicket(ticket);
                };
            }
            
            printTicket(ticket) {
                // In a real app, this would open a print dialog with the ticket formatted for printing
                const printWindow = window.open('', '_blank');
                printWindow.document.write(`
                    <!DOCTYPE html>
                    <html>
                    <head>
                        <title>Ticket ${ticket.code}</title>
                        <style>
                            body { font-family: Arial, sans-serif; }
                            .ticket { border: 1px dashed #000; padding: 20px; max-width: 400px; margin: 0 auto; }
                            .ticket-header { text-align: center; margin-bottom: 15px; }
                            .ticket-code { font-size: 24px; font-weight: bold; text-align: center; margin: 10px 0; }
                            .ticket-info { margin-bottom: 10px; }
                            .barcode { text-align: center; margin: 20px 0; }
                        </style>
                    </head>
                    <body>
                        <div class="ticket">
                            <div class="ticket-header">
                                <h2>${this.settings.venueName || 'Tempat Wisata'}</h2>
                                <p>${this.settings.venueLocation || ''}</p>
                            </div>
                            <div class="ticket-code">${ticket.code}</div>
                            <div class="ticket-info">
                                <p><strong>Jenis:</strong> ${this.formatTicketType(ticket.type)}</p>
                                <p><strong>Harga:</strong> ${this.formatCurrency(ticket.price)}</p>
                                <p><strong>Tanggal:</strong> ${this.formatDateTime(ticket.generatedAt)}</p>
                            </div>
                            <div class="barcode">
                                <p>*${ticket.code}*</p>
                                <small>Scan barcode untuk validasi</small>
                            </div>
                            <div class="text-center">
                                <small>Terima kasih telah berkunjung</small>
                            </div>
                        </div>
                        <script>
                            window.onload = function() {
                                window.print();
                                setTimeout(function() {
                                    window.close();
                                }, 1000);
                            };
                        </script>
                    </body>
                    </html>
                `);
                printWindow.document.close();
            }
            
            searchTickets(query) {
                const resultsContainer = document.getElementById('ticketSearchResults');
                resultsContainer.innerHTML = '';
                
                if (!query || query.length < 2) {
                    resultsContainer.style.display = 'none';
                    return;
                }
                
                const searchTerm = query.toLowerCase();
                const availableTickets = this.tickets.filter(t => 
                    t.status === 'available' && 
                    t.code.toLowerCase().includes(searchTerm)
                    .slice(0, 10); // Limit to 10 results
                
                if (availableTickets.length === 0) {
                    resultsContainer.innerHTML = '<div class="search-result-item">Tiket tidak ditemukan</div>';
                    resultsContainer.style.display = 'block';
                    return;
                }
                
                availableTickets.forEach(ticket => {
                    const resultItem = document.createElement('div');
                    resultItem.className = 'search-result-item';
                    resultItem.innerHTML = `
                        ${ticket.code} 
                        <span class="badge bg-primary float-end">${this.formatCurrency(ticket.price)}</span>
                        <span class="badge bg-secondary float-end me-1">${this.formatTicketType(ticket.type)}</span>
                    `;
                    
                    resultItem.addEventListener('click', () => {
                        this.addTicketToCart(ticket.code);
                        resultsContainer.style.display = 'none';
                        document.getElementById('ticketSearchInput').value = '';
                    });
                    
                    resultsContainer.appendChild(resultItem);
                });
                
                resultsContainer.style.display = 'block';
            }
            
            addTicketToCart(code) {
                const ticket = this.tickets.find(t => t.code === code && t.status === 'available');
                if (!ticket) {
                    this.showToast('Error', 'Tiket tidak tersedia atau sudah terjual', 'error');
                    return;
                }
                
                // Check if ticket already in cart
                if (this.cart.some(item => item.code === code)) {
                    this.showToast('Peringatan', 'Tiket sudah ada di keranjang', 'warning');
                    return;
                }
                
                // Add to cart
                this.cart.push({
                    code: ticket.code,
                    type: ticket.type,
                    price: ticket.price
                });
                
                // Update cart display
                this.updateCartDisplay();
                
                // Show success message
                this.showToast('Berhasil', 'Tiket ditambahkan ke keranjang', 'success');
            }
            
            addSelectedToCart() {
                const checkboxes = document.querySelectorAll('.ticket-checkbox:checked');
                if (checkboxes.length === 0) {
                    this.showToast('Peringatan', 'Tidak ada tiket yang dipilih', 'warning');
                    return;
                }
                
                let addedCount = 0;
                
                checkboxes.forEach(checkbox => {
                    const code = checkbox.getAttribute('data-code');
                    const ticket = this.tickets.find(t => t.code === code && t.status === 'available');
                    
                    if (ticket && !this.cart.some(item => item.code === code)) {
                        this.cart.push({
                            code: ticket.code,
                            type: ticket.type,
                            price: ticket.price
                        });
                        addedCount++;
                    }
                });
                
                // Update cart display
                this.updateCartDisplay();
                
                // Show result message
                if (addedCount > 0) {
                    this.showToast('Berhasil', `${addedCount} tiket ditambahkan ke keranjang`, 'success');
                } else {
                    this.showToast('Peringatan', 'Tidak ada tiket baru yang ditambahkan', 'warning');
                }
            }
            
            updateCartDisplay() {
                const cartBody = document.getElementById('cartTableBody');
                cartBody.innerHTML = '';
                
                if (this.cart.length === 0) {
                    cartBody.innerHTML = `
                        <tr>
                            <td colspan="4" class="text-center text-muted py-3">Keranjang kosong</td>
                        </tr>
                    `;
                    
                    document.getElementById('totalAmount').value = 'Rp 0';
                    document.getElementById('amountPaid').value = '';
                    document.getElementById('changeAmount').value = 'Rp 0';
                    return;
                }
                
                let total = 0;
                
                this.cart.forEach(item => {
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td>${item.code}</td>
                        <td>${this.formatTicketType(item.type)}</td>
                        <td>${this.formatCurrency(item.price)}</td>
                        <td>
                            <button class="btn btn-sm btn-outline-danger remove-from-cart-btn" data-code="${item.code}">
                                <i class="fas fa-trash"></i>
                            </button>
                        </td>
                    `;
                    
                    cartBody.appendChild(row);
                    total += item.price;
                    
                    // Add event listener to remove button
                    row.querySelector('.remove-from-cart-btn').addEventListener('click', () => {
                        this.removeFromCart(item.code);
                    });
                });
                
                // Update totals
                document.getElementById('cartTotal').textContent = this.formatCurrency(total);
                document.getElementById('totalAmount').value = this.formatCurrency(total);
                
                // Clear payment inputs
                document.getElementById('amountPaid').value = '';
                document.getElementById('changeAmount').value = 'Rp 0';
            }
            
            removeFromCart(code) {
                this.cart = this.cart.filter(item => item.code !== code);
                this.updateCartDisplay();
                this.showToast('Berhasil', 'Tiket dihapus dari keranjang', 'success');
            }
            
            clearCart() {
                this.cart = [];
                this.updateCartDisplay();
                this.showToast('Info', 'Keranjang dikosongkan', 'info');
            }
            
            calculateChange() {
                const total = this.cart.reduce((sum, item) => sum + item.price, 0);
                const paid = parseFloat(document.getElementById('amountPaid').value) || 0;
                
                const change = paid - total;
                document.getElementById('changeAmount').value = this.formatCurrency(change);
            }
            
            completePayment() {
                if (this.cart.length === 0) {
                    this.showToast('Error', 'Keranjang kosong', 'error');
                    return;
                }
                
                const paymentMethod = document.getElementById('paymentMethod').value;
                const customerName = document.getElementById('customerName').value || 'Pelanggan';
                const total = this.cart.reduce((sum, item) => sum + item.price, 0);
                const paid = parseFloat(document.getElementById('amountPaid').value) || 0;
                
                if (paid < total) {
                    this.showToast('Error', 'Jumlah pembayaran kurang', 'error');
                    return;
                }
                
                // Create transaction
                const transactionId = 'TRX-' + new Date().getTime();
                const now = new Date().toISOString();
                
                const transaction = {
                    id: transactionId,
                    date: now,
                    cashier: this.currentUser.username,
                    customerName,
                    items: [...this.cart],
                    totalAmount: total,
                    amountPaid: paid,
                    changeAmount: paid - total,
                    paymentMethod,
                    taxAmount: 0,
                    discountAmount: 0
                };
                
                // Apply tax if enabled
                if (this.settings.enableTax) {
                    const taxRate = this.settings.taxRate || 0;
                    const taxAmount = Math.round(total * taxRate / 100);
                    transaction.taxAmount = taxAmount;
                    transaction.totalAmount += taxAmount;
                }
                
                // Update tickets status
                this.cart.forEach(item => {
                    const ticket = this.tickets.find(t => t.code === item.code);
                    if (ticket) {
                        ticket.status = 'sold';
                        ticket.soldAt = now;
                        ticket.transactionId = transactionId;
                    }
                });
                
                // Add transaction to history
                this.transactions.unshift(transaction);
                
                // Save data
                this.saveData();
                
                // Log activity
                this.logActivity(
                    'Transaksi Baru',
                    `Menyelesaikan transaksi ${transactionId} senilai ${this.formatCurrency(total)}`,
                    this.currentUser.username
                );
                
                // Show success message
                this.showToast('Berhasil', `Transaksi ${transactionId} berhasil`, 'success');
                
                // Print receipt (simulated)
                this.printReceipt(transaction);
                
                // Clear cart
                this.clearCart();
                
                // Reload dashboard data
                this.loadDashboardData();
            }
            
            printReceipt(transaction) {
                // In a real app, this would open a print dialog with the receipt formatted for printing
                const printWindow = window.open('', '_blank');
                
                // Prepare items table
                let itemsTable = '';
                transaction.items.forEach(item => {
                    itemsTable += `
                        <tr>
                            <td>${item.code}</td>
                            <td>${this.formatTicketType(item.type)}</td>
                            <td class="text-right">${this.formatCurrency(item.price)}</td>
                        </tr>
                    `;
                });
                
                // Prepare receipt footer if enabled
                let receiptFooter = '';
                if (this.settings.enableReceiptFooter) {
                    receiptFooter = `
                        <div class="receipt-footer">
                            ${this.settings.receiptFooterText || 'Terima kasih telah berkunjung!'}
                        </div>
                    `;
                }
                
                printWindow.document.write(`
                    <!DOCTYPE html>
                    <html>
                    <head>
                        <title>Receipt ${transaction.id}</title>
                        <style>
                            body { font-family: Arial, sans-serif; font-size: 14px; }
                            .receipt-logo { max-width: 150px; margin-bottom: 10px; }
                            .receipt-header { text-align: center; margin-bottom: 15px; }
                            .receipt-title { font-weight: bold; font-size: 1.2rem; margin-bottom: 5px; }
                            .receipt-subtitle { font-size: 0.9rem; color: #666; }
                            .receipt-transaction-id { font-weight: bold; font-size: 1.1rem; margin-bottom: 10px; text-align: center; }
                            .receipt-items { width: 100%; border-collapse: collapse; margin-bottom: 15px; }
                            .receipt-items th { text-align: left; border-bottom: 1px solid #ddd; padding: 5px; background-color: #f5f5f5; }
                            .receipt-items td { padding: 5px; border-bottom: 1px solid #eee; }
                            .receipt-items .text-right { text-align: right; }
                            .receipt-totals { width: 100%; border-collapse: collapse; margin-bottom: 15px; }
                            .receipt-totals td { padding: 5px; }
                            .receipt-totals .total-row { font-weight: bold; border-top: 1px solid #ddd; background-color: #f5f5f5; }
                            .receipt-footer { text-align: center; margin-top: 20px; font-size: 0.8rem; color: #666; border-top: 1px solid #eee; padding-top: 10px; }
                        </style>
                    </head>
                    <body>
                        <div class="receipt-header">
                            ${this.settings.venueLogo ? `<img src="${this.settings.venueLogo}" class="receipt-logo">` : ''}
                            <div class="receipt-title">${this.settings.venueName || 'Tempat Wisata'}</div>
                            <div class="receipt-subtitle">${this.settings.venueLocation || ''}</div>
                            <div class="receipt-transaction-id">${transaction.id}</div>
                        </div>
                        
                        <table class="receipt-items">
                            <thead>
                                <tr>
                                    <th>Kode</th>
                                    <th>Jenis</th>
                                    <th class="text-right">Harga</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${itemsTable}
                            </tbody>
                        </table>
                        
                        <table class="receipt-totals">
                            <tr>
                                <td>Subtotal:</td>
                                <td class="text-right">${this.formatCurrency(transaction.totalAmount - transaction.taxAmount)}</td>
                            </tr>
                            ${transaction.taxAmount > 0 ? `
                            <tr>
                                <td>${this.settings.taxName || 'Pajak'} (${this.settings.taxRate || 0}%):</td>
                                <td class="text-right">${this.formatCurrency(transaction.taxAmount)}</td>
                            </tr>
                            ` : ''}
                            <tr class="total-row">
                                <td>Total:</td>
                                <td class="text-right">${this.formatCurrency(transaction.totalAmount)}</td>
                            </tr>
                            <tr>
                                <td>Dibayar:</td>
                                <td class="text-right">${this.formatCurrency(transaction.amountPaid)}</td>
                            </tr>
                            <tr class="total-row">
                                <td>Kembalian:</td>
                                <td class="text-right">${this.formatCurrency(transaction.changeAmount)}</td>
                            </tr>
                        </table>
                        
                        <div class="text-center" style="margin-top: 15px;">
                            <small>Kasir: ${transaction.cashier}</small><br>
                            <small>${this.formatDateTime(transaction.date)}</small><br>
                            <small>Metode: ${this.formatPaymentMethod(transaction.paymentMethod)}</small>
                        </div>
                        
                        ${receiptFooter}
                        
                        <script>
                            window.onload = function() {
                                window.print();
                                setTimeout(function() {
                                    window.close();
                                }, 1000);
                            };
                        </script>
                    </body>
                    </html>
                `);
                printWindow.document.close();
            }
            
            loadTransactions() {
                const tableBody = document.getElementById('transactionsTableBody');
                tableBody.innerHTML = '';
                
                // Apply filters
                const dateFrom = document.getElementById('transactionFilterDateFrom').value;
                const dateTo = document.getElementById('transactionFilterDateTo').value;
                const methodFilter = document.getElementById('transactionFilterMethod').value;
                const userFilter = document.getElementById('transactionFilterUser').value;
                
                let filteredTransactions = [...this.transactions];
                
                if (dateFrom) {
                    filteredTransactions = filteredTransactions.filter(t => 
                        t.date.split('T')[0] >= dateFrom
                    );
                }
                
                if (dateTo) {
                    filteredTransactions = filteredTransactions.filter(t => 
                        t.date.split('T')[0] <= dateTo
                    );
                }
                
                if (methodFilter !== 'all') {
                    filteredTransactions = filteredTransactions.filter(t => 
                        t.paymentMethod === methodFilter
                    );
                }
                
                if (userFilter !== 'all') {
                    filteredTransactions = filteredTransactions.filter(t => 
                        t.cashier === userFilter
                    );
                }
                
                // Sort by most recent first
                filteredTransactions.sort((a, b) => new Date(b.date) - new Date(a.date));
                
                // Display transactions
                if (filteredTransactions.length === 0) {
                    tableBody.innerHTML = `
                        <tr>
                            <td colspan="7" class="text-center text-muted py-3">Tidak ada transaksi</td>
                        </tr>
                    `;
                    return;
                }
                
                filteredTransactions.forEach(transaction => {
                    const row = document.createElement('tr');
                    
                    row.innerHTML = `
                        <td>${transaction.id}</td>
                        <td>${this.formatDateTime(transaction.date)}</td>
                        <td>${transaction.cashier}</td>
                        <td>${transaction.items.length}</td>
                        <td>${this.formatCurrency(transaction.totalAmount)}</td>
                        <td>${this.formatPaymentMethod(transaction.paymentMethod)}</td>
                        <td>
                            <button class="btn btn-sm btn-outline-primary view-transaction-btn" data-id="${transaction.id}">
                                <i class="fas fa-eye"></i>
                            </button>
                            <button class="btn btn-sm btn-outline-secondary print-transaction-btn" data-id="${transaction.id}">
                                <i class="fas fa-print"></i>
                            </button>
                        </td>
                    `;
                    
                    tableBody.appendChild(row);
                });
                
                // Add event listeners to view buttons
                document.querySelectorAll('.view-transaction-btn').forEach(button => {
                    button.addEventListener('click', () => {
                        const id = button.getAttribute('data-id');
                        this.viewTransactionDetails(id);
                    });
                });
                
                // Add event listeners to print buttons
                document.querySelectorAll('.print-transaction-btn').forEach(button => {
                    button.addEventListener('click', () => {
                        const id = button.getAttribute('data-id');
                        const transaction = this.transactions.find(t => t.id === id);
                        if (transaction) {
                            this.printReceipt(transaction);
                        }
                    });
                });
            }
            
            viewTransactionDetails(id) {
                const transaction = this.transactions.find(t => t.id === id);
                if (!transaction) return;
                
                const modalContent = document.getElementById('transactionModalContent');
                
                // Prepare items table
                let itemsTable = '';
                transaction.items.forEach(item => {
                    itemsTable += `
                        <tr>
                            <td>${item.code}</td>
                            <td>${this.formatTicketType(item.type)}</td>
                            <td class="text-right">${this.formatCurrency(item.price)}</td>
                        </tr>
                    `;
                });
                
                modalContent.innerHTML = `
                    <div class="receipt-header">
                        <div class="receipt-title">Detail Transaksi</div>
                        <div class="receipt-transaction-id">${transaction.id}</div>
                    </div>
                    
                    <div class="row mb-3">
                        <div class="col-md-6">
                            <p><strong>Tanggal:</strong> ${this.formatDateTime(transaction.date)}</p>
                            <p><strong>Kasir:</strong> ${transaction.cashier}</p>
                            <p><strong>Pelanggan:</strong> ${transaction.customerName}</p>
                        </div>
                        <div class="col-md-6">
                            <p><strong>Metode Pembayaran:</strong> ${this.formatPaymentMethod(transaction.paymentMethod)}</p>
                            <p><strong>Total Tiket:</strong> ${transaction.items.length}</p>
                            <p><strong>Status:</strong> <span class="badge bg-success">Selesai</span></p>
                        </div>
                    </div>
                    
                    <h5 class="mb-3">Daftar Tiket</h5>
                    <div class="table-responsive">
                        <table class="table table-striped">
                            <thead>
                                <tr>
                                    <th>Kode</th>
                                    <th>Jenis</th>
                                    <th class="text-right">Harga</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${itemsTable}
                            </tbody>
                            <tfoot>
                                <tr>
                                    <td colspan="2" class="text-end"><strong>Subtotal:</strong></td>
                                    <td class="text-right"><strong>${this.formatCurrency(transaction.totalAmount - transaction.taxAmount)}</strong></td>
                                </tr>
                                ${transaction.taxAmount > 0 ? `
                                <tr>
                                    <td colspan="2" class="text-end"><strong>${this.settings.taxName || 'Pajak'} (${this.settings.taxRate || 0}%):</strong></td>
                                    <td class="text-right"><strong>${this.formatCurrency(transaction.taxAmount)}</strong></td>
                                </tr>
                                ` : ''}
                                <tr>
                                    <td colspan="2" class="text-end"><strong>Total:</strong></td>
                                    <td class="text-right"><strong>${this.formatCurrency(transaction.totalAmount)}</strong></td>
                                </tr>
                                <tr>
                                    <td colspan="2" class="text-end"><strong>Dibayar:</strong></td>
                                    <td class="text-right"><strong>${this.formatCurrency(transaction.amountPaid)}</strong></td>
                                </tr>
                                <tr>
                                    <td colspan="2" class="text-end"><strong>Kembalian:</strong></td>
                                    <td class="text-right"><strong>${this.formatCurrency(transaction.changeAmount)}</strong></td>
                                </tr>
                            </tfoot>
                        </table>
                    </div>
                `;
                
                // Show modal
                const modal = new bootstrap.Modal(document.getElementById('viewTransactionModal'));
                modal.show();
                
                // Set print button handler
                document.getElementById('printTransactionBtn').onclick = () => {
                    this.printReceipt(transaction);
                };
            }
            
            loadUsers() {
                const tableBody = document.getElementById('usersTableBody');
                tableBody.innerHTML = '';
                
                // Sort users by role (admin first) then by username
                const sortedUsers = [...this.users].sort((a, b) => {
                    if (a.role === b.role) {
                        return a.username.localeCompare(b.username);
                    }
                    return this.userRoles.indexOf(a.role) - this.userRoles.indexOf(b.role);
                });
                
                sortedUsers.forEach(user => {
                    const row = document.createElement('tr');
                    
                    // Determine status badge
                    const statusBadge = user.status === 'active' ? 
                        '<span class="badge bg-success">Aktif</span>' : 
                        '<span class="badge bg-secondary">Nonaktif</span>';
                    
                    // Determine role badge
                    let roleBadge;
                    switch (user.role) {
                        case 'admin':
                            roleBadge = '<span class="badge bg-danger">Admin</span>';
                            break;
                        case 'manager':
                            roleBadge = '<span class="badge bg-warning text-dark">Manager</span>';
                            break;
                        case 'cashier':
                            roleBadge = '<span class="badge bg-primary">Kasir</span>';
                            break;
                        default:
                            roleBadge = '<span class="badge bg-secondary">Unknown</span>';
                    }
                    
                    row.innerHTML = `
                        <td>${user.username}</td>
                        <td>${user.fullName}</td>
                        <td>${roleBadge}</td>
                        <td>${statusBadge}</td>
                        <td>${user.lastLogin ? this.formatDateTime(user.lastLogin) : 'Belum pernah login'}</td>
                        <td>
                            <button class="btn btn-sm btn-outline-primary edit-user-btn" data-id="${user.id}">
                                <i class="fas fa-edit"></i>
                            </button>
                            ${user.id !== this.currentUser.id ? `
                            <button class="btn btn-sm btn-outline-danger delete-user-btn" data-id="${user.id}">
                                <i class="fas fa-trash"></i>
                            </button>
                            ` : ''}
                        </td>
                    `;
                    
                    tableBody.appendChild(row);
                });
                
                // Add event listeners to edit buttons
                document.querySelectorAll('.edit-user-btn').forEach(button => {
                    button.addEventListener('click', () => {
                        const id = parseInt(button.getAttribute('data-id'));
                        this.editUser(id);
                    });
                });
                
                // Add event listeners to delete buttons
                document.querySelectorAll('.delete-user-btn').forEach(button => {
                    button.addEventListener('click', () => {
                        const id = parseInt(button.getAttribute('data-id'));
                        this.confirmDeleteUser(id);
                    });
                });
            }
            
            editUser(id) {
                const user = this.users.find(u => u.id === id);
                if (!user) return;
                
                // Fill form
                document.getElementById('editUserId').value = user.id;
                document.getElementById('editUsername').value = user.username;
                document.getElementById('editFullName').value = user.fullName;
                document.getElementById('editUserRole').value = user.role;
                document.getElementById('editUserStatus').value = user.status;
                document.getElementById('editUserPassword').value = '';
                
                // Show modal
                const modal = new bootstrap.Modal(document.getElementById('editUserModal'));
                modal.show();
            }
            
            confirmDeleteUser(id) {
                const user = this.users.find(u => u.id === id);
                if (!user) return;
                
                // Set confirmation modal content
                document.getElementById('confirmationModalTitle').textContent = 'Konfirmasi Hapus Pengguna';
                document.getElementById('confirmationModalBody').innerHTML = `
                    <p>Anda yakin ingin menghapus pengguna <strong>${user.username}</strong>?</p>
                    <p class="text-danger">Tindakan ini tidak dapat dibatalkan!</p>
                `;
                
                // Set confirm button action
                document.getElementById('confirmActionBtn').onclick = () => {
                    this.deleteUser(id);
                    const modal = bootstrap.Modal.getInstance(document.getElementById('confirmationModal'));
                    if (modal) modal.hide();
                };
                
                // Show modal
                const modal = new bootstrap.Modal(document.getElementById('confirmationModal'));
                modal.show();
            }
            
            deleteUser(id) {
                // Don't allow deleting self
                if (id === this.currentUser.id) {
                    this.showToast('Error', 'Tidak dapat menghapus akun sendiri', 'error');
                    return;
                }
                
                // Find user index
                const index = this.users.findIndex(u => u.id === id);
                if (index === -1) return;
                
                // Remove user
                const deletedUser = this.users.splice(index, 1)[0];
                
                // Save data
                this.saveData();
                
                // Log activity
                this.logActivity(
                    'Hapus Pengguna',
                    `Menghapus pengguna ${deletedUser.username}`,
                    this.currentUser.username
                );
                
                // Show success message
                this.showToast('Berhasil', `Pengguna ${deletedUser.username} dihapus`, 'success');
                
                // Reload users
                this.loadUsers();
            }
            
            loadSettings() {
                // Load venue info
                document.getElementById('venueName').value = this.settings.venueName || '';
                document.getElementById('venueLocation').value = this.settings.venueLocation || '';
                document.getElementById('venueDescription').value = this.settings.venueDescription || '';
                document.getElementById('venueLogo').value = this.settings.venueLogo || '';
                
                // Load system settings
                document.getElementById('currency').value = this.settings.currency || 'IDR';
                document.getElementById('dateFormat').value = this.settings.dateFormat || 'DD-MM-YYYY';
                document.getElementById('timeFormat').value = this.settings.timeFormat || '24';
                
                // Load tax settings
                document.getElementById('enableTax').checked = this.settings.enableTax || false;
                document.getElementById('taxRate').value = this.settings.taxRate || 10;
                document.getElementById('taxName').value = this.settings.taxName || 'PPN';
                this.toggleTaxSettings();
                
                // Load receipt footer settings
                document.getElementById('enableReceiptFooter').checked = this.settings.enableReceiptFooter !== false;
                document.getElementById('receiptFooterText').value = this.settings.receiptFooterText || 'Terima kasih telah berkunjung!';
                this.toggleReceiptFooterSettings();
                
                // Add event listeners to toggle switches
                document.getElementById('enableTax').addEventListener('change', () => {
                    this.toggleTaxSettings();
                });
                
                document.getElementById('enableReceiptFooter').addEventListener('change', () => {
                    this.toggleReceiptFooterSettings();
                });
            }
            
            toggleTaxSettings() {
                const enableTax = document.getElementById('enableTax').checked;
                document.getElementById('taxSettings').style.display = enableTax ? 'block' : 'none';
            }
            
            toggleReceiptFooterSettings() {
                const enableFooter = document.getElementById('enableReceiptFooter').checked;
                document.getElementById('receiptFooterSettings').style.display = enableFooter ? 'block' : 'none';
            }
            
            saveSettings() {
                // Save venue info
                this.settings.venueName = document.getElementById('venueName').value;
                this.settings.venueLocation = document.getElementById('venueLocation').value;
                this.settings.venueDescription = document.getElementById('venueDescription').value;
                this.settings.venueLogo = document.getElementById('venueLogo').value;
                
                // Save system settings
                this.settings.currency = document.getElementById('currency').value;
                this.settings.dateFormat = document.getElementById('dateFormat').value;
                this.settings.timeFormat = document.getElementById('timeFormat').value;
                
                // Save tax settings
                this.settings.enableTax = document.getElementById('enableTax').checked;
                this.settings.taxRate = parseFloat(document.getElementById('taxRate').value) || 0;
                this.settings.taxName = document.getElementById('taxName').value;
                
                // Save receipt footer settings
                this.settings.enableReceiptFooter = document.getElementById('enableReceiptFooter').checked;
                this.settings.receiptFooterText = document.getElementById('receiptFooterText').value;
                
                // Save data
                this.saveData();
                
                // Update date format
                this.setDateFormat();
                
                // Show success message
                this.showToast('Berhasil', 'Pengaturan berhasil disimpan', 'success');
            }
            
            logActivity(title, description, user) {
                const activity = {
                    id: new Date().getTime(),
                    title,
                    description,
                    user,
                    timestamp: new Date().toISOString()
                };
                
                this.activities.unshift(activity);
                
                // Keep only the last 100 activities
                if (this.activities.length > 100) {
                    this.activities = this.activities.slice(0, 100);
                }
                
                // Save data
                this.saveData();
            }
            
            showLoading(show) {
                const loadingOverlay = document.getElementById('loadingOverlay');
                loadingOverlay.style.display = show ? 'flex' : 'none';
            }
            
            formatCurrency(amount) {
                const currency = this.settings.currency || 'IDR';
                amount = parseFloat(amount) || 0;
                
                switch (currency) {
                    case 'IDR':
                        return 'Rp ' + amount.toLocaleString('id-ID');
                    case 'USD':
                        return '$ ' + amount.toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
                    case 'EUR':
                        return 'â‚¬ ' + amount.toLocaleString('de-DE', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
                    case 'SGD':
                        return 'S$ ' + amount.toLocaleString('en-SG', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
                    default:
                        return amount.toLocaleString();
                }
            }
            
            formatDateTime(dateString) {
                const date = new Date(dateString);
                if (isNaN(date.getTime())) return '-';
                
                const format = this.settings.dateFormat || 'DD-MM-YYYY';
                const timeFormat = this.settings.timeFormat === '12' ? '12' : '24';
                
                // Format date
                let day = date.getDate().toString().padStart(2, '0');
                let month = (date.getMonth() + 1).toString().padStart(2, '0');
                let year = date.getFullYear();
                
                let formattedDate;
                switch (format) {
                    case 'DD-MM-YYYY':
                        formattedDate = `${day}-${month}-${year}`;
                        break;
                    case 'YYYY-MM-DD':
                        formattedDate = `${year}-${month}-${day}`;
                        break;
                    case 'MM/DD/YYYY':
                        formattedDate = `${month}/${day}/${year}`;
                        break;
                    default:
                        formattedDate = `${day}-${month}-${year}`;
                }
                
                // Format time
                let hours = date.getHours();
                let minutes = date.getMinutes().toString().padStart(2, '0');
                
                let ampm = '';
                if (timeFormat === '12') {
                    ampm = hours >= 12 ? ' PM' : ' AM';
                    hours = hours % 12;
                    hours = hours ? hours : 12; // the hour '0' should be '12'
                }
                
                hours = hours.toString().padStart(2, '0');
                
                return `${formattedDate} ${hours}:${minutes}${ampm}`;
            }
            
            formatDisplayDate(dateString) {
                const format = this.settings.dateFormat || 'DD-MM-YYYY';
                const date = new Date(dateString);
                if (isNaN(date.getTime())) return '-';
                
                let day = date.getDate().toString().padStart(2, '0');
                let month = (date.getMonth() + 1).toString().padStart(2, '0');
                let year = date.getFullYear();
                
                switch (format) {
                    case 'DD-MM-YYYY':
                        return `${day}-${month}-${year}`;
                    case 'YYYY-MM-DD':
                        return `${year}-${month}-${day}`;
                    case 'MM/DD/YYYY':
                        return `${month}/${day}/${year}`;
                    default:
                        return `${day}-${month}-${year}`;
                }
            }
            
            formatTicketType(type) {
                switch (type) {
                    case 'regular':
                        return 'Regular';
                    case 'vip':
                        return 'VIP';
                    case 'family':
                        return 'Family Package';
                    case 'group':
                        return 'Group';
                    default:
                        return type;
                }
            }
            
            formatTicketStatus(status) {
                switch (status) {
                    case 'available':
                        return '<span class="badge bg-success">Tersedia</span>';
                    case 'sold':
                        return '<span class="badge bg-primary">Terjual</span>';
                    case 'expired':
                        return '<span class="badge bg-danger">Kedaluwarsa</span>';
                    default:
                        return '<span class="badge bg-secondary">Unknown</span>';
                }
            }
            
            formatPaymentMethod(method) {
                switch (method) {
                    case 'cash':
                        return 'Tunai';
                    case 'debit':
                        return 'Kartu Debit';
                    case 'credit':
                        return 'Kartu Kredit';
                    case 'transfer':
                        return 'Transfer Bank';
                    case 'ewallet':
                        return 'E-Wallet';
                    default:
                        return method;
                }
            }
        }
    </script>
</body>
</html>
