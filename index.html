<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TourTick - Sistem Karcis Pariwisata</title>
    <script src="https://cdn.jsdelivr.net/npm/jsbarcode@3.11.5/dist/JsBarcode.all.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root {
            --primary-color: #3498db;
            --secondary-color: #2980b9;
            --accent-color: #e74c3c;
            --light-color: #ecf0f1;
            --dark-color: #2c3e50;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: #f5f5f5;
            color: #333;
        }
        
        .sidebar {
            background-color: var(--dark-color);
            color: white;
            height: 100vh;
            position: fixed;
            transition: all 0.3s;
            overflow-y: auto;
        }
        
        .sidebar .nav-link {
            color: rgba(255, 255, 255, 0.8);
            border-radius: 5px;
            margin: 5px 0;
            transition: all 0.2s;
        }
        
        .sidebar .nav-link:hover {
            background-color: rgba(255, 255, 255, 0.1);
            color: white;
        }
        
        .sidebar .nav-link.active {
            background-color: var(--primary-color);
            color: white;
        }
        
        .main-content {
            margin-left: 250px;
            padding: 20px;
            transition: all 0.3s;
        }
        
        .card {
            border-radius: 10px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            margin-bottom: 20px;
            border: none;
        }
        
        .card-header {
            background-color: var(--primary-color);
            color: white;
            border-radius: 10px 10px 0 0 !important;
            padding: 12px 20px;
        }
        
        .btn-primary {
            background-color: var(--primary-color);
            border-color: var(--primary-color);
        }
        
        .btn-primary:hover {
            background-color: var(--secondary-color);
            border-color: var(--secondary-color);
        }
        
        .btn-danger {
            background-color: var(--accent-color);
            border-color: var(--accent-color);
        }
        
        .ticket {
            border: 2px dashed #ccc;
            padding: 15px;
            margin: 10px 0;
            background-color: white;
            border-radius: 10px;
        }
        
        .barcode-container {
            text-align: center;
            margin: 15px 0;
        }
        
        /* Responsive styles */
        @media (max-width: 992px) {
            .sidebar {
                width: 100%;
                height: auto;
                position: relative;
                padding: 10px;
            }
            .main-content {
                margin-left: 0;
                padding: 15px;
            }
        }
        
        @media (max-width: 768px) {
            .row > div {
                margin-bottom: 15px;
            }
            .d-flex.justify-content-between {
                flex-direction: column;
            }
            .d-flex.justify-content-between > * {
                margin-bottom: 10px;
            }
            .card-body {
                padding: 15px;
            }
        }
        
        .search-box {
            position: relative;
        }
        
        .search-box i {
            position: absolute;
            top: 10px;
            left: 10px;
            color: #aaa;
        }
        
        .search-box input {
            padding-left: 35px;
        }
        
        .ticket-preview {
            background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 20px;
        }
        
        .user-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background-color: var(--primary-color);
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
        }
        
        /* Receipt styles */
        .receipt {
            width: 100%;
            max-width: 400px;
            margin: 0 auto;
            font-family: 'Courier New', monospace;
            padding: 15px;
            background-color: white;
        }
        
        .receipt .header {
            text-align: center;
            margin-bottom: 10px;
        }
        
        .receipt .divider {
            border-top: 1px dashed #000;
            margin: 10px 0;
        }
        
        .receipt .item {
            display: flex;
            justify-content: space-between;
            margin-bottom: 5px;
        }
        
        .receipt .footer {
            text-align: center;
            margin-top: 15px;
            font-size: 0.9em;
        }
        
        .receipt-barcode {
            text-align: center;
            margin: 10px 0;
        }
        
        /* Permission settings */
        .permission-group {
            border: 1px solid #ddd;
            border-radius: 5px;
            padding: 10px;
            margin-bottom: 15px;
        }
        
        .permission-group h6 {
            border-bottom: 1px solid #eee;
            padding-bottom: 5px;
            margin-bottom: 10px;
        }
        
        .permission-item {
            margin-bottom: 8px;
        }
        
        /* Status badges */
        .badge-valid {
            background-color: #28a745;
        }
        
        .badge-used {
            background-color: #17a2b8;
        }
        
        .badge-expired {
            background-color: #dc3545;
        }
        
        /* Access denied */
        .access-denied {
            text-align: center;
            padding: 50px 20px;
        }
        
        .access-denied i {
            font-size: 80px;
            color: var(--accent-color);
            margin-bottom: 20px;
        }
        
        /* Loading spinner */
        .loading-spinner {
            display: inline-block;
            width: 2rem;
            height: 2rem;
            vertical-align: text-bottom;
            border: 0.25em solid currentColor;
            border-right-color: transparent;
            border-radius: 50%;
            animation: spinner-border .75s linear infinite;
        }
        
        @keyframes spinner-border {
            to { transform: rotate(360deg); }
        }
    </style>
</head>
<body>
    <!-- Login Modal -->
    <div class="modal fade" id="loginModal" tabindex="-1" aria-hidden="false" data-bs-backdrop="static" data-bs-keyboard="false">
        <div class="modal-dialog login-modal">
            <div class="modal-content">
                <div class="modal-body p-4">
                    <div class="login-logo">
                        <i class="fas fa-ticket-alt"></i>
                        <h3>TourTick</h3>
                        <p class="text-muted">Sistem Karcis Pariwisata</p>
                    </div>
                    <form id="loginForm">
                        <div class="mb-3">
                            <label class="form-label">Username</label>
                            <input type="text" class="form-control" id="loginUsername" required>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Password</label>
                            <input type="password" class="form-control" id="loginPassword" required>
                        </div>
                        <button type="submit" class="btn btn-primary w-100">
                            <i class="fas fa-sign-in-alt me-1"></i> Login
                        </button>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <!-- Main App (hidden until login) -->
    <div id="appContainer" style="display: none;">
        <div class="d-flex flex-column flex-lg-row">
            <!-- Sidebar -->
            <div class="sidebar p-3" style="width: 250px;">
                <div class="text-center mb-4">
                    <h4>TourTick</h4>
                    <p class="text-muted">Sistem Karcis Pariwisata</p>
                </div>
                <hr>
                <ul class="nav flex-column">
                    <li class="nav-item">
                        <a class="nav-link active" href="#" onclick="showSection('dashboard')">
                            <i class="fas fa-home me-2"></i> Dashboard
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="#" onclick="showSection('ticket-sales')">
                            <i class="fas fa-ticket-alt me-2"></i> Penjualan Karcis
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="#" onclick="showSection('generate-ticket')">
                            <i class="fas fa-barcode me-2"></i> Generate Karcis
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="#" onclick="showSection('ticket-list')">
                            <i class="fas fa-list me-2"></i> Daftar Karcis
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="#" onclick="showSection('reports')">
                            <i class="fas fa-chart-bar me-2"></i> Laporan
                        </a>
                    </li>
                    <li class="nav-item" id="products-menu-item" style="display: none;">
                        <a class="nav-link" href="#" onclick="showSection('products')">
                            <i class="fas fa-map-marked-alt me-2"></i> Produk Wisata
                        </a>
                    </li>
                    <li class="nav-item" id="users-menu-item" style="display: none;">
                        <a class="nav-link" href="#" onclick="showSection('users')">
                            <i class="fas fa-users me-2"></i> Pengguna
                        </a>
                    </li>
                    <li class="nav-item" id="settings-menu-item" style="display: none;">
                        <a class="nav-link" href="#" onclick="showSection('settings')">
                            <i class="fas fa-cog me-2"></i> Pengaturan
                        </a>
                    </li>
                </ul>
                <div class="mt-auto pt-3">
                    <div class="d-flex align-items-center">
                        <div class="user-avatar me-2" id="userAvatar">AD</div>
                        <div>
                            <small class="d-block" id="userName">Admin</small>
                            <small class="text-muted" id="userRole">Super User</small>
                        </div>
                    </div>
                    <button class="btn btn-sm btn-danger w-100 mt-3" onclick="logout()">
                        <i class="fas fa-sign-out-alt me-1"></i> Logout
                    </button>
                </div>
            </div>

            <!-- Main Content -->
            <div class="main-content">
                <!-- Dashboard Section -->
                <div id="dashboard-section">
                    <div class="d-flex justify-content-between align-items-center mb-4">
                        <h3>Dashboard</h3>
                        <div class="d-flex">
                            <div class="search-box me-2">
                                <i class="fas fa-search"></i>
                                <input type="text" class="form-control" placeholder="Cari...">
                            </div>
                            <button class="btn btn-primary" onclick="refreshDashboard()">
                                <i class="fas fa-sync-alt me-1"></i> Refresh
                            </button>
                        </div>
                    </div>

                    <div class="row">
                        <div class="col-md-3">
                            <div class="card">
                                <div class="card-body">
                                    <div class="d-flex justify-content-between align-items-center">
                                        <div>
                                            <h6 class="text-muted">Penjualan Hari Ini</h6>
                                            <h3 id="todaySales">0</h3>
                                            <span class="text-success"><i class="fas fa-arrow-up me-1"></i> 0%</span>
                                        </div>
                                        <div class="bg-primary bg-opacity-10 p-3 rounded">
                                            <i class="fas fa-shopping-cart text-primary"></i>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="card">
                                <div class="card-body">
                                    <div class="d-flex justify-content-between align-items-center">
                                        <div>
                                            <h6 class="text-muted">Pendapatan Hari Ini</h6>
                                            <h3 id="todayRevenue">Rp0</h3>
                                            <span class="text-success"><i class="fas fa-arrow-up me-1"></i> 0%</span>
                                        </div>
                                        <div class="bg-success bg-opacity-10 p-3 rounded">
                                            <i class="fas fa-wallet text-success"></i>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="card">
                                <div class="card-body">
                                    <div class="d-flex justify-content-between align-items-center">
                                        <div>
                                            <h6 class="text-muted">Pengunjung Hari Ini</h6>
                                            <h3 id="todayVisitors">0</h3>
                                            <span class="text-danger"><i class="fas fa-arrow-down me-1"></i> 0%</span>
                                        </div>
                                        <div class="bg-info bg-opacity-10 p-3 rounded">
                                            <i class="fas fa-users text-info"></i>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="card">
                                <div class="card-body">
                                    <div class="d-flex justify-content-between align-items-center">
                                        <div>
                                            <h6 class="text-muted">Karcis Tersedia</h6>
                                            <h3 id="availableTickets">0</h3>
                                            <span class="text-warning"><i class="fas fa-exclamation-circle me-1"></i> Low</span>
                                        </div>
                                        <div class="bg-warning bg-opacity-10 p-3 rounded">
                                            <i class="fas fa-ticket-alt text-warning"></i>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="row mt-4">
                        <div class="col-md-8">
                            <div class="card">
                                <div class="card-header">
                                    <h5 class="card-title mb-0">Statistik Penjualan 7 Hari Terakhir</h5>
                                </div>
                                <div class="card-body">
                                    <canvas id="salesChart" height="250"></canvas>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="card">
                                <div class="card-header">
                                    <h5 class="card-title mb-0">Produk Terlaris</h5>
                                </div>
                                <div class="card-body">
                                    <canvas id="topProductsChart" height="250"></canvas>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="row mt-4">
                        <div class="col-md-6">
                            <div class="card">
                                <div class="card-header">
                                    <h5 class="card-title mb-0">Transaksi Terakhir</h5>
                                </div>
                                <div class="card-body p-0">
                                    <div class="table-responsive">
                                        <table class="table table-hover mb-0">
                                            <thead>
                                                <tr>
                                                    <th>ID</th>
                                                    <th>Tanggal</th>
                                                    <th>Jumlah</th>
                                                    <th>Status</th>
                                                </tr>
                                            </thead>
                                            <tbody id="recentTransactions">
                                                <!-- Transactions will be loaded here -->
                                            </tbody>
                                        </table>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="card">
                                <div class="card-header">
                                    <h5 class="card-title mb-0">Aktivitas Terkini</h5>
                                </div>
                                <div class="card-body p-0">
                                    <div class="list-group list-group-flush" id="recentActivities">
                                        <!-- Activities will be loaded here -->
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Ticket Sales Section -->
                <div id="ticket-sales-section" style="display: none;">
                    <div class="d-flex justify-content-between align-items-center mb-4">
                        <h3>Penjualan Karcis</h3>
                        <div>
                            <button class="btn btn-primary me-2" onclick="printTicket()">
                                <i class="fas fa-print me-1"></i> Cetak
                            </button>
                            <button class="btn btn-success" onclick="completeTransaction()">
                                <i class="fas fa-check me-1"></i> Selesaikan Transaksi
                            </button>
                        </div>
                    </div>

                    <div class="row">
                        <div class="col-lg-8">
                            <div class="card">
                                <div class="card-header">
                                    <div class="d-flex justify-content-between align-items-center">
                                        <h5 class="card-title mb-0">Karcis Tersedia</h5>
                                        <div class="search-box">
                                            <i class="fas fa-search"></i>
                                            <input type="text" class="form-control form-control-sm" placeholder="Cari karcis..." id="ticketSearchSales" onkeyup="searchTicketsSales()">
                                        </div>
                                    </div>
                                </div>
                                <div class="card-body">
                                    <div class="table-responsive">
                                        <table class="table table-hover">
                                            <thead>
                                                <tr>
                                                    <th>Kode</th>
                                                    <th>Destinasi</th>
                                                    <th>Jenis</th>
                                                    <th>Harga</th>
                                                    <th>Tanggal Berlaku</th>
                                                    <th>Aksi</th>
                                                </tr>
                                            </thead>
                                            <tbody id="availableTicketsTable">
                                                <!-- Available tickets will be loaded here -->
                                            </tbody>
                                        </table>
                                    </div>
                                </div>
                            </div>

                            <div class="card mt-4">
                                <div class="card-header">
                                    <h5 class="card-title mb-0">Preview Karcis</h5>
                                </div>
                                <div class="card-body">
                                    <div class="ticket-preview text-center" id="ticketPreviewContent">
                                        <h4>Taman Wisata Alam</h4>
                                        <p>Jl. Raya Wisata No. 123, Kota Pariwisata</p>
                                        <hr>
                                        <div class="barcode-container">
                                            <svg id="barcode-preview"></svg>
                                        </div>
                                        <div class="d-flex justify-content-between">
                                            <div class="text-start">
                                                <small class="text-muted">Kode Karcis</small>
                                                <p class="mb-0 fw-bold">TWA-001</p>
                                            </div>
                                            <div class="text-end">
                                                <small class="text-muted">Tanggal</small>
                                                <p class="mb-0 fw-bold">10 Jun 2023</p>
                                            </div>
                                        </div>
                                        <hr>
                                        <div class="d-flex justify-content-between">
                                            <div class="text-start">
                                                <small class="text-muted">Harga</small>
                                                <p class="mb-0 fw-bold">Rp50.000</p>
                                            </div>
                                            <div class="text-end">
                                                <small class="text-muted">Status</small>
                                                <p class="mb-0 fw-bold text-success">Valid</p>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="col-lg-4">
                            <div class="card">
                                <div class="card-header">
                                    <h5 class="card-title mb-0">Keranjang Belanja</h5>
                                </div>
                                <div class="card-body">
                                    <div class="table-responsive">
                                        <table class="table table-sm">
                                            <thead>
                                                <tr>
                                                    <th>Karcis</th>
                                                    <th>Harga</th>
                                                    <th></th>
                                                </tr>
                                            </thead>
                                            <tbody id="cartItems">
                                                <!-- Cart items will be loaded here -->
                                            </tbody>
                                        </table>
                                    </div>
                                    <hr>
                                    <div class="d-flex justify-content-between mb-3 fw-bold">
                                        <span>Total:</span>
                                        <span id="total">Rp0</span>
                                    </div>
                                    <div class="mb-3">
                                        <label class="form-label">Pembayaran</label>
                                        <select class="form-select" id="paymentMethod" onchange="updatePaymentMethod()">
                                            <option value="cash">Tunai</option>
                                            <option value="transfer">Transfer Bank</option>
                                            <option value="qris">QRIS</option>
                                            <option value="debit">Kartu Debit</option>
                                        </select>
                                    </div>
                                    <div class="mb-3" id="cashInputContainer">
                                        <label class="form-label">Uang Diterima</label>
                                        <input type="number" class="form-control" id="cashReceived" min="0" value="0" oninput="updateChangeAmount()">
                                    </div>
                                    <div class="mb-3">
                                        <label class="form-label">Kembalian</label>
                                        <input type="text" class="form-control" id="changeAmount" readonly value="Rp0">
                                    </div>
                                    <button class="btn btn-danger w-100 mb-2" onclick="clearCart()">
                                        <i class="fas fa-trash me-1"></i> Kosongkan Keranjang
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Generate Ticket Section -->
                <div id="generate-ticket-section" style="display: none;">
                    <div class="d-flex justify-content-between align-items-center mb-4">
                        <h3>Generate Karcis</h3>
                        <div>
                            <button class="btn btn-primary me-2" onclick="generateBarcode()">
                                <i class="fas fa-barcode me-1"></i> Generate Barcode
                            </button>
                            <button class="btn btn-success" onclick="printGeneratedTicket()">
                                <i class="fas fa-print me-1"></i> Cetak Karcis
                            </button>
                        </div>
                    </div>

                    <div class="row">
                        <div class="col-md-6">
                            <div class="card">
                                <div class="card-header">
                                    <h5 class="card-title mb-0">Form Karcis</h5>
                                </div>
                                <div class="card-body">
                                    <form id="ticketForm">
                                        <div class="mb-3">
                                            <label class="form-label">Jenis Karcis</label>
                                            <select class="form-select" id="ticketType" required onchange="updateTicketCode()">
                                                <option value="">Pilih Jenis Karcis</option>
                                                <option value="regular">Reguler</option>
                                                <option value="vip">VIP</option>
                                                <option value="group">Grup</option>
                                                <option value="student">Pelajar/Mahasiswa</option>
                                                <option value="foreigner">Warga Asing</option>
                                            </select>
                                        </div>
                                        <div class="mb-3">
                                            <label class="form-label">Destinasi Wisata</label>
                                            <select class="form-select" id="destination" required onchange="updateDestinationDetails()">
                                                <option value="">Pilih Destinasi</option>
                                                <!-- Options will be loaded from products -->
                                            </select>
                                        </div>
                                        <div class="mb-3">
                                            <label class="form-label">Harga</label>
                                            <input type="number" class="form-control" id="ticketPrice" required>
                                        </div>
                                        <div class="mb-3">
                                            <label class="form-label">Jumlah Karcis</label>
                                            <input type="number" class="form-control" id="ticketQuantity" min="1" value="1" required>
                                        </div>
                                        <div class="mb-3">
                                            <label class="form-label">Tanggal Berlaku</label>
                                            <input type="date" class="form-control" id="validDate" required>
                                        </div>
                                        <div class="mb-3 form-check">
                                            <input type="checkbox" class="form-check-input" id="includeTax">
                                            <label class="form-check-label" for="includeTax">Termasuk Pajak</label>
                                        </div>
                                        <button type="submit" class="btn btn-primary w-100" onclick="saveTicket(event)">
                                            <i class="fas fa-save me-1"></i> Simpan Karcis
                                        </button>
                                    </form>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="card">
                                <div class="card-header">
                                    <h5 class="card-title mb-0">Preview Karcis</h5>
                                </div>
                                <div class="card-body">
                                    <div class="ticket-preview text-center" id="ticketPreview">
                                        <h4 id="previewDestination">Taman Wisata Alam</h4>
                                        <p id="previewAddress">Jl. Raya Wisata No. 123, Kota Pariwisata</p>
                                        <hr>
                                        <div class="barcode-container">
                                            <svg id="barcode"></svg>
                                        </div>
                                        <div class="d-flex justify-content-between">
                                            <div class="text-start">
                                                <small class="text-muted">Jenis</small>
                                                <p class="mb-0 fw-bold" id="previewType">Reguler</p>
                                            </div>
                                            <div class="text-end">
                                                <small class="text-muted">Kode</small>
                                                <p class="mb-0 fw-bold" id="previewCode">TWA-001</p>
                                            </div>
                                        </div>
                                        <hr>
                                        <div class="d-flex justify-content-between">
                                            <div class="text-start">
                                                <small class="text-muted">Tanggal</small>
                                                <p class="mb-0 fw-bold" id="previewDate">10 Jun 2023</p>
                                            </div>
                                            <div class="text-end">
                                                <small class="text-muted">Harga</small>
                                                <p class="mb-0 fw-bold" id="previewPrice">Rp50.000</p>
                                            </div>
                                        </div>
                                        <div class="mt-3">
                                            <small class="text-muted">Status</small>
                                            <p class="mb-0 fw-bold text-success" id="previewStatus">Belum Digunakan</p>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Ticket List Section -->
                <div id="ticket-list-section" style="display: none;">
                    <div class="d-flex justify-content-between align-items-center mb-4">
                        <h3>Daftar Karcis</h3>
                        <div>
                            <button class="btn btn-primary me-2" onclick="exportTickets()">
                                <i class="fas fa-file-export me-1"></i> Export
                            </button>
                            <button class="btn btn-success" onclick="showImportModal()">
                                <i class="fas fa-file-import me-1"></i> Import
                            </button>
                        </div>
                    </div>

                    <div class="card">
                        <div class="card-header">
                            <div class="d-flex justify-content-between align-items-center">
                                <h5 class="card-title mb-0">Daftar Karcis</h5>
                                <div class="d-flex">
                                    <div class="search-box me-2">
                                        <i class="fas fa-search"></i>
                                        <input type="text" class="form-control form-control-sm" placeholder="Cari karcis..." id="ticketSearch" onkeyup="searchTickets()">
                                    </div>
                                    <select class="form-select form-select-sm" style="width: 150px;" id="ticketFilter" onchange="filterTickets()">
                                        <option value="all">Semua Status</option>
                                        <option value="valid">Valid</option>
                                        <option value="used">Digunakan</option>
                                        <option value="expired">Kadaluarsa</option>
                                    </select>
                                </div>
                            </div>
                        </div>
                        <div class="card-body">
                            <div class="table-responsive">
                                <table class="table table-hover">
                                    <thead>
                                        <tr>
                                            <th>Kode</th>
                                            <th>Destinasi</th>
                                            <th>Jenis</th>
                                            <th>Harga</th>
                                            <th>Tanggal</th>
                                            <th>Status</th>
                                            <th>Aksi</th>
                                        </tr>
                                    </thead>
                                    <tbody id="ticketTableBody">
                                        <!-- Tickets will be loaded here -->
                                    </tbody>
                                </table>
                            </div>
                            <nav aria-label="Page navigation" class="mt-3">
                                <ul class="pagination justify-content-center">
                                    <li class="page-item disabled">
                                        <a class="page-link" href="#" tabindex="-1">Previous</a>
                                    </li>
                                    <li class="page-item active"><a class="page-link" href="#">1</a></li>
                                    <li class="page-item"><a class="page-link" href="#">2</a></li>
                                    <li class="page-item"><a class="page-link" href="#">3</a></li>
                                    <li class="page-item">
                                        <a class="page-link" href="#">Next</a>
                                    </li>
                                </ul>
                            </nav>
                        </div>
                    </div>
                </div>

                <!-- Reports Section -->
                <div id="reports-section" style="display: none;">
                    <div class="d-flex justify-content-between align-items-center mb-4">
                        <h3>Laporan</h3>
                        <div>
                            <button class="btn btn-primary me-2" onclick="generateDailyReport()">
                                <i class="fas fa-file-pdf me-1"></i> Cetak Laporan
                            </button>
                            <button class="btn btn-success" onclick="exportReportData()">
                                <i class="fas fa-file-excel me-1"></i> Export Data
                            </button>
                        </div>
                    </div>

                    <div class="card">
                        <div class="card-header">
                            <h5 class="card-title mb-0">Filter Laporan</h5>
                        </div>
                        <div class="card-body">
                            <div class="row">
                                <div class="col-md-3">
                                    <div class="mb-3">
                                        <label class="form-label">Tanggal Mulai</label>
                                        <input type="date" class="form-control" id="reportStartDate">
                                    </div>
                                </div>
                                <div class="col-md-3">
                                    <div class="mb-3">
                                        <label class="form-label">Tanggal Akhir</label>
                                        <input type="date" class="form-control" id="reportEndDate">
                                    </div>
                                </div>
                                <div class="col-md-3">
                                    <div class="mb-3">
                                        <label class="form-label">Jenis Karcis</label>
                                        <select class="form-select" id="reportTicketType">
                                            <option value="all">Semua Jenis</option>
                                            <option value="regular">Reguler</option>
                                            <option value="vip">VIP</option>
                                            <option value="group">Grup</option>
                                            <option value="student">Pelajar/Mahasiswa</option>
                                            <option value="foreigner">Warga Asing</option>
                                        </select>
                                    </div>
                                </div>
                                <div class="col-md-3">
                                    <div class="mb-3">
                                        <label class="form-label">Destinasi</label>
                                        <select class="form-select" id="reportDestination">
                                            <option value="all">Semua Destinasi</option>
                                            <!-- Options will be loaded from products -->
                                        </select>
                                    </div>
                                </div>
                            </div>
                            <button class="btn btn-primary" onclick="loadReportData()">
                                <i class="fas fa-filter me-1"></i> Filter Data
                            </button>
                        </div>
                    </div>

                    <div class="card mt-4">
                        <div class="card-header">
                            <h5 class="card-title mb-0">Statistik Penjualan</h5>
                        </div>
                        <div class="card-body">
                            <canvas id="reportChart" height="300"></canvas>
                        </div>
                    </div>

                    <div class="card mt-4">
                        <div class="card-header">
                            <h5 class="card-title mb-0">Detail Transaksi</h5>
                        </div>
                        <div class="card-body">
                            <div class="table-responsive">
                                <table class="table table-hover">
                                    <thead>
                                        <tr>
                                            <th>ID Transaksi</th>
                                            <th>Tanggal</th>
                                            <th>Karcis</th>
                                            <th>Jumlah</th>
                                            <th>Harga</th>
                                            <th>Total</th>
                                            <th>Kasir</th>
                                        </tr>
                                    </thead>
                                    <tbody id="reportTableBody">
                                        <!-- Report data will be loaded here -->
                                    </tbody>
                                </table>
                            </div>
                            <nav aria-label="Page navigation" class="mt-3">
                                <ul class="pagination justify-content-center">
                                    <li class="page-item disabled">
                                        <a class="page-link" href="#" tabindex="-1">Previous</a>
                                    </li>
                                    <li class="page-item active"><a class="page-link" href="#">1</a></li>
                                    <li class="page-item"><a class="page-link" href="#">2</a></li>
                                    <li class="page-item"><a class="page-link" href="#">3</a></li>
                                    <li class="page-item">
                                        <a class="page-link" href="#">Next</a>
                                    </li>
                                </ul>
                            </nav>
                        </div>
                    </div>
                </div>

                <!-- Products Section -->
                <div id="products-section" style="display: none;">
                    <div class="d-flex justify-content-between align-items-center mb-4">
                        <h3>Produk Wisata</h3>
                        <button class="btn btn-primary" onclick="showAddProductModal()" id="addProductBtn" style="display: none;">
                            <i class="fas fa-plus me-1"></i> Tambah Produk
                        </button>
                    </div>

                    <div class="card">
                        <div class="card-header">
                            <div class="d-flex justify-content-between align-items-center">
                                <h5 class="card-title mb-0">Daftar Produk</h5>
                                <div class="search-box">
                                    <i class="fas fa-search"></i>
                                    <input type="text" class="form-control form-control-sm" placeholder="Cari produk..." id="productListSearch" onkeyup="searchProductList()">
                                </div>
                            </div>
                        </div>
                        <div class="card-body">
                            <div class="table-responsive">
                                <table class="table table-hover">
                                    <thead>
                                        <tr>
                                            <th>Nama</th>
                                            <th>Kategori</th>
                                            <th>Harga Reguler</th>
                                            <th>Harga Weekend</th>
                                            <th>Stok</th>
                                            <th>Status</th>
                                            <th>Aksi</th>
                                        </tr>
                                    </thead>
                                    <tbody id="productTableBody">
                                        <!-- Products will be loaded here -->
                                    </tbody>
                                </table>
                            </div>
                            <nav aria-label="Page navigation" class="mt-3">
                                <ul class="pagination justify-content-center">
                                    <li class="page-item disabled">
                                        <a class="page-link" href="#" tabindex="-1">Previous</a>
                                    </li>
                                    <li class="page-item active"><a class="page-link" href="#">1</a></li>
                                    <li class="page-item"><a class="page-link" href="#">2</a></li>
                                    <li class="page-item"><a class="page-link" href="#">3</a></li>
                                    <li class="page-item">
                                        <a class="page-link" href="#">Next</a>
                                    </li>
                                </ul>
                            </nav>
                        </div>
                    </div>
                </div>

                <!-- Users Section -->
                <div id="users-section" style="display: none;">
                    <div class="d-flex justify-content-between align-items-center mb-4">
                        <h3>Manajemen Pengguna</h3>
                        <button class="btn btn-primary" onclick="showAddUserModal()" id="addUserBtn" style="display: none;">
                            <i class="fas fa-user-plus me-1"></i> Tambah Pengguna
                        </button>
                    </div>

                    <div class="card">
                        <div class="card-header">
                            <div class="d-flex justify-content-between align-items-center">
                                <h5 class="card-title mb-0">Daftar Pengguna</h5>
                                <div class="search-box">
                                    <i class="fas fa-search"></i>
                                    <input type="text" class="form-control form-control-sm" placeholder="Cari pengguna..." id="userSearch" onkeyup="searchUsers()">
                                </div>
                            </div>
                        </div>
                        <div class="card-body">
                            <div class="table-responsive">
                                <table class="table table-hover">
                                    <thead>
                                        <tr>
                                            <th>Nama</th>
                                            <th>Username</th>
                                            <th>Role</th>
                                            <th>Terakhir Login</th>
                                            <th>Status</th>
                                            <th>Aksi</th>
                                        </tr>
                                    </thead>
                                    <tbody id="userTableBody">
                                        <!-- Users will be loaded here -->
                                    </tbody>
                                </table>
                            </div>
                            <nav aria-label="Page navigation" class="mt-3">
                                <ul class="pagination justify-content-center">
                                    <li class="page-item disabled">
                                        <a class="page-link" href="#" tabindex="-1">Previous</a>
                                    </li>
                                    <li class="page-item active"><a class="page-link" href="#">1</a></li>
                                    <li class="page-item"><a class="page-link" href="#">2</a></li>
                                    <li class="page-item"><a class="page-link" href="#">3</a></li>
                                    <li class="page-item">
                                        <a class="page-link" href="#">Next</a>
                                    </li>
                                </ul>
                            </nav>
                        </div>
                    </div>
                </div>

                <!-- Settings Section -->
                <div id="settings-section" style="display: none;">
                    <div class="d-flex justify-content-between align-items-center mb-4">
                        <h3>Pengaturan Sistem</h3>
                        <div>
                            <button class="btn btn-secondary me-2" onclick="showSecurityModal()">
                                <i class="fas fa-lock me-1"></i> Keamanan
                            </button>
                            <button class="btn btn-primary" onclick="verifySecurityCodeBeforeSave()">
                                <i class="fas fa-save me-1"></i> Simpan Pengaturan
                            </button>
                        </div>
                    </div>

                    <div class="row">
                        <div class="col-md-6">
                            <div class="card">
                                <div class="card-header">
                                    <h5 class="card-title mb-0">Pengaturan Umum</h5>
                                </div>
                                <div class="card-body">
                                    <div class="mb-3">
                                        <label class="form-label">Nama Bisnis</label>
                                        <input type="text" class="form-control" id="businessName" value="TourTick">
                                    </div>
                                    <div class="mb-3">
                                        <label class="form-label">Alamat</label>
                                        <textarea class="form-control" id="businessAddress" rows="2">Jl. Raya Wisata No. 123, Kota Pariwisata</textarea>
                                    </div>
                                    <div class="mb-3">
                                        <label class="form-label">Telepon</label>
                                        <input type="text" class="form-control" id="businessPhone" value="(021) 1234567">
                                    </div>
                                    <div class="mb-3">
                                        <label class="form-label">Email</label>
                                        <input type="email" class="form-control" id="businessEmail" value="info@tourtick.com">
                                    </div>
                                </div>
                            </div>

                            <div class="card mt-4">
                                <div class="card-header">
                                    <h5 class="card-title mb-0">Pengaturan Struk</h5>
                                </div>
                                <div class="card-body">
                                    <div class="mb-3">
                                        <label class="form-label">Format Kode Transaksi</label>
                                        <input type="text" class="form-control" id="receiptFormat" value="TRX">
                                        <small class="text-muted">Kode unik akan digenerate otomatis setelah prefix ini</small>
                                    </div>
                                    <div class="mb-3">
                                        <label class="form-label">Footer Struk</label>
                                        <textarea class="form-control" id="receiptFooter" rows="2">Terima kasih atas kunjungan Anda</textarea>
                                    </div>
                                    <div class="mb-3 form-check">
                                        <input type="checkbox" class="form-check-input" id="autoPrint" checked>
                                        <label class="form-check-label" for="autoPrint">Cetak otomatis setelah transaksi</label>
                                    </div>
                                    <div class="mb-3 form-check">
                                        <input type="checkbox" class="form-check-input" id="showBarcode" checked>
                                        <label class="form-check-label" for="showBarcode">Tampilkan barcode di struk</label>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="col-md-6">
                            <div class="card">
                                <div class="card-header">
                                    <h5 class="card-title mb-0">Pengaturan Pembayaran</h5>
                                </div>
                                <div class="card-body">
                                    <div class="mb-3">
                                        <label class="form-label">Mata Uang</label>
                                        <select class="form-select" id="currency">
                                            <option value="IDR" selected>Rupiah (IDR)</option>
                                            <option value="USD">Dollar AS (USD)</option>
                                            <option value="EUR">Euro (EUR)</option>
                                        </select>
                                    </div>
                                    <div class="mb-3">
                                        <label class="form-label">Pajak (%)</label>
                                        <input type="number" class="form-control" id="taxRate" value="10">
                                    </div>
                                    <div class="mb-3">
                                        <label class="form-label">Metode Pembayaran</label>
                                        <div class="form-check">
                                            <input class="form-check-input" type="checkbox" id="cashPayment" checked>
                                            <label class="form-check-label" for="cashPayment">Tunai</label>
                                        </div>
                                        <div class="form-check">
                                            <input class="form-check-input" type="checkbox" id="transferPayment" checked>
                                            <label class="form-check-label" for="transferPayment">Transfer Bank</label>
                                        </div>
                                        <div class="form-check">
                                            <input class="form-check-input" type="checkbox" id="qrisPayment" checked>
                                            <label class="form-check-label" for="qrisPayment">QRIS</label>
                                        </div>
                                        <div class="form-check">
                                            <input class="form-check-input" type="checkbox" id="debitPayment">
                                            <label class="form-check-label" for="debitPayment">Kartu Debit</label>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <div class="card mt-4">
                                <div class="card-header">
                                    <h5 class="card-title mb-0">Pengaturan Hak Akses</h5>
                                </div>
                                <div class="card-body">
                                    <div class="mb-3">
                                        <label class="form-label">Kasir Bertugas Hari Ini</label>
                                        <select class="form-select" id="activeCashier">
                                            <option value="">Pilih Kasir</option>
                                            <!-- Options will be loaded from users -->
                                        </select>
                                    </div>
                                    
                                    <div class="permission-group">
                                        <h6>Hak Akses Admin</h6>
                                        <div class="permission-item">
                                            <input type="checkbox" class="form-check-input" id="adminView" checked disabled>
                                            <label class="form-check-label" for="adminView">Lihat Data</label>
                                        </div>
                                        <div class="permission-item">
                                            <input type="checkbox" class="form-check-input" id="adminAdd" checked>
                                            <label class="form-check-label" for="adminAdd">Tambah Data</label>
                                        </div>
                                        <div class="permission-item">
                                            <input type="checkbox" class="form-check-input" id="adminEdit" checked>
                                            <label class="form-check-label" for="adminEdit">Edit Data</label>
                                        </div>
                                        <div class="permission-item">
                                            <input type="checkbox" class="form-check-input" id="adminDelete" checked>
                                            <label class="form-check-label" for="adminDelete">Hapus Data</label>
                                        </div>
                                        <div class="permission-item">
                                            <input type="checkbox" class="form-check-input" id="adminPrint" checked>
                                            <label class="form-check-label" for="adminPrint">Cetak Laporan</label>
                                        </div>
                                    </div>
                                    
                                    <div class="permission-group">
                                        <h6>Hak Akses Kasir</h6>
                                        <div class="permission-item">
                                            <input type="checkbox" class="form-check-input" id="cashierView" checked>
                                            <label class="form-check-label" for="cashierView">Lihat Data</label>
                                        </div>
                                        <div class="permission-item">
                                            <input type="checkbox" class="form-check-input" id="cashierAdd" checked>
                                            <label class="form-check-label" for="cashierAdd">Tambah Data</label>
                                        </div>
                                        <div class="permission-item">
                                            <input type="checkbox" class="form-check-input" id="cashierEdit" checked>
                                            <label class="form-check-label" for="cashierEdit">Edit Data</label>
                                        </div>
                                        <div class="permission-item">
                                            <input type="checkbox" class="form-check-input" id="cashierDelete">
                                            <label class="form-check-label" for="cashierDelete">Hapus Data</label>
                                        </div>
                                        <div class="permission-item">
                                            <input type="checkbox" class="form-check-input" id="cashierPrint" checked>
                                            <label class="form-check-label" for="cashierPrint">Cetak Laporan</label>
                                        </div>
                                    </div>
                                    
                                    <div class="permission-group">
                                        <h6>Hak Akses Manajer</h6>
                                        <div class="permission-item">
                                            <input type="checkbox" class="form-check-input" id="managerView" checked>
                                            <label class="form-check-label" for="managerView">Lihat Data</label>
                                        </div>
                                        <div class="permission-item">
                                            <input type="checkbox" class="form-check-input" id="managerAdd" checked>
                                            <label class="form-check-label" for="managerAdd">Tambah Data</label>
                                        </div>
                                        <div class="permission-item">
                                            <input type="checkbox" class="form-check-input" id="managerEdit" checked>
                                            <label class="form-check-label" for="managerEdit">Edit Data</label>
                                        </div>
                                        <div class="permission-item">
                                            <input type="checkbox" class="form-check-input" id="managerDelete">
                                            <label class="form-check-label" for="managerDelete">Hapus Data</label>
                                        </div>
                                        <div class="permission-item">
                                            <input type="checkbox" class="form-check-input" id="managerPrint" checked>
                                            <label class="form-check-label" for="managerPrint">Cetak Laporan</label>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="card mt-4">
                        <div class="card-header">
                            <h5 class="card-title mb-0">Pengaturan Produk Wisata</h5>
                        </div>
                        <div class="card-body">
                            <div class="row">
                                <div class="col-md-6">
                                    <div class="mb-3">
                                        <label class="form-label">Kategori Produk</label>
                                        <div class="d-flex mb-2">
                                            <input type="text" class="form-control me-2" id="newCategory" placeholder="Kategori Baru">
                                            <button class="btn btn-primary" onclick="addCategory()">Tambah</button>
                                        </div>
                                        <select class="form-select" multiple id="productCategories">
                                            <option value="nature">Alam</option>
                                            <option value="history">Sejarah</option>
                                            <option value="waterpark">Waterpark</option>
                                            <option value="adventure">Petualangan</option>
                                            <option value="beach">Pantai</option>
                                        </select>
                                        <button class="btn btn-sm btn-danger mt-2" onclick="removeSelectedCategories()">Hapus Terpilih</button>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="mb-3">
                                        <label class="form-label">Jenis Tiket</label>
                                        <div class="d-flex mb-2">
                                            <input type="text" class="form-control me-2" id="newTicketType" placeholder="Jenis Tiket Baru">
                                            <button class="btn btn-primary" onclick="addTicketType()">Tambah</button>
                                        </div>
                                        <select class="form-select" multiple id="ticketTypes">
                                            <option value="regular">Reguler</option>
                                            <option value="vip">VIP</option>
                                            <option value="group">Grup</option>
                                            <option value="student">Pelajar/Mahasiswa</option>
                                            <option value="foreigner">Warga Asing</option>
                                        </select>
                                        <button class="btn btn-sm btn-danger mt-2" onclick="removeSelectedTicketTypes()">Hapus Terpilih</button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Backup & Restore Section -->
                    <div class="card mt-4">
                        <div class="card-header">
                            <h5 class="card-title mb-0">Backup & Restore Data</h5>
                        </div>
                        <div class="card-body">
                            <div class="row">
                                <div class="col-md-6">
                                    <div class="mb-3">
                                        <label class="form-label">Backup Data</label>
                                        <button class="btn btn-primary w-100" onclick="backupData()">
                                            <i class="fas fa-download me-1"></i> Backup Data
                                        </button>
                                        <small class="text-muted">Simpan semua data sistem ke file JSON</small>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="mb-3">
                                        <label class="form-label">Restore Data</label>
                                        <input type="file" class="form-control mb-2" id="restoreFile" accept=".json">
                                        <button class="btn btn-success w-100" onclick="restoreData()">
                                            <i class="fas fa-upload me-1"></i> Restore Data
                                        </button>
                                        <small class="text-muted">Muat ulang data dari file backup</small>
                                    </div>
                                </div>
                            </div>
                            <div class="row mt-3">
                                <div class="col-md-12">
                                    <div class="mb-3">
                                        <label class="form-label">Reset Data</label>
                                        <button class="btn btn-danger w-100" onclick="confirmResetData()">
                                            <i class="fas fa-trash me-1"></i> Reset Semua Data
                                        </button>
                                        <small class="text-muted">Hati-hati! Aksi ini akan menghapus semua data dan mengembalikan ke pengaturan awal</small>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Access Denied Section -->
                <div id="access-denied-section" style="display: none;">
                    <div class="access-denied">
                        <i class="fas fa-ban"></i>
                        <h3>Akses Ditolak</h3>
                        <p>Anda tidak memiliki izin untuk mengakses halaman ini.</p>
                        <button class="btn btn-primary" onclick="showSection('dashboard')">
                            <i class="fas fa-home me-1"></i> Kembali ke Dashboard
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Add Product Modal -->
    <div class="modal fade" id="addProductModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Tambah Produk Wisata</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <form id="productForm">
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label class="form-label">Nama Produk</label>
                                    <input type="text" class="form-control" id="productName" required>
                                </div>
                                <div class="mb-3">
                                    <label class="form-label">Kategori</label>
                                    <select class="form-select" id="productCategory" required>
                                        <option value="">Pilih Kategori</option>
                                        <!-- Options will be loaded from settings -->
                                    </select>
                                </div>
                                <div class="mb-3">
                                    <label class="form-label">Deskripsi</label>
                                    <textarea class="form-control" id="productDescription" rows="3"></textarea>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label class="form-label">Harga Reguler</label>
                                    <input type="number" class="form-control" id="productRegularPrice" required>
                                </div>
                                <div class="mb-3">
                                    <label class="form-label">Harga Weekend</label>
                                    <input type="number" class="form-control" id="productWeekendPrice" required>
                                </div>
                                <div class="mb-3">
                                    <label class="form-label">Stok Awal</label>
                                    <input type="number" class="form-control" id="productStock" value="0">
                                </div>
                                <div class="mb-3 form-check">
                                    <input type="checkbox" class="form-check-input" id="productStatus" checked>
                                    <label class="form-check-label" for="productStatus">Aktif</label>
                                </div>
                            </div>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Batal</button>
                    <button type="button" class="btn btn-primary" onclick="saveProduct()">Simpan</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Add User Modal -->
    <div class="modal fade" id="addUserModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Tambah Pengguna</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <form id="userForm">
                        <div class="mb-3">
                            <label class="form-label">Nama Lengkap</label>
                            <input type="text" class="form-control" id="userFullName" required>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Username</label>
                            <input type="text" class="form-control" id="userUsername" required>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Password</label>
                            <input type="password" class="form-control" id="userPassword" required>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Role</label>
                            <select class="form-select" id="userRoleSelect" required>
                                <option value="">Pilih Role</option>
                                <option value="admin">Admin</option>
                                <option value="cashier">Kasir</option>
                                <option value="manager">Manajer</option>
                            </select>
                        </div>
                        <div class="mb-3 form-check">
                            <input type="checkbox" class="form-check-input" id="userStatus" checked>
                            <label class="form-check-label" for="userStatus">Aktif</label>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Batal</button>
                    <button type="button" class="btn btn-primary" onclick="saveUser()">Simpan</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Import Modal -->
    <div class="modal fade" id="importModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Import Data</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-3">
                        <label class="form-label">Pilih File Excel</label>
                        <input type="file" class="form-control" id="importFile" accept=".xlsx, .xls, .csv">
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Jenis Data</label>
                        <select class="form-select" id="importType">
                            <option value="tickets">Karcis</option>
                            <option value="products">Produk</option>
                            <option value="users">Pengguna</option>
                        </select>
                    </div>
                    <div class="alert alert-info">
                        <i class="fas fa-info-circle me-2"></i>
                        Pastikan format file sesuai dengan template yang disediakan.
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Batal</button>
                    <button type="button" class="btn btn-primary" onclick="importData()">Import</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Transaction Receipt Modal -->
    <div class="modal fade" id="receiptModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Struk Transaksi</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body" id="receiptContent">
                    <div class="receipt">
                        <div class="header">
                            <h4 id="receiptBusinessName">TourTick</h4>
                            <p class="mb-1" id="receiptBusinessAddress">Jl. Raya Wisata No. 123, Kota Pariwisata</p>
                            <p class="mb-1" id="receiptBusinessPhone">Telp: (021) 1234567</p>
                            <div class="divider"></div>
                        </div>
                        <div class="details">
                            <div class="item">
                                <span>No. Transaksi:</span>
                                <span class="fw-bold" id="receiptTrxId">#TRX-001</span>
                            </div>
                            <div class="item">
                                <span>Tanggal:</span>
                                <span id="receiptDate">10 Jun 2023 14:30</span>
                            </div>
                            <div class="item">
                                <span>Kasir:</span>
                                <span id="receiptCashier">Admin</span>
                            </div>
                            <div class="item">
                                <span>Metode Pembayaran:</span>
                                <span id="receiptPaymentMethod">Tunai</span>
                            </div>
                            <div class="divider"></div>
                        </div>
                        <div class="items" id="receiptItems">
                            <!-- Items will be added here -->
                        </div>
                        <div class="divider"></div>
                        <div class="totals">
                            <div class="item">
                                <span>Subtotal:</span>
                                <span id="receiptSubtotal">Rp80.000</span>
                            </div>
                            <div class="item">
                                <span>Pajak (10%):</span>
                                <span id="receiptTax">Rp8.000</span>
                            </div>
                            <div class="item fw-bold">
                                <span>Total:</span>
                                <span id="receiptTotal">Rp88.000</span>
                            </div>
                            <div class="item">
                                <span>Tunai:</span>
                                <span id="receiptCash">Rp100.000</span>
                            </div>
                            <div class="item fw-bold">
                                <span>Kembalian:</span>
                                <span id="receiptChange">Rp12.000</span>
                            </div>
                        </div>
                        <div class="divider"></div>
                        <div class="receipt-barcode">
                            <svg id="receiptBarcode"></svg>
                        </div>
                        <div class="footer">
                            <p class="mb-2" id="receiptFooter">Terima kasih atas kunjungan Anda</p>
                            <p>www.tourtick.com</p>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Tutup</button>
                    <button type="button" class="btn btn-primary" onclick="printReceipt()">
                        <i class="fas fa-print me-1"></i> Cetak
                    </button>
                    <button type="button" class="btn btn-success" onclick="downloadReceipt()">
                        <i class="fas fa-download me-1"></i> Download PDF
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Security Modal -->
    <div class="modal fade" id="securityModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Pengaturan Keamanan</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-4">
                        <h6>Ganti Password Admin</h6>
                        <div class="mb-3">
                            <label class="form-label">Password Saat Ini</label>
                            <input type="password" class="form-control" id="currentPassword">
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Password Baru</label>
                            <input type="password" class="form-control" id="newPassword">
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Konfirmasi Password Baru</label>
                            <input type="password" class="form-control" id="confirmNewPassword">
                        </div>
                        <button class="btn btn-primary" onclick="changePassword()">Ganti Password</button>
                    </div>
                    
                    <div class="mb-4">
                        <h6>Kode Keamanan Sistem</h6>
                        <div class="mb-3">
                            <label class="form-label">Kode Keamanan Saat Ini</label>
                            <input type="password" class="form-control" id="currentSecurityCode" placeholder="Masukkan kode saat ini">
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Kode Keamanan Baru</label>
                            <input type="password" class="form-control" id="newSecurityCode" placeholder="Masukkan kode baru">
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Konfirmasi Kode Baru</label>
                            <input type="password" class="form-control" id="confirmSecurityCode" placeholder="Konfirmasi kode baru">
                        </div>
                        <button class="btn btn-primary" onclick="changeSecurityCode()">Ganti Kode Keamanan</button>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Tutup</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Security Code Verification Modal -->
    <div class="modal fade" id="securityCodeModal" tabindex="-1" aria-hidden="true" data-bs-backdrop="static" data-bs-keyboard="false">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Verifikasi Kode Keamanan</h5>
                </div>
                <div class="modal-body">
                    <div class="mb-3">
                        <label class="form-label">Masukkan Kode Keamanan</label>
                        <input type="password" class="form-control" id="securityCodeInput" placeholder="Masukkan kode keamanan">
                    </div>
                    <div class="alert alert-danger mt-3" id="securityCodeError" style="display: none;">
                        <i class="fas fa-exclamation-circle me-2"></i>
                        <span id="securityCodeErrorMessage">Kode keamanan salah!</span>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-primary" onclick="verifySecurityCode()">Verifikasi</button>
                </div>
            </div>
        </div>
    </div>

    <!-- View Ticket Modal -->
    <div class="modal fade" id="viewTicketModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Detail Karcis</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body" id="ticketDetailsContent">
                    <!-- Ticket details will be loaded here -->
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Tutup</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Reset Data Confirmation Modal -->
    <div class="modal fade" id="resetDataModal" tabindex="-1" aria-hidden="true" data-bs-backdrop="static" data-bs-keyboard="false">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Konfirmasi Reset Data</h5>
                </div>
                <div class="modal-body">
                    <div class="mb-3">
                        <label class="form-label">Masukkan Kode Keamanan</label>
                        <input type="password" class="form-control" id="resetSecurityCode" placeholder="Masukkan kode keamanan">
                    </div>
                    <div class="alert alert-danger mt-3" id="resetDataError" style="display: none;">
                        <i class="fas fa-exclamation-circle me-2"></i>
                        <span id="resetDataErrorMessage">Kode keamanan salah!</span>
                    </div>
                    <div class="alert alert-warning">
                        <i class="fas fa-exclamation-triangle me-2"></i>
                        <span>PERINGATAN: Aksi ini akan menghapus semua data dan mengembalikan sistem ke pengaturan awal. Pastikan Anda sudah melakukan backup data sebelum melanjutkan.</span>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Batal</button>
                    <button type="button" class="btn btn-danger" onclick="resetData()">Reset Data</button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // Data initialization
        let products = [];
        let tickets = [];
        let users = [
            {
                name: "Admin",
                username: "admin",
                password: "admin123",
                role: "admin",
                lastLogin: "",
                status: "active",
                createdBy: "system",
                createdAt: "2023-01-01"
            }
        ];

        let transactions = [];
        let currentUser = null;
        let securityCode = "Tiket.013579";
        let cart = [];
        let currentTicketCode = '';
        let currentTransactionId = '';
        let transactionCounter = 1;

        // System settings
        let systemSettings = {
            businessName: "TourTick",
            businessAddress: "Jl. Raya Wisata No. 123, Kota Pariwisata",
            businessPhone: "(021) 1234567",
            businessEmail: "info@tourtick.com",
            receiptFormat: "TRX",
            receiptFooter: "Terima kasih atas kunjungan Anda",
            ticketValidity: 30,
            autoPrint: true,
            showBarcode: true,
            currency: "IDR",
            taxRate: 10,
            paymentMethods: ["cash", "transfer", "qris"],
            activeCashier: "",
            permissions: {
                admin: { view: true, add: true, edit: true, delete: true, print: true, settings: true },
                cashier: { view: true, add: true, edit: true, delete: false, print: true, settings: false },
                manager: { view: true, add: true, edit: true, delete: false, print: true, settings: false }
            },
            productCategories: ["nature", "history", "waterpark", "adventure", "beach"],
            ticketTypes: ["regular", "vip", "group", "student", "foreigner"]
        };

        // Initialize the app
        document.addEventListener('DOMContentLoaded', function() {
            // Show login modal first
            const loginModal = new bootstrap.Modal(document.getElementById('loginModal'));
            loginModal.show();

            // Set up login form
            document.getElementById('loginForm').addEventListener('submit', function(e) {
                e.preventDefault();
                login();
            });

            // Set today's date as default for valid date
            document.getElementById('validDate').valueAsDate = new Date();
        });

        // Login function
        function login() {
            const username = document.getElementById('loginUsername').value;
            const password = document.getElementById('loginPassword').value;
            
            const user = users.find(u => u.username === username && u.password === password);
            
            if (user) {
                if (user.status !== 'active') {
                    alert('Akun ini tidak aktif!');
                    return;
                }
                
                currentUser = user;
                user.lastLogin = new Date().toLocaleString('id-ID');
                
                // Update UI
                document.getElementById('userAvatar').textContent = user.name.substring(0, 2).toUpperCase();
                document.getElementById('userName').textContent = user.name;
                document.getElementById('userRole').textContent = getRoleText(user.role);
                
                // Hide login modal and show app
                const loginModal = bootstrap.Modal.getInstance(document.getElementById('loginModal'));
                loginModal.hide();
                
                document.getElementById('appContainer').style.display = 'block';
                
                // Initialize the app
                initializeApp();
            } else {
                alert('Username atau password salah!');
            }
        }

        // Get role text
        function getRoleText(role) {
            switch(role) {
                case 'admin': return 'Super User';
                case 'cashier': return 'Kasir';
                case 'manager': return 'Manajer';
                default: return role;
            }
        }

        // Initialize the app after login
        function initializeApp() {
            // Generate initial barcode
            generateBarcode();
            
            // Load products
            loadProducts();
            
            // Load tickets
            loadTickets();
            
            // Load users
            loadUsers();
            
            // Load reports
            loadReports();
            
            // Initialize charts
            initCharts();
            
            // Hide cash input if payment method is not cash
            updatePaymentMethod();
            
            // Load settings
            loadSettings();
            
            // Check permissions
            checkPermissions();
            
            // Show dashboard by default
            showSection('dashboard');
        }

        // Check user permissions
        function checkPermissions() {
            // Show/hide menu items based on role
            if (currentUser.role === 'admin') {
                document.getElementById('users-menu-item').style.display = 'block';
                document.getElementById('settings-menu-item').style.display = 'block';
                document.getElementById('products-menu-item').style.display = 'block';
                document.getElementById('addUserBtn').style.display = 'block';
                document.getElementById('addProductBtn').style.display = 'block';
            } else {
                document.getElementById('users-menu-item').style.display = 'none';
                document.getElementById('settings-menu-item').style.display = 'none';
                document.getElementById('products-menu-item').style.display = 'none';
                document.getElementById('addUserBtn').style.display = 'none';
                document.getElementById('addProductBtn').style.display = 'none';
            }
        }

        // Show section based on menu click with permission check
        function showSection(section) {
            // Check if user has permission to access this section
            if ((section === 'settings' || section === 'users' || section === 'products') && currentUser.role !== 'admin') {
                showAccessDenied();
                return;
            }
            
            // Hide all sections
            document.getElementById('dashboard-section').style.display = 'none';
            document.getElementById('ticket-sales-section').style.display = 'none';
            document.getElementById('generate-ticket-section').style.display = 'none';
            document.getElementById('ticket-list-section').style.display = 'none';
            document.getElementById('reports-section').style.display = 'none';
            document.getElementById('products-section').style.display = 'none';
            document.getElementById('users-section').style.display = 'none';
            document.getElementById('settings-section').style.display = 'none';
            document.getElementById('access-denied-section').style.display = 'none';
            
            // Show selected section
            document.getElementById(section + '-section').style.display = 'block';
            
            // Update active menu item
            const navLinks = document.querySelectorAll('.nav-link');
            navLinks.forEach(link => link.classList.remove('active'));
            event.target.classList.add('active');
            
            // Refresh data if needed
            if (section === 'ticket-list') {
                loadTickets();
            } else if (section === 'products') {
                loadProducts();
            } else if (section === 'users') {
                loadUsers();
            } else if (section === 'reports') {
                loadReports();
            } else if (section === 'ticket-sales') {
                loadAvailableTickets();
            } else if (section === 'settings') {
                loadSettings();
            }
        }

        // Show access denied page
        function showAccessDenied() {
            // Hide all sections
            document.getElementById('dashboard-section').style.display = 'none';
            document.getElementById('ticket-sales-section').style.display = 'none';
            document.getElementById('generate-ticket-section').style.display = 'none';
            document.getElementById('ticket-list-section').style.display = 'none';
            document.getElementById('reports-section').style.display = 'none';
            document.getElementById('products-section').style.display = 'none';
            document.getElementById('users-section').style.display = 'none';
            document.getElementById('settings-section').style.display = 'none';
            
            // Show access denied section
            document.getElementById('access-denied-section').style.display = 'block';
            
            // Update active menu item
            const navLinks = document.querySelectorAll('.nav-link');
            navLinks.forEach(link => link.classList.remove('active'));
        }

        // Check if user has specific permission
        function hasPermission(permission) {
            if (!currentUser) return false;
            
            if (currentUser.role === 'admin') {
                return true; // Admin has all permissions
            }
            
            return systemSettings.permissions[currentUser.role][permission] || false;
        }

        // Generate barcode for ticket
        function generateBarcode() {
            const type = document.getElementById('ticketType').value;
            const destination = document.getElementById('destination').value;
            
            if (!type || !destination) {
                alert('Pilih jenis karcis dan destinasi terlebih dahulu!');
                return;
            }
            
            // Generate unique ticket code with timestamp and random number
            const timestamp = Date.now().toString().slice(-6);
            const randomNum = Math.floor(1000 + Math.random() * 9000);
            currentTicketCode = `TKT-${timestamp}-${randomNum}`;
            
            JsBarcode("#barcode", currentTicketCode, {
                format: "CODE128",
                lineColor: "#000",
                width: 2,
                height: 50,
                displayValue: true
            });
            
            // Update preview
            document.getElementById('previewCode').textContent = currentTicketCode;
        }

        // Update ticket code when type or destination changes
        function updateTicketCode() {
            const type = document.getElementById('ticketType').value;
            const destination = document.getElementById('destination').value;
            
            if (type && destination) {
                generateBarcode();
                updateDestinationDetails();
            }
        }

        // Update destination details based on selection
        function updateDestinationDetails() {
            const destination = document.getElementById('destination').value;
            const product = products.find(p => p.id === destination);
            
            if (!product) {
                document.getElementById('previewDestination').textContent = 'Pilih Destinasi';
                document.getElementById('previewAddress').textContent = '';
                document.getElementById('ticketPrice').value = '';
                document.getElementById('previewPrice').textContent = 'Rp0';
                return;
            }
            
            document.getElementById('previewDestination').textContent = product.name;
            document.getElementById('previewAddress').textContent = product.description || 'Alamat tidak tersedia';
            document.getElementById('ticketPrice').value = product.regularPrice;
            document.getElementById('previewPrice').textContent = formatPrice(product.regularPrice);
            
            // Update type
            const type = document.getElementById('ticketType').value;
            document.getElementById('previewType').textContent = type ? type.charAt(0).toUpperCase() + type.slice(1) : 'Reguler';
            
            // Update date
            const date = document.getElementById('validDate').value;
            if (date) {
                const formattedDate = new Date(date).toLocaleDateString('id-ID', { day: 'numeric', month: 'short', year: 'numeric' });
                document.getElementById('previewDate').textContent = formattedDate;
            }
        }

        // Save ticket to database
        function saveTicket(event) {
            if (event) event.preventDefault();
            
            const type = document.getElementById('ticketType').value;
            const destination = document.getElementById('destination').value;
            const price = document.getElementById('ticketPrice').value;
            const quantity = document.getElementById('ticketQuantity').value;
            const validDate = document.getElementById('validDate').value;
            const includeTax = document.getElementById('includeTax').checked;
            
            if (!type || !destination || !price || !quantity || !validDate) {
                alert('Harap lengkapi semua field yang diperlukan!');
                return;
            }
            
            const product = products.find(p => p.id === destination);
            if (!product) {
                alert('Destinasi tidak valid!');
                return;
            }
            
            // Generate ticket codes
            const newTickets = [];
            
            for (let i = 0; i < quantity; i++) {
                // Generate unique code for each ticket
                const timestamp = Date.now().toString().slice(-6);
                const randomNum = Math.floor(1000 + Math.random() * 9000);
                const ticketCode = `TKT-${timestamp}-${randomNum}-${i}`;
                
                newTickets.push({
                    code: ticketCode,
                    destination: product.name,
                    type: type,
                    price: parseInt(price),
                    date: validDate,
                    status: "valid",
                    createdBy: currentUser.username,
                    createdAt: new Date().toISOString()
                });
            }
            
            // Add to tickets array
            tickets = [...tickets, ...newTickets];
            
            // Show success message
            alert(`Berhasil membuat ${quantity} karcis dengan jenis ${type} untuk destinasi ${product.name}`);
            
            // Reset form
            document.getElementById('ticketForm').reset();
            document.getElementById('validDate').valueAsDate = new Date();
            
            // Generate new barcode
            generateBarcode();
            
            // Update preview
            updateDestinationDetails();
            
            // Reload tickets list
            loadTickets();
            loadAvailableTickets();
            
            // Add to recent activities
            addActivity(`${currentUser.name} membuat ${quantity} karcis baru`);
        }

        // Print generated ticket
        function printGeneratedTicket() {
            const printContent = document.getElementById('ticketPreview').innerHTML;
            const originalContent = document.body.innerHTML;
            
            document.body.innerHTML = printContent;
            window.print();
            document.body.innerHTML = originalContent;
            
            // Restore the active section
            showSection('generate-ticket');
        }

        // Load products to sales page
        function loadProducts() {
            // Load to product management table
            const productTableBody = document.getElementById('productTableBody');
            productTableBody.innerHTML = '';
            
            products.forEach(product => {
                const row = document.createElement('tr');
                
                row.innerHTML = `
                    <td>${product.name}</td>
                    <td>${product.category}</td>
                    <td>${formatPrice(product.regularPrice)}</td>
                    <td>${formatPrice(product.weekendPrice)}</td>
                    <td>${product.stock}</td>
                    <td>
                        <span class="badge ${product.status === 'active' ? 'bg-success' : 'bg-secondary'}">
                            ${product.status === 'active' ? 'Aktif' : 'Nonaktif'}
                        </span>
                    </td>
                    <td>
                        <button class="btn btn-sm btn-outline-primary me-1" onclick="editProduct('${product.id}')" ${!hasPermission('edit') ? 'disabled' : ''}>
                            <i class="fas fa-edit"></i>
                        </button>
                        <button class="btn btn-sm btn-outline-danger" onclick="deleteProduct('${product.id}')" ${!hasPermission('delete') ? 'disabled' : ''}>
                            <i class="fas fa-trash"></i>
                        </button>
                    </td>
                `;
                
                productTableBody.appendChild(row);
            });
            
            // Load products to destination dropdowns
            const destinationSelects = [
                document.getElementById('destination'),
                document.getElementById('reportDestination')
            ];
            
            destinationSelects.forEach(select => {
                if (!select) return;
                
                select.innerHTML = '<option value="">Pilih Destinasi</option>';
                products.forEach(product => {
                    const option = document.createElement('option');
                    option.value = product.id;
                    option.textContent = product.name;
                    select.appendChild(option);
                });
            });
            
            // Load categories to product form
            const categorySelect = document.getElementById('productCategory');
            if (categorySelect) {
                categorySelect.innerHTML = '<option value="">Pilih Kategori</option>';
                systemSettings.productCategories.forEach(category => {
                    const option = document.createElement('option');
                    option.value = category;
                    option.textContent = category.charAt(0).toUpperCase() + category.slice(1);
                    categorySelect.appendChild(option);
                });
            }
            
            // Update dashboard stats
            updateDashboardStats();
        }

        // Load available tickets for sales
        function loadAvailableTickets() {
            const availableTicketsTable = document.getElementById('availableTicketsTable');
            availableTicketsTable.innerHTML = '';
            
            const validTickets = tickets.filter(t => t.status === 'valid');
            
            validTickets.forEach(ticket => {
                const row = document.createElement('tr');
                
                row.innerHTML = `
                    <td>${ticket.code}</td>
                    <td>${ticket.destination}</td>
                    <td>${ticket.type.charAt(0).toUpperCase() + ticket.type.slice(1)}</td>
                    <td>${formatPrice(ticket.price)}</td>
                    <td>${formatDate(ticket.date)}</td>
                    <td>
                        <button class="btn btn-sm btn-primary" onclick="addTicketToCart('${ticket.code}')">
                            <i class="fas fa-cart-plus me-1"></i> Tambah
                        </button>
                    </td>
                `;
                
                availableTicketsTable.appendChild(row);
            });
        }

        // Search tickets in sales page
        function searchTicketsSales() {
            const searchTerm = document.getElementById('ticketSearchSales').value.toLowerCase();
            const rows = document.querySelectorAll('#availableTicketsTable tr');
            
            rows.forEach(row => {
                const ticketCode = row.querySelector('td').textContent.toLowerCase();
                const destination = row.querySelector('td:nth-child(2)').textContent.toLowerCase();
                
                if (ticketCode.includes(searchTerm) || destination.includes(searchTerm)) {
                    row.style.display = '';
                } else {
                    row.style.display = 'none';
                }
            });
        }

        // Add ticket to cart
        function addTicketToCart(ticketCode) {
            const ticket = tickets.find(t => t.code === ticketCode);
            
            if (ticket) {
                // Check if ticket already in cart
                const existingItem = cart.find(item => item.code === ticketCode);
                
                if (existingItem) {
                    alert('Karcis ini sudah ada di keranjang!');
                } else {
                    cart.push({
                        code: ticket.code,
                        name: `${ticket.destination} (${ticket.type})`,
                        price: ticket.price
                    });
                    
                    updateCartDisplay();
                    
                    // Add activity
                    addActivity(`menambahkan karcis ${ticket.code} ke keranjang`);
                }
            }
        }

        // Update cart display
        function updateCartDisplay() {
            const cartItems = document.getElementById('cartItems');
            cartItems.innerHTML = '';
            
            cart.forEach(item => {
                const row = document.createElement('tr');
                
                row.innerHTML = `
                    <td>${item.name}</td>
                    <td>${formatPrice(item.price)}</td>
                    <td>
                        <button class="btn btn-sm btn-outline-danger" onclick="removeFromCart('${item.code}')">
                            <i class="fas fa-times"></i>
                        </button>
                    </td>
                `;
                
                cartItems.appendChild(row);
            });
            
            updateCartTotal();
        }

        // Remove item from cart
        function removeFromCart(ticketCode) {
            cart = cart.filter(item => item.code !== ticketCode);
            updateCartDisplay();
            
            // Add activity
            addActivity(`menghapus karcis ${ticketCode} dari keranjang`);
        }

        // Clear cart
        function clearCart() {
            if (confirm('Apakah Anda yakin ingin mengosongkan keranjang?')) {
                cart = [];
                updateCartDisplay();
                
                // Add activity
                addActivity('mengosongkan keranjang belanja');
            }
        }

        // Update payment method
        function updatePaymentMethod() {
            const method = document.getElementById('paymentMethod').value;
            const cashInput = document.getElementById('cashInputContainer');
            
            if (method === 'cash') {
                cashInput.style.display = 'block';
            } else {
                cashInput.style.display = 'none';
            }
        }

        // Update cart totals
        function updateCartTotal() {
            const total = cart.reduce((sum, item) => sum + item.price, 0);
            
            document.getElementById('total').textContent = formatPrice(total);
            
            // Update change amount if cash payment
            updateChangeAmount();
        }

        // Update change amount
        function updateChangeAmount() {
            const total = parseFloat(document.getElementById('total').textContent.replace(/[^0-9]/g, '')) || 0;
            const cashReceived = parseFloat(document.getElementById('cashReceived').value) || 0;
            const change = cashReceived - total;
            
            document.getElementById('changeAmount').value = formatPrice(change > 0 ? change : 0);
        }

        // Complete transaction
        function completeTransaction() {
            if (cart.length === 0) {
                alert('Keranjang belanja kosong!');
                return;
            }
            
            const total = parseFloat(document.getElementById('total').textContent.replace(/[^0-9]/g, '')) || 0;
            const paymentMethod = document.getElementById('paymentMethod').value;
            
            if (paymentMethod === 'cash') {
                const cashReceived = parseFloat(document.getElementById('cashReceived').value) || 0;
                
                if (cashReceived < total) {
                    alert('Uang yang diterima kurang dari total pembayaran!');
                    return;
                }
            }
            
            // Generate transaction ID with prefix and unique number
            const prefix = systemSettings.receiptFormat;
            const uniqueNumber = transactionCounter.toString().padStart(4, '0');
            currentTransactionId = `${prefix}-${uniqueNumber}`;
            transactionCounter++;
            
            // Calculate tax if included
            const taxRate = systemSettings.taxRate / 100;
            const subtotal = total;
            const tax = subtotal * taxRate;
            const grandTotal = subtotal + tax;
            
            // Create transaction record
            const transaction = {
                id: currentTransactionId,
                date: new Date().toLocaleString('id-ID'),
                items: cart.map(item => item.name),
                amounts: cart.map(() => 1),
                prices: cart.map(item => item.price),
                subtotal: subtotal,
                tax: tax,
                total: grandTotal,
                cashier: currentUser.name,
                paymentMethod: paymentMethod,
                cashReceived: paymentMethod === 'cash' ? parseFloat(document.getElementById('cashReceived').value) || 0 : 0,
                change: paymentMethod === 'cash' ? (parseFloat(document.getElementById('cashReceived').value) || 0) - grandTotal : 0
            };
            
            // Add to transactions array
            transactions.unshift(transaction);
            
            // Update ticket status to 'used'
            cart.forEach(item => {
                const ticketIndex = tickets.findIndex(t => t.code === item.code);
                if (ticketIndex !== -1) {
                    tickets[ticketIndex].status = 'used';
                    tickets[ticketIndex].usedDate = new Date().toISOString();
                }
            });
            
            // Prepare receipt data
            prepareReceipt();
            
            // Show receipt modal
            const receiptModal = new bootstrap.Modal(document.getElementById('receiptModal'));
            receiptModal.show();
            
            // Clear cart
            cart = [];
            document.getElementById('paymentMethod').value = 'cash';
            document.getElementById('cashReceived').value = 0;
            updateCartDisplay();
            
            // Reload available tickets
            loadAvailableTickets();
            
            // Add activity
            addActivity(`menyelesaikan transaksi ${currentTransactionId}`);
            
            // Update dashboard stats
            updateDashboardStats();
            
            // Auto print if enabled
            if (systemSettings.autoPrint) {
                setTimeout(() => {
                    printReceipt();
                }, 500);
            }
        }

        // Prepare receipt data
        function prepareReceipt() {
            // Set business details
            document.getElementById('receiptBusinessName').textContent = systemSettings.businessName;
            document.getElementById('receiptBusinessAddress').textContent = systemSettings.businessAddress;
            document.getElementById('receiptBusinessPhone').textContent = `Telp: ${systemSettings.businessPhone}`;
            
            // Set transaction details
            const transaction = transactions.find(t => t.id === currentTransactionId);
            if (!transaction) return;
            
            document.getElementById('receiptTrxId').textContent = currentTransactionId;
            document.getElementById('receiptDate').textContent = transaction.date;
            document.getElementById('receiptCashier').textContent = transaction.cashier;
            document.getElementById('receiptPaymentMethod').textContent = getPaymentMethodText(transaction.paymentMethod);
            
            // Set items
            const receiptItems = document.getElementById('receiptItems');
            receiptItems.innerHTML = '';
            
            transaction.items.forEach((item, index) => {
                const itemDiv = document.createElement('div');
                itemDiv.className = 'item mb-2';
                itemDiv.innerHTML = `
                    <span>${index + 1}. ${item}</span>
                    <span>${formatPrice(transaction.prices[index])}</span>
                `;
                receiptItems.appendChild(itemDiv);
            });
            
            // Set totals
            document.getElementById('receiptSubtotal').textContent = formatPrice(transaction.subtotal);
            document.getElementById('receiptTax').textContent = formatPrice(transaction.tax);
            document.getElementById('receiptTotal').textContent = formatPrice(transaction.total);
            document.getElementById('receiptCash').textContent = formatPrice(transaction.cashReceived);
            document.getElementById('receiptChange').textContent = formatPrice(transaction.change > 0 ? transaction.change : 0);
            
            // Set footer
            document.getElementById('receiptFooter').textContent = systemSettings.receiptFooter;
            
            // Generate barcode for receipt
            if (systemSettings.showBarcode) {
                document.getElementById('receiptBarcode').style.display = 'block';
                JsBarcode("#receiptBarcode", currentTransactionId, {
                    format: "CODE128",
                    lineColor: "#000",
                    width: 1.5,
                    height: 40,
                    displayValue: true
                });
            } else {
                document.getElementById('receiptBarcode').style.display = 'none';
            }
        }

        // Get payment method text
        function getPaymentMethodText(method) {
            switch(method) {
                case 'cash': return 'Tunai';
                case 'transfer': return 'Transfer Bank';
                case 'qris': return 'QRIS';
                case 'debit': return 'Kartu Debit';
                default: return method;
            }
        }

        // Print ticket
        function printTicket() {
            const printContent = document.getElementById('ticketPreviewContent').innerHTML;
            const originalContent = document.body.innerHTML;
            
            document.body.innerHTML = printContent;
            window.print();
            document.body.innerHTML = originalContent;
            
            // Restore the active section
            showSection('ticket-sales');
            
            // Add activity
            addActivity('mencetak karcis');
        }

        // Print receipt
        function printReceipt() {
            const printContent = document.getElementById('receiptContent').innerHTML;
            const originalContent = document.body.innerHTML;
            
            document.body.innerHTML = printContent;
            window.print();
            document.body.innerHTML = originalContent;
            
            // Add activity
            addActivity(`mencetak struk ${currentTransactionId}`);
        }

        // Download receipt as PDF
        function downloadReceipt() {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();
            
            // Capture the receipt content
            html2canvas(document.getElementById('receiptContent')).then(canvas => {
                const imgData = canvas.toDataURL('image/png');
                const imgWidth = doc.internal.pageSize.getWidth() - 20;
                const imgHeight = canvas.height * imgWidth / canvas.width;
                
                doc.addImage(imgData, 'PNG', 10, 10, imgWidth, imgHeight);
                doc.save(`Struk_${currentTransactionId}.pdf`);
                
                // Add activity
                addActivity(`mendownload struk ${currentTransactionId} sebagai PDF`);
            });
        }

        // Load tickets to ticket list
        function loadTickets() {
            const ticketTableBody = document.getElementById('ticketTableBody');
            ticketTableBody.innerHTML = '';
            
            const searchTerm = document.getElementById('ticketSearch').value.toLowerCase();
            const filterStatus = document.getElementById('ticketFilter').value;
            
            const filteredTickets = tickets.filter(ticket => {
                const matchesSearch = ticket.code.toLowerCase().includes(searchTerm) || 
                                     ticket.destination.toLowerCase().includes(searchTerm) ||
                                     ticket.type.toLowerCase().includes(searchTerm);
                
                const matchesFilter = filterStatus === 'all' || ticket.status === filterStatus;
                
                return matchesSearch && matchesFilter;
            });
            
            filteredTickets.forEach(ticket => {
                const row = document.createElement('tr');
                
                row.innerHTML = `
                    <td>${ticket.code}</td>
                    <td>${ticket.destination}</td>
                    <td>${ticket.type.charAt(0).toUpperCase() + ticket.type.slice(1)}</td>
                    <td>${formatPrice(ticket.price)}</td>
                    <td>${formatDate(ticket.date)}</td>
                    <td>
                        <span class="badge ${getStatusBadge(ticket.status)}">
                            ${getStatusText(ticket.status)}
                        </span>
                    </td>
                    <td>
                        <button class="btn btn-sm btn-outline-primary me-1" onclick="viewTicket('${ticket.code}')">
                            <i class="fas fa-eye"></i>
                        </button>
                        <button class="btn btn-sm btn-outline-danger" onclick="voidTicket('${ticket.code}')" ${!hasPermission('delete') ? 'disabled' : ''}>
                            <i class="fas fa-ban"></i>
                        </button>
                    </td>
                `;
                
                ticketTableBody.appendChild(row);
            });
            
            // Update dashboard stats
            updateDashboardStats();
        }

        // View ticket details
        function viewTicket(ticketCode) {
            const ticket = tickets.find(t => t.code === ticketCode);
            if (!ticket) return;
            
            const ticketDetailsContent = document.getElementById('ticketDetailsContent');
            ticketDetailsContent.innerHTML = `
                <div class="mb-3">
                    <label class="form-label">Kode Karcis</label>
                    <p class="form-control-static">${ticket.code}</p>
                </div>
                <div class="mb-3">
                    <label class="form-label">Destinasi</label>
                    <p class="form-control-static">${ticket.destination}</p>
                </div>
                <div class="mb-3">
                    <label class="form-label">Jenis</label>
                    <p class="form-control-static">${ticket.type.charAt(0).toUpperCase() + ticket.type.slice(1)}</p>
                </div>
                <div class="mb-3">
                    <label class="form-label">Harga</label>
                    <p class="form-control-static">${formatPrice(ticket.price)}</p>
                </div>
                <div class="mb-3">
                    <label class="form-label">Tanggal Berlaku</label>
                    <p class="form-control-static">${formatDate(ticket.date)}</p>
                </div>
                <div class="mb-3">
                    <label class="form-label">Status</label>
                    <p class="form-control-static">
                        <span class="badge ${getStatusBadge(ticket.status)}">
                            ${getStatusText(ticket.status)}
                        </span>
                    </p>
                </div>
                <div class="mb-3">
                    <label class="form-label">Dibuat Oleh</label>
                    <p class="form-control-static">${ticket.createdBy}</p>
                </div>
            `;
            
            const modal = new bootstrap.Modal(document.getElementById('viewTicketModal'));
            modal.show();
        }

        // Void ticket
        function voidTicket(ticketCode) {
            if (!hasPermission('delete')) {
                alert('Anda tidak memiliki izin untuk membatalkan karcis!');
                return;
            }
            
            if (confirm('Apakah Anda yakin ingin membatalkan karcis ini?')) {
                // Update ticket status
                const ticketIndex = tickets.findIndex(t => t.code === ticketCode);
                if (ticketIndex !== -1) {
                    tickets[ticketIndex].status = 'expired';
                    alert(`Karcis ${ticketCode} berhasil dibatalkan!`);
                    loadTickets();
                    loadAvailableTickets();
                    
                    // Add activity
                    addActivity(`membatalkan karcis: ${ticketCode}`);
                }
            }
        }

        // Load users to user management
        function loadUsers() {
            const userTableBody = document.getElementById('userTableBody');
            userTableBody.innerHTML = '';
            
            users.forEach(user => {
                const row = document.createElement('tr');
                
                row.innerHTML = `
                    <td>${user.name}</td>
                    <td>${user.username}</td>
                    <td>${getRoleText(user.role)}</td>
                    <td>${user.lastLogin || 'Belum pernah login'}</td>
                    <td>
                        <span class="badge ${user.status === 'active' ? 'bg-success' : 'bg-secondary'}">
                            ${user.status === 'active' ? 'Aktif' : 'Nonaktif'}
                        </span>
                    </td>
                    <td>
                        <button class="btn btn-sm btn-outline-primary me-1" onclick="editUser('${user.username}')" ${currentUser.username === user.username || !hasPermission('edit') ? 'disabled' : ''}>
                            <i class="fas fa-edit"></i>
                        </button>
                        <button class="btn btn-sm btn-outline-danger" onclick="deleteUser('${user.username}')" ${currentUser.username === user.username || !hasPermission('delete') ? 'disabled' : ''}>
                            <i class="fas fa-trash"></i>
                        </button>
                    </td>
                `;
                
                userTableBody.appendChild(row);
            });
            
            // Load cashiers to active cashier dropdown
            const activeCashierSelect = document.getElementById('activeCashier');
            if (activeCashierSelect) {
                activeCashierSelect.innerHTML = '<option value="">Pilih Kasir</option>';
                users.filter(u => u.role === 'cashier' && u.status === 'active').forEach(user => {
                    const option = document.createElement('option');
                    option.value = user.username;
                    option.textContent = user.name;
                    if (systemSettings.activeCashier === user.username) {
                        option.selected = true;
                    }
                    activeCashierSelect.appendChild(option);
                });
            }
        }

        // Show add user modal
        function showAddUserModal() {
            if (!hasPermission('add')) {
                alert('Anda tidak memiliki izin untuk menambahkan pengguna!');
                return;
            }
            
            // Reset form first
            document.getElementById('userForm').reset();
            document.querySelector('#addUserModal .modal-title').textContent = 'Tambah Pengguna';
            const saveBtn = document.querySelector('#addUserModal .btn-primary');
            saveBtn.textContent = 'Simpan';
            saveBtn.onclick = function() { saveUser(); };
            
            const modal = new bootstrap.Modal(document.getElementById('addUserModal'));
            modal.show();
        }

        // Save user
        function saveUser() {
            const fullName = document.getElementById('userFullName').value;
            const username = document.getElementById('userUsername').value;
            const password = document.getElementById('userPassword').value;
            const role = document.getElementById('userRoleSelect').value;
            const status = document.getElementById('userStatus').checked ? 'active' : 'inactive';
            
            if (!fullName || !username || !password || !role) {
                alert('Harap lengkapi semua field yang diperlukan!');
                return;
            }
            
            // Check if username already exists
            const existingUser = users.find(u => u.username === username);
            if (existingUser) {
                alert('Username sudah digunakan!');
                return;
            }
            
            // Add new user
            const newUser = {
                name: fullName,
                username: username,
                password: password,
                role: role,
                lastLogin: '',
                status: status,
                createdBy: currentUser.username,
                createdAt: new Date().toISOString()
            };
            
            users.push(newUser);
            
            alert('Pengguna berhasil disimpan!');
            
            // Close modal
            const modal = bootstrap.Modal.getInstance(document.getElementById('addUserModal'));
            modal.hide();
            
            // Refresh user list
            loadUsers();
            
            // Add activity
            addActivity(`menambahkan pengguna baru: ${fullName}`);
        }

        // Edit user
        function editUser(username) {
            if (!hasPermission('edit')) {
                alert('Anda tidak memiliki izin untuk mengedit pengguna!');
                return;
            }
            
            const user = users.find(u => u.username === username);
            if (!user) return;
            
            // Fill form with user data
            document.getElementById('userFullName').value = user.name;
            document.getElementById('userUsername').value = user.username;
            document.getElementById('userPassword').value = user.password;
            document.getElementById('userRoleSelect').value = user.role;
            document.getElementById('userStatus').checked = user.status === 'active';
            
            // Change modal title
            document.querySelector('#addUserModal .modal-title').textContent = 'Edit Pengguna';
            
            // Change save button to update
            const saveBtn = document.querySelector('#addUserModal .btn-primary');
            saveBtn.textContent = 'Update';
            saveBtn.onclick = function() {
                updateUser(username);
            };
            
            // Show modal
            const modal = new bootstrap.Modal(document.getElementById('addUserModal'));
            modal.show();
        }

        // Update user
        function updateUser(username) {
            const userIndex = users.findIndex(u => u.username === username);
	            if (userIndex === -1) return;
            
            const fullName = document.getElementById('userFullName').value;
            const password = document.getElementById('userPassword').value;
            const role = document.getElementById('userRoleSelect').value;
            const status = document.getElementById('userStatus').checked ? 'active' : 'inactive';
            
            if (!fullName || !password || !role) {
                alert('Harap lengkapi semua field yang diperlukan!');
                return;
            }
            
            // Update user
            users[userIndex] = {
                ...users[userIndex],
                name: fullName,
                password: password,
                role: role,
                status: status
            };
            
            alert('Pengguna berhasil diperbarui!');
            
            // Close modal
            const modal = bootstrap.Modal.getInstance(document.getElementById('addUserModal'));
            modal.hide();
            
            // Refresh user list
            loadUsers();
            
            // Add activity
            addActivity(`memperbarui pengguna: ${fullName}`);
        }

        // Delete user
        function deleteUser(username) {
            if (!hasPermission('delete')) {
                alert('Anda tidak memiliki izin untuk menghapus pengguna!');
                return;
            }
            
            if (confirm('Apakah Anda yakin ingin menghapus pengguna ini?')) {
                users = users.filter(u => u.username !== username);
                alert('Pengguna berhasil dihapus!');
                loadUsers();
                
                // Add activity
                addActivity(`menghapus pengguna: ${username}`);
            }
        }

        // Show add product modal
        function showAddProductModal() {
            if (!hasPermission('add')) {
                alert('Anda tidak memiliki izin untuk menambahkan produk!');
                return;
            }
            
            // Reset form first
            document.getElementById('productForm').reset();
            document.querySelector('#addProductModal .modal-title').textContent = 'Tambah Produk Wisata';
            const saveBtn = document.querySelector('#addProductModal .btn-primary');
            saveBtn.textContent = 'Simpan';
            saveBtn.onclick = function() { saveProduct(); };
            
            const modal = new bootstrap.Modal(document.getElementById('addProductModal'));
            modal.show();
        }

        // Save product
        function saveProduct() {
            const name = document.getElementById('productName').value;
            const category = document.getElementById('productCategory').value;
            const description = document.getElementById('productDescription').value;
            const regularPrice = document.getElementById('productRegularPrice').value;
            const weekendPrice = document.getElementById('productWeekendPrice').value;
            const stock = document.getElementById('productStock').value;
            const status = document.getElementById('productStatus').checked ? 'active' : 'inactive';
            
            if (!name || !category || !regularPrice || !weekendPrice) {
                alert('Harap lengkapi semua field yang diperlukan!');
                return;
            }
            
            // Generate product ID
            const productId = 'PRD-' + Date.now().toString().slice(-6);
            
            // Add new product
            const newProduct = {
                id: productId,
                name: name,
                category: category,
                description: description,
                regularPrice: parseInt(regularPrice),
                weekendPrice: parseInt(weekendPrice),
                stock: parseInt(stock) || 0,
                status: status,
                createdBy: currentUser.username,
                createdAt: new Date().toISOString()
            };
            
            products.push(newProduct);
            
            alert('Produk berhasil disimpan!');
            
            // Close modal
            const modal = bootstrap.Modal.getInstance(document.getElementById('addProductModal'));
            modal.hide();
            
            // Refresh product list
            loadProducts();
            
            // Add activity
            addActivity(`menambahkan produk baru: ${name}`);
        }

        // Edit product
        function editProduct(productId) {
            if (!hasPermission('edit')) {
                alert('Anda tidak memiliki izin untuk mengedit produk!');
                return;
            }
            
            const product = products.find(p => p.id === productId);
            if (!product) return;
            
            // Fill form with product data
            document.getElementById('productName').value = product.name;
            document.getElementById('productCategory').value = product.category;
            document.getElementById('productDescription').value = product.description || '';
            document.getElementById('productRegularPrice').value = product.regularPrice;
            document.getElementById('productWeekendPrice').value = product.weekendPrice;
            document.getElementById('productStock').value = product.stock;
            document.getElementById('productStatus').checked = product.status === 'active';
            
            // Change modal title
            document.querySelector('#addProductModal .modal-title').textContent = 'Edit Produk Wisata';
            
            // Change save button to update
            const saveBtn = document.querySelector('#addProductModal .btn-primary');
            saveBtn.textContent = 'Update';
            saveBtn.onclick = function() {
                updateProduct(productId);
            };
            
            // Show modal
            const modal = new bootstrap.Modal(document.getElementById('addProductModal'));
            modal.show();
        }

        // Update product
        function updateProduct(productId) {
            const productIndex = products.findIndex(p => p.id === productId);
            if (productIndex === -1) return;
            
            const name = document.getElementById('productName').value;
            const category = document.getElementById('productCategory').value;
            const description = document.getElementById('productDescription').value;
            const regularPrice = document.getElementById('productRegularPrice').value;
            const weekendPrice = document.getElementById('productWeekendPrice').value;
            const stock = document.getElementById('productStock').value;
            const status = document.getElementById('productStatus').checked ? 'active' : 'inactive';
            
            if (!name || !category || !regularPrice || !weekendPrice) {
                alert('Harap lengkapi semua field yang diperlukan!');
                return;
            }
            
            // Update product
            products[productIndex] = {
                ...products[productIndex],
                name: name,
                category: category,
                description: description,
                regularPrice: parseInt(regularPrice),
                weekendPrice: parseInt(weekendPrice),
                stock: parseInt(stock) || 0,
                status: status
            };
            
            alert('Produk berhasil diperbarui!');
            
            // Close modal
            const modal = bootstrap.Modal.getInstance(document.getElementById('addProductModal'));
            modal.hide();
            
            // Refresh product list
            loadProducts();
            
            // Add activity
            addActivity(`memperbarui produk: ${name}`);
        }

        // Delete product
        function deleteProduct(productId) {
            if (!hasPermission('delete')) {
                alert('Anda tidak memiliki izin untuk menghapus produk!');
                return;
            }
            
            const product = products.find(p => p.id === productId);
            if (!product) return;
            
            if (confirm('Apakah Anda yakin ingin menghapus produk ini?')) {
                products = products.filter(p => p.id !== productId);
                alert('Produk berhasil dihapus!');
                loadProducts();
                
                // Add activity
                addActivity(`menghapus produk: ${product.name}`);
            }
        }

        // Load reports data
        function loadReports() {
            // Load report data to table
            const reportTableBody = document.getElementById('reportTableBody');
            reportTableBody.innerHTML = '';
            
            // Filter transactions based on report filters
            const startDate = document.getElementById('reportStartDate').value;
            const endDate = document.getElementById('reportEndDate').value;
            const ticketType = document.getElementById('reportTicketType').value;
            const destination = document.getElementById('reportDestination').value;
            
            const filteredTransactions = transactions.filter(transaction => {
                // Date filter
                if (startDate && endDate) {
                    const transactionDate = new Date(transaction.date.split(',')[0]);
                    const start = new Date(startDate);
                    const end = new Date(endDate);
                    
                    if (transactionDate < start || transactionDate > end) {
                        return false;
                    }
                }
                
                // Other filters would be applied here if we had more data
                return true;
            });
            
            filteredTransactions.forEach(transaction => {
                const row = document.createElement('tr');
                
                row.innerHTML = `
                    <td>${transaction.id}</td>
                    <td>${transaction.date}</td>
                    <td>${transaction.items.join(', ')}</td>
                    <td>${transaction.amounts.join(', ')}</td>
                    <td>${transaction.prices.map(p => formatPrice(p)).join(', ')}</td>
                    <td>${formatPrice(transaction.total)}</td>
                    <td>${transaction.cashier}</td>
                `;
                
                reportTableBody.appendChild(row);
            });
            
            // Initialize report chart
            initReportChart(filteredTransactions);
        }

        // Initialize report chart
        function initReportChart(transactions) {
            const ctx = document.getElementById('reportChart').getContext('2d');
            
            // Group transactions by date
            const dailySales = {};
            transactions.forEach(transaction => {
                const date = transaction.date.split(',')[0];
                if (!dailySales[date]) {
                    dailySales[date] = 0;
                }
                dailySales[date] += transaction.total;
            });
            
            const dates = Object.keys(dailySales);
            const amounts = Object.values(dailySales);
            
            if (window.reportChart) {
                window.reportChart.destroy();
            }
            
            window.reportChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: dates,
                    datasets: [{
                        label: 'Pendapatan Harian',
                        data: amounts,
                        backgroundColor: 'rgba(54, 162, 235, 0.5)',
                        borderColor: 'rgba(54, 162, 235, 1)',
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                callback: function(value) {
                                    return 'Rp' + value.toLocaleString('id-ID');
                                }
                            }
                        }
                    },
                    plugins: {
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    return 'Rp' + context.raw.toLocaleString('id-ID');
                                }
                            }
                        }
                    }
                }
            });
        }

        // Generate daily report
        function generateDailyReport() {
            if (!hasPermission('print')) {
                alert('Anda tidak memiliki izin untuk mencetak laporan!');
                return;
            }
            
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();
            
            // Add title
            doc.setFontSize(18);
            doc.text('Laporan Harian Penjualan', 105, 15, { align: 'center' });
            
            // Add business info
            doc.setFontSize(10);
            doc.text(systemSettings.businessName, 105, 25, { align: 'center' });
            doc.text(systemSettings.businessAddress, 105, 30, { align: 'center' });
            doc.text(`Telp: ${systemSettings.businessPhone} | Email: ${systemSettings.businessEmail}`, 105, 35, { align: 'center' });
            
            // Add date range
            const startDate = document.getElementById('reportStartDate').value || 'Semua Tanggal';
            const endDate = document.getElementById('reportEndDate').value || 'Semua Tanggal';
            doc.text(`Periode: ${startDate} - ${endDate}`, 105, 45, { align: 'center' });
            
            // Add generated info
            doc.text(`Dibuat oleh: ${currentUser.name}`, 14, 50);
            doc.text(`Tanggal: ${new Date().toLocaleDateString('id-ID')}`, 14, 55);
            
            // Add table headers
            doc.setFontSize(12);
            doc.text('No. Transaksi', 14, 70);
            doc.text('Tanggal', 50, 70);
            doc.text('Total', 120, 70);
            doc.text('Kasir', 160, 70);
            
            // Add table rows
            doc.setFontSize(10);
            let y = 80;
            transactions.forEach((transaction, index) => {
                if (y > 270) {
                    doc.addPage();
                    y = 20;
                }
                
                doc.text(transaction.id, 14, y);
                doc.text(transaction.date, 50, y);
                doc.text(formatPrice(transaction.total), 120, y);
                doc.text(transaction.cashier, 160, y);
                
                y += 10;
            });
            
            // Add totals
            doc.setFontSize(12);
            const total = transactions.reduce((sum, t) => sum + t.total, 0);
            doc.text(`Total Pendapatan: ${formatPrice(total)}`, 14, y + 10);
            
            // Save the PDF
            doc.save(`Laporan_Penjualan_${new Date().toISOString().slice(0, 10)}.pdf`);
            
            // Add activity
            addActivity('mencetak laporan harian');
        }

        // Export report data
        function exportReportData() {
            if (!hasPermission('print')) {
                alert('Anda tidak memiliki izin untuk mengekspor data!');
                return;
            }
            
            // Convert transactions to CSV
            let csv = 'No. Transaksi,Tanggal,Items,Jumlah,Harga,Total,Kasir\n';
            
            transactions.forEach(transaction => {
                csv += `"${transaction.id}","${transaction.date}","${transaction.items.join(', ')}","${transaction.amounts.join(', ')}","${transaction.prices.map(p => formatPrice(p)).join(', ')}","${formatPrice(transaction.total)}","${transaction.cashier}"\n`;
            });
            
            // Create download link
            const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
            const url = URL.createObjectURL(blob);
            const link = document.createElement('a');
            link.setAttribute('href', url);
            link.setAttribute('download', `Laporan_Transaksi_${new Date().toISOString().slice(0, 10)}.csv`);
            link.style.visibility = 'hidden';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            
            // Add activity
            addActivity('mengekspor data laporan');
        }

        // Load system settings
        function loadSettings() {
            // General settings
            document.getElementById('businessName').value = systemSettings.businessName;
            document.getElementById('businessAddress').value = systemSettings.businessAddress;
            document.getElementById('businessPhone').value = systemSettings.businessPhone;
            document.getElementById('businessEmail').value = systemSettings.businessEmail;
            
            // Receipt settings
            document.getElementById('receiptFormat').value = systemSettings.receiptFormat;
            document.getElementById('receiptFooter').value = systemSettings.receiptFooter;
            document.getElementById('autoPrint').checked = systemSettings.autoPrint;
            document.getElementById('showBarcode').checked = systemSettings.showBarcode;
            
            // Payment settings
            document.getElementById('currency').value = systemSettings.currency;
            document.getElementById('taxRate').value = systemSettings.taxRate;
            document.getElementById('cashPayment').checked = systemSettings.paymentMethods.includes('cash');
            document.getElementById('transferPayment').checked = systemSettings.paymentMethods.includes('transfer');
            document.getElementById('qrisPayment').checked = systemSettings.paymentMethods.includes('qris');
            document.getElementById('debitPayment').checked = systemSettings.paymentMethods.includes('debit');
            
            // Permission settings
            document.getElementById('adminView').checked = systemSettings.permissions.admin.view;
            document.getElementById('adminAdd').checked = systemSettings.permissions.admin.add;
            document.getElementById('adminEdit').checked = systemSettings.permissions.admin.edit;
            document.getElementById('adminDelete').checked = systemSettings.permissions.admin.delete;
            document.getElementById('adminPrint').checked = systemSettings.permissions.admin.print;
            
            document.getElementById('cashierView').checked = systemSettings.permissions.cashier.view;
            document.getElementById('cashierAdd').checked = systemSettings.permissions.cashier.add;
            document.getElementById('cashierEdit').checked = systemSettings.permissions.cashier.edit;
            document.getElementById('cashierDelete').checked = systemSettings.permissions.cashier.delete;
            document.getElementById('cashierPrint').checked = systemSettings.permissions.cashier.print;
            
            document.getElementById('managerView').checked = systemSettings.permissions.manager.view;
            document.getElementById('managerAdd').checked = systemSettings.permissions.manager.add;
            document.getElementById('managerEdit').checked = systemSettings.permissions.manager.edit;
            document.getElementById('managerDelete').checked = systemSettings.permissions.manager.delete;
            document.getElementById('managerPrint').checked = systemSettings.permissions.manager.print;
            
            // Product categories
            const productCategories = document.getElementById('productCategories');
            productCategories.innerHTML = '';
            systemSettings.productCategories.forEach(category => {
                const option = document.createElement('option');
                option.value = category;
                option.textContent = category.charAt(0).toUpperCase() + category.slice(1);
                productCategories.appendChild(option);
            });
            
            // Ticket types
            const ticketTypes = document.getElementById('ticketTypes');
            ticketTypes.innerHTML = '';
            systemSettings.ticketTypes.forEach(type => {
                const option = document.createElement('option');
                option.value = type;
                option.textContent = type.charAt(0).toUpperCase() + type.slice(1);
                ticketTypes.appendChild(option);
            });
        }

        // Save system settings
        function saveSettings() {
            // Verify security code first
            const securityCodeModal = new bootstrap.Modal(document.getElementById('securityCodeModal'));
            securityCodeModal.show();
            
            // Set callback for when security code is verified
            window.verifySecurityCodeCallback = function() {
                // General settings
                systemSettings.businessName = document.getElementById('businessName').value;
                systemSettings.businessAddress = document.getElementById('businessAddress').value;
                systemSettings.businessPhone = document.getElementById('businessPhone').value;
                systemSettings.businessEmail = document.getElementById('businessEmail').value;
                
                // Receipt settings
                systemSettings.receiptFormat = document.getElementById('receiptFormat').value;
                systemSettings.receiptFooter = document.getElementById('receiptFooter').value;
                systemSettings.autoPrint = document.getElementById('autoPrint').checked;
                systemSettings.showBarcode = document.getElementById('showBarcode').checked;
                
                // Payment settings
                systemSettings.currency = document.getElementById('currency').value;
                systemSettings.taxRate = parseInt(document.getElementById('taxRate').value) || 0;
                
                const paymentMethods = [];
                if (document.getElementById('cashPayment').checked) paymentMethods.push('cash');
                if (document.getElementById('transferPayment').checked) paymentMethods.push('transfer');
                if (document.getElementById('qrisPayment').checked) paymentMethods.push('qris');
                if (document.getElementById('debitPayment').checked) paymentMethods.push('debit');
                systemSettings.paymentMethods = paymentMethods;
                
                // Active cashier
                systemSettings.activeCashier = document.getElementById('activeCashier').value;
                
                // Permission settings
                systemSettings.permissions.admin.view = document.getElementById('adminView').checked;
                systemSettings.permissions.admin.add = document.getElementById('adminAdd').checked;
                systemSettings.permissions.admin.edit = document.getElementById('adminEdit').checked;
                systemSettings.permissions.admin.delete = document.getElementById('adminDelete').checked;
                systemSettings.permissions.admin.print = document.getElementById('adminPrint').checked;
                
                systemSettings.permissions.cashier.view = document.getElementById('cashierView').checked;
                systemSettings.permissions.cashier.add = document.getElementById('cashierAdd').checked;
                systemSettings.permissions.cashier.edit = document.getElementById('cashierEdit').checked;
                systemSettings.permissions.cashier.delete = document.getElementById('cashierDelete').checked;
                systemSettings.permissions.cashier.print = document.getElementById('cashierPrint').checked;
                
                systemSettings.permissions.manager.view = document.getElementById('managerView').checked;
                systemSettings.permissions.manager.add = document.getElementById('managerAdd').checked;
                systemSettings.permissions.manager.edit = document.getElementById('managerEdit').checked;
                systemSettings.permissions.manager.delete = document.getElementById('managerDelete').checked;
                systemSettings.permissions.manager.print = document.getElementById('managerPrint').checked;
                
                alert('Pengaturan berhasil disimpan!');
                
                // Add activity
                addActivity('memperbarui pengaturan sistem');
            };
        }

        // Verify security code before saving settings
        function verifySecurityCodeBeforeSave() {
            const securityCodeModal = new bootstrap.Modal(document.getElementById('securityCodeModal'));
            securityCodeModal.show();
            
            // Set callback for when security code is verified
            window.verifySecurityCodeCallback = function() {
                saveSettings();
            };
        }

        // Verify security code
        function verifySecurityCode() {
            const inputCode = document.getElementById('securityCodeInput').value;
            const errorDiv = document.getElementById('securityCodeError');
            
            if (inputCode === securityCode) {
                // Hide error if shown
                errorDiv.style.display = 'none';
                
                // Close modal
                const modal = bootstrap.Modal.getInstance(document.getElementById('securityCodeModal'));
                modal.hide();
                
                // Clear input
                document.getElementById('securityCodeInput').value = '';
                
                // Execute callback if set
                if (typeof window.verifySecurityCodeCallback === 'function') {
                    window.verifySecurityCodeCallback();
                    window.verifySecurityCodeCallback = null;
                }
            } else {
                // Show error
                errorDiv.style.display = 'block';
                document.getElementById('securityCodeErrorMessage').textContent = 'Kode keamanan salah!';
            }
        }

        // Show security modal
        function showSecurityModal() {
            const modal = new bootstrap.Modal(document.getElementById('securityModal'));
            modal.show();
        }

        // Change password
        function changePassword() {
            const currentPassword = document.getElementById('currentPassword').value;
            const newPassword = document.getElementById('newPassword').value;
            const confirmPassword = document.getElementById('confirmNewPassword').value;
            
            if (currentUser.password !== currentPassword) {
                alert('Password saat ini salah!');
                return;
            }
            
            if (newPassword !== confirmPassword) {
                alert('Password baru dan konfirmasi password tidak cocok!');
                return;
            }
            
            if (newPassword.length < 6) {
                alert('Password baru harus minimal 6 karakter!');
                return;
            }
            
            // Update password
            currentUser.password = newPassword;
            
            // Update in users array
            const userIndex = users.findIndex(u => u.username === currentUser.username);
            if (userIndex !== -1) {
                users[userIndex].password = newPassword;
            }
            
            alert('Password berhasil diubah!');
            
            // Add activity
            addActivity('mengubah password');
            
            // Close modal
            const modal = bootstrap.Modal.getInstance(document.getElementById('securityModal'));
            modal.hide();
            
            // Clear form
            document.getElementById('currentPassword').value = '';
            document.getElementById('newPassword').value = '';
            document.getElementById('confirmNewPassword').value = '';
        }

        // Change security code
        function changeSecurityCode() {
            const currentCode = document.getElementById('currentSecurityCode').value;
            const newCode = document.getElementById('newSecurityCode').value;
            const confirmCode = document.getElementById('confirmSecurityCode').value;
            
            if (currentCode !== securityCode) {
                alert('Kode keamanan saat ini salah!');
                return;
            }
            
            if (newCode !== confirmCode) {
                alert('Kode baru dan konfirmasi kode tidak cocok!');
                return;
            }
            
            if (newCode.length < 8) {
                alert('Kode keamanan baru harus minimal 8 karakter!');
                return;
            }
            
            // Update security code
            securityCode = newCode;
            
            alert('Kode keamanan berhasil diubah!');
            
            // Add activity
            addActivity('mengubah kode keamanan sistem');
            
            // Clear form
            document.getElementById('currentSecurityCode').value = '';
            document.getElementById('newSecurityCode').value = '';
            document.getElementById('confirmSecurityCode').value = '';
        }

        // Add new category
        function addCategory() {
            const newCategory = document.getElementById('newCategory').value.trim();
            
            if (!newCategory) {
                alert('Masukkan nama kategori terlebih dahulu!');
                return;
            }
            
            if (systemSettings.productCategories.includes(newCategory.toLowerCase())) {
                alert('Kategori sudah ada!');
                return;
            }
            
            systemSettings.productCategories.push(newCategory.toLowerCase());
            
            // Update UI
            const productCategories = document.getElementById('productCategories');
            const option = document.createElement('option');
            option.value = newCategory.toLowerCase();
            option.textContent = newCategory;
            productCategories.appendChild(option);
            
            // Clear input
            document.getElementById('newCategory').value = '';
            
            // Add activity
            addActivity(`menambahkan kategori produk: ${newCategory}`);
        }

        // Remove selected categories
        function removeSelectedCategories() {
            const select = document.getElementById('productCategories');
            const selectedOptions = Array.from(select.selectedOptions).map(opt => opt.value);
            
            if (selectedOptions.length === 0) {
                alert('Pilih kategori yang ingin dihapus terlebih dahulu!');
                return;
            }
            
            if (confirm('Apakah Anda yakin ingin menghapus kategori terpilih?')) {
                systemSettings.productCategories = systemSettings.productCategories.filter(
                    cat => !selectedOptions.includes(cat)
                );
                
                // Update UI
                loadSettings();
                
                // Add activity
                addActivity(`menghapus kategori produk: ${selectedOptions.join(', ')}`);
            }
        }

        // Add new ticket type
        function addTicketType() {
            const newType = document.getElementById('newTicketType').value.trim();
            
            if (!newType) {
                alert('Masukkan jenis tiket terlebih dahulu!');
                return;
            }
            
            if (systemSettings.ticketTypes.includes(newType.toLowerCase())) {
                alert('Jenis tiket sudah ada!');
                return;
            }
            
            systemSettings.ticketTypes.push(newType.toLowerCase());
            
            // Update UI
            const ticketTypes = document.getElementById('ticketTypes');
            const option = document.createElement('option');
            option.value = newType.toLowerCase();
            option.textContent = newType;
            ticketTypes.appendChild(option);
            
            // Clear input
            document.getElementById('newTicketType').value = '';
            
            // Add activity
            addActivity(`menambahkan jenis tiket: ${newType}`);
        }

        // Remove selected ticket types
        function removeSelectedTicketTypes() {
            const select = document.getElementById('ticketTypes');
            const selectedOptions = Array.from(select.selectedOptions).map(opt => opt.value);
            
            if (selectedOptions.length === 0) {
                alert('Pilih jenis tiket yang ingin dihapus terlebih dahulu!');
                return;
            }
            
            if (confirm('Apakah Anda yakin ingin menghapus jenis tiket terpilih?')) {
                systemSettings.ticketTypes = systemSettings.ticketTypes.filter(
                    type => !selectedOptions.includes(type)
                );
                
                // Update UI
                loadSettings();
                
                // Add activity
                addActivity(`menghapus jenis tiket: ${selectedOptions.join(', ')}`);
            }
        }

        // Backup data
        function backupData() {
            const data = {
                products: products,
                tickets: tickets,
                users: users,
                transactions: transactions,
                systemSettings: systemSettings,
                securityCode: securityCode,
                transactionCounter: transactionCounter
            };
            
            const dataStr = JSON.stringify(data, null, 2);
            const blob = new Blob([dataStr], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const link = document.createElement('a');
            link.setAttribute('href', url);
            link.setAttribute('download', `TourTick_Backup_${new Date().toISOString().slice(0, 10)}.json`);
            link.style.visibility = 'hidden';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            
            // Add activity
            addActivity('melakukan backup data sistem');
        }

        // Restore data
        function restoreData() {
            const fileInput = document.getElementById('restoreFile');
            const file = fileInput.files[0];
            
            if (!file) {
                alert('Pilih file backup terlebih dahulu!');
                return;
            }
            
            if (!confirm('PERINGATAN: Semua data saat ini akan diganti dengan data dari backup. Lanjutkan?')) {
                return;
            }
            
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const data = JSON.parse(e.target.result);
                    
                    // Restore data
                    products = data.products || [];
                    tickets = data.tickets || [];
                    users = data.users || [];
                    transactions = data.transactions || [];
                    systemSettings = data.systemSettings || {};
                    securityCode = data.securityCode || "Tiket.013579";
                    transactionCounter = data.transactionCounter || 1;
                    
                    // Reload all data
                    loadProducts();
                    loadTickets();
                    loadUsers();
                    loadReports();
                    loadSettings();
                    
                    alert('Data berhasil dipulihkan dari backup!');
                    
                    // Add activity
                    addActivity('memulihkan data dari backup');
                } catch (error) {
                    alert('Gagal memproses file backup: ' + error.message);
                }
            };
            reader.readAsText(file);
        }

        // Confirm reset data
        function confirmResetData() {
            const modal = new bootstrap.Modal(document.getElementById('resetDataModal'));
            modal.show();
        }

        // Reset all data
        function resetData() {
            const inputCode = document.getElementById('resetSecurityCode').value;
            
            if (inputCode !== securityCode) {
                document.getElementById('resetDataError').style.display = 'block';
                document.getElementById('resetDataErrorMessage').textContent = 'Kode keamanan salah!';
                return;
            }
            
            if (!confirm('PERINGATAN: Semua data akan dihapus dan sistem akan dikembalikan ke pengaturan awal. Lanjutkan?')) {
                return;
            }
            
            // Reset all data
            products = [];
            tickets = [];
            users = [
                {
                    name: "Admin",
                    username: "admin",
                    password: "admin123",
                    role: "admin",
                    lastLogin: "",
                    status: "active",
                    createdBy: "system",
                    createdAt: "2023-01-01"
                }
            ];
            
            transactions = [];
            currentUser = null;
            securityCode = "Tiket.013579";
            cart = [];
            currentTicketCode = '';
            currentTransactionId = '';
            transactionCounter = 1;
            
            // Reset system settings
            systemSettings = {
                businessName: "TourTick",
                businessAddress: "Jl. Raya Wisata No. 123, Kota Pariwisata",
                businessPhone: "(021) 1234567",
                businessEmail: "info@tourtick.com",
                receiptFormat: "TRX",
                receiptFooter: "Terima kasih atas kunjungan Anda",
                ticketValidity: 30,
                autoPrint: true,
                showBarcode: true,
                currency: "IDR",
                taxRate: 10,
                paymentMethods: ["cash", "transfer", "qris"],
                activeCashier: "",
                permissions: {
                    admin: { view: true, add: true, edit: true, delete: true, print: true, settings: true },
                    cashier: { view: true, add: true, edit: true, delete: false, print: true, settings: false },
                    manager: { view: true, add: true, edit: true, delete: false, print: true, settings: false }
                },
                productCategories: ["nature", "history", "waterpark", "adventure", "beach"],
                ticketTypes: ["regular", "vip", "group", "student", "foreigner"]
            };
            
            // Reload all data
            loadProducts();
            loadTickets();
            loadUsers();
            loadReports();
            loadSettings();
            
            // Close modal
            const modal = bootstrap.Modal.getInstance(document.getElementById('resetDataModal'));
            modal.hide();
            
            alert('Semua data berhasil direset ke pengaturan awal!');
            
            // Add activity
            addActivity('melakukan reset semua data sistem');
        }

        // Show import modal
        function showImportModal() {
            const modal = new bootstrap.Modal(document.getElementById('importModal'));
            modal.show();
        }

        // Import data
        function importData() {
            const fileInput = document.getElementById('importFile');
            const file = fileInput.files[0];
            const importType = document.getElementById('importType').value;
            
            if (!file) {
                alert('Pilih file terlebih dahulu!');
                return;
            }
            
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    // Parse Excel file would go here in a real implementation
                    // For this demo, we'll just simulate success
                    
                    alert(`Data ${importType} berhasil diimport!`);
                    
                    // Close modal
                    const modal = bootstrap.Modal.getInstance(document.getElementById('importModal'));
                    modal.hide();
                    
                    // Reload data
                    if (importType === 'tickets') {
                        loadTickets();
                    } else if (importType === 'products') {
                        loadProducts();
                    } else if (importType === 'users') {
                        loadUsers();
                    }
                    
                    // Add activity
                    addActivity(`mengimport data ${importType}`);
                } catch (error) {
                    alert('Gagal memproses file: ' + error.message);
                }
            };
            reader.readAsBinaryString(file);
        }

        // Export tickets
        function exportTickets() {
            if (!hasPermission('print')) {
                alert('Anda tidak memiliki izin untuk mengekspor data!');
                return;
            }
            
            // Convert tickets to CSV
            let csv = 'Kode,Destinasi,Jenis,Harga,Tanggal,Status,Dibuat Oleh\n';
            
            tickets.forEach(ticket => {
                csv += `"${ticket.code}","${ticket.destination}","${ticket.type}","${ticket.price}","${formatDate(ticket.date)}","${ticket.status}","${ticket.createdBy}"\n`;
            });
            
            // Create download link
            const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
            const url = URL.createObjectURL(blob);
            const link = document.createElement('a');
            link.setAttribute('href', url);
            link.setAttribute('download', `Daftar_Karcis_${new Date().toISOString().slice(0, 10)}.csv`);
            link.style.visibility = 'hidden';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            
            // Add activity
            addActivity('mengekspor data karcis');
        }

        // Search tickets in ticket list
        function searchTickets() {
            const searchTerm = document.getElementById('ticketSearch').value.toLowerCase();
            const rows = document.querySelectorAll('#ticketTableBody tr');
            
            rows.forEach(row => {
                const ticketCode = row.querySelector('td').textContent.toLowerCase();
                const destination = row.querySelector('td:nth-child(2)').textContent.toLowerCase();
                const type = row.querySelector('td:nth-child(3)').textContent.toLowerCase();
                
                if (ticketCode.includes(searchTerm) || destination.includes(searchTerm) || type.includes(searchTerm)) {
                    row.style.display = '';
                } else {
                    row.style.display = 'none';
                }
            });
        }

        // Filter tickets by status
        function filterTickets() {
            loadTickets();
        }

        // Search product list
        function searchProductList() {
            const searchTerm = document.getElementById('productListSearch').value.toLowerCase();
            const rows = document.querySelectorAll('#productTableBody tr');
            
            rows.forEach(row => {
                const productName = row.querySelector('td').textContent.toLowerCase();
                const category = row.querySelector('td:nth-child(2)').textContent.toLowerCase();
                
                if (productName.includes(searchTerm) || category.includes(searchTerm)) {
                    row.style.display = '';
                } else {
                    row.style.display = 'none';
                }
            });
        }

        // Search users
        function searchUsers() {
            const searchTerm = document.getElementById('userSearch').value.toLowerCase();
            const rows = document.querySelectorAll('#userTableBody tr');
            
            rows.forEach(row => {
                const name = row.querySelector('td').textContent.toLowerCase();
                const username = row.querySelector('td:nth-child(2)').textContent.toLowerCase();
                const role = row.querySelector('td:nth-child(3)').textContent.toLowerCase();
                
                if (name.includes(searchTerm) || username.includes(searchTerm) || role.includes(searchTerm)) {
                    row.style.display = '';
                } else {
                    row.style.display = 'none';
                }
            });
        }

        // Initialize charts
        function initCharts() {
            // Sales chart
            const salesCtx = document.getElementById('salesChart').getContext('2d');
            
            // Sample data for last 7 days
            const labels = [];
            const salesData = [];
            const visitorsData = [];
            
            for (let i = 6; i >= 0; i--) {
                const date = new Date();
                date.setDate(date.getDate() - i);
                labels.push(date.toLocaleDateString('id-ID', { weekday: 'short', day: 'numeric' }));
                
                // Random data for demo
                salesData.push(Math.floor(Math.random() * 50) + 10);
                visitorsData.push(Math.floor(Math.random() * 100) + 30);
            }
            
            window.salesChart = new Chart(salesCtx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [
                        {
                            label: 'Penjualan',
                            data: salesData,
                            borderColor: 'rgba(54, 162, 235, 1)',
                            backgroundColor: 'rgba(54, 162, 235, 0.1)',
                            tension: 0.3,
                            yAxisID: 'y'
                        },
                        {
                            label: 'Pengunjung',
                            data: visitorsData,
                            borderColor: 'rgba(75, 192, 192, 1)',
                            backgroundColor: 'rgba(75, 192, 192, 0.1)',
                            tension: 0.3,
                            yAxisID: 'y1'
                        }
                    ]
                },
                options: {
                    responsive: true,
                    interaction: {
                        mode: 'index',
                        intersect: false,
                    },
                    scales: {
                        y: {
                            type: 'linear',
                            display: true,
                            position: 'left',
                            title: {
                                display: true,
                                text: 'Penjualan'
                            }
                        },
                        y1: {
                            type: 'linear',
                            display: true,
                            position: 'right',
                            title: {
                                display: true,
                                text: 'Pengunjung'
                            },
                            grid: {
                                drawOnChartArea: false,
                            }
                        }
                    }
                }
            });
            
            // Top products chart
            const topProductsCtx = document.getElementById('topProductsChart').getContext('2d');
            
            // Sample data for top products
            const topProducts = products.length > 0 ? 
                products.slice(0, 5).map(p => p.name) : 
                ['Taman Wisata', 'Museum', 'Waterpark', 'Pantai', 'Gunung'];
                
            const topProductsSales = products.length > 0 ? 
                products.slice(0, 5).map(() => Math.floor(Math.random() * 100) + 20) :
                [85, 72, 65, 50, 45];
            
            window.topProductsChart = new Chart(topProductsCtx, {
                type: 'doughnut',
                data: {
                    labels: topProducts,
                    datasets: [{
                        data: topProductsSales,
                        backgroundColor: [
                            'rgba(255, 99, 132, 0.7)',
                            'rgba(54, 162, 235, 0.7)',
                            'rgba(255, 206, 86, 0.7)',
                            'rgba(75, 192, 192, 0.7)',
                            'rgba(153, 102, 255, 0.7)'
                        ],
                        borderColor: [
                            'rgba(255, 99, 132, 1)',
                            'rgba(54, 162, 235, 1)',
                            'rgba(255, 206, 86, 1)',
                            'rgba(75, 192, 192, 1)',
                            'rgba(153, 102, 255, 1)'
                        ],
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        legend: {
                            position: 'bottom',
                        }
                    }
                }
            });
        }

        // Update dashboard stats
        function updateDashboardStats() {
            // Today's date
            const today = new Date().toISOString().slice(0, 10);
            
            // Today's sales
            const todaySales = tickets.filter(t => 
                t.status === 'used' && 
                t.usedDate && 
                t.usedDate.slice(0, 10) === today
            ).length;
            
            document.getElementById('todaySales').textContent = todaySales;
            
            // Today's revenue
            const todayRevenue = tickets.filter(t => 
                t.status === 'used' && 
                t.usedDate && 
                t.usedDate.slice(0, 10) === today
            ).reduce((sum, t) => sum + t.price, 0);
            
            document.getElementById('todayRevenue').textContent = formatPrice(todayRevenue);
            
            // Today's visitors (same as sales for this demo)
            document.getElementById('todayVisitors').textContent = todaySales;
            
            // Available tickets
            const availableTickets = tickets.filter(t => t.status === 'valid').length;
            document.getElementById('availableTickets').textContent = availableTickets;
            
            // Recent transactions
            const recentTransactions = document.getElementById('recentTransactions');
            recentTransactions.innerHTML = '';
            
            transactions.slice(0, 5).forEach(transaction => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${transaction.id}</td>
                    <td>${transaction.date}</td>
                    <td>${transaction.items.length}</td>
                    <td>${formatPrice(transaction.total)}</td>
                `;
                recentTransactions.appendChild(row);
            });
            
            // Recent activities
            const recentActivities = document.getElementById('recentActivities');
            recentActivities.innerHTML = '';
            
            // Sample activities
            const activities = [
                { text: 'Transaksi TRX-001 selesai', time: '2 menit lalu' },
                { text: '5 karcis baru dibuat', time: '15 menit lalu' },
                { text: 'Pengguna baru ditambahkan', time: '1 jam lalu' },
                { text: 'Laporan harian dicetak', time: '3 jam lalu' },
                { text: 'Sistem diupdate', time: '5 jam lalu' }
            ];
            
            activities.forEach(activity => {
                const item = document.createElement('a');
                item.className = 'list-group-item list-group-item-action';
                item.innerHTML = `
                    <div class="d-flex w-100 justify-content-between">
                        <p class="mb-1">${activity.text}</p>
                        <small class="text-muted">${activity.time}</small>
                    </div>
                `;
                recentActivities.appendChild(item);
            });
        }

        // Refresh dashboard
        function refreshDashboard() {
            updateDashboardStats();
            
            // Add activity
            addActivity('memperbarui dashboard');
        }

        // Add activity to log
        function addActivity(text) {
            // In a real app, this would save to a database
            console.log(`[Activity] ${currentUser.name} ${text}`);
        }

        // Format price
        function formatPrice(amount) {
            return 'Rp' + parseInt(amount || 0).toLocaleString('id-ID');
        }

        // Format date
        function formatDate(dateString) {
            if (!dateString) return '';
            const date = new Date(dateString);
            return date.toLocaleDateString('id-ID', { day: 'numeric', month: 'short', year: 'numeric' });
        }

        // Get status badge class
        function getStatusBadge(status) {
            switch(status) {
                case 'valid': return 'badge-valid';
                case 'used': return 'badge-used';
                case 'expired': return 'badge-expired';
                default: return 'badge-secondary';
            }
        }

        // Get status text
        function getStatusText(status) {
            switch(status) {
                case 'valid': return 'Valid';
                case 'used': return 'Digunakan';
                case 'expired': return 'Kadaluarsa';
                default: return status;
            }
        }

        // Logout function
        function logout() {
            if (confirm('Apakah Anda yakin ingin logout?')) {
                currentUser = null;
                document.getElementById('appContainer').style.display = 'none';
                
                // Show login modal
                const loginModal = new bootstrap.Modal(document.getElementById('loginModal'));
                loginModal.show();
                
                // Clear login form
                document.getElementById('loginForm').reset();
            }
        }
    </script>
</body>
</html>
