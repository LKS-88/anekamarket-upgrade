<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TourTicket Pro - Sistem Penjualan Tiket Wisata</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.25/jspdf.plugin.autotable.min.js"></script>
    <style>
        :root {
            --primary-color: #2c3e50;
            --secondary-color: #3498db;
            --accent-color: #e74c3c;
            --light-color: #ecf0f1;
            --dark-color: #2c3e50;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: #f5f5f5;
            color: var(--dark-color);
        }
        
        .navbar-brand {
            font-weight: 700;
            color: var(--light-color) !important;
            display: flex;
            align-items: center;
        }
        
        .navbar-brand img {
            height: 30px;
            margin-right: 10px;
        }
        
        .navbar {
            background-color: var(--primary-color) !important;
        }
        
        .sidebar {
            background-color: var(--dark-color);
            color: white;
            min-height: calc(100vh - 56px);
            padding: 0;
        }
        
        .sidebar .nav-link {
            color: rgba(255, 255, 255, 0.8);
            padding: 12px 20px;
            border-left: 4px solid transparent;
            transition: all 0.3s;
        }
        
        .sidebar .nav-link:hover {
            color: white;
            background-color: rgba(255, 255, 255, 0.1);
            border-left: 4px solid var(--secondary-color);
        }
        
        .sidebar .nav-link.active {
            color: white;
            background-color: rgba(255, 255, 255, 0.1);
            border-left: 4px solid var(--secondary-color);
        }
        
        .sidebar .nav-link i {
            margin-right: 10px;
        }
        
        .card {
            border: none;
            border-radius: 10px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            transition: transform 0.3s;
            margin-bottom: 20px;
        }
        
        .card:hover {
            transform: translateY(-5px);
        }
        
        .card-header {
            background-color: var(--primary-color);
            color: white;
            border-radius: 10px 10px 0 0 !important;
            padding: 15px 20px;
        }
        
        .btn-primary {
            background-color: var(--secondary-color);
            border-color: var(--secondary-color);
        }
        
        .btn-danger {
            background-color: var(--accent-color);
            border-color: var(--accent-color);
        }
        
        .ticket-card {
            background: linear-gradient(135deg, #ffffff 0%, #f8f9fa 100%);
            border: 1px solid #dee2e6;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 20px;
            position: relative;
            overflow: hidden;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        }
        
        .ticket-card::before {
            content: "";
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 5px;
            background: linear-gradient(90deg, var(--secondary-color), var(--accent-color));
        }
        
        .ticket-code {
            font-family: 'Courier New', monospace;
            font-size: 1.5rem;
            font-weight: bold;
            color: var(--primary-color);
            letter-spacing: 1px;
            background: #f8f9fa;
            padding: 10px;
            border-radius: 5px;
            text-align: center;
            border: 1px dashed #ccc;
            margin: 10px 0;
        }
        
        .ticket-watermark {
            position: absolute;
            opacity: 0.05;
            font-size: 8rem;
            font-weight: bold;
            color: var(--primary-color);
            transform: rotate(-30deg);
            top: 30%;
            left: 10%;
            z-index: 0;
        }
        
        .ticket-type-badge {
            position: absolute;
            top: 10px;
            right: 10px;
            font-size: 0.8rem;
            font-weight: bold;
            padding: 5px 10px;
            border-radius: 20px;
            text-transform: uppercase;
        }
        
        .ticket-regular {
            background-color: #3498db;
            color: white;
        }
        
        .ticket-vip {
            background-color: #f39c12;
            color: white;
        }
        
        .ticket-family {
            background-color: #2ecc71;
            color: white;
        }
        
        .ticket-group {
            background-color: #9b59b6;
            color: white;
        }
        
        .ticket-details {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
            margin-top: 15px;
        }
        
        .ticket-detail {
            background: #f8f9fa;
            padding: 8px;
            border-radius: 5px;
            font-size: 0.9rem;
        }
        
        .ticket-detail small {
            display: block;
            color: #6c757d;
            font-size: 0.8rem;
        }
        
        @media print {
            .no-print {
                display: none !important;
            }
            
            body {
                background-color: white !important;
            }
            
            .ticket-card {
                page-break-inside: avoid;
                margin: 10px 0;
                box-shadow: none;
                border: 1px solid #ddd;
            }
            
            .ticket-watermark {
                opacity: 0.1;
            }
            
            .ticket-print-grid {
                display: grid;
                grid-template-columns: repeat(2, 1fr);
                gap: 10px;
                margin-bottom: 20px;
            }
            
            @page {
                size: A4;
                margin: 10mm;
            }
        }
        
        @media (max-width: 768px) {
            .sidebar {
                min-height: auto;
            }
            
            .ticket-watermark {
                font-size: 5rem;
            }
            
            .ticket-details {
                grid-template-columns: 1fr;
            }
        }
        
        /* Receipt styling */
        .receipt {
            width: 100%;
            max-width: 400px;
            margin: 0 auto;
            font-family: 'Courier New', monospace;
            padding: 20px;
            border: 1px solid #ddd;
        }
        
        .receipt-header {
            text-align: center;
            margin-bottom: 15px;
        }
        
        .receipt-header img {
            max-height: 60px;
            margin-bottom: 10px;
        }
        
        .receipt-title {
            font-weight: bold;
            font-size: 1.2rem;
            margin-bottom: 5px;
        }
        
        .receipt-meta {
            font-size: 0.9rem;
            color: #555;
            margin-bottom: 15px;
        }
        
        .receipt-items {
            width: 100%;
            border-collapse: collapse;
            margin-bottom: 15px;
        }
        
        .receipt-items th {
            text-align: left;
            border-bottom: 1px dashed #ddd;
            padding: 5px 0;
        }
        
        .receipt-items td {
            padding: 5px 0;
            border-bottom: 1px dashed #eee;
        }
        
        .receipt-items .right {
            text-align: right;
        }
        
        .receipt-totals {
            width: 100%;
            margin-top: 15px;
        }
        
        .receipt-totals td {
            padding: 5px 0;
        }
        
        .receipt-totals .right {
            text-align: right;
        }
        
        .receipt-totals .total {
            font-weight: bold;
            border-top: 1px dashed #ddd;
            border-bottom: 1px dashed #ddd;
        }
        
        .receipt-footer {
            margin-top: 20px;
            text-align: center;
            font-size: 0.8rem;
            color: #777;
        }
        
        /* Access badge styles */
        .badge-admin {
            background-color: #e74c3c;
            color: white;
        }
        
        .badge-cashier {
            background-color: #3498db;
            color: white;
        }
        
        .badge-manager {
            background-color: #f39c12;
            color: white;
        }
        
        /* Restricted access styling */
        .restricted-access {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 300px;
            text-align: center;
            color: #777;
        }
        
        .restricted-access i {
            font-size: 3rem;
            margin-bottom: 15px;
            color: #e74c3c;
        }
        
        /* Premium ticket styling */
        .premium-ticket {
            background: linear-gradient(135deg, #f5f7fa 0%, #e4e8eb 100%);
            border: 1px solid #d1d9e6;
            border-radius: 12px;
            padding: 25px;
            margin-bottom: 25px;
            position: relative;
            overflow: hidden;
            box-shadow: 0 10px 20px rgba(0, 0, 0, 0.1);
        }
        
        .premium-ticket::before {
            content: "";
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 8px;
            background: linear-gradient(90deg, #3498db, #2ecc71, #f39c12, #e74c3c);
        }
        
        .premium-ticket .ticket-code {
            font-family: 'Courier New', monospace;
            font-size: 1.8rem;
            font-weight: bold;
            color: #2c3e50;
            letter-spacing: 2px;
            background: #ffffff;
            padding: 15px;
            border-radius: 8px;
            text-align: center;
            border: 2px dashed #3498db;
            margin: 15px 0;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.05);
        }
        
        .premium-ticket .ticket-watermark {
            position: absolute;
            opacity: 0.03;
            font-size: 10rem;
            font-weight: bold;
            color: #2c3e50;
            transform: rotate(-30deg);
            top: 25%;
            left: 5%;
            z-index: 0;
        }
        
        .premium-ticket .ticket-type-badge {
            position: absolute;
            top: 15px;
            right: 15px;
            font-size: 0.9rem;
            font-weight: bold;
            padding: 6px 12px;
            border-radius: 20px;
            text-transform: uppercase;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
        }
        
        .premium-ticket .ticket-details {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            margin-top: 20px;
        }
        
        .premium-ticket .ticket-detail {
            background: #ffffff;
            padding: 12px;
            border-radius: 8px;
            font-size: 0.95rem;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.05);
        }
        
        .premium-ticket .ticket-detail small {
            display: block;
            color: #7f8c8d;
            font-size: 0.85rem;
            margin-bottom: 5px;
        }
        
        /* Print layout for tickets */
        .ticket-print-page {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 15px;
            padding: 15px;
        }
        
        .ticket-print-page .premium-ticket {
            margin: 0;
            break-inside: avoid;
        }
    </style>
</head>
<body>
    <!-- Navbar -->
    <nav class="navbar navbar-expand-lg navbar-dark mb-4">
        <div class="container-fluid">
            <a class="navbar-brand" href="#">
                <img src="https://raw.githubusercontent.com/LKS-88/anekamarket/refs/heads/main/Logo-Anekamarketku.png" alt="Logo">
                TourTicket Pro
            </a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav ms-auto">
                    <li class="nav-item dropdown">
                        <a class="nav-link dropdown-toggle" href="#" id="userDropdown" role="button" data-bs-toggle="dropdown">
                            <i class="fas fa-user-circle me-1"></i>
                            <span id="currentUsername">Admin</span>
                        </a>
                        <ul class="dropdown-menu dropdown-menu-end">
                            <li><a class="dropdown-item" href="#" data-bs-toggle="modal" data-bs-target="#changePasswordModal"><i class="fas fa-key me-2"></i>Ganti Password</a></li>
                            <li><hr class="dropdown-divider"></li>
                            <li><a class="dropdown-item" href="#" id="logoutBtn"><i class="fas fa-sign-out-alt me-2"></i>Logout</a></li>
                        </ul>
                    </li>
                </ul>
            </div>
        </div>
    </nav>

    <div class="container-fluid">
        <div class="row">
            <!-- Sidebar -->
            <div class="col-lg-2 col-md-3 d-md-block sidebar collapse no-print" id="sidebarMenu">
                <div class="position-sticky pt-3">
                    <ul class="nav flex-column">
                        <li class="nav-item">
                            <a class="nav-link active" href="#" id="dashboardLink">
                                <i class="fas fa-tachometer-alt"></i> Dashboard
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="#" id="generateTicketLink">
                                <i class="fas fa-ticket-alt"></i> Generate Tiket
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="#" id="stockTicketLink">
                                <i class="fas fa-boxes"></i> Stok Tiket
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="#" id="salesLink">
                                <i class="fas fa-cash-register"></i> Penjualan
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="#" id="transactionsLink">
                                <i class="fas fa-history"></i> Transaksi
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="#" id="reportsLink">
                                <i class="fas fa-chart-bar"></i> Laporan
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="#" id="usersLink">
                                <i class="fas fa-users-cog"></i> Pengguna
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="#" id="settingsLink">
                                <i class="fas fa-cog"></i> Pengaturan
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="#" id="backupLink">
                                <i class="fas fa-database"></i> Backup & Restore
                            </a>
                        </li>
                    </ul>
                </div>
            </div>

            <!-- Main Content -->
            <main class="col-lg-10 col-md-9 ms-sm-auto px-md-4">
                <!-- Dashboard Section -->
                <div class="section" id="dashboardSection">
                    <div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
                        <h1 class="h2">Dashboard</h1>
                    </div>
                    
                    <div class="row">
                        <div class="col-md-4">
                            <div class="card">
                                <div class="card-header">
                                    <h5 class="card-title mb-0"><i class="fas fa-box-open me-2"></i>Stok Tiket</h5>
                                </div>
                                <div class="card-body">
                                    <h3 class="card-text text-center" id="stockCount">0</h3>
                                    <p class="text-muted text-center">Tiket Tersedia</p>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="card">
                                <div class="card-header">
                                    <h5 class="card-title mb-0"><i class="fas fa-money-bill-wave me-2"></i>Penjualan Hari Ini</h5>
                                </div>
                                <div class="card-body">
                                    <h3 class="card-text text-center" id="todaySalesCount">0</h3>
                                    <p class="text-muted text-center">Tiket Terjual</p>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="card">
                                <div class="card-header">
                                    <h5 class="card-title mb-0"><i class="fas fa-wallet me-2"></i>Pendapatan Hari Ini</h5>
                                </div>
                                <div class="card-body">
                                    <h3 class="card-text text-center" id="todayRevenue">Rp 0</h3>
                                    <p class="text-muted text-center">Total Pendapatan</p>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="row mt-4">
                        <div class="col-md-6">
                            <div class="card">
                                <div class="card-header">
                                    <h5 class="card-title mb-0"><i class="fas fa-chart-line me-2"></i>Penjualan 7 Hari Terakhir</h5>
                                </div>
                                <div class="card-body">
                                    <canvas id="salesChart" height="250"></canvas>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="card">
                                <div class="card-header">
                                    <h5 class="card-title mb-0"><i class="fas fa-bell me-2"></i>Aktivitas Terakhir</h5>
                                </div>
                                <div class="card-body">
                                    <div class="list-group" id="recentActivities">
                                        <div class="list-group-item">
                                            <div class="d-flex w-100 justify-content-between">
                                                <small class="text-muted">Tidak ada aktivitas terakhir</small>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Generate Ticket Section -->
                <div class="section d-none" id="generateTicketSection">
                    <div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
                        <h1 class="h2">Generate Tiket</h1>
                    </div>
                    
                    <div class="card mb-4">
                        <div class="card-header">
                            <h5 class="card-title mb-0"><i class="fas fa-cogs me-2"></i>Pengaturan Tiket</h5>
                        </div>
                        <div class="card-body">
                            <form id="generateTicketForm">
                                <div class="row mb-3">
                                    <div class="col-md-6">
                                        <label for="ticketType" class="form-label">Jenis Tiket</label>
                                        <select class="form-select" id="ticketType" required>
                                            <option value="regular">Regular</option>
                                            <option value="vip">VIP</option>
                                            <option value="family">Family Package</option>
                                            <option value="group">Group</option>
                                        </select>
                                    </div>
                                    <div class="col-md-6">
                                        <label for="ticketPrice" class="form-label">Harga Tiket (Rp)</label>
                                        <input type="number" class="form-control" id="ticketPrice" min="1000" value="50000" required>
                                    </div>
                                </div>
                                <div class="row mb-3">
                                    <div class="col-md-6">
                                        <label for="ticketQuantity" class="form-label">Jumlah Tiket</label>
                                        <input type="number" class="form-control" id="ticketQuantity" min="1" max="1000" value="1" required>
                                    </div>
                                    <div class="col-md-6">
                                        <label for="ticketPrefix" class="form-label">Prefix Kode Tiket (Opsional)</label>
                                        <input type="text" class="form-control" id="ticketPrefix" maxlength="3" placeholder="TT">
                                    </div>
                                </div>
                                <div class="mb-3">
                                    <label for="ticketExpiry" class="form-label">Tanggal Kedaluwarsa</label>
                                    <input type="date" class="form-control" id="ticketExpiry">
                                    <div class="form-text">Biarkan kosong jika tidak ada kedaluwarsa</div>
                                </div>
                                <button type="submit" class="btn btn-primary">
                                    <i class="fas fa-ticket-alt me-2"></i>Generate Tiket
                                </button>
                            </form>
                        </div>
                    </div>
                    
                    <div class="card" id="generatedTicketsCard" style="display: none;">
                        <div class="card-header d-flex justify-content-between align-items-center">
                            <h5 class="card-title mb-0"><i class="fas fa-tickets me-2"></i>Tiket yang Digenerate</h5>
                            <button class="btn btn-sm btn-success" id="printAllTicketsBtn">
                                <i class="fas fa-print me-1"></i>Cetak Semua
                            </button>
                        </div>
                        <div class="card-body" id="generatedTicketsContainer">
                            <!-- Generated tickets will appear here -->
                        </div>
                    </div>
                </div>
                
                <!-- Stock Ticket Section -->
                <div class="section d-none" id="stockTicketSection">
                    <div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
                        <h1 class="h2">Stok Tiket</h1>
                        <div class="btn-toolbar mb-2 mb-md-0">
                            <div class="btn-group me-2">
                                <button type="button" class="btn btn-sm btn-outline-secondary" id="exportStockBtn">
                                    <i class="fas fa-file-export me-1"></i>Export
                                </button>
                                <button type="button" class="btn btn-sm btn-outline-danger" id="clearStockBtn">
                                    <i class="fas fa-trash me-1"></i>Hapus Stok
                                </button>
                            </div>
                        </div>
                    </div>
                    
                    <div class="card mb-4">
                        <div class="card-header">
                            <h5 class="card-title mb-0"><i class="fas fa-filter me-2"></i>Filter</h5>
                        </div>
                        <div class="card-body">
                            <div class="row">
                                <div class="col-md-4">
                                    <label for="filterStatus" class="form-label">Status</label>
                                    <select class="form-select" id="filterStatus">
                                        <option value="all">Semua</option>
                                        <option value="available">Tersedia</option>
                                        <option value="sold">Terjual</option>
                                        <option value="expired">Kedaluwarsa</option>
                                    </select>
                                </div>
                                <div class="col-md-4">
                                    <label for="filterType" class="form-label">Jenis Tiket</label>
                                    <select class="form-select" id="filterType">
                                        <option value="all">Semua</option>
                                        <option value="regular">Regular</option>
                                        <option value="vip">VIP</option>
                                        <option value="family">Family Package</option>
                                        <option value="group">Group</option>
                                    </select>
                                </div>
                                <div class="col-md-4">
                                    <label for="filterDate" class="form-label">Tanggal Generate</label>
                                    <input type="date" class="form-control" id="filterDate">
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="card">
                        <div class="card-header d-flex justify-content-between align-items-center">
                            <h5 class="card-title mb-0"><i class="fas fa-boxes me-2"></i>Daftar Tiket</h5>
                            <div class="d-flex">
                                <input type="text" class="form-control form-control-sm me-2" id="searchTicketInput" placeholder="Cari kode tiket..." style="width: 200px;">
                                <button class="btn btn-sm btn-outline-primary" id="refreshStockBtn">
                                    <i class="fas fa-sync-alt"></i>
                                </button>
                            </div>
                        </div>
                        <div class="card-body">
                            <div class="table-responsive">
                                <table class="table table-striped table-hover" id="stockTable">
                                    <thead>
                                        <tr>
                                            <th>Kode Tiket</th>
                                            <th>Jenis</th>
                                            <th>Harga</th>
                                            <th>Status</th>
                                            <th>Generate Pada</th>
                                            <th>Kedaluwarsa</th>
                                            <th>Aksi</th>
                                        </tr>
                                    </thead>
                                    <tbody id="stockTableBody">
                                        <!-- Ticket stock data will appear here -->
                                    </tbody>
                                </table>
                            </div>
                            <nav aria-label="Page navigation">
                                <ul class="pagination justify-content-center" id="stockPagination">
                                    <!-- Pagination will appear here -->
                                </ul>
                            </nav>
                        </div>
                    </div>
                </div>
                
                <!-- Sales Section -->
                <div class="section d-none" id="salesSection">
                    <div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
                        <h1 class="h2">Penjualan Tiket</h1>
                    </div>
                    
                    <div class="row">
                        <div class="col-md-8">
                            <div class="card mb-4">
                                <div class="card-header">
                                    <h5 class="card-title mb-0"><i class="fas fa-shopping-cart me-2"></i>Kasir</h5>
                                </div>
                                <div class="card-body">
                                    <form id="salesForm">
                                        <div class="row mb-3">
                                            <div class="col-md-8">
                                                <label for="ticketCodeInput" class="form-label">Kode Tiket</label>
                                                <div class="input-group">
                                                    <input type="text" class="form-control" id="ticketCodeInput" placeholder="Scan atau masukkan kode tiket" required>
                                                    <button class="btn btn-outline-secondary" type="button" id="scanTicketBtn">
                                                        <i class="fas fa-barcode"></i>
                                                    </button>
                                                </div>
                                            </div>
                                            <div class="col-md-4">
                                                <label for="ticketQuantityInput" class="form-label">Jumlah</label>
                                                <input type="number" class="form-control" id="ticketQuantityInput" min="1" value="1" required>
                                            </div>
                                        </div>
                                        <div class="mb-3">
                                            <button type="submit" class="btn btn-primary">
                                                <i class="fas fa-cart-plus me-2"></i>Tambah ke Keranjang
                                            </button>
                                        </div>
                                    </form>
                                    
                                    <div class="table-responsive mt-4">
                                        <table class="table table-striped" id="cartTable">
                                            <thead>
                                                <tr>
                                                    <th>Kode Tiket</th>
                                                    <th>Jenis</th>
                                                    <th>Harga</th>
                                                    <th>Jumlah</th>
                                                    <th>Subtotal</th>
                                                    <th>Aksi</th>
                                                </tr>
                                            </thead>
                                            <tbody id="cartTableBody">
                                                <!-- Cart items will appear here -->
                                            </tbody>
                                            <tfoot>
                                                <tr>
                                                    <td colspan="4" class="text-end fw-bold">Total:</td>
                                                    <td class="fw-bold" id="cartTotal">Rp 0</td>
                                                    <td></td>
                                                </tr>
                                            </tfoot>
                                        </table>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="card mb-4">
                                <div class="card-header">
                                    <h5 class="card-title mb-0"><i class="fas fa-money-bill-wave me-2"></i>Pembayaran</h5>
                                </div>
                                <div class="card-body">
                                    <form id="paymentForm">
                                        <div class="mb-3">
                                            <label for="paymentMethod" class="form-label">Metode Pembayaran</label>
                                            <select class="form-select" id="paymentMethod" required>
                                                <option value="cash">Tunai</option>
                                                <option value="debit">Kartu Debit</option>
                                                <option value="credit">Kartu Kredit</option>
                                                <option value="transfer">Transfer Bank</option>
                                                <option value="ewallet">E-Wallet</option>
                                            </select>
                                        </div>
                                        <div class="mb-3">
                                            <label for="customerName" class="form-label">Nama Pelanggan (Opsional)</label>
                                            <input type="text" class="form-control" id="customerName" placeholder="Nama pelanggan">
                                        </div>
                                        <div class="mb-3">
                                            <label for="totalAmount" class="form-label">Total Pembayaran</label>
                                            <input type="text" class="form-control" id="totalAmount" readonly>
                                        </div>
                                        <div class="mb-3">
                                            <label for="amountPaid" class="form-label">Jumlah Dibayar</label>
                                            <input type="number" class="form-control" id="amountPaid" min="0" required>
                                        </div>
                                        <div class="mb-3">
                                            <label for="changeAmount" class="form-label">Kembalian</label>
                                            <input type="text" class="form-control" id="changeAmount" readonly>
                                        </div>
                                        <div class="d-grid gap-2">
                                            <button type="submit" class="btn btn-success" id="completePaymentBtn">
                                                <i class="fas fa-check-circle me-2"></i>Selesaikan Pembayaran
                                            </button>
                                            <button type="button" class="btn btn-danger" id="cancelTransactionBtn">
                                                <i class="fas fa-times-circle me-2"></i>Batalkan Transaksi
                                            </button>
                                        </div>
                                    </form>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Transactions Section -->
                <div class="section d-none" id="transactionsSection">
                    <div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
                        <h1 class="h2">Riwayat Transaksi</h1>
                        <div class="btn-toolbar mb-2 mb-md-0">
                            <div class="btn-group me-2">
                                <button type="button" class="btn btn-sm btn-outline-secondary" id="exportTransactionsBtn">
                                    <i class="fas fa-file-export me-1"></i>Export
                                </button>
                                <button type="button" class="btn btn-sm btn-outline-danger" id="clearTransactionsBtn">
                                    <i class="fas fa-trash me-1"></i>Hapus Riwayat
                                </button>
                            </div>
                        </div>
                    </div>
                    
                    <div class="card mb-4">
                        <div class="card-header">
                            <h5 class="card-title mb-0"><i class="fas fa-filter me-2"></i>Filter</h5>
                        </div>
                        <div class="card-body">
                            <div class="row">
                                <div class="col-md-3">
                                    <label for="transactionFilterDateFrom" class="form-label">Dari Tanggal</label>
                                    <input type="date" class="form-control" id="transactionFilterDateFrom">
                                </div>
                                <div class="col-md-3">
                                    <label for="transactionFilterDateTo" class="form-label">Sampai Tanggal</label>
                                    <input type="date" class="form-control" id="transactionFilterDateTo">
                                </div>
                                <div class="col-md-3">
                                    <label for="transactionFilterMethod" class="form-label">Metode Pembayaran</label>
                                    <select class="form-select" id="transactionFilterMethod">
                                        <option value="all">Semua</option>
                                        <option value="cash">Tunai</option>
                                        <option value="debit">Kartu Debit</option>
                                        <option value="credit">Kartu Kredit</option>
                                        <option value="transfer">Transfer Bank</option>
                                        <option value="ewallet">E-Wallet</option>
                                    </select>
                                </div>
                                <div class="col-md-3">
                                    <label for="transactionFilterUser" class="form-label">Kasir</label>
                                    <select class="form-select" id="transactionFilterUser">
                                        <option value="all">Semua</option>
                                        <!-- User options will be populated here -->
                                    </select>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="card">
                        <div class="card-header d-flex justify-content-between align-items-center">
                            <h5 class="card-title mb-0"><i class="fas fa-list me-2"></i>Daftar Transaksi</h5>
                            <div class="d-flex">
                                <input type="text" class="form-control form-control-sm me-2" id="searchTransactionInput" placeholder="Cari transaksi..." style="width: 200px;">
                                <button class="btn btn-sm btn-outline-primary" id="refreshTransactionsBtn">
                                    <i class="fas fa-sync-alt"></i>
                                </button>
                            </div>
                        </div>
                        <div class="card-body">
                            <div class="table-responsive">
                                <table class="table table-striped table-hover" id="transactionsTable">
                                    <thead>
                                        <tr>
                                            <th>ID Transaksi</th>
                                            <th>Tanggal</th>
                                            <th>Kasir</th>
                                            <th>Jumlah Tiket</th>
                                            <th>Total</th>
                                            <th>Metode</th>
                                            <th>Aksi</th>
                                        </tr>
                                    </thead>
                                    <tbody id="transactionsTableBody">
                                        <!-- Transactions data will appear here -->
                                    </tbody>
                                </table>
                            </div>
                            <nav aria-label="Page navigation">
                                <ul class="pagination justify-content-center" id="transactionsPagination">
                                    <!-- Pagination will appear here -->
                                </ul>
                            </nav>
                        </div>
                    </div>
                </div>
                
                <!-- Reports Section -->
                <div class="section d-none" id="reportsSection">
                    <div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
                        <h1 class="h2">Laporan</h1>
                        <div class="btn-toolbar mb-2 mb-md-0">
                            <div class="btn-group me-2">
                                <button type="button" class="btn btn-sm btn-outline-primary" id="printReportBtn">
                                    <i class="fas fa-print me-1"></i>Cetak
                                </button>
                                <button type="button" class="btn btn-sm btn-outline-success" id="exportReportBtn">
                                    <i class="fas fa-file-export me-1"></i>Export PDF
                                </button>
                            </div>
                        </div>
                    </div>
                    
                    <div class="card mb-4">
                        <div class="card-header">
                            <h5 class="card-title mb-0"><i class="fas fa-filter me-2"></i>Filter Laporan</h5>
                        </div>
                        <div class="card-body">
                            <div class="row">
                                <div class="col-md-4">
                                    <label for="reportType" class="form-label">Jenis Laporan</label>
                                    <select class="form-select" id="reportType">
                                        <option value="daily">Harian</option>
                                        <option value="weekly">Mingguan</option>
                                        <option value="monthly">Bulanan</option>
                                        <option value="yearly">Tahunan</option>
                                        <option value="custom">Custom</option>
                                    </select>
                                </div>
                                <div class="col-md-4" id="reportDateContainer">
                                    <label for="reportDate" class="form-label">Tanggal</label>
                                    <input type="date" class="form-control" id="reportDate">
                                </div>
                                <div class="col-md-4 d-none" id="reportDateRangeContainer">
                                    <div class="row">
                                        <div class="col-md-6">
                                            <label for="reportDateFrom" class="form-label">Dari</label>
                                            <input type="date" class="form-control" id="reportDateFrom">
                                        </div>
                                        <div class="col-md-6">
                                            <label for="reportDateTo" class="form-label">Sampai</label>
                                            <input type="date" class="form-control" id="reportDateTo">
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="row mt-3">
                                <div class="col-md-4">
                                    <label for="reportTicketType" class="form-label">Jenis Tiket</label>
                                    <select class="form-select" id="reportTicketType">
                                        <option value="all">Semua</option>
                                        <option value="regular">Regular</option>
                                        <option value="vip">VIP</option>
                                        <option value="family">Family Package</option>
                                        <option value="group">Group</option>
                                    </select>
                                </div>
                                <div class="col-md-4">
                                    <label for="reportUser" class="form-label">Kasir</label>
                                    <select class="form-select" id="reportUser">
                                        <option value="all">Semua</option>
                                        <!-- User options will be populated here -->
                                    </select>
                                </div>
                                <div class="col-md-4">
                                    <label for="reportPaymentMethod" class="form-label">Metode Pembayaran</label>
                                    <select class="form-select" id="reportPaymentMethod">
                                        <option value="all">Semua</option>
                                        <option value="cash">Tunai</option>
                                        <option value="debit">Kartu Debit</option>
                                        <option value="credit">Kartu Kredit</option>
                                        <option value="transfer">Transfer Bank</option>
                                        <option value="ewallet">E-Wallet</option>
                                    </select>
                                </div>
                            </div>
                            <div class="mt-3">
                                <button type="button" class="btn btn-primary" id="generateReportBtn">
                                    <i class="fas fa-chart-bar me-2"></i>Generate Laporan
                                </button>
                            </div>
                        </div>
                    </div>
                    
                    <div class="card">
                        <div class="card-header">
                            <h5 class="card-title mb-0"><i class="fas fa-chart-pie me-2"></i>Hasil Laporan</h5>
                        </div>
                        <div class="card-body">
                            <div id="reportResults">
                                <div class="text-center text-muted py-5">
                                    <i class="fas fa-chart-bar fa-3x mb-3"></i>
                                    <p>Pilih filter dan klik "Generate Laporan" untuk menampilkan data</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Users Section -->
                <div class="section d-none" id="usersSection">
                    <div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
                        <h1 class="h2">Manajemen Pengguna</h1>
                        <div class="btn-toolbar mb-2 mb-md-0">
                            <button type="button" class="btn btn-sm btn-primary" data-bs-toggle="modal" data-bs-target="#addUserModal">
                                <i class="fas fa-user-plus me-1"></i>Tambah Pengguna
                            </button>
                        </div>
                    </div>
                    
                    <div class="card">
                        <div class="card-header d-flex justify-content-between align-items-center">
                            <h5 class="card-title mb-0"><i class="fas fa-users me-2"></i>Daftar Pengguna</h5>
                            <div class="d-flex">
                                <input type="text" class="form-control form-control-sm me-2" id="searchUserInput" placeholder="Cari pengguna..." style="width: 200px;">
                                <button class="btn btn-sm btn-outline-primary" id="refreshUsersBtn">
                                    <i class="fas fa-sync-alt"></i>
                                </button>
                            </div>
                        </div>
                        <div class="card-body">
                            <div class="table-responsive">
                                <table class="table table-striped table-hover" id="usersTable">
                                    <thead>
                                        <tr>
                                            <th>Nama Pengguna</th>
                                            <th>Nama Lengkap</th>
                                            <th>Role</th>
                                            <th>Status</th>
                                            <th>Terakhir Login</th>
                                            <th>Aksi</th>
                                        </tr>
                                    </thead>
                                    <tbody id="usersTableBody">
                                        <!-- Users data will appear here -->
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Settings Section -->
                <div class="section d-none" id="settingsSection">
                    <div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
                        <h1 class="h2">Pengaturan Sistem</h1>
                    </div>
                    
                    <div class="card mb-4">
                        <div class="card-header">
                            <h5 class="card-title mb-0"><i class="fas fa-info-circle me-2"></i>Informasi Tempat Wisata</h5>
                        </div>
                        <div class="card-body">
                            <form id="venueInfoForm">
                                <div class="row mb-3">
                                    <div class="col-md-6">
                                        <label for="venueName" class="form-label">Nama Tempat Wisata</label>
                                        <input type="text" class="form-control" id="venueName" required>
                                    </div>
                                    <div class="col-md-6">
                                        <label for="venueLocation" class="form-label">Lokasi</label>
                                        <input type="text" class="form-control" id="venueLocation" required>
                                    </div>
                                </div>
                                <div class="mb-3">
                                    <label for="venueDescription" class="form-label">Deskripsi</label>
                                    <textarea class="form-control" id="venueDescription" rows="3"></textarea>
                                </div>
                                <div class="mb-3">
                                    <label for="venueLogo" class="form-label">Logo</label>
                                    <input type="file" class="form-control" id="venueLogo" accept="image/*">
                                    <div class="form-text">Maksimal ukuran file 2MB</div>
                                </div>
                                <button type="submit" class="btn btn-primary">
                                    <i class="fas fa-save me-2"></i>Simpan Perubahan
                                </button>
                            </form>
                        </div>
                    </div>
                    
                    <div class="card">
                        <div class="card-header">
                            <h5 class="card-title mb-0"><i class="fas fa-cog me-2"></i>Pengaturan Sistem</h5>
                        </div>
                        <div class="card-body">
                            <form id="systemSettingsForm">
                                <div class="row mb-3">
                                    <div class="col-md-4">
                                        <label for="currency" class="form-label">Mata Uang</label>
                                        <select class="form-select" id="currency" required>
                                            <option value="IDR">Rupiah (IDR)</option>
                                            <option value="USD">Dollar AS (USD)</option>
                                            <option value="EUR">Euro (EUR)</option>
                                            <option value="SGD">Dollar Singapura (SGD)</option>
                                        </select>
                                    </div>
                                    <div class="col-md-4">
                                        <label for="dateFormat" class="form-label">Format Tanggal</label>
                                        <select class="form-select" id="dateFormat" required>
                                            <option value="DD-MM-YYYY">DD-MM-YYYY</option>
                                            <option value="YYYY-MM-DD">YYYY-MM-DD</option>
                                            <option value="MM/DD/YYYY">MM/DD/YYYY</option>
                                        </select>
                                    </div>
                                    <div class="col-md-4">
                                        <label for="timeFormat" class="form-label">Format Waktu</label>
                                        <select class="form-select" id="timeFormat" required>
                                            <option value="24">24 Jam</option>
                                            <option value="12">12 Jam (AM/PM)</option>
                                        </select>
                                    </div>
                                </div>
                                <div class="row mb-3">
                                    <div class="col-md-6">
                                        <div class="form-check form-switch">
                                            <input class="form-check-input" type="checkbox" id="enableTax">
                                            <label class="form-check-label" for="enableTax">Aktifkan Pajak</label>
                                        </div>
                                        <div id="taxSettings" style="display: none;">
                                            <div class="row mt-2">
                                                <div class="col-md-6">
                                                    <label for="taxRate" class="form-label">Persentase Pajak (%)</label>
                                                    <input type="number" class="form-control" id="taxRate" min="0" max="100" step="0.1" value="10">
                                                </div>
                                                <div class="col-md-6">
                                                    <label for="taxName" class="form-label">Nama Pajak</label>
                                                    <input type="text" class="form-control" id="taxName" value="PPN">
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <div class="form-check form-switch">
                                            <input class="form-check-input" type="checkbox" id="enableReceiptFooter">
                                            <label class="form-check-label" for="enableReceiptFooter">Aktifkan Footer Struk</label>
                                        </div>
                                        <div id="receiptFooterSettings" style="display: none;">
                                            <div class="mt-2">
                                                <label for="receiptFooterText" class="form-label">Teks Footer Struk</label>
                                                <textarea class="form-control" id="receiptFooterText" rows="2">Terima kasih telah berkunjung!</textarea>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                <button type="submit" class="btn btn-primary">
                                    <i class="fas fa-save me-2"></i>Simpan Pengaturan
                                </button>
                            </form>
                        </div>
                    </div>
                </div>
                
                <!-- Backup & Restore Section -->
                <div class="section d-none" id="backupSection">
                    <div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
                        <h1 class="h2">Backup & Restore Data</h1>
                    </div>
                    
                    <div class="row">
                        <div class="col-md-6">
                            <div class="card mb-4">
                                <div class="card-header">
                                    <h5 class="card-title mb-0"><i class="fas fa-database me-2"></i>Backup Data</h5>
                                </div>
                                <div class="card-body">
                                    <p>Backup semua data sistem termasuk tiket, transaksi, pengguna, dan pengaturan.</p>
                                    <div class="mb-3">
                                        <label for="backupFileName" class="form-label">Nama File Backup</label>
                                        <input type="text" class="form-control" id="backupFileName" value="TourTicketPro_Backup">
                                    </div>
                                    <div class="mb-3">
                                        <label for="backupPassword" class="form-label">Password (Opsional)</label>
                                        <input type="password" class="form-control" id="backupPassword" placeholder="Masukkan password untuk enkripsi">
                                    </div>
                                    <button type="button" class="btn btn-primary" id="createBackupBtn">
                                        <i class="fas fa-download me-2"></i>Buat Backup
                                    </button>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="card mb-4">
                                <div class="card-header">
                                    <h5 class="card-title mb-0"><i class="fas fa-upload me-2"></i>Restore Data</h5>
                                </div>
                                <div class="card-body">
                                    <p>Restore data dari file backup. Semua data saat ini akan diganti dengan data dari backup.</p>
                                    <div class="mb-3">
                                        <label for="restoreFile" class="form-label">File Backup</label>
                                        <input type="file" class="form-control" id="restoreFile" accept=".json,.txt">
                                    </div>
                                    <div class="mb-3">
                                        <label for="restorePassword" class="form-label">Password</label>
                                        <input type="password" class="form-control" id="restorePassword" placeholder="Masukkan password jika file dienkripsi">
                                    </div>
                                    <button type="button" class="btn btn-warning" id="restoreDataBtn">
                                        <i class="fas fa-upload me-2"></i>Restore Data
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="card">
                        <div class="card-header">
                            <h5 class="card-title mb-0"><i class="fas fa-exclamation-triangle me-2"></i>Reset Sistem</h5>
                        </div>
                        <div class="card-body">
                            <div class="alert alert-danger">
                                <i class="fas fa-exclamation-circle me-2"></i>
                                <strong>Peringatan!</strong> Tindakan ini akan menghapus semua data dan mengembalikan sistem ke pengaturan awal. Pastikan Anda telah membuat backup.
                            </div>
                            <div class="mb-3">
                                <label for="resetPassword" class="form-label">Password Admin</label>
                                <input type="password" class="form-control" id="resetPassword" placeholder="Masukkan password admin untuk konfirmasi">
                            </div>
                            <button type="button" class="btn btn-danger" id="resetSystemBtn">
                                <i class="fas fa-trash-alt me-2"></i>Reset Sistem
                            </button>
                        </div>
                    </div>
                </div>
            </main>
        </div>
    </div>
    
    <!-- Modals -->
    
    <!-- Add User Modal -->
    <div class="modal fade" id="addUserModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Tambah Pengguna Baru</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <form id="addUserForm">
                        <div class="mb-3">
                            <label for="newUsername" class="form-label">Username</label>
                            <input type="text" class="form-control" id="newUsername" required>
                        </div>
                        <div class="mb-3">
                            <label for="newFullName" class="form-label">Nama Lengkap</label>
                            <input type="text" class="form-control" id="newFullName" required>
                        </div>
                        <div class="mb-3">
                            <label for="newUserRole" class="form-label">Role</label>
                            <select class="form-select" id="newUserRole" required>
                                <option value="admin">Admin</option>
                                <option value="cashier">Kasir</option>
                                <option value="manager">Manager</option>
                            </select>
                        </div>
                        <div class="mb-3">
                            <label for="newUserPassword" class="form-label">Password</label>
                            <input type="password" class="form-control" id="newUserPassword" required>
                        </div>
                        <div class="mb-3">
                            <label for="confirmUserPassword" class="form-label">Konfirmasi Password</label>
                            <input type="password" class="form-control" id="confirmUserPassword" required>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Batal</button>
                    <button type="button" class="btn btn-primary" id="saveNewUserBtn">Simpan</button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Edit User Modal -->
    <div class="modal fade" id="editUserModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Edit Pengguna</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <form id="editUserForm">
                        <input type="hidden" id="editUserId">
                        <div class="mb-3">
                            <label for="editUsername" class="form-label">Username</label>
                            <input type="text" class="form-control" id="editUsername" readonly>
                        </div>
                        <div class="mb-3">
                            <label for="editFullName" class="form-label">Nama Lengkap</label>
                            <input type="text" class="form-control" id="editFullName" required>
                        </div>
                        <div class="mb-3">
                            <label for="editUserRole" class="form-label">Role</label>
                            <select class="form-select" id="editUserRole" required>
                                <option value="admin">Admin</option>
                                <option value="cashier">Kasir</option>
                                <option value="manager">Manager</option>
                            </select>
                        </div>
                        <div class="mb-3">
                            <label for="editUserStatus" class="form-label">Status</label>
                            <select class="form-select" id="editUserStatus" required>
                                <option value="active">Aktif</option>
                                <option value="inactive">Nonaktif</option>
                            </select>
                        </div>
                        <div class="mb-3">
                            <label for="editUserPassword" class="form-label">Password Baru (Opsional)</label>
                            <input type="password" class="form-control" id="editUserPassword">
                            <div class="form-text">Biarkan kosong jika tidak ingin mengubah password</div>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Batal</button>
                    <button type="button" class="btn btn-primary" id="saveEditUserBtn">Simpan Perubahan</button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Change Password Modal -->
    <div class="modal fade" id="changePasswordModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Ganti Password</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <form id="changePasswordForm">
                        <div class="mb-3">
                            <label for="currentPassword" class="form-label">Password Saat Ini</label>
                            <input type="password" class="form-control" id="currentPassword" required>
                        </div>
                        <div class="mb-3">
                            <label for="newPassword" class="form-label">Password Baru</label>
                            <input type="password" class="form-control" id="newPassword" required>
                        </div>
                        <div class="mb-3">
                            <label for="confirmNewPassword" class="form-label">Konfirmasi Password Baru</label>
                            <input type="password" class="form-control" id="confirmNewPassword" required>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Batal</button>
                    <button type="button" class="btn btn-primary" id="savePasswordBtn">Simpan Password</button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- View Ticket Modal -->
    <div class="modal fade" id="viewTicketModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Detail Tiket</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body" id="ticketModalContent">
                    <!-- Ticket content will be loaded here -->
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Tutup</button>
                    <button type="button" class="btn btn-primary" id="printTicketBtn">
                        <i class="fas fa-print me-1"></i>Cetak
                    </button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- View Transaction Modal -->
    <div class="modal fade" id="viewTransactionModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Detail Transaksi</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body" id="transactionModalContent">
                    <!-- Transaction content will be loaded here -->
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Tutup</button>
                    <button type="button" class="btn btn-primary" id="printTransactionBtn">
                        <i class="fas fa-print me-1"></i>Cetak Struk
                    </button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Login Modal -->
    <div class="modal fade" id="loginModal" tabindex="-1" aria-hidden="false" data-bs-backdrop="static" data-bs-keyboard="false">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">
                        <i class="fas fa-ticket-alt me-2"></i>TourTicket Pro - Login
                    </h5>
                </div>
                <div class="modal-body">
                    <form id="loginForm">
                        <div class="mb-3">
                            <label for="loginUsername" class="form-label">Username</label>
                            <input type="text" class="form-control" id="loginUsername" required>
                        </div>
                        <div class="mb-3">
                            <label for="loginPassword" class="form-label">Password</label>
                            <input type="password" class="form-control" id="loginPassword" required>
                        </div>
                        <div class="mb-3 form-check">
                            <input type="checkbox" class="form-check-input" id="rememberMe">
                            <label class="form-check-label" for="rememberMe">Ingat saya</label>
                        </div>
                        <button type="submit" class="btn btn-primary w-100">
                            <i class="fas fa-sign-in-alt me-2"></i>Login
                        </button>
                    </form>
                </div>
                <div class="modal-footer">
                    <small class="text-muted">Sistem Penjualan Tiket Wisata v1.0</small>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Confirmation Modal -->
    <div class="modal fade" id="confirmationModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="confirmationModalTitle">Konfirmasi</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body" id="confirmationModalBody">
                    Apakah Anda yakin ingin melanjutkan?
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Batal</button>
                    <button type="button" class="btn btn-primary" id="confirmActionBtn">Ya, Lanjutkan</button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Password Verification Modal -->
    <div class="modal fade" id="passwordVerifyModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Verifikasi Password</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-3">
                        <label for="verifyPassword" class="form-label">Masukkan Password Anda</label>
                        <input type="password" class="form-control" id="verifyPassword" required>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Batal</button>
                    <button type="button" class="btn btn-primary" id="confirmVerifyBtn">Verifikasi</button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Alert Toast -->
    <div class="position-fixed bottom-0 end-0 p-3" style="z-index: 11">
        <div id="alertToast" class="toast" role="alert" aria-live="assertive" aria-atomic="true">
            <div class="toast-header">
                <strong class="me-auto" id="toastTitle">Notification</strong>
                <small id="toastTime">Just now</small>
                <button type="button" class="btn-close" data-bs-dismiss="toast" aria-label="Close"></button>
            </div>
            <div class="toast-body" id="toastMessage">
                This is a toast message.
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script>
        // Initialize the application when DOM is loaded
        document.addEventListener('DOMContentLoaded', function() {
            // Initialize the app
            const app = new TicketSalesApp();
            app.init();
        });
        
        // Main Application Class
        class TicketSalesApp {
            constructor() {
                // Initialize properties
                this.currentUser = null;
                this.cart = [];
                this.ticketTypes = ['regular', 'vip', 'family', 'group'];
                this.paymentMethods = [
                    { value: 'cash', label: 'Tunai' },
                    { value: 'debit', label: 'Kartu Debit' },
                    { value: 'credit', label: 'Kartu Kredit' },
                    { value: 'transfer', label: 'Transfer Bank' },
                    { value: 'ewallet', label: 'E-Wallet' }
                ];
                this.userRoles = ['admin', 'cashier', 'manager'];
                this.salesChart = null;
                
                // Initialize data if not exists
                this.initData();
                
                // Load data from localStorage
                this.loadData();
            }
            
            init() {
                // Initialize UI components
                this.initUI();
                
                // Check if user is logged in
                this.checkAuth();
                
                // Setup event listeners
                this.setupEventListeners();
                
                // Load dashboard data
                this.loadDashboardData();
            }
            
            initData() {
                // Initialize data structure if not exists in localStorage
                if (!localStorage.getItem('ticketSalesData')) {
                    const initialData = {
                        settings: {
                            venueName: 'Tempat Wisata Contoh',
                            venueLocation: 'Jl. Contoh No. 123, Kota Contoh',
                            venueDescription: 'Tempat wisata keluarga dengan berbagai wahana menarik',
                            currency: 'IDR',
                            dateFormat: 'DD-MM-YYYY',
                            timeFormat: '24',
                            enableTax: false,
                            taxRate: 10,
                            taxName: 'PPN',
                            enableReceiptFooter: true,
                            receiptFooterText: 'Terima kasih telah berkunjung!',
                            venueLogo: 'https://raw.githubusercontent.com/LKS-88/anekamarket/refs/heads/main/Logo-Anekamarketku.png'
                        },
                        users: [
                            {
                                id: 1,
                                username: 'admin',
                                password: this.hashPassword('Admin.13579'),
                                fullName: 'Administrator',
                                role: 'admin',
                                status: 'active',
                                lastLogin: null,
                                createdAt: new Date().toISOString(),
                                permissions: {
                                    generateTickets: true,
                                    manageStock: true,
                                    processSales: true,
                                    viewTransactions: true,
                                    generateReports: true,
                                    manageUsers: true,
                                    systemSettings: true,
                                    backupRestore: true
                                }
                            },
                            {
                                id: 2,
                                username: 'kasir',
                                password: this.hashPassword('Kasir.123'),
                                fullName: 'Kasir Toko',
                                role: 'cashier',
                                status: 'active',
                                lastLogin: null,
                                createdAt: new Date().toISOString(),
                                permissions: {
                                    generateTickets: false,
                                    manageStock: false,
                                    processSales: true,
                                    viewTransactions: true,
                                    generateReports: false,
                                    manageUsers: false,
                                    systemSettings: false,
                                    backupRestore: false
                                }
                            }
                        ],
                        tickets: [],
                        transactions: [],
                        activities: []
                    };
                    
                    localStorage.setItem('ticketSalesData', JSON.stringify(initialData));
                }
            }
            
            loadData() {
                // Load all data from localStorage
                const data = JSON.parse(localStorage.getItem('ticketSalesData'));
                
                this.settings = data.settings || {};
                this.users = data.users || [];
                this.tickets = data.tickets || [];
                this.transactions = data.transactions || [];
                this.activities = data.activities || [];
                
                // Set current date format for display
                this.setDateFormat();
            }
            
            saveData() {
                // Save all data to localStorage
                const data = {
                    settings: this.settings,
                    users: this.users,
                    tickets: this.tickets,
                    transactions: this.transactions,
                    activities: this.activities
                };
                
                localStorage.setItem('ticketSalesData', JSON.stringify(data));
            }
            
            initUI() {
                // Initialize date pickers with current date
                const today = new Date().toISOString().split('T')[0];
                document.getElementById('ticketExpiry').min = today;
                document.getElementById('reportDate').value = today;
                document.getElementById('reportDateFrom').value = today;
                document.getElementById('reportDateTo').value = today;
                document.getElementById('filterDate').value = today;
                document.getElementById('transactionFilterDateFrom').value = today;
                document.getElementById('transactionFilterDateTo').value = today;
                
                // Setup report type change
                document.getElementById('reportType').addEventListener('change', (e) => {
                    if (e.target.value === 'custom') {
                        document.getElementById('reportDateContainer').classList.add('d-none');
                        document.getElementById('reportDateRangeContainer').classList.remove('d-none');
                    } else {
                        document.getElementById('reportDateContainer').classList.remove('d-none');
                        document.getElementById('reportDateRangeContainer').classList.add('d-none');
                    }
                });
                
                // Setup tax toggle
                document.getElementById('enableTax').addEventListener('change', (e) => {
                    document.getElementById('taxSettings').style.display = e.target.checked ? 'block' : 'none';
                });
                
                // Setup receipt footer toggle
                document.getElementById('enableReceiptFooter').addEventListener('change', (e) => {
                    document.getElementById('receiptFooterSettings').style.display = e.target.checked ? 'block' : 'none';
                });
                
                // Set initial values from settings
                if (this.settings) {
                    document.getElementById('venueName').value = this.settings.venueName || '';
                    document.getElementById('venueLocation').value = this.settings.venueLocation || '';
                    document.getElementById('venueDescription').value = this.settings.venueDescription || '';
                    document.getElementById('currency').value = this.settings.currency || 'IDR';
                    document.getElementById('dateFormat').value = this.settings.dateFormat || 'DD-MM-YYYY';
                    document.getElementById('timeFormat').value = this.settings.timeFormat || '24';
                    document.getElementById('enableTax').checked = this.settings.enableTax || false;
                    document.getElementById('taxRate').value = this.settings.taxRate || 10;
                    document.getElementById('taxName').value = this.settings.taxName || 'PPN';
                    document.getElementById('enableReceiptFooter').checked = this.settings.enableReceiptFooter !== false;
                    document.getElementById('receiptFooterText').value = this.settings.receiptFooterText || 'Terima kasih telah berkunjung!';
                    
                    // Show/hide tax settings based on current value
                    document.getElementById('taxSettings').style.display = this.settings.enableTax ? 'block' : 'none';
                    document.getElementById('receiptFooterSettings').style.display = this.settings.enableReceiptFooter !== false ? 'block' : 'none';
                }
            }
            
            setDateFormat() {
                // Helper function to format dates based on settings
                this.formatDate = (dateString) => {
                    if (!dateString) return '';
                    
                    const date = new Date(dateString);
                    if (isNaN(date.getTime())) return '';
                    
                    let day = date.getDate().toString().padStart(2, '0');
                    let month = (date.getMonth() + 1).toString().padStart(2, '0');
                    let year = date.getFullYear();
                    
                    switch (this.settings.dateFormat) {
                        case 'DD-MM-YYYY':
                            return `${day}-${month}-${year}`;
                        case 'YYYY-MM-DD':
                            return `${year}-${month}-${day}`;
                        case 'MM/DD/YYYY':
                            return `${month}/${day}/${year}`;
                        default:
                            return `${day}-${month}-${year}`;
                    }
                };
                
                // Helper function to format time based on settings
                this.formatTime = (dateString) => {
                    if (!dateString) return '';
                    
                    const date = new Date(dateString);
                    if (isNaN(date.getTime())) return '';
                    
                    let hours = date.getHours();
                    let minutes = date.getMinutes().toString().padStart(2, '0');
                    
                    if (this.settings.timeFormat === '12') {
                        const ampm = hours >= 12 ? 'PM' : 'AM';
                        hours = hours % 12;
                        hours = hours ? hours : 12; // the hour '0' should be '12'
                        return `${hours}:${minutes} ${ampm}`;
                    } else {
                        hours = hours.toString().padStart(2, '0');
                        return `${hours}:${minutes}`;
                    }
                };
                
                // Helper function to format date and time
                this.formatDateTime = (dateString) => {
                    return `${this.formatDate(dateString)} ${this.formatTime(dateString)}`;
                };
            }
            
            checkAuth() {
                // Check if user is logged in from sessionStorage
                const loggedInUser = sessionStorage.getItem('loggedInUser');
                
                if (loggedInUser) {
                    this.currentUser = JSON.parse(loggedInUser);
                    document.getElementById('currentUsername').textContent = this.currentUser.username;
                    
                    // Hide login modal if shown
                    const loginModal = bootstrap.Modal.getInstance(document.getElementById('loginModal'));
                    if (loginModal) loginModal.hide();
                    
                    // Show main content
                    document.getElementById('loginModal').classList.add('d-none');
                    
                    // Check permissions and adjust UI accordingly
                    this.checkPermissions();
                } else {
                    // Show login modal
                    const loginModal = new bootstrap.Modal(document.getElementById('loginModal'), {
                        backdrop: 'static',
                        keyboard: false
                    });
                    loginModal.show();
                }
            }
            
            checkPermissions() {
                if (!this.currentUser || !this.currentUser.permissions) return;
                
                const permissions = this.currentUser.permissions;
                
                // Hide menu items based on permissions
                if (!permissions.generateTickets) {
                    document.getElementById('generateTicketLink').style.display = 'none';
                }
                
                if (!permissions.manageStock) {
                    document.getElementById('stockTicketLink').style.display = 'none';
                }
                
                if (!permissions.processSales) {
                    document.getElementById('salesLink').style.display = 'none';
                }
                
                if (!permissions.viewTransactions) {
                    document.getElementById('transactionsLink').style.display = 'none';
                }
                
                if (!permissions.generateReports) {
                    document.getElementById('reportsLink').style.display = 'none';
                }
                
                if (!permissions.manageUsers) {
                    document.getElementById('usersLink').style.display = 'none';
                }
                
                if (!permissions.systemSettings) {
                    document.getElementById('settingsLink').style.display = 'none';
                }
                
                if (!permissions.backupRestore) {
                    document.getElementById('backupLink').style.display = 'none';
                }
            }
            
            setupEventListeners() {
                // Navigation links
                document.getElementById('dashboardLink').addEventListener('click', (e) => {
                    e.preventDefault();
                    this.showSection('dashboardSection');
                    this.loadDashboardData();
                });
                
                document.getElementById('generateTicketLink').addEventListener('click', (e) => {
                    e.preventDefault();
                    if (this.checkPermission('generateTickets')) {
                        this.showSection('generateTicketSection');
                    }
                });
                
                document.getElementById('stockTicketLink').addEventListener('click', (e) => {
                    e.preventDefault();
                    if (this.checkPermission('manageStock')) {
                        this.showSection('stockTicketSection');
                        this.loadTicketStock();
                    }
                });
                
                document.getElementById('salesLink').addEventListener('click', (e) => {
                    e.preventDefault();
                    if (this.checkPermission('processSales')) {
                        this.showSection('salesSection');
                        this.resetCart();
                    }
                });
                
                document.getElementById('transactionsLink').addEventListener('click', (e) => {
                    e.preventDefault();
                    if (this.checkPermission('viewTransactions')) {
                        this.showSection('transactionsSection');
                        this.loadTransactions();
                    }
                });
                
                document.getElementById('reportsLink').addEventListener('click', (e) => {
                    e.preventDefault();
                    if (this.checkPermission('generateReports')) {
                        this.showSection('reportsSection');
                        this.populateUserDropdown('reportUser');
                    }
                });
                
                document.getElementById('usersLink').addEventListener('click', (e) => {
                    e.preventDefault();
                    if (this.checkPermission('manageUsers')) {
                        this.showSection('usersSection');
                        this.loadUsers();
                    }
                });
                
                document.getElementById('settingsLink').addEventListener('click', (e) => {
                    e.preventDefault();
                    if (this.checkPermission('systemSettings')) {
                        this.showSection('settingsSection');
                    }
                });
                
                document.getElementById('backupLink').addEventListener('click', (e) => {
                    e.preventDefault();
                    if (this.checkPermission('backupRestore')) {
                        this.showSection('backupSection');
                    }
                });
                
                // Logout button
                document.getElementById('logoutBtn').addEventListener('click', (e) => {
                    e.preventDefault();
                    sessionStorage.removeItem('loggedInUser');
                    window.location.reload();
                });
                
                // Login form
                document.getElementById('loginForm').addEventListener('submit', (e) => {
                    e.preventDefault();
                    this.handleLogin();
                });
                
                // Generate ticket form
                document.getElementById('generateTicketForm').addEventListener('submit', (e) => {
                    e.preventDefault();
                    this.generateTickets();
                });
                
                // Print all tickets button
                document.getElementById('printAllTicketsBtn').addEventListener('click', () => {
                    this.printAllTickets();
                });
                
                // Stock management buttons
                document.getElementById('exportStockBtn').addEventListener('click', () => {
                    this.exportStock();
                });
                
                document.getElementById('clearStockBtn').addEventListener('click', () => {
                    this.showConfirmation(
                        'Hapus Semua Stok Tiket',
                        'Apakah Anda yakin ingin menghapus semua stok tiket? Tindakan ini tidak dapat dibatalkan.',
                        () => this.clearStock()
                    );
                });
                
                document.getElementById('refreshStockBtn').addEventListener('click', () => {
                    this.loadTicketStock();
                });
                
                document.getElementById('searchTicketInput').addEventListener('input', (e) => {
                    this.filterTickets(e.target.value);
                });
                
                document.getElementById('filterStatus').addEventListener('change', () => {
                    this.loadTicketStock();
                });
                
                document.getElementById('filterType').addEventListener('change', () => {
                    this.loadTicketStock();
                });
                
                document.getElementById('filterDate').addEventListener('change', () => {
                    this.loadTicketStock();
                });
                
                // Sales form
                document.getElementById('salesForm').addEventListener('submit', (e) => {
                    e.preventDefault();
                    this.addToCart();
                });
                
                document.getElementById('paymentForm').addEventListener('submit', (e) => {
                    e.preventDefault();
                    this.completePayment();
                });
                
                document.getElementById('amountPaid').addEventListener('input', (e) => {
                    this.calculateChange();
                });
                
                document.getElementById('cancelTransactionBtn').addEventListener('click', () => {
                    this.resetCart();
                });
                
                // Transactions buttons
                document.getElementById('exportTransactionsBtn').addEventListener('click', () => {
                    this.exportTransactions();
                });
                
                document.getElementById('clearTransactionsBtn').addEventListener('click', () => {
                    this.showConfirmation(
                        'Hapus Semua Riwayat Transaksi',
                        'Apakah Anda yakin ingin menghapus semua riwayat transaksi? Tindakan ini tidak dapat dibatalkan.',
                        () => this.clearTransactions()
                    );
                });
                
                document.getElementById('refreshTransactionsBtn').addEventListener('click', () => {
                    this.loadTransactions();
                });
                
                document.getElementById('searchTransactionInput').addEventListener('input', (e) => {
                    this.filterTransactions(e.target.value);
                });
                
                // Transaction filters
                document.getElementById('transactionFilterDateFrom').addEventListener('change', () => {
                    this.loadTransactions();
                });
                
                document.getElementById('transactionFilterDateTo').addEventListener('change', () => {
                    this.loadTransactions();
                });
                
                document.getElementById('transactionFilterMethod').addEventListener('change', () => {
                    this.loadTransactions();
                });
                
                document.getElementById('transactionFilterUser').addEventListener('change', () => {
                    this.loadTransactions();
                });
                
                // Reports buttons
                document.getElementById('generateReportBtn').addEventListener('click', () => {
                    this.generateReport();
                });
                
                document.getElementById('printReportBtn').addEventListener('click', () => {
                    this.printReport();
                });
                
                document.getElementById('exportReportBtn').addEventListener('click', () => {
                    this.exportReportToPDF();
                });
                
                // User management buttons
                document.getElementById('saveNewUserBtn').addEventListener('click', () => {
                    this.addNewUser();
                });
                
                document.getElementById('saveEditUserBtn').addEventListener('click', () => {
                    this.saveEditedUser();
                });
                
                document.getElementById('refreshUsersBtn').addEventListener('click', () => {
                    this.loadUsers();
                });
                
                document.getElementById('searchUserInput').addEventListener('input', (e) => {
                    this.filterUsers(e.target.value);
                });
                
                // Change password
                document.getElementById('savePasswordBtn').addEventListener('click', () => {
                    this.changePassword();
                });
                
                // Settings forms
                document.getElementById('venueInfoForm').addEventListener('submit', (e) => {
                    e.preventDefault();
                    this.saveVenueInfo();
                });
                
                document.getElementById('systemSettingsForm').addEventListener('submit', (e) => {
                    e.preventDefault();
                    this.saveSystemSettings();
                });
                
                // Backup & Restore buttons
                document.getElementById('createBackupBtn').addEventListener('click', () => {
                    this.verifyPassword('createBackup');
                });
                
                document.getElementById('restoreDataBtn').addEventListener('click', () => {
                    this.verifyPassword('restoreData');
                });
                
                document.getElementById('resetSystemBtn').addEventListener('click', () => {
                    this.showConfirmation(
                        'Reset Sistem',
                        'Apakah Anda yakin ingin mereset semua data sistem? Semua data akan dikembalikan ke pengaturan awal. Pastikan Anda telah membuat backup.',
                        () => this.verifyPassword('resetSystem'),
                        true
                    );
                });
                
                // Password verification
                document.getElementById('confirmVerifyBtn').addEventListener('click', () => {
                    const action = document.getElementById('confirmVerifyBtn').getAttribute('data-action');
                    const password = document.getElementById('verifyPassword').value;
                    
                    if (this.hashPassword(password) === this.currentUser.password) {
                        const modal = bootstrap.Modal.getInstance(document.getElementById('passwordVerifyModal'));
                        modal.hide();
                        
                        if (action === 'createBackup') {
                            this.createBackup();
                        } else if (action === 'restoreData') {
                            this.restoreData();
                        } else if (action === 'resetSystem') {
                            this.resetSystem();
                        }
                    } else {
                        this.showToast('Error', 'Password salah', 'error');
                    }
                });
            }
            
            checkPermission(permission) {
                if (!this.currentUser || !this.currentUser.permissions) return false;
                
                if (this.currentUser.role === 'admin') return true;
                
                return this.currentUser.permissions[permission] === true;
            }
            
            showSection(sectionId) {
                // Hide all sections
                document.querySelectorAll('.section').forEach(section => {
                    section.classList.add('d-none');
                });
                
                // Show the selected section
                document.getElementById(sectionId).classList.remove('d-none');
                
                // Update active nav link
                document.querySelectorAll('.sidebar .nav-link').forEach(link => {
                    link.classList.remove('active');
                });
                
                switch (sectionId) {
                    case 'dashboardSection':
                        document.getElementById('dashboardLink').classList.add('active');
                        break;
                    case 'generateTicketSection':
                        document.getElementById('generateTicketLink').classList.add('active');
                        break;
                    case 'stockTicketSection':
                        document.getElementById('stockTicketLink').classList.add('active');
                        break;
                    case 'salesSection':
                        document.getElementById('salesLink').classList.add('active');
                        break;
                    case 'transactionsSection':
                        document.getElementById('transactionsLink').classList.add('active');
                        break;
                    case 'reportsSection':
                        document.getElementById('reportsLink').classList.add('active');
                        break;
                    case 'usersSection':
                        document.getElementById('usersLink').classList.add('active');
                        break;
                    case 'settingsSection':
                        document.getElementById('settingsLink').classList.add('active');
                        break;
                    case 'backupSection':
                        document.getElementById('backupLink').classList.add('active');
                        break;
                }
            }
            
            showToast(title, message, type = 'info') {
                const toast = document.getElementById('alertToast');
                const toastTitle = document.getElementById('toastTitle');
                const toastMessage = document.getElementById('toastMessage');
                const toastTime = document.getElementById('toastTime');
                
                // Set toast content
                toastTitle.textContent = title;
                toastMessage.textContent = message;
                
                // Set current time
                const now = new Date();
                toastTime.textContent = now.toLocaleTimeString();
                
                // Set toast color based on type
                const toastHeader = toast.querySelector('.toast-header');
                toastHeader.classList.remove('bg-primary', 'bg-success', 'bg-danger', 'bg-warning');
                
                switch (type) {
                    case 'success':
                        toastHeader.classList.add('bg-success', 'text-white');
                        break;
                    case 'error':
                        toastHeader.classList.add('bg-danger', 'text-white');
                        break;
                    case 'warning':
                        toastHeader.classList.add('bg-warning', 'text-dark');
                        break;
                    default:
                        toastHeader.classList.add('bg-primary', 'text-white');
                }
                
                // Show toast
                const bsToast = new bootstrap.Toast(toast);
                bsToast.show();
            }
            
            showConfirmation(title, message, confirmCallback, isDanger = false) {
                const modalTitle = document.getElementById('confirmationModalTitle');
                const modalBody = document.getElementById('confirmationModalBody');
                const confirmBtn = document.getElementById('confirmActionBtn');
                
                modalTitle.textContent = title;
                modalBody.textContent = message;
                
                if (isDanger) {
                    confirmBtn.classList.remove('btn-primary');
                    confirmBtn.classList.add('btn-danger');
                } else {
                    confirmBtn.classList.remove('btn-danger');
                    confirmBtn.classList.add('btn-primary');
                }
                
                // Remove previous event listeners
                const newConfirmBtn = confirmBtn.cloneNode(true);
                confirmBtn.parentNode.replaceChild(newConfirmBtn, confirmBtn);
                
                // Add new event listener
                newConfirmBtn.addEventListener('click', () => {
                    confirmCallback();
                    const modal = bootstrap.Modal.getInstance(document.getElementById('confirmationModal'));
                    modal.hide();
                });
                
                const modal = new bootstrap.Modal(document.getElementById('confirmationModal'));
                modal.show();
            }
            
            verifyPassword(action) {
                const verifyBtn = document.getElementById('confirmVerifyBtn');
                verifyBtn.setAttribute('data-action', action);
                
                document.getElementById('verifyPassword').value = '';
                
                const modal = new bootstrap.Modal(document.getElementById('passwordVerifyModal'));
                modal.show();
            }
            
            hashPassword(password) {
                // Simple hash function for demo purposes
                // In a real application, use a proper hashing algorithm like bcrypt
                let hash = 0;
                for (let i = 0; i < password.length; i++) {
                    const char = password.charCodeAt(i);
                    hash = ((hash << 5) - hash) + char;
                    hash = hash & hash; // Convert to 32bit integer
                }
                return hash.toString();
            }
            
            generateTicketCode(prefix = '') {
                // Generate a random ticket code with optional prefix (max 6 chars total)
                const chars = 'ABCDEFGHJKLMNPQRSTUVWXYZ23456789';
                let code = prefix.toUpperCase().substring(0, 3); // Max 3 chars for prefix
                
                // Add random chars to make total length 6
                const remainingLength = 6 - code.length;
                for (let i = 0; i < remainingLength; i++) {
                    code += chars.charAt(Math.floor(Math.random() * chars.length));
                }
                
                return code;
            }
            
            generateTransactionCode() {
                // Generate a unique transaction code (format: TT-YYYYMMDD-XXXXX)
                const now = new Date();
                const datePart = now.getFullYear().toString() + 
                                (now.getMonth() + 1).toString().padStart(2, '0') + 
                                now.getDate().toString().padStart(2, '0');
                
                // Get last transaction ID or start from 1
                const lastId = this.transactions.length > 0 ? 
                    Math.max(...this.transactions.map(t => t.id)) : 0;
                
                const idPart = (lastId + 1).toString().padStart(5, '0');
                
                return `TT-${datePart}-${idPart}`;
            }
            
            formatCurrency(amount) {
                // Format currency based on settings
                if (this.settings.currency === 'IDR') {
                    return `Rp ${amount.toLocaleString('id-ID')}`;
                } else if (this.settings.currency === 'USD') {
                    return `$${amount.toLocaleString('en-US', {minimumFractionDigits: 2, maximumFractionDigits: 2})}`;
                } else if (this.settings.currency === 'EUR') {
                    return `€${amount.toLocaleString('de-DE', {minimumFractionDigits: 2, maximumFractionDigits: 2})}`;
                } else if (this.settings.currency === 'SGD') {
                    return `S$${amount.toLocaleString('en-SG', {minimumFractionDigits: 2, maximumFractionDigits: 2})}`;
                } else {
                    return amount.toLocaleString();
                }
            }
            
            // Authentication methods
            handleLogin() {
                const username = document.getElementById('loginUsername').value;
                const password = document.getElementById('loginPassword').value;
                const rememberMe = document.getElementById('rememberMe').checked;
                
                // Find user
                const user = this.users.find(u => u.username === username && u.status === 'active');
                
                if (user && this.hashPassword(password) === user.password) {
                    // Update last login
                    user.lastLogin = new Date().toISOString();
                    this.saveData();
                    
                    // Set current user
                    this.currentUser = user;
                    
                    // Store in sessionStorage
                    sessionStorage.setItem('loggedInUser', JSON.stringify(user));
                    
                    // Show success message
                    this.showToast('Login Berhasil', `Selamat datang, ${user.fullName}!`, 'success');
                    
                    // Hide login modal
                    const loginModal = bootstrap.Modal.getInstance(document.getElementById('loginModal'));
                    loginModal.hide();
                    
                    // Update UI
                    document.getElementById('currentUsername').textContent = user.username;
                    
                    // Check permissions and adjust UI
                    this.checkPermissions();
                    
                    // Load dashboard
                    this.showSection('dashboardSection');
                    this.loadDashboardData();
                    
                    // Add activity log
                    this.addActivity(`${user.fullName} (${user.username}) logged in`);
                } else {
                    this.showToast('Login Gagal', 'Username atau password salah', 'error');
                }
            }
            
            changePassword() {
                const currentPassword = document.getElementById('currentPassword').value;
                const newPassword = document.getElementById('newPassword').value;
                const confirmPassword = document.getElementById('confirmNewPassword').value;
                
                // Validate
                if (this.hashPassword(currentPassword) !== this.currentUser.password) {
                    this.showToast('Gagal', 'Password saat ini salah', 'error');
                    return;
                }
                
                if (newPassword !== confirmPassword) {
                    this.showToast('Gagal', 'Password baru tidak cocok', 'error');
                    return;
                }
                
                if (newPassword.length < 6) {
                    this.showToast('Gagal', 'Password minimal 6 karakter', 'error');
                    return;
                }
                
                // Update password
                const userIndex = this.users.findIndex(u => u.id === this.currentUser.id);
                if (userIndex !== -1) {
                    this.users[userIndex].password = this.hashPassword(newPassword);
                    this.saveData();
                    
                    // Update current user
                    this.currentUser = this.users[userIndex];
                    sessionStorage.setItem('loggedInUser', JSON.stringify(this.currentUser));
                    
                    this.showToast('Berhasil', 'Password berhasil diubah', 'success');
                    
                    // Hide modal
                    const modal = bootstrap.Modal.getInstance(document.getElementById('changePasswordModal'));
                    modal.hide();
                    
                    // Add activity log
                    this.addActivity(`${this.currentUser.fullName} (${this.currentUser.username}) changed password`);
                }
            }
            
            // Dashboard methods
            loadDashboardData() {
                // Calculate stock count
                const availableTickets = this.tickets.filter(t => t.status === 'available').length;
                document.getElementById('stockCount').textContent = availableTickets;
                
                // Calculate today's sales
                const today = new Date().toISOString().split('T')[0];
                const todayTransactions = this.transactions.filter(t => t.date.startsWith(today));
                const todayTicketsSold = todayTransactions.reduce((sum, t) => sum + t.items.length, 0);
                const todayRevenue = todayTransactions.reduce((sum, t) => sum + t.total, 0);
                
                document.getElementById('todaySalesCount').textContent = todayTicketsSold;
                document.getElementById('todayRevenue').textContent = this.formatCurrency(todayRevenue);
                
                // Load recent activities
                this.loadRecentActivities();
                
                // Load sales chart
                this.loadSalesChart();
            }
            
            loadRecentActivities() {
                const activitiesContainer = document.getElementById('recentActivities');
                activitiesContainer.innerHTML = '';
                
                // Get last 5 activities
                const recentActivities = [...this.activities].reverse().slice(0, 5);
                
                if (recentActivities.length === 0) {
                    activitiesContainer.innerHTML = `
                        <div class="list-group-item">
                            <div class="d-flex w-100 justify-content-between">
                                <small class="text-muted">Tidak ada aktivitas terakhir</small>
                            </div>
                        </div>
                    `;
                    return;
                }
                
                recentActivities.forEach(activity => {
                    const activityDate = new Date(activity.timestamp);
                    const timeString = this.formatTime(activity.timestamp);
                    
                    const activityElement = document.createElement('div');
                    activityElement.className = 'list-group-item';
                    activityElement.innerHTML = `
                        <div class="d-flex w-100 justify-content-between">
                            <small>${activity.message}</small>
                            <small class="text-muted">${timeString}</small>
                        </div>
                    `;
                    
                    activitiesContainer.appendChild(activityElement);
                });
            }
            
            loadSalesChart() {
                const ctx = document.getElementById('salesChart').getContext('2d');
                
                // Get sales data for last 7 days
                const dates = [];
                const salesData = [];
                const revenueData = [];
                
                for (let i = 6; i >= 0; i--) {
                    const date = new Date();
                    date.setDate(date.getDate() - i);
                    const dateString = date.toISOString().split('T')[0];
                    dates.push(this.formatDate(dateString));
                    
                    const dayTransactions = this.transactions.filter(t => t.date.startsWith(dateString));
                    salesData.push(dayTransactions.reduce((sum, t) => sum + t.items.length, 0));
                    revenueData.push(dayTransactions.reduce((sum, t) => sum + t.total, 0));
                }
                
                // Destroy previous chart if exists
                if (this.salesChart) {
                    this.salesChart.destroy();
                }
                
                this.salesChart = new Chart(ctx, {
                    type: 'bar',
                    data: {
                        labels: dates,
                        datasets: [
                            {
                                label: 'Tiket Terjual',
                                data: salesData,
                                backgroundColor: 'rgba(52, 152, 219, 0.7)',
                                borderColor: 'rgba(52, 152, 219, 1)',
                                borderWidth: 1,
                                yAxisID: 'y'
                            },
                            {
                                label: 'Pendapatan',
                                data: revenueData,
                                backgroundColor: 'rgba(46, 204, 113, 0.7)',
                                borderColor: 'rgba(46, 204, 113, 1)',
                                borderWidth: 1,
                                type: 'line',
                                yAxisID: 'y1'
                            }
                        ]
                    },
                    options: {
                        responsive: true,
                        interaction: {
                            mode: 'index',
                            intersect: false,
                        },
                        scales: {
                            y: {
                                type: 'linear',
                                display: true,
                                position: 'left',
                                title: {
                                    display: true,
                                    text: 'Tiket Terjual'
                                }
                            },
                            y1: {
                                type: 'linear',
                                display: true,
                                position: 'right',
                                title: {
                                    display: true,
                                    text: 'Pendapatan'
                                },
                                // grid line settings
                                grid: {
                                    drawOnChartArea: false, // only want the grid lines for one axis to show up
                                },
                                ticks: {
                                    callback: (value) => this.formatCurrency(value)
                                }
                            }
                        },
                        plugins: {
                            tooltip: {
                                callbacks: {
                                    label: (context) => {
                                        let label = context.dataset.label || '';
                                        if (label === 'Pendapatan') {
                                            label += ': ' + this.formatCurrency(context.raw);
                                        } else {
                                            label += ': ' + context.raw;
                                        }
                                        return label;
                                    }
                                }
                            }
                        }
                    }
                });
            }
            
            addActivity(message) {
                // Add activity to log
                this.activities.push({
                    timestamp: new Date().toISOString(),
                    message: message,
                    userId: this.currentUser.id,
                    username: this.currentUser.username
                });
                
                // Keep only last 100 activities
                if (this.activities.length > 100) {
                    this.activities.shift();
                }
                
                this.saveData();
            }
            
            // Ticket generation methods
            generateTickets() {
                const type = document.getElementById('ticketType').value;
                const price = parseInt(document.getElementById('ticketPrice').value);
                const quantity = parseInt(document.getElementById('ticketQuantity').value);
                const prefix = document.getElementById('ticketPrefix').value;
                const expiry = document.getElementById('ticketExpiry').value;
                
                if (quantity < 1 || quantity > 1000) {
                    this.showToast('Error', 'Jumlah tiket harus antara 1-1000', 'error');
                    return;
                }
                
                if (price < 1000) {
                    this.showToast('Error', 'Harga tiket minimal Rp 1.000', 'error');
                    return;
                }
                
                const ticketsContainer = document.getElementById('generatedTicketsContainer');
                ticketsContainer.innerHTML = '';
                
                const generatedTickets = [];
                
                for (let i = 0; i < quantity; i++) {
                    let code;
                    let attempts = 0;
                    
                    // Generate unique code
                    do {
                        code = this.generateTicketCode(prefix);
                        attempts++;
                        
                        if (attempts > 100) {
                            this.showToast('Error', 'Gagal menghasilkan kode tiket unik', 'error');
                            return;
                        }
                    } while (this.tickets.some(t => t.code === code));
                    
                    const ticket = {
                        id: this.tickets.length > 0 ? Math.max(...this.tickets.map(t => t.id)) + 1 : 1,
                        code: code,
                        type: type,
                        price: price,
                        status: 'available',
                        generatedBy: this.currentUser.id,
                        generatedAt: new Date().toISOString(),
                        expiryDate: expiry || null,
                        soldAt: null,
                        soldBy: null,
                        transactionId: null
                    };
                    
                    generatedTickets.push(ticket);
                    
                    // Add to display
                    const ticketElement = this.createTicketElement(ticket, true);
                    ticketsContainer.appendChild(ticketElement);
                }
                
                // Add to main tickets array
                this.tickets.push(...generatedTickets);
                this.saveData();
                
                // Show generated tickets card
                document.getElementById('generatedTicketsCard').style.display = 'block';
                
                // Show success message
                this.showToast('Berhasil', `${quantity} tiket berhasil digenerate`, 'success');
                
                // Add activity log
                this.addActivity(`${this.currentUser.fullName} generated ${quantity} ${type} tickets`);
                
                // Update dashboard counts
                this.loadDashboardData();
            }
            
            createTicketElement(ticket, isPremium = false) {
                if (isPremium) {
                    return this.createPremiumTicketElement(ticket);
                }
                
                const ticketElement = document.createElement('div');
                ticketElement.className = 'ticket-card mb-3 position-relative';
                
                let statusBadge;
                if (ticket.status === 'available') {
                    statusBadge = '<span class="badge bg-success">Tersedia</span>';
                } else if (ticket.status === 'sold') {
                    statusBadge = '<span class="badge bg-primary">Terjual</span>';
                } else if (ticket.status === 'expired') {
                    statusBadge = '<span class="badge bg-danger">Kedaluwarsa</span>';
                }
                
                let typeBadgeClass = '';
                switch(ticket.type) {
                    case 'regular': typeBadgeClass = 'ticket-regular'; break;
                    case 'vip': typeBadgeClass = 'ticket-vip'; break;
                    case 'family': typeBadgeClass = 'ticket-family'; break;
                    case 'group': typeBadgeClass = 'ticket-group'; break;
                }
                
                ticketElement.innerHTML = `
                    <div class="ticket-watermark">${ticket.type.toUpperCase()}</div>
                    <span class="ticket-type-badge ${typeBadgeClass}">${ticket.type.toUpperCase()}</span>
                    
                    <div class="d-flex justify-content-between align-items-center mb-2">
                        <h5 class="mb-0">Tiket ${ticket.type.charAt(0).toUpperCase() + ticket.type.slice(1)}</h5>
                        ${statusBadge}
                    </div>
                    
                    <div class="ticket-code">${ticket.code}</div>
                    
                    <div class="ticket-details">
                        <div class="ticket-detail">
                            <small>Harga</small>
                            <div>${this.formatCurrency(ticket.price)}</div>
                        </div>
                        <div class="ticket-detail">
                            <small>Generate Pada</small>
                            <div>${this.formatDateTime(ticket.generatedAt)}</div>
                        </div>
                        ${ticket.expiryDate ? `
                            <div class="ticket-detail">
                                <small>Kedaluwarsa</small>
                                <div>${this.formatDate(ticket.expiryDate)}</div>
                            </div>
                        ` : ''}
                        ${ticket.soldAt ? `
                            <div class="ticket-detail">
                                <small>Dijual Pada</small>
                                <div>${this.formatDateTime(ticket.soldAt)}</div>
                            </div>
                        ` : ''}
                    </div>
                `;
                
                return ticketElement;
            }
            
            createPremiumTicketElement(ticket) {
                const ticketElement = document.createElement('div');
                ticketElement.className = 'premium-ticket mb-4 position-relative';
                
                let statusBadge;
                if (ticket.status === 'available') {
                    statusBadge = '<span class="badge bg-success">Tersedia</span>';
                } else if (ticket.status === 'sold') {
                    statusBadge = '<span class="badge bg-primary">Terjual</span>';
                } else if (ticket.status === 'expired') {
                    statusBadge = '<span class="badge bg-danger">Kedaluwarsa</span>';
                }
                
                let typeBadgeClass = '';
                switch(ticket.type) {
                    case 'regular': typeBadgeClass = 'ticket-regular'; break;
                    case 'vip': typeBadgeClass = 'ticket-vip'; break;
                    case 'family': typeBadgeClass = 'ticket-family'; break;
                    case 'group': typeBadgeClass = 'ticket-group'; break;
                }
                
                ticketElement.innerHTML = `
                    <div class="ticket-watermark">${ticket.type.toUpperCase()}</div>
                    <span class="ticket-type-badge ${typeBadgeClass}">${ticket.type.toUpperCase()}</span>
                    
                    <div class="d-flex justify-content-between align-items-center mb-3">
                        <h4 class="mb-0">Tiket ${ticket.type.charAt(0).toUpperCase() + ticket.type.slice(1)}</h4>
                        ${statusBadge}
                    </div>
                    
                    <div class="ticket-code">${ticket.code}</div>
                    
                    <div class="ticket-details">
                        <div class="ticket-detail">
                            <small>Harga</small>
                            <div class="fw-bold">${this.formatCurrency(ticket.price)}</div>
                        </div>
                        <div class="ticket-detail">
                            <small>Generate Pada</small>
                            <div>${this.formatDateTime(ticket.generatedAt)}</div>
                        </div>
                        ${ticket.expiryDate ? `
                            <div class="ticket-detail">
                                <small>Kedaluwarsa</small>
                                <div>${this.formatDate(ticket.expiryDate)}</div>
                            </div>
                        ` : ''}
                        ${ticket.soldAt ? `
                            <div class="ticket-detail">
                                <small>Dijual Pada</small>
                                <div>${this.formatDateTime(ticket.soldAt)}</div>
                            </div>
                        ` : ''}
                    </div>
                               `;

                return ticketElement;
            }

            printAllTickets() {
                // Create a print window with all generated tickets
                const printWindow = window.open('', '_blank');
                const tickets = document.getElementById('generatedTicketsContainer').innerHTML;
                
                printWindow.document.write(`
                    <!DOCTYPE html>
                    <html>
                    <head>
                        <title>Print Tiket</title>
                        <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
                        <style>
                            body {
                                padding: 20px;
                            }
                            .ticket-print-page {
                                display: grid;
                                grid-template-columns: repeat(2, 1fr);
                                gap: 15px;
                                padding: 15px;
                            }
                            .premium-ticket {
                                break-inside: avoid;
                                margin-bottom: 20px;
                            }
                            @page {
                                size: A4;
                                margin: 10mm;
                            }
                            @media print {
                                .no-print {
                                    display: none !important;
                                }
                            }
                        </style>
                    </head>
                    <body>
                        <div class="ticket-print-page">
                            ${tickets}
                        </div>
                        <script>
                            window.onload = function() {
                                window.print();
                                window.close();
                            };
                        </script>
                    </body>
                    </html>
                `);
            }

            // Ticket stock management methods
            loadTicketStock() {
                const statusFilter = document.getElementById('filterStatus').value;
                const typeFilter = document.getElementById('filterType').value;
                const dateFilter = document.getElementById('filterDate').value;
                
                let filteredTickets = [...this.tickets];
                
                // Apply filters
                if (statusFilter !== 'all') {
                    filteredTickets = filteredTickets.filter(t => t.status === statusFilter);
                }
                
                if (typeFilter !== 'all') {
                    filteredTickets = filteredTickets.filter(t => t.type === typeFilter);
                }
                
                if (dateFilter) {
                    filteredTickets = filteredTickets.filter(t => 
                        t.generatedAt.startsWith(dateFilter)
                    );
                }
                
                // Sort by most recent first
                filteredTickets.sort((a, b) => 
                    new Date(b.generatedAt) - new Date(a.generatedAt)
                );
                
                // Populate table
                const tableBody = document.getElementById('stockTableBody');
                tableBody.innerHTML = '';
                
                if (filteredTickets.length === 0) {
                    tableBody.innerHTML = `
                        <tr>
                            <td colspan="7" class="text-center text-muted py-4">
                                Tidak ada tiket yang ditemukan
                            </td>
                        </tr>
                    `;
                    return;
                }
                
                filteredTickets.forEach(ticket => {
                    const row = document.createElement('tr');
                    
                    let statusBadge;
                    if (ticket.status === 'available') {
                        statusBadge = '<span class="badge bg-success">Tersedia</span>';
                    } else if (ticket.status === 'sold') {
                        statusBadge = '<span class="badge bg-primary">Terjual</span>';
                    } else if (ticket.status === 'expired') {
                        statusBadge = '<span class="badge bg-danger">Kedaluwarsa</span>';
                    }
                    
                    let typeBadge;
                    switch(ticket.type) {
                        case 'regular': 
                            typeBadge = '<span class="badge bg-primary">Regular</span>';
                            break;
                        case 'vip': 
                            typeBadge = '<span class="badge bg-warning text-dark">VIP</span>';
                            break;
                        case 'family': 
                            typeBadge = '<span class="badge bg-success">Family</span>';
                            break;
                        case 'group': 
                            typeBadge = '<span class="badge bg-info text-dark">Group</span>';
                            break;
                    }
                    
                    row.innerHTML = `
                        <td>${ticket.code}</td>
                        <td>${typeBadge}</td>
                        <td>${this.formatCurrency(ticket.price)}</td>
                        <td>${statusBadge}</td>
                        <td>${this.formatDateTime(ticket.generatedAt)}</td>
                        <td>${ticket.expiryDate ? this.formatDate(ticket.expiryDate) : '-'}</td>
                        <td>
                            <button class="btn btn-sm btn-outline-primary view-ticket-btn" data-id="${ticket.id}">
                                <i class="fas fa-eye"></i>
                            </button>
                            ${ticket.status === 'available' ? `
                                <button class="btn btn-sm btn-outline-danger delete-ticket-btn" data-id="${ticket.id}">
                                    <i class="fas fa-trash"></i>
                                </button>
                            ` : ''}
                        </td>
                    `;
                    
                    tableBody.appendChild(row);
                });
                
                // Add event listeners to buttons
                document.querySelectorAll('.view-ticket-btn').forEach(btn => {
                    btn.addEventListener('click', () => {
                        const ticketId = parseInt(btn.getAttribute('data-id'));
                        this.viewTicketDetails(ticketId);
                    });
                });
                
                document.querySelectorAll('.delete-ticket-btn').forEach(btn => {
                    btn.addEventListener('click', () => {
                        const ticketId = parseInt(btn.getAttribute('data-id'));
                        this.deleteTicket(ticketId);
                    });
                });
            }
            
            filterTickets(searchTerm) {
                const rows = document.querySelectorAll('#stockTableBody tr');
                const searchLower = searchTerm.toLowerCase();
                
                rows.forEach(row => {
                    const code = row.cells[0].textContent.toLowerCase();
                    const type = row.cells[1].textContent.toLowerCase();
                    
                    if (code.includes(searchLower) || type.includes(searchLower)) {
                        row.style.display = '';
                    } else {
                        row.style.display = 'none';
                    }
                });
            }
            
            viewTicketDetails(ticketId) {
                const ticket = this.tickets.find(t => t.id === ticketId);
                if (!ticket) return;
                
                const modalContent = document.getElementById('ticketModalContent');
                modalContent.innerHTML = '';
                
                const ticketElement = this.createPremiumTicketElement(ticket);
                modalContent.appendChild(ticketElement);
                
                // Set print button action
                document.getElementById('printTicketBtn').onclick = () => {
                    this.printTicket(ticket);
                };
                
                const modal = new bootstrap.Modal(document.getElementById('viewTicketModal'));
                modal.show();
            }
            
            printTicket(ticket) {
                const printWindow = window.open('', '_blank');
                
                printWindow.document.write(`
                    <!DOCTYPE html>
                    <html>
                    <head>
                        <title>Print Tiket ${ticket.code}</title>
                        <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
                        <style>
                            body {
                                padding: 20px;
                            }
                            @page {
                                size: A4;
                                margin: 10mm;
                            }
                        </style>
                    </head>
                    <body>
                        ${this.createPremiumTicketElement(ticket).outerHTML}
                        <script>
                            window.onload = function() {
                                window.print();
                                window.close();
                            };
                        </script>
                    </body>
                    </html>
                `);
            }
            
            deleteTicket(ticketId) {
                this.showConfirmation(
                    'Hapus Tiket',
                    'Apakah Anda yakin ingin menghapus tiket ini?',
                    () => {
                        const index = this.tickets.findIndex(t => t.id === ticketId);
                        if (index !== -1) {
                            this.tickets.splice(index, 1);
                            this.saveData();
                            this.loadTicketStock();
                            this.showToast('Berhasil', 'Tiket berhasil dihapus', 'success');
                            
                            // Add activity log
                            this.addActivity(`${this.currentUser.fullName} deleted a ticket`);
                            
                            // Update dashboard counts
                            this.loadDashboardData();
                        }
                    }
                );
            }
            
            exportStock() {
                // Prepare data for export
                const data = this.tickets.map(ticket => ({
                    'Kode Tiket': ticket.code,
                    'Jenis Tiket': ticket.type,
                    'Harga': ticket.price,
                    'Status': ticket.status,
                    'Generate Pada': this.formatDateTime(ticket.generatedAt),
                    'Kedaluwarsa': ticket.expiryDate ? this.formatDate(ticket.expiryDate) : '-',
                    'Dijual Pada': ticket.soldAt ? this.formatDateTime(ticket.soldAt) : '-'
                }));
                
                // Convert to CSV
                const csv = this.convertToCSV(data);
                
                // Create download link
                const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
                const url = URL.createObjectURL(blob);
                const link = document.createElement('a');
                link.href = url;
                link.setAttribute('download', `Stok_Tiket_${new Date().toISOString().split('T')[0]}.csv`);
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                
                // Add activity log
                this.addActivity(`${this.currentUser.fullName} exported ticket stock`);
            }
            
            clearStock() {
                // Remove all tickets
                this.tickets = [];
                this.saveData();
                
                // Reload table
                this.loadTicketStock();
                
                // Show success message
                this.showToast('Berhasil', 'Semua stok tiket telah dihapus', 'success');
                
                // Add activity log
                this.addActivity(`${this.currentUser.fullName} cleared all ticket stock`);
                
                // Update dashboard counts
                this.loadDashboardData();
            }
            
            // Sales methods
            addToCart() {
                const code = document.getElementById('ticketCodeInput').value.trim().toUpperCase();
                const quantity = parseInt(document.getElementById('ticketQuantityInput').value);
                
                if (quantity < 1) {
                    this.showToast('Error', 'Jumlah tiket minimal 1', 'error');
                    return;
                }
                
                // Find ticket
                const ticket = this.tickets.find(t => 
                    t.code === code && t.status === 'available' && 
                    (!t.expiryDate || new Date(t.expiryDate) >= new Date())
                );
                
                if (!ticket) {
                    this.showToast('Error', 'Tiket tidak ditemukan atau tidak tersedia', 'error');
                    return;
                }
                
                // Check if ticket already in cart
                const existingItem = this.cart.find(item => item.ticket.id === ticket.id);
                
                if (existingItem) {
                    existingItem.quantity += quantity;
                } else {
                    this.cart.push({
                        ticket: ticket,
                        quantity: quantity
                    });
                }
                
                // Update cart display
                this.updateCartDisplay();
                
                // Clear input
                document.getElementById('ticketCodeInput').value = '';
                document.getElementById('ticketQuantityInput').value = 1;
                
                // Focus on ticket code input
                document.getElementById('ticketCodeInput').focus();
            }
            
            updateCartDisplay() {
                const tableBody = document.getElementById('cartTableBody');
                tableBody.innerHTML = '';
                
                if (this.cart.length === 0) {
                    tableBody.innerHTML = `
                        <tr>
                            <td colspan="6" class="text-center text-muted py-4">
                                Keranjang kosong
                            </td>
                        </tr>
                    `;
                    
                    document.getElementById('cartTotal').textContent = 'Rp 0';
                    document.getElementById('totalAmount').value = 'Rp 0';
                    document.getElementById('amountPaid').value = '';
                    document.getElementById('changeAmount').value = 'Rp 0';
                    
                    return;
                }
                
                let total = 0;
                
                this.cart.forEach((item, index) => {
                    const subtotal = item.ticket.price * item.quantity;
                    total += subtotal;
                    
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td>${item.ticket.code}</td>
                        <td>${item.ticket.type.charAt(0).toUpperCase() + item.ticket.type.slice(1)}</td>
                        <td>${this.formatCurrency(item.ticket.price)}</td>
                        <td>
                            <input type="number" class="form-control form-control-sm cart-quantity" 
                                   value="${item.quantity}" min="1" data-index="${index}" style="width: 70px;">
                        </td>
                        <td>${this.formatCurrency(subtotal)}</td>
                        <td>
                            <button class="btn btn-sm btn-outline-danger remove-item-btn" data-index="${index}">
                                <i class="fas fa-trash"></i>
                            </button>
                        </td>
                    `;
                    
                    tableBody.appendChild(row);
                });
                
                // Apply tax if enabled
                if (this.settings.enableTax) {
                    const taxAmount = total * (this.settings.taxRate / 100);
                    total += taxAmount;
                    
                    const taxRow = document.createElement('tr');
                    taxRow.innerHTML = `
                        <td colspan="4" class="text-end">Pajak (${this.settings.taxName} ${this.settings.taxRate}%)</td>
                        <td>${this.formatCurrency(taxAmount)}</td>
                        <td></td>
                    `;
                    tableBody.appendChild(taxRow);
                }
                
                // Update totals
                document.getElementById('cartTotal').textContent = this.formatCurrency(total);
                document.getElementById('totalAmount').value = this.formatCurrency(total);
                
                // Calculate change if amount paid exists
                if (document.getElementById('amountPaid').value) {
                    this.calculateChange();
                }
                
                // Add event listeners
                document.querySelectorAll('.cart-quantity').forEach(input => {
                    input.addEventListener('change', (e) => {
                        const index = parseInt(e.target.getAttribute('data-index'));
                        const newQuantity = parseInt(e.target.value);
                        
                        if (newQuantity < 1) {
                            e.target.value = 1;
                            return;
                        }
                        
                        this.cart[index].quantity = newQuantity;
                        this.updateCartDisplay();
                    });
                });
                
                document.querySelectorAll('.remove-item-btn').forEach(btn => {
                    btn.addEventListener('click', (e) => {
                        const index = parseInt(e.target.closest('button').getAttribute('data-index'));
                        this.cart.splice(index, 1);
                        this.updateCartDisplay();
                    });
                });
            }
            
            calculateChange() {
                const total = this.getCartTotal();
                const amountPaid = parseFloat(document.getElementById('amountPaid').value) || 0;
                const change = amountPaid - total;
                
                document.getElementById('changeAmount').value = 
                    change >= 0 ? this.formatCurrency(change) : this.formatCurrency(0);
            }
            
            getCartTotal() {
                let total = this.cart.reduce((sum, item) => 
                    sum + (item.ticket.price * item.quantity), 0);
                
                if (this.settings.enableTax) {
                    total += total * (this.settings.taxRate / 100);
                }
                
                return total;
            }
            
            resetCart() {
                this.cart = [];
                this.updateCartDisplay();
            }
            
            completePayment() {
                const paymentMethod = document.getElementById('paymentMethod').value;
                const customerName = document.getElementById('customerName').value.trim();
                const amountPaid = parseFloat(document.getElementById('amountPaid').value);
                const total = this.getCartTotal();
                
                if (this.cart.length === 0) {
                    this.showToast('Error', 'Keranjang kosong', 'error');
                    return;
                }
                
                if (amountPaid < total) {
                    this.showToast('Error', 'Jumlah pembayaran kurang', 'error');
                    return;
                }
                
                // Create transaction
                const transactionId = this.transactions.length > 0 ? 
                    Math.max(...this.transactions.map(t => t.id)) + 1 : 1;
                
                const transaction = {
                    id: transactionId,
                    code: this.generateTransactionCode(),
                    date: new Date().toISOString(),
                    userId: this.currentUser.id,
                    customerName: customerName || null,
                    items: this.cart.map(item => ({
                        ticketId: item.ticket.id,
                        code: item.ticket.code,
                        type: item.ticket.type,
                        price: item.ticket.price,
                        quantity: item.quantity
                    })),
                    subtotal: this.cart.reduce((sum, item) => 
                        sum + (item.ticket.price * item.quantity), 0),
                    tax: this.settings.enableTax ? 
                        this.settings.taxName + ' ' + this.settings.taxRate + '%' : null,
                    taxAmount: this.settings.enableTax ? 
                        total * (this.settings.taxRate / 100) : 0,
                    total: total,
                    paymentMethod: paymentMethod,
                    amountPaid: amountPaid,
                    change: amountPaid - total
                };
                
                // Update ticket statuses
                this.cart.forEach(item => {
                    const ticket = this.tickets.find(t => t.id === item.ticket.id);
                    if (ticket) {
                        ticket.status = 'sold';
                        ticket.soldAt = new Date().toISOString();
                        ticket.soldBy = this.currentUser.id;
                        ticket.transactionId = transactionId;
                    }
                });
                
                // Add transaction to history
                this.transactions.push(transaction);
                this.saveData();
                
                // Show receipt
                this.showReceipt(transaction);
                
                // Reset cart
                this.resetCart();
                
                // Show success message
                this.showToast('Berhasil', 'Pembayaran berhasil diproses', 'success');
                
                // Add activity log
                this.addActivity(`${this.currentUser.fullName} completed a transaction (${transaction.code})`);
                
                // Update dashboard counts
                this.loadDashboardData();
            }
            
            showReceipt(transaction) {
                const modalContent = document.getElementById('transactionModalContent');
                modalContent.innerHTML = this.createReceiptHTML(transaction);
                
                // Set print button action
                document.getElementById('printTransactionBtn').onclick = () => {
                    this.printReceipt(transaction);
                };
                
                const modal = new bootstrap.Modal(document.getElementById('viewTransactionModal'));
                modal.show();
            }
            
            createReceiptHTML(transaction) {
                const venueLogo = this.settings.venueLogo || 
                    'https://raw.githubusercontent.com/LKS-88/anekamarket/refs/heads/main/Logo-Anekamarketku.png';
                
                let receiptHTML = `
                    <div class="receipt">
                        <div class="receipt-header">
                            <img src="${venueLogo}" alt="Venue Logo" class="mb-2">
                            <div class="receipt-title">${this.settings.venueName || 'Tempat Wisata'}</div>
                            <div class="receipt-meta">
                                ${this.settings.venueLocation || ''}<br>
                                ${transaction.code} | ${this.formatDateTime(transaction.date)}
                            </div>
                        </div>
                        
                        <table class="receipt-items">
                            <thead>
                                <tr>
                                    <th>Item</th>
                                    <th class="right">Qty</th>
                                    <th class="right">Harga</th>
                                    <th class="right">Subtotal</th>
                                </tr>
                            </thead>
                            <tbody>
                `;
                
                transaction.items.forEach(item => {
                    receiptHTML += `
                        <tr>
                            <td>Tiket ${item.type.charAt(0).toUpperCase() + item.type.slice(1)} (${item.code})</td>
                            <td class="right">${item.quantity}</td>
                            <td class="right">${this.formatCurrency(item.price)}</td>
                            <td class="right">${this.formatCurrency(item.price * item.quantity)}</td>
                        </tr>
                    `;
                });
                
                receiptHTML += `
                            </tbody>
                        </table>
                        
                        <table class="receipt-totals">
                            <tr>
                                <td>Subtotal</td>
                                <td class="right">${this.formatCurrency(transaction.subtotal)}</td>
                            </tr>
                `;
                
                if (transaction.tax) {
                    receiptHTML += `
                        <tr>
                            <td>${transaction.tax}</td>
                            <td class="right">${this.formatCurrency(transaction.taxAmount)}</td>
                        </tr>
                    `;
                }
                
                receiptHTML += `
                            <tr class="total">
                                <td>Total</td>
                                <td class="right">${this.formatCurrency(transaction.total)}</td>
                            </tr>
                            <tr>
                                <td>Dibayar (${this.paymentMethods.find(m => m.value === transaction.paymentMethod).label})</td>
                                <td class="right">${this.formatCurrency(transaction.amountPaid)}</td>
                            </tr>
                            <tr>
                                <td>Kembalian</td>
                                <td class="right">${this.formatCurrency(transaction.change)}</td>
                            </tr>
                        </table>
                `;
                
                if (transaction.customerName) {
                    receiptHTML += `
                        <div class="mt-3">
                            <strong>Pelanggan:</strong> ${transaction.customerName}
                        </div>
                    `;
                }
                
                if (this.settings.enableReceiptFooter !== false) {
                    receiptHTML += `
                        <div class="receipt-footer mt-3">
                            ${this.settings.receiptFooterText || 'Terima kasih telah berkunjung!'}
                        </div>
                    `;
                }
                
                receiptHTML += `
                        <div class="text-center mt-3">
                            <small class="text-muted">Kasir: ${this.currentUser.fullName}</small>
                        </div>
                    </div>
                `;
                
                return receiptHTML;
            }
            
            printReceipt(transaction) {
                const printWindow = window.open('', '_blank');
                
                printWindow.document.write(`
                    <!DOCTYPE html>
                    <html>
                    <head>
                        <title>Struk ${transaction.code}</title>
                        <style>
                            body {
                                font-family: 'Courier New', monospace;
                                padding: 10px;
                            }
                            .receipt {
                                width: 100%;
                                max-width: 400px;
                                margin: 0 auto;
                            }
                            @page {
                                size: auto;
                                margin: 0;
                            }
                            @media print {
                                body {
                                    padding: 0;
                                }
                            }
                        </style>
                    </head>
                    <body>
                        ${this.createReceiptHTML(transaction)}
                        <script>
                            window.onload = function() {
                                window.print();
                                window.close();
                            };
                        </script>
                    </body>
                    </html>
                `);
            }
            
            // Transactions methods
            loadTransactions() {
                const dateFrom = document.getElementById('transactionFilterDateFrom').value;
                const dateTo = document.getElementById('transactionFilterDateTo').value;
                const methodFilter = document.getElementById('transactionFilterMethod').value;
                const userFilter = document.getElementById('transactionFilterUser').value;
                
                let filteredTransactions = [...this.transactions];
                
                // Apply date filter
                if (dateFrom) {
                    filteredTransactions = filteredTransactions.filter(t => 
                        t.date >= dateFrom + 'T00:00:00'
                    );
                }
                
                if (dateTo) {
                    filteredTransactions = filteredTransactions.filter(t => 
                        t.date <= dateTo + 'T23:59:59'
                    );
                }
                
                // Apply method filter
                if (methodFilter !== 'all') {
                    filteredTransactions = filteredTransactions.filter(t => 
                        t.paymentMethod === methodFilter
                    );
                }
                
                // Apply user filter
                if (userFilter !== 'all') {
                    filteredTransactions = filteredTransactions.filter(t => 
                        t.userId === parseInt(userFilter)
                    );
                }
                
                // Sort by most recent first
                filteredTransactions.sort((a, b) => 
                    new Date(b.date) - new Date(a.date)
                );
                
                // Populate table
                const tableBody = document.getElementById('transactionsTableBody');
                tableBody.innerHTML = '';
                
                if (filteredTransactions.length === 0) {
                    tableBody.innerHTML = `
                        <tr>
                            <td colspan="7" class="text-center text-muted py-4">
                                Tidak ada transaksi yang ditemukan
                            </td>
                        </tr>
                    `;
                    return;
                }
                
                filteredTransactions.forEach(transaction => {
                    const user = this.users.find(u => u.id === transaction.userId);
                    const userName = user ? user.fullName : 'Unknown';
                    
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td>${transaction.code}</td>
                        <td>${this.formatDateTime(transaction.date)}</td>
                        <td>${userName}</td>
                        <td>${transaction.items.reduce((sum, item) => sum + item.quantity, 0)}</td>
                        <td>${this.formatCurrency(transaction.total)}</td>
                        <td>${this.paymentMethods.find(m => m.value === transaction.paymentMethod).label}</td>
                        <td>
                            <button class="btn btn-sm btn-outline-primary view-transaction-btn" data-id="${transaction.id}">
                                <i class="fas fa-eye"></i>
                            </button>
                        </td>
                    `;
                    
                    tableBody.appendChild(row);
                });
                
                // Add event listeners to buttons
                document.querySelectorAll('.view-transaction-btn').forEach(btn => {
                    btn.addEventListener('click', () => {
                        const transactionId = parseInt(btn.getAttribute('data-id'));
                        this.viewTransactionDetails(transactionId);
                    });
                });
            }
            
            filterTransactions(searchTerm) {
                const rows = document.querySelectorAll('#transactionsTableBody tr');
                const searchLower = searchTerm.toLowerCase();
                
                rows.forEach(row => {
                    const code = row.cells[0].textContent.toLowerCase();
                    const user = row.cells[2].textContent.toLowerCase();
                    
                    if (code.includes(searchLower) || user.includes(searchLower)) {
                        row.style.display = '';
                    } else {
                        row.style.display = 'none';
                    }
                });
            }
            
            viewTransactionDetails(transactionId) {
                const transaction = this.transactions.find(t => t.id === transactionId);
                if (!transaction) return;
                
                this.showReceipt(transaction);
            }
            
            exportTransactions() {
                // Prepare data for export
                const data = this.transactions.map(transaction => {
                    const user = this.users.find(u => u.id === transaction.userId);
                    
                    return {
                        'ID Transaksi': transaction.code,
                        'Tanggal': this.formatDateTime(transaction.date),
                        'Kasir': user ? user.fullName : 'Unknown',
                        'Jumlah Tiket': transaction.items.reduce((sum, item) => sum + item.quantity, 0),
                        'Subtotal': transaction.subtotal,
                        'Pajak': transaction.tax || '-',
                        'Jumlah Pajak': transaction.taxAmount || 0,
                        'Total': transaction.total,
                        'Metode Pembayaran': this.paymentMethods.find(m => m.value === transaction.paymentMethod).label,
                        'Dibayar': transaction.amountPaid,
                        'Kembalian': transaction.change,
                        'Pelanggan': transaction.customerName || '-'
                    };
                });
                
                // Convert to CSV
                const csv = this.convertToCSV(data);
                
                // Create download link
                const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
                const url = URL.createObjectURL(blob);
                const link = document.createElement('a');
                link.href = url;
                link.setAttribute('download', `Transaksi_${new Date().toISOString().split('T')[0]}.csv`);
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                
                // Add activity log
                this.addActivity(`${this.currentUser.fullName} exported transactions`);
            }
            
            clearTransactions() {
                // Remove all transactions
                this.transactions = [];
                
                // Update ticket statuses to available
                this.tickets.forEach(ticket => {
                    if (ticket.status === 'sold') {
                        ticket.status = 'available';
                        ticket.soldAt = null;
                        ticket.soldBy = null;
                        ticket.transactionId = null;
                    }
                });
                
                this.saveData();
                
                // Reload table
                this.loadTransactions();
                
                // Show success message
                this.showToast('Berhasil', 'Semua riwayat transaksi telah dihapus', 'success');
                
                // Add activity log
                this.addActivity(`${this.currentUser.fullName} cleared all transactions`);
                
                // Update dashboard counts
                this.loadDashboardData();
            }
            
            // Reports methods
            generateReport() {
                const reportType = document.getElementById('reportType').value;
                const date = document.getElementById('reportDate').value;
                const dateFrom = document.getElementById('reportDateFrom').value;
                const dateTo = document.getElementById('reportDateTo').value;
                const ticketType = document.getElementById('reportTicketType').value;
                const userId = document.getElementById('reportUser').value;
                const paymentMethod = document.getElementById('reportPaymentMethod').value;
                
                let filteredTransactions = [...this.transactions];
                
                // Apply date filter based on report type
                if (reportType === 'daily' && date) {
                    filteredTransactions = filteredTransactions.filter(t => 
                        t.date.startsWith(date)
                    );
                } else if (reportType === 'custom' && dateFrom && dateTo) {
                    filteredTransactions = filteredTransactions.filter(t => 
                        t.date >= dateFrom + 'T00:00:00' && 
                        t.date <= dateTo + 'T23:59:59'
                    );
                } else if (reportType === 'weekly') {
                    // Get start and end of current week
                    const now = new Date();
                    const startOfWeek = new Date(now);
                    startOfWeek.setDate(now.getDate() - now.getDay());
                    const endOfWeek = new Date(now);
                    endOfWeek.setDate(now.getDate() + (6 - now.getDay()));
                    
                    filteredTransactions = filteredTransactions.filter(t => 
                        new Date(t.date) >= startOfWeek && 
                        new Date(t.date) <= endOfWeek
                    );
                } else if (reportType === 'monthly') {
                    // Get start and end of current month
                    const now = new Date();
                    const startOfMonth = new Date(now.getFullYear(), now.getMonth(), 1);
                    const endOfMonth = new Date(now.getFullYear(), now.getMonth() + 1, 0);
                    
                    filteredTransactions = filteredTransactions.filter(t => 
                        new Date(t.date) >= startOfMonth && 
                        new Date(t.date) <= endOfMonth
                    );
                } else if (reportType === 'yearly') {
                    // Get start and end of current year
                    const now = new Date();
                    const startOfYear = new Date(now.getFullYear(), 0, 1);
                    const endOfYear = new Date(now.getFullYear(), 11, 31);
                    
                    filteredTransactions = filteredTransactions.filter(t => 
                        new Date(t.date) >= startOfYear && 
                        new Date(t.date) <= endOfYear
                    );
                }
                
                // Apply ticket type filter
                if (ticketType !== 'all') {
                    filteredTransactions = filteredTransactions.map(t => ({
                        ...t,
                        items: t.items.filter(i => i.type === ticketType)
                    })).filter(t => t.items.length > 0);
                }
                
                // Apply user filter
                if (userId !== 'all') {
                    filteredTransactions = filteredTransactions.filter(t => 
                        t.userId === parseInt(userId)
                    );
                }
                
                // Apply payment method filter
                if (paymentMethod !== 'all') {
                    filteredTransactions = filteredTransactions.filter(t => 
                        t.paymentMethod === paymentMethod
                    );
                }
                
                // Calculate report data
                const totalTransactions = filteredTransactions.length;
                const totalTickets = filteredTransactions.reduce((sum, t) => 
                    sum + t.items.reduce((itemSum, item) => itemSum + item.quantity, 0), 0);
                const totalRevenue = filteredTransactions.reduce((sum, t) => sum + t.total, 0);
                
                // Group by ticket type
                const ticketTypeData = {};
                this.ticketTypes.forEach(type => {
                    ticketTypeData[type] = {
                        count: 0,
                        revenue: 0
                    };
                });
                
                filteredTransactions.forEach(t => {
                    t.items.forEach(item => {
                        ticketTypeData[item.type].count += item.quantity;
                        ticketTypeData[item.type].revenue += item.price * item.quantity;
                    });
                });
                
                // Group by payment method
                const paymentMethodData = {};
                this.paymentMethods.forEach(method => {
                    paymentMethodData[method.value] = {
                        count: 0,
                        revenue: 0
                    };
                });
                
                filteredTransactions.forEach(t => {
                    paymentMethodData[t.paymentMethod].count++;
                    paymentMethodData[t.paymentMethod].revenue += t.total;
                });
                
                // Display report
                const reportResults = document.getElementById('reportResults');
                reportResults.innerHTML = `
                    <div class="row mb-4">
                        <div class="col-md-4">
                            <div class="card">
                                <div class="card-body">
                                    <h5 class="card-title">Total Transaksi</h5>
                                    <h2 class="card-text">${totalTransactions}</h2>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="card">
                                <div class="card-body">
                                    <h5 class="card-title">Total Tiket Terjual</h5>
                                    <h2 class="card-text">${totalTickets}</h2>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="card">
                                <div class="card-body">
                                    <h5 class="card-title">Total Pendapatan</h5>
                                    <h2 class="card-text">${this.formatCurrency(totalRevenue)}</h2>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="row">
                        <div class="col-md-6">
                            <div class="card mb-4">
                                <div class="card-header">
                                    <h5 class="card-title mb-0">Penjualan per Jenis Tiket</h5>
                                </div>
                                <div class="card-body">
                                    <canvas id="ticketTypeChart" height="250"></canvas>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="card mb-4">
                                <div class="card-header">
                                    <h5 class="card-title mb-0">Pendapatan per Metode Pembayaran</h5>
                                </div>
                                <div class="card-body">
                                    <canvas id="paymentMethodChart" height="250"></canvas>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="card">
                        <div class="card-header">
                            <h5 class="card-title mb-0">Detail Transaksi</h5>
                        </div>
                        <div class="card-body">
                            <div class="table-responsive">
                                <table class="table table-striped">
                                    <thead>
                                        <tr>
                                            <th>ID Transaksi</th>
                                            <th>Tanggal</th>
                                            <th>Kasir</th>
                                            <th>Jumlah Tiket</th>
                                            <th>Total</th>
                                            <th>Metode</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        ${filteredTransactions.length > 0 ? 
                                            filteredTransactions.map(t => {
                                                const user = this.users.find(u => u.id === t.userId);
                                                return `
                                                    <tr>
                                                        <td>${t.code}</td>
                                                        <td>${this.formatDateTime(t.date)}</td>
                                                        <td>${user ? user.fullName : 'Unknown'}</td>
                                                        <td>${t.items.reduce((sum, item) => sum + item.quantity, 0)}</td>
                                                        <td>${this.formatCurrency(t.total)}</td>
                                                        <td>${this.paymentMethods.find(m => m.value === t.paymentMethod).label}</td>
                                                    </tr>
                                                `;
                                            }).join('') : `
                                                <tr>
                                                    <td colspan="6" class="text-center text-muted py-4">
                                                        Tidak ada transaksi yang ditemukan
                                                    </td>
                                                </tr>
                                            `}
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                `;
                
                // Create charts
                this.createTicketTypeChart(ticketTypeData);
                this.createPaymentMethodChart(paymentMethodData);
                
                // Add activity log
                this.addActivity(`${this.currentUser.fullName} generated a report`);
            }
            
            createTicketTypeChart(data) {
                const ctx = document.getElementById('ticketTypeChart').getContext('2d');
                
                const labels = Object.keys(data).map(type => 
                    type.charAt(0).toUpperCase() + type.slice(1)
                );
                
                const counts = Object.values(data).map(d => d.count);
                const revenues = Object.values(data).map(d => d.revenue);
                
                new Chart(ctx, {
                    type: 'bar',
                    data: {
                        labels: labels,
                        datasets: [
                            {
                                label: 'Jumlah Tiket',
                                data: counts,
                                backgroundColor: 'rgba(52, 152, 219, 0.7)',
                                borderColor: 'rgba(52, 152, 219, 1)',
                                borderWidth: 1,
                                yAxisID: 'y'
                            },
                            {
                                label: 'Pendapatan',
                                data: revenues,
                                backgroundColor: 'rgba(46, 204, 113, 0.7)',
                                borderColor: 'rgba(46, 204, 113, 1)',
                                borderWidth: 1,
                                type: 'line',
                                yAxisID: 'y1'
                            }
                        ]
                    },
                    options: {
                        responsive: true,
                        interaction: {
                            mode: 'index',
                            intersect: false,
                        },
                        scales: {
                            y: {
                                type: 'linear',
                                display: true,
                                position: 'left',
                                title: {
                                    display: true,
                                    text: 'Jumlah Tiket'
                                }
                            },
                            y1: {
                                type: 'linear',
                                display: true,
                                position: 'right',
                                title: {
                                    display: true,
                                    text: 'Pendapatan'
                                },
                                grid: {
                                    drawOnChartArea: false,
                                },
                                ticks: {
                                    callback: (value) => this.formatCurrency(value)
                                }
                            }
                        },
                        plugins: {
                            tooltip: {
                                callbacks: {
                                    label: (context) => {
                                        let label = context.dataset.label || '';
                                        if (label === 'Pendapatan') {
                                            label += ': ' + this.formatCurrency(context.raw);
                                        } else {
                                            label += ': ' + context.raw;
                                        }
                                        return label;
                                    }
                                }
                            }
                        }
                    }
                });
            }
            
            createPaymentMethodChart(data) {
                const ctx = document.getElementById('paymentMethodChart').getContext('2d');
                
                const labels = Object.keys(data).map(method => 
                    this.paymentMethods.find(m => m.value === method).label
                );
                
                const counts = Object.values(data).map(d => d.count);
                const revenues = Object.values(data).map(d => d.revenue);
                
                new Chart(ctx, {
                    type: 'doughnut',
                    data: {
                        labels: labels,
                        datasets: [
                            {
                                label: 'Pendapatan',
                                data: revenues,
                                backgroundColor: [
                                    'rgba(52, 152, 219, 0.7)',
                                    'rgba(155, 89, 182, 0.7)',
                                    'rgba(241, 196, 15, 0.7)',
                                    'rgba(46, 204, 113, 0.7)',
                                    'rgba(231, 76, 60, 0.7)'
                                ],
                                borderColor: [
                                    'rgba(52, 152, 219, 1)',
                                    'rgba(155, 89, 182, 1)',
                                    'rgba(241, 196, 15, 1)',
                                    'rgba(46, 204, 113, 1)',
                                    'rgba(231, 76, 60, 1)'
                                ],
                                borderWidth: 1
                            }
                        ]
                    },
                    options: {
                        responsive: true,
                        plugins: {
                            tooltip: {
                                callbacks: {
                                    label: (context) => {
                                        const label = context.label || '';
                                        const value = context.raw || 0;
                                        const total = context.dataset.data.reduce((a, b) => a + b, 0);
                                        const percentage = Math.round((value / total) * 100);
                                        return `${label}: ${this.formatCurrency(value)} (${percentage}%)`;
                                    }
                                }
                            },
                            legend: {
                                position: 'right',
                            }
                        }
                    }
                });
            }
            
            printReport() {
                const reportContent = document.getElementById('reportResults').innerHTML;
                const printWindow = window.open('', '_blank');
                
                printWindow.document.write(`
                    <!DOCTYPE html>
                    <html>
                    <head>
                        <title>Laporan Penjualan</title>
                        <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
                        <style>
                            body {
                                padding: 20px;
                            }
                            @page {
                                size: A4;
                                margin: 10mm;
                            }
                        </style>
                    </head>
                    <body>
                        <h2 class="mb-4">Laporan Penjualan</h2>
                        ${reportContent}
                        <script>
                            window.onload = function() {
                                window.print();
                                window.close();
                            };
                        </script>
                    </body>
                    </html>
                `);
            }
            
            exportReportToPDF() {
                // In a real implementation, you would use a library like jsPDF or a server-side solution
                this.showToast('Info', 'Fitur export PDF akan diimplementasikan', 'info');
            }
            
            // User management methods
            loadUsers() {
                const tableBody = document.getElementById('usersTableBody');
                tableBody.innerHTML = '';
                
                if (this.users.length === 0) {
                    tableBody.innerHTML = `
                        <tr>
                            <td colspan="6" class="text-center text-muted py-4">
                                Tidak ada pengguna yang ditemukan
                            </td>
                        </tr>
                    `;
                    return;
                }
                
                this.users.forEach(user => {
                    let roleBadge;
                    if (user.role === 'admin') {
                        roleBadge = '<span class="badge badge-admin">Admin</span>';
                    } else if (user.role === 'cashier') {
                        roleBadge = '<span class="badge badge-cashier">Kasir</span>';
                    } else if (user.role === 'manager') {
                        roleBadge = '<span class="badge badge-manager">Manager</span>';
                    }
                    
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td>${user.username}</td>
                        <td>${user.fullName}</td>
                        <td>${roleBadge}</td>
                        <td>${user.status === 'active' ? 
                            '<span class="badge bg-success">Aktif</span>' : 
                            '<span class="badge bg-secondary">Nonaktif</span>'}</td>
                        <td>${user.lastLogin ? this.formatDateTime(user.lastLogin) : 'Belum pernah login'}</td>
                        <td>
                            <button class="btn btn-sm btn-outline-primary edit-user-btn" data-id="${user.id}">
                                <i class="fas fa-edit"></i>
                            </button>
                            ${user.id !== this.currentUser.id ? `
                                <button class="btn btn-sm btn-outline-danger delete-user-btn" data-id="${user.id}">
                                    <i class="fas fa-trash"></i>
                                </button>
                            ` : ''}
                        </td>
                    `;
                    
                    tableBody.appendChild(row);
                });
                
                // Add event listeners to buttons
                document.querySelectorAll('.edit-user-btn').forEach(btn => {
                    btn.addEventListener('click', () => {
                        const userId = parseInt(btn.getAttribute('data-id'));
                        this.editUser(userId);
                    });
                });
                
                document.querySelectorAll('.delete-user-btn').forEach(btn => {
                    btn.addEventListener('click', () => {
                        const userId = parseInt(btn.getAttribute('data-id'));
                        this.deleteUser(userId);
                    });
                });
                
                // Populate user dropdowns in other sections
                this.populateUserDropdown('transactionFilterUser');
                this.populateUserDropdown('reportUser');
            }
            
            populateUserDropdown(dropdownId) {
                const dropdown = document.getElementById(dropdownId);
                if (!dropdown) return;
                
                // Keep the first option (usually "All")
                const firstOption = dropdown.options[0];
                dropdown.innerHTML = '';
                dropdown.appendChild(firstOption);
                
                // Add user options
                this.users.forEach(user => {
                    const option = document.createElement('option');
                    option.value = user.id;
                    option.textContent = `${user.fullName} (${user.username})`;
                    dropdown.appendChild(option);
                });
            }
            
            filterUsers(searchTerm) {
                const rows = document.querySelectorAll('#usersTableBody tr');
                const searchLower = searchTerm.toLowerCase();
                
                rows.forEach(row => {
                    const username = row.cells[0].textContent.toLowerCase();
                    const fullName = row.cells[1].textContent.toLowerCase();
                    
                    if (username.includes(searchLower) || fullName.includes(searchLower)) {
                        row.style.display = '';
                    } else {
                        row.style.display = 'none';
                    }
                });
            }
            
            addNewUser() {
                const username = document.getElementById('newUsername').value.trim();
                const fullName = document.getElementById('newFullName').value.trim();
                const role = document.getElementById('newUserRole').value;
                const password = document.getElementById('newUserPassword').value;
                const confirmPassword = document.getElementById('confirmUserPassword').value;
                
                // Validate
                if (!username || !fullName || !password || !confirmPassword) {
                    this.showToast('Error', 'Semua field harus diisi', 'error');
                    return;
                }
                
                if (password !== confirmPassword) {
                    this.showToast('Error', 'Password tidak cocok', 'error');
                    return;
                }
                
                if (password.length < 6) {
                    this.showToast('Error', 'Password minimal 6 karakter', 'error');
                    return;
                }
                
                if (this.users.some(u => u.username === username)) {
                    this.showToast('Error', 'Username sudah digunakan', 'error');
                    return;
                }
                
                // Create new user
                const newUser = {
                    id: this.users.length > 0 ? Math.max(...this.users.map(u => u.id)) + 1 : 1,
                    username: username,
                    password: this.hashPassword(password),
                    fullName: fullName,
                    role: role,
                    status: 'active',
                    lastLogin: null,
                    createdAt: new Date().toISOString(),
                    permissions: this.getDefaultPermissions(role)
                };
                
                // Add to users array
                this.users.push(newUser);
                this.saveData();
                
                // Reload users table
                this.loadUsers();
                
                // Hide modal
                const modal = bootstrap.Modal.getInstance(document.getElementById('addUserModal'));
                modal.hide();
                
                // Clear form
                document.getElementById('addUserForm').reset();
                
                // Show success message
                this.showToast('Berhasil', 'Pengguna baru berhasil ditambahkan', 'success');
                
                // Add activity log
                this.addActivity(`${this.currentUser.fullName} added new user: ${username}`);
            }
            
            editUser(userId) {
                const user = this.users.find(u => u.id === userId);
                if (!user) return;
                
                // Fill form
                document.getElementById('editUserId').value = user.id;
                document.getElementById('editUsername').value = user.username;
                document.getElementById('editFullName').value = user.fullName;
                document.getElementById('editUserRole').value = user.role;
                document.getElementById('editUserStatus').value = user.status;
                document.getElementById('editUserPassword').value = '';
                
                // Show modal
                const modal = new bootstrap.Modal(document.getElementById('editUserModal'));
                modal.show();
            }
            
            saveEditedUser() {
                const userId = parseInt(document.getElementById('editUserId').value);
                const fullName = document.getElementById('editFullName').value.trim();
                const role = document.getElementById('editUserRole').value;
                const status = document.getElementById('editUserStatus').value;
                const newPassword = document.getElementById('editUserPassword').value;
                
                // Validate
                if (!fullName) {
                    this.showToast('Error', 'Nama lengkap harus diisi', 'error');
                    return;
                }
                
                if (newPassword && newPassword.length < 6) {
                    this.showToast('Error', 'Password minimal 6 karakter', 'error');
                    return;
                }
                
                // Find user
                const userIndex = this.users.findIndex(u => u.id === userId);
                if (userIndex === -1) return;
                
                // Update user
                this.users[userIndex].fullName = fullName;
                this.users[userIndex].role = role;
                this.users[userIndex].status = status;
                
                if (newPassword) {
                    this.users[userIndex].password = this.hashPassword(newPassword);
                }
                
                // Update permissions if role changed
                if (this.users[userIndex].role !== role) {
                    this.users[userIndex].permissions = this.getDefaultPermissions(role);
                }
                
                this.saveData();
                
                // Reload users table
                this.loadUsers();
                
                // Hide modal
                const modal = bootstrap.Modal.getInstance(document.getElementById('editUserModal'));
                modal.hide();
                
                // Show success message
                this.showToast('Berhasil', 'Perubahan pengguna berhasil disimpan', 'success');
                
                // Add activity log
                this.addActivity(`${this.currentUser.fullName} edited user: ${this.users[userIndex].username}`);
                
                // If current user was edited, update session
                if (userId === this.currentUser.id) {
                    this.currentUser = this.users[userIndex];
                    sessionStorage.setItem('loggedInUser', JSON.stringify(this.currentUser));
                    this.checkPermissions();
                }
            }
            
            deleteUser(userId) {
                if (userId === this.currentUser.id) {
                    this.showToast('Error', 'Tidak dapat menghapus akun sendiri', 'error');
                    return;
                }
                
                this.showConfirmation(
                    'Hapus Pengguna',
                    'Apakah Anda yakin ingin menghapus pengguna ini?',
                    () => {
                        const index = this.users.findIndex(u => u.id === userId);
                        if (index !== -1) {
                            const username = this.users[index].username;
                            this.users.splice(index, 1);
                            this.saveData();
                            this.loadUsers();
                            this.showToast('Berhasil', 'Pengguna berhasil dihapus', 'success');
                            
                            // Add activity log
                            this.addActivity(`${this.currentUser.fullName} deleted user: ${username}`);
                        }
                    }
                );
            }
            
            getDefaultPermissions(role) {
                // Define default permissions based on role
                switch(role) {
                    case 'admin':
                        return {
                            generateTickets: true,
                            manageStock: true,
                            processSales: true,
                            viewTransactions: true,
                            generateReports: true,
                            manageUsers: true,
                            systemSettings: true,
                            backupRestore: true
                        };
                    case 'manager':
                        return {
                            generateTickets: true,
                            manageStock: true,
                            processSales: true,
                            viewTransactions: true,
                            generateReports: true,
                            manageUsers: false,
                            systemSettings: false,
                            backupRestore: false
                        };
                    case 'cashier':
                        return {
                            generateTickets: false,
                            manageStock: false,
                            processSales: true,
                            viewTransactions: true,
                            generateReports: false,
                            manageUsers: false,
                            systemSettings: false,
                            backupRestore: false
                        };
                    default:
                        return {};
                }
            }
            
            // Settings methods
            saveVenueInfo() {
                const venueName = document.getElementById('venueName').value.trim();
                const venueLocation = document.getElementById('venueLocation').value.trim();
                const venueDescription = document.getElementById('venueDescription').value.trim();
                const venueLogo = document.getElementById('venueLogo').files[0];
                
                if (!venueName || !venueLocation) {
                    this.showToast('Error', 'Nama dan lokasi tempat wisata harus diisi', 'error');
                    return;
                }
                
                // Update settings
                this.settings.venueName = venueName;
                this.settings.venueLocation = venueLocation;
                this.settings.venueDescription = venueDescription;
                
                // Handle logo upload (in a real app, this would upload to a server)
                if (venueLogo) {
                    if (venueLogo.size > 2 * 1024 * 1024) {
                        this.showToast('Error', 'Ukuran file logo maksimal 2MB', 'error');
                        return;
                    }
                    
                    const reader = new FileReader();
                    reader.onload = (e) => {
                        this.settings.venueLogo = e.target.result;
                        this.saveData();
                        
                        // Show success message
                        this.showToast('Berhasil', 'Informasi tempat wisata berhasil diperbarui', 'success');
                        
                        // Add activity log
                        this.addActivity(`${this.currentUser.fullName} updated venue information`);
                    };
                    reader.readAsDataURL(venueLogo);
                } else {
                    this.saveData();
                    
                    // Show success message
                    this.showToast('Berhasil', 'Informasi tempat wisata berhasil diperbarui', 'success');
                    
                    // Add activity log
                    this.addActivity(`${this.currentUser.fullName} updated venue information`);
                }
            }
            
            saveSystemSettings() {
                const currency = document.getElementById('currency').value;
                const dateFormat = document.getElementById('dateFormat').value;
                const timeFormat = document.getElementById('timeFormat').value;
                const enableTax = document.getElementById('enableTax').checked;
                const taxRate = parseFloat(document.getElementById('taxRate').value);
                const taxName = document.getElementById('taxName').value.trim();
                const enableReceiptFooter = document.getElementById('enableReceiptFooter').checked;
                const receiptFooterText = document.getElementById('receiptFooterText').value.trim();
                
                // Validate
                if (enableTax && (!taxName || isNaN(taxRate) || taxRate < 0 || taxRate > 100)) {
                    this.showToast('Error', 'Pengaturan pajak tidak valid', 'error');
                    return;
                }
                
                // Update settings
                this.settings.currency = currency;
                this.settings.dateFormat = dateFormat;
                this.settings.timeFormat = timeFormat;
                this.settings.enableTax = enableTax;
                this.settings.taxRate = taxRate;
                this.settings.taxName = taxName;
                this.settings.enableReceiptFooter = enableReceiptFooter;
                this.settings.receiptFooterText = receiptFooterText;
                
                this.saveData();
                this.setDateFormat();
                
                // Show success message
                this.showToast('Berhasil', 'Pengaturan sistem berhasil diperbarui', 'success');
                
                // Add activity log
                this.addActivity(`${this.currentUser.fullName} updated system settings`);
            }
            
            // Backup & Restore methods
            createBackup() {
                const backupName = document.getElementById('backupFileName').value.trim() || 
                    `TourTicketPro_Backup_${new Date().toISOString().split('T')[0]}`;
                const password = document.getElementById('backupPassword').value;
                
                // Get all data
                const data = {
                    settings: this.settings,
                    users: this.users,
                    tickets: this.tickets,
                    transactions: this.transactions,
                    activities: this.activities,
                    backupDate: new Date().toISOString(),
                    backedUpBy: this.currentUser.id
                };
                
                // Convert to JSON
                let backupData = JSON.stringify(data);
                
                // Encrypt if password provided
                if (password) {
                    // In a real app, use proper encryption
                    backupData = btoa(backupData + '|' + this.hashPassword(password));
                }
                
                // Create download link
                const blob = new Blob([backupData], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                const link = document.createElement('a');
                link.href = url;
                link.setAttribute('download', `${backupName}.ttbackup`);
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                
                // Show success message
                this.showToast('Berhasil', 'Backup data berhasil dibuat', 'success');
                
                // Add activity log
                this.addActivity(`${this.currentUser.fullName} created a backup`);
            }
            
            restoreData() {
                const fileInput = document.getElementById('restoreFile');
                const password = document.getElementById('restorePassword').value;
                
                if (!fileInput.files || fileInput.files.length === 0) {
                    this.showToast('Error', 'Pilih file backup terlebih dahulu', 'error');
                    return;
                }
                
                const file = fileInput.files[0];
                const reader = new FileReader();
                
                reader.onload = (e) => {
                    try {
                        let backupData = e.target.result;
                        
                        // Decrypt if password provided
                        if (password) {
                            try {
                                const decrypted = atob(backupData);
                                const [data, hash] = decrypted.split('|');
                                
                                if (this.hashPassword(password) !== hash) {
                                    this.showToast('Error', 'Password backup salah', 'error');
                                    return;
                                }
                                
                                backupData = data;
                            } catch (err) {
                                this.showToast('Error', 'Gagal mendekripsi backup', 'error');
                                return;
                            }
                        }
                        
                        const data = JSON.parse(backupData);
                        
                        // Validate backup data
                        if (!data.settings || !data.users || !data.tickets || !data.transactions) {
                            this.showToast('Error', 'File backup tidak valid', 'error');
                            return;
                        }
                        
                        // Confirm restore
                        this.showConfirmation(
                            'Restore Data',
                            'Semua data saat ini akan diganti dengan data dari backup. Lanjutkan?',
                            () => {
                                // Restore data
                                this.settings = data.settings;
                                this.users = data.users;
                                this.tickets = data.tickets;
                                this.transactions = data.transactions;
                                this.activities = data.activities || [];
                                
                                this.saveData();
                                
                                // Reload UI
                                this.loadData();
                                this.initUI();
                                this.loadDashboardData();
                                
                                // Show success message
                                this.showToast('Berhasil', 'Data berhasil direstore', 'success');
                                
                                // Add activity log
                                this.addActivity(`${this.currentUser.fullName} restored data from backup`);
                                
                                // Update current user if changed
                                const currentUserBackup = this.users.find(u => u.id === this.currentUser.id);
                                if (currentUserBackup) {
                                    this.currentUser = currentUserBackup;
                                    sessionStorage.setItem('loggedInUser', JSON.stringify(this.currentUser));
                                    document.getElementById('currentUsername').textContent = this.currentUser.username;
                                    this.checkPermissions();
                                }
                            },
                            true
                        );
                    } catch (err) {
                        this.showToast('Error', 'Gagal memproses file backup', 'error');
                        console.error(err);
                    }
                };
                
                reader.readAsText(file);
            }
            
            resetSystem() {
                const password = document.getElementById('resetPassword').value;
                
                // Verify admin password
                if (this.hashPassword(password) !== this.users.find(u => u.role === 'admin').password) {
                    this.showToast('Error', 'Password admin salah', 'error');
                    return;
                }
                
                // Clear all data
                localStorage.removeItem('ticketSalesData');
                
                // Reload page to initialize fresh data
                window.location.reload();
            }
            
            // Utility methods
            convertToCSV(data) {
                const headers = Object.keys(data[0]);
                const rows = data.map(obj => 
                    headers.map(header => {
                        let value = obj[header];
                        // Handle values that might contain commas
                        if (typeof value === 'string' && value.includes(',')) {
                            return `"${value}"`;
                        }
                        return value;
                    }).join(',')
                );
                
                return [headers.join(','), ...rows].join('\n');
            }
        }
    </script>
</body>
</html>
