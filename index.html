<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TourTick - Sistem Karcis Pariwisata</title>
    <!-- Load libraries from CDN -->
    <script src="https://cdn.jsdelivr.net/npm/jsbarcode@3.11.5/dist/JsBarcode.all.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/crypto-js@4.1.1/crypto-js.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root {
            --primary-color: #3498db;
            --secondary-color: #2980b9;
            --accent-color: #e74c3c;
            --light-color: #ecf0f1;
            --dark-color: #2c3e50;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: #f5f5f5;
            color: #333;
        }
        
        .sidebar {
            background-color: var(--dark-color);
            color: white;
            height: 100vh;
            position: fixed;
            transition: all 0.3s;
            overflow-y: auto;
        }
        
        .sidebar .nav-link {
            color: rgba(255, 255, 255, 0.8);
            border-radius: 5px;
            margin: 5px 0;
            transition: all 0.2s;
        }
        
        .sidebar .nav-link:hover {
            background-color: rgba(255, 255, 255, 0.1);
            color: white;
        }
        
        .sidebar .nav-link.active {
            background-color: var(--primary-color);
            color: white;
        }
        
        .main-content {
            margin-left: 250px;
            padding: 20px;
            transition: all 0.3s;
        }
        
        .card {
            border-radius: 10px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            margin-bottom: 20px;
            border: none;
        }
        
        .card-header {
            background-color: var(--primary-color);
            color: white;
            border-radius: 10px 10px 0 0 !important;
            padding: 12px 20px;
        }
        
        .btn-primary {
            background-color: var(--primary-color);
            border-color: var(--primary-color);
        }
        
        .btn-primary:hover {
            background-color: var(--secondary-color);
            border-color: var(--secondary-color);
        }
        
        .btn-danger {
            background-color: var(--accent-color);
            border-color: var(--accent-color);
        }
        
        .ticket {
            border: 2px dashed #ccc;
            padding: 15px;
            margin: 10px 0;
            background-color: white;
            border-radius: 10px;
        }
        
        .barcode-container {
            text-align: center;
            margin: 15px 0;
        }
        
        /* Responsive styles */
        @media (max-width: 992px) {
            .sidebar {
                width: 100%;
                height: auto;
                position: relative;
                padding: 10px;
            }
            .main-content {
                margin-left: 0;
                padding: 15px;
            }
        }
        
        @media (max-width: 768px) {
            .row > div {
                margin-bottom: 15px;
            }
            .d-flex.justify-content-between {
                flex-direction: column;
            }
            .d-flex.justify-content-between > * {
                margin-bottom: 10px;
            }
            .card-body {
                padding: 15px;
            }
        }
        
        .search-box {
            position: relative;
        }
        
        .search-box i {
            position: absolute;
            top: 10px;
            left: 10px;
            color: #aaa;
        }
        
        .search-box input {
            padding-left: 35px;
        }
        
        .ticket-preview {
            background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 20px;
        }
        
        .user-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background-color: var(--primary-color);
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
        }
        
        /* Receipt styles */
        .receipt {
            width: 100%;
            max-width: 400px;
            margin: 0 auto;
            font-family: 'Courier New', monospace;
            padding: 15px;
            background-color: white;
            border: 1px solid #ddd;
        }
        
        .receipt .header {
            text-align: center;
            margin-bottom: 10px;
        }
        
        .receipt .divider {
            border-top: 1px dashed #000;
            margin: 10px 0;
        }
        
        .receipt .item {
            display: flex;
            justify-content: space-between;
            margin-bottom: 5px;
            font-size: 14px;
        }
        
        .receipt .footer {
            text-align: center;
            margin-top: 15px;
            font-size: 0.9em;
        }
        
        .receipt-barcode {
            text-align: center;
            margin: 10px 0;
        }
        
        /* Status badges */
        .badge-valid {
            background-color: #28a745;
            color: white;
        }
        
        .badge-used {
            background-color: #17a2b8;
            color: white;
        }
        
        .badge-expired {
            background-color: #dc3545;
            color: white;
        }
        
        /* Access denied */
        .access-denied {
            text-align: center;
            padding: 50px 20px;
        }
        
        .access-denied i {
            font-size: 80px;
            color: var(--accent-color);
            margin-bottom: 20px;
        }
        
        /* Loading spinner */
        .loading-spinner {
            display: inline-block;
            width: 2rem;
            height: 2rem;
            vertical-align: text-bottom;
            border: 0.25em solid currentColor;
            border-right-color: transparent;
            border-radius: 50%;
            animation: spinner-border .75s linear infinite;
        }
        
        @keyframes spinner-border {
            to { transform: rotate(360deg); }
        }

        /* Footer */
        .app-footer {
            background-color: var(--dark-color);
            color: white;
            padding: 15px;
            text-align: center;
            margin-top: 20px;
            border-radius: 5px;
        }

        .app-footer a {
            color: var(--light-color);
            text-decoration: none;
        }

        .app-footer a:hover {
            color: var(--primary-color);
        }

        /* Role permissions */
        .permission-group {
            margin-bottom: 20px;
            padding: 15px;
            border: 1px solid #eee;
            border-radius: 5px;
        }

        .permission-item {
            margin-bottom: 10px;
            padding: 8px;
            background-color: #f8f9fa;
            border-radius: 4px;
        }

        .permission-checkbox {
            margin-right: 8px;
        }

        /* Backup section */
        .backup-card {
            cursor: pointer;
            transition: transform 0.2s;
        }

        .backup-card:hover {
            transform: translateY(-5px);
        }

        .backup-icon {
            font-size: 2.5rem;
            margin-bottom: 15px;
        }

        /* Logo styles */
        .app-logo {
            max-width: 150px;
            margin-bottom: 15px;
        }

        /* PDF styles */
        .pdf-table {
            width: 100%;
            border-collapse: collapse;
        }

        .pdf-table th, .pdf-table td {
            border: 1px solid #ddd;
            padding: 5px;
            font-size: 10px;
        }

        .pdf-table th {
            background-color: #f2f2f2;
            text-align: center;
        }

        /* Print styles */
        @media print {
            body * {
                visibility: hidden;
            }
            .receipt, .receipt * {
                visibility: visible;
            }
            .receipt {
                position: absolute;
                left: 0;
                top: 0;
                width: 100%;
                max-width: 100%;
                box-shadow: none;
                border: none;
            }
        }
    </style>
</head>
<body>
    <!-- Login Modal -->
    <div class="modal fade" id="loginModal" tabindex="-1" aria-hidden="false" data-bs-backdrop="static" data-bs-keyboard="false">
        <div class="modal-dialog login-modal">
            <div class="modal-content">
                <div class="modal-body p-4">
                    <div class="login-logo text-center">
                        <img src="https://raw.githubusercontent.com/LKS-88/anekamarket/refs/heads/main/Logo-Anekamarketku.png" alt="TourTick Logo" class="app-logo">
                        <h3>TourTick</h3>
                        <p class="text-muted">Sistem Karcis Pariwisata</p>
                    </div>
                    <form id="loginForm">
                        <div class="mb-3">
                            <label class="form-label">Username</label>
                            <input type="text" class="form-control" id="loginUsername" required>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Password</label>
                            <input type="password" class="form-control" id="loginPassword" required>
                        </div>
                        <button type="submit" class="btn btn-primary w-100">
                            <i class="fas fa-sign-in-alt me-1"></i> Login
                        </button>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <!-- Main App (hidden until login) -->
    <div id="appContainer" style="display: none;">
        <div class="d-flex flex-column flex-lg-row">
            <!-- Sidebar -->
            <div class="sidebar p-3" style="width: 250px;">
                <div class="text-center mb-4">
                    <img src="https://raw.githubusercontent.com/LKS-88/anekamarket/refs/heads/main/Logo-Anekamarketku.png" alt="TourTick Logo" class="app-logo">
                    <h4>TourTick</h4>
                    <p class="text-muted">Sistem Karcis Pariwisata</p>
                </div>
                <hr>
                <ul class="nav flex-column" id="sidebarMenu">
                    <li class="nav-item">
                        <a class="nav-link active" href="#" onclick="showSection('dashboard')">
                            <i class="fas fa-home me-2"></i> Dashboard
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="#" onclick="showSection('ticket-sales')">
                            <i class="fas fa-ticket-alt me-2"></i> Penjualan Karcis
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="#" onclick="showSection('generate-ticket')">
                            <i class="fas fa-barcode me-2"></i> Generate Karcis
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="#" onclick="showSection('ticket-list')">
                            <i class="fas fa-list me-2"></i> Daftar Karcis
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="#" onclick="showSection('reports')">
                            <i class="fas fa-chart-bar me-2"></i> Laporan
                        </a>
                    </li>
                    <li class="nav-item" id="products-menu-item">
                        <a class="nav-link" href="#" onclick="showSection('products')">
                            <i class="fas fa-map-marked-alt me-2"></i> Produk Wisata
                        </a>
                    </li>
                    <li class="nav-item" id="users-menu-item">
                        <a class="nav-link" href="#" onclick="showSection('users')">
                            <i class="fas fa-users me-2"></i> Pengguna
                        </a>
                    </li>
                    <li class="nav-item" id="settings-menu-item">
                        <a class="nav-link" href="#" onclick="showSection('settings')">
                            <i class="fas fa-cog me-2"></i> Pengaturan
                        </a>
                    </li>
                    <li class="nav-item" id="backup-menu-item">
                        <a class="nav-link" href="#" onclick="showSection('backup')">
                            <i class="fas fa-database me-2"></i> Backup Data
                        </a>
                    </li>
                </ul>
                <div class="mt-auto pt-3">
                    <div class="d-flex align-items-center">
                        <div class="user-avatar me-2" id="userAvatar">AD</div>
                        <div>
                            <small class="d-block" id="userName">Admin</small>
                            <small class="text-muted" id="userRole">Super User</small>
                        </div>
                    </div>
                    <button class="btn btn-sm btn-danger w-100 mt-3" onclick="logout()">
                        <i class="fas fa-sign-out-alt me-1"></i> Logout
                    </button>
                </div>
            </div>

            <!-- Main Content -->
            <div class="main-content">
                <!-- Dashboard Section -->
                <div id="dashboard-section">
                    <div class="d-flex justify-content-between align-items-center mb-4">
                        <h3>Dashboard</h3>
                        <div class="d-flex">
                            <div class="search-box me-2">
                                <i class="fas fa-search"></i>
                                <input type="text" class="form-control" placeholder="Cari...">
                            </div>
                            <button class="btn btn-primary" onclick="refreshDashboard()">
                                <i class="fas fa-sync-alt me-1"></i> Refresh
                            </button>
                        </div>
                    </div>

                    <div class="row">
                        <div class="col-md-3">
                            <div class="card">
                                <div class="card-body">
                                    <div class="d-flex justify-content-between align-items-center">
                                        <div>
                                            <h6 class="text-muted">Penjualan Hari Ini</h6>
                                            <h3 id="todaySales">0</h3>
                                            <span class="text-success"><i class="fas fa-arrow-up me-1"></i> 0%</span>
                                        </div>
                                        <div class="bg-primary bg-opacity-10 p-3 rounded">
                                            <i class="fas fa-shopping-cart text-primary"></i>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="card">
                                <div class="card-body">
                                    <div class="d-flex justify-content-between align-items-center">
                                        <div>
                                            <h6 class="text-muted">Pendapatan Hari Ini</h6>
                                            <h3 id="todayRevenue">Rp0</h3>
                                            <span class="text-success"><i class="fas fa-arrow-up me-1"></i> 0%</span>
                                        </div>
                                        <div class="bg-success bg-opacity-10 p-3 rounded">
                                            <i class="fas fa-wallet text-success"></i>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="card">
                                <div class="card-body">
                                    <div class="d-flex justify-content-between align-items-center">
                                        <div>
                                            <h6 class="text-muted">Pengunjung Hari Ini</h6>
                                            <h3 id="todayVisitors">0</h3>
                                            <span class="text-danger"><i class="fas fa-arrow-down me-1"></i> 0%</span>
                                        </div>
                                        <div class="bg-info bg-opacity-10 p-3 rounded">
                                            <i class="fas fa-users text-info"></i>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="card">
                                <div class="card-body">
                                    <div class="d-flex justify-content-between align-items-center">
                                        <div>
                                            <h6 class="text-muted">Karcis Tersedia</h6>
                                            <h3 id="availableTickets">0</h3>
                                            <span class="text-warning"><i class="fas fa-exclamation-circle me-1"></i> Low</span>
                                        </div>
                                        <div class="bg-warning bg-opacity-10 p-3 rounded">
                                            <i class="fas fa-ticket-alt text-warning"></i>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="row mt-4">
                        <div class="col-md-8">
                            <div class="card">
                                <div class="card-header">
                                    <h5 class="card-title mb-0">Statistik Penjualan 7 Hari Terakhir</h5>
                                </div>
                                <div class="card-body">
                                    <canvas id="salesChart" height="250"></canvas>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="card">
                                <div class="card-header">
                                    <h5 class="card-title mb-0">Produk Terlaris</h5>
                                </div>
                                <div class="card-body">
                                    <canvas id="topProductsChart" height="250"></canvas>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="row mt-4">
                        <div class="col-md-6">
                            <div class="card">
                                <div class="card-header">
                                    <h5 class="card-title mb-0">Transaksi Terakhir</h5>
                                </div>
                                <div class="card-body p-0">
                                    <div class="table-responsive">
                                        <table class="table table-hover mb-0">
                                            <thead>
                                                <tr>
                                                    <th>ID</th>
                                                    <th>Tanggal</th>
                                                    <th>Jumlah</th>
                                                    <th>Total</th>
                                                </tr>
                                            </thead>
                                            <tbody id="recentTransactions">
                                                <!-- Transactions will be loaded here -->
                                            </tbody>
                                        </table>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="card">
                                <div class="card-header">
                                    <h5 class="card-title mb-0">Aktivitas Terkini</h5>
                                </div>
                                <div class="card-body p-0">
                                    <div class="list-group list-group-flush" id="recentActivities">
                                        <!-- Activities will be loaded here -->
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Ticket Sales Section -->
                <div id="ticket-sales-section" style="display: none;">
                    <div class="d-flex justify-content-between align-items-center mb-4">
                        <h3>Penjualan Karcis</h3>
                        <div>
                            <button class="btn btn-primary me-2" onclick="printTicket()">
                                <i class="fas fa-print me-1"></i> Cetak
                            </button>
                            <button class="btn btn-success" onclick="completeTransaction()">
                                <i class="fas fa-check me-1"></i> Selesaikan Transaksi
                            </button>
                        </div>
                    </div>

                    <div class="row">
                        <div class="col-lg-8">
                            <div class="card">
                                <div class="card-header">
                                    <div class="d-flex justify-content-between align-items-center">
                                        <h5 class="card-title mb-0">Karcis Tersedia</h5>
                                        <div class="search-box">
                                            <i class="fas fa-search"></i>
                                            <input type="text" class="form-control form-control-sm" placeholder="Cari karcis..." id="ticketSearchSales" onkeyup="searchTicketsSales()">
                                        </div>
                                    </div>
                                </div>
                                <div class="card-body">
                                    <div class="table-responsive">
                                        <table class="table table-hover">
                                            <thead>
                                                <tr>
                                                    <th>Kode</th>
                                                    <th>Destinasi</th>
                                                    <th>Jenis</th>
                                                    <th>Harga</th>
                                                    <th>Tanggal Berlaku</th>
                                                    <th>Aksi</th>
                                                </tr>
                                            </thead>
                                            <tbody id="availableTicketsTable">
                                                <!-- Available tickets will be loaded here -->
                                            </tbody>
                                        </table>
                                    </div>
                                </div>
                            </div>

                            <div class="card mt-4">
                                <div class="card-header">
                                    <h5 class="card-title mb-0">Preview Karcis</h5>
                                </div>
                                <div class="card-body">
                                    <div class="ticket-preview text-center" id="ticketPreviewContent">
                                        <h4>Taman Wisata Alam</h4>
                                        <p>Jl. Raya Wisata No. 123, Kota Pariwisata</p>
                                        <hr>
                                        <div class="barcode-container">
                                            <svg id="barcode-preview"></svg>
                                        </div>
                                        <div class="d-flex justify-content-between">
                                            <div class="text-start">
                                                <small class="text-muted">Kode Karcis</small>
                                                <p class="mb-0 fw-bold">TWA-001</p>
                                            </div>
                                            <div class="text-end">
                                                <small class="text-muted">Tanggal</small>
                                                <p class="mb-0 fw-bold">10 Jun 2023</p>
                                            </div>
                                        </div>
                                        <hr>
                                        <div class="d-flex justify-content-between">
                                            <div class="text-start">
                                                <small class="text-muted">Harga</small>
                                                <p class="mb-0 fw-bold">Rp50.000</p>
                                            </div>
                                            <div class="text-end">
                                                <small class="text-muted">Status</small>
                                                <p class="mb-0 fw-bold text-success">Valid</p>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="col-lg-4">
                            <div class="card">
                                <div class="card-header">
                                    <h5 class="card-title mb-0">Keranjang Belanja</h5>
                                </div>
                                <div class="card-body">
                                    <div class="table-responsive">
                                        <table class="table table-sm">
                                            <thead>
                                                <tr>
                                                    <th>Karcis</th>
                                                    <th>Harga</th>
                                                    <th></th>
                                                </tr>
                                            </thead>
                                            <tbody id="cartItems">
                                                <!-- Cart items will be loaded here -->
                                            </tbody>
                                        </table>
                                    </div>
                                    <hr>
                                    <div class="d-flex justify-content-between mb-3 fw-bold">
                                        <span>Total:</span>
                                        <span id="total">Rp0</span>
                                    </div>
                                    <div class="mb-3">
                                        <label class="form-label">Pembayaran</label>
                                        <select class="form-select" id="paymentMethod" onchange="updatePaymentMethod()">
                                            <option value="cash">Tunai</option>
                                            <option value="transfer">Transfer Bank</option>
                                            <option value="qris">QRIS</option>
                                            <option value="debit">Kartu Debit</option>
                                        </select>
                                    </div>
                                    <div class="mb-3" id="cashInputContainer">
                                        <label class="form-label">Uang Diterima</label>
                                        <input type="number" class="form-control" id="cashReceived" min="0" value="0" oninput="updateChangeAmount()">
                                    </div>
                                    <div class="mb-3">
                                        <label class="form-label">Kembalian</label>
                                        <input type="text" class="form-control" id="changeAmount" readonly value="Rp0">
                                    </div>
                                    <button class="btn btn-danger w-100 mb-2" onclick="clearCart()">
                                        <i class="fas fa-trash me-1"></i> Kosongkan Keranjang
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Generate Ticket Section -->
                <div id="generate-ticket-section" style="display: none;">
                    <div class="d-flex justify-content-between align-items-center mb-4">
                        <h3>Generate Karcis</h3>
                        <div>
                            <button class="btn btn-primary me-2" onclick="generateBarcode()">
                                <i class="fas fa-barcode me-1"></i> Generate Barcode
                            </button>
                            <button class="btn btn-success" onclick="printGeneratedTicket()">
                                <i class="fas fa-print me-1"></i> Cetak Karcis
                            </button>
                        </div>
                    </div>

                    <div class="row">
                        <div class="col-md-6">
                            <div class="card">
                                <div class="card-header">
                                    <h5 class="card-title mb-0">Form Karcis</h5>
                                </div>
                                <div class="card-body">
                                    <form id="ticketForm">
                                        <div class="mb-3">
                                            <label class="form-label">Jenis Karcis</label>
                                            <select class="form-select" id="ticketType" required onchange="updateTicketCode()">
                                                <option value="">Pilih Jenis Karcis</option>
                                                <option value="regular">Reguler</option>
                                                <option value="vip">VIP</option>
                                                <option value="group">Grup</option>
                                                <option value="student">Pelajar/Mahasiswa</option>
                                                <option value="foreigner">Warga Asing</option>
                                            </select>
                                        </div>
                                        <div class="mb-3">
                                            <label class="form-label">Destinasi Wisata</label>
                                            <select class="form-select" id="destination" required onchange="updateDestinationDetails()">
                                                <option value="">Pilih Destinasi</option>
                                                <!-- Options will be loaded from products -->
                                            </select>
                                        </div>
                                        <div class="mb-3">
                                            <label class="form-label">Harga</label>
                                            <input type="number" class="form-control" id="ticketPrice" required>
                                        </div>
                                        <div class="mb-3">
                                            <label class="form-label">Jumlah Karcis</label>
                                            <input type="number" class="form-control" id="ticketQuantity" min="1" value="1" required>
                                        </div>
                                        <div class="mb-3">
                                            <label class="form-label">Tanggal Berlaku</label>
                                            <input type="date" class="form-control" id="validDate" required>
                                        </div>
                                        <div class="mb-3 form-check">
                                            <input type="checkbox" class="form-check-input" id="includeTax">
                                            <label class="form-check-label" for="includeTax">Termasuk Pajak</label>
                                        </div>
                                        <button type="submit" class="btn btn-primary w-100" onclick="saveTicket(event)">
                                            <i class="fas fa-save me-1"></i> Simpan Karcis
                                        </button>
                                    </form>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="card">
                                <div class="card-header">
                                    <h5 class="card-title mb-0">Preview Karcis</h5>
                                </div>
                                <div class="card-body">
                                    <div class="ticket-preview text-center" id="ticketPreview">
                                        <h4 id="previewDestination">Taman Wisata Alam</h4>
                                        <p id="previewAddress">Jl. Raya Wisata No. 123, Kota Pariwisata</p>
                                        <hr>
                                        <div class="barcode-container">
                                            <svg id="barcode"></svg>
                                        </div>
                                        <div class="d-flex justify-content-between">
                                            <div class="text-start">
                                                <small class="text-muted">Jenis</small>
                                                <p class="mb-0 fw-bold" id="previewType">Reguler</p>
                                            </div>
                                            <div class="text-end">
                                                <small class="text-muted">Kode</small>
                                                <p class="mb-0 fw-bold" id="previewCode">TWA-001</p>
                                            </div>
                                        </div>
                                        <hr>
                                        <div class="d-flex justify-content-between">
                                            <div class="text-start">
                                                <small class="text-muted">Tanggal</small>
                                                <p class="mb-0 fw-bold" id="previewDate">10 Jun 2023</p>
                                            </div>
                                            <div class="text-end">
                                                <small class="text-muted">Harga</small>
                                                <p class="mb-0 fw-bold" id="previewPrice">Rp50.000</p>
                                            </div>
                                        </div>
                                        <div class="mt-3">
                                            <small class="text-muted">Status</small>
                                            <p class="mb-0 fw-bold text-success" id="previewStatus">Belum Digunakan</p>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Ticket List Section -->
                <div id="ticket-list-section" style="display: none;">
                    <div class="d-flex justify-content-between align-items-center mb-4">
                        <h3>Daftar Karcis</h3>
                        <div>
                            <button class="btn btn-primary me-2" onclick="exportTickets()">
                                <i class="fas fa-file-export me-1"></i> Export
                            </button>
                            <button class="btn btn-success" onclick="showImportModal()">
                                <i class="fas fa-file-import me-1"></i> Import
                            </button>
                        </div>
                    </div>

                    <div class="card">
                        <div class="card-header">
                            <div class="d-flex justify-content-between align-items-center">
                                <h5 class="card-title mb-0">Daftar Karcis</h5>
                                <div class="d-flex">
                                    <div class="search-box me-2">
                                        <i class="fas fa-search"></i>
                                        <input type="text" class="form-control form-control-sm" placeholder="Cari karcis..." id="ticketSearch" onkeyup="searchTickets()">
                                    </div>
                                    <select class="form-select form-select-sm" style="width: 150px;" id="ticketFilter" onchange="filterTickets()">
                                        <option value="all">Semua Status</option>
                                        <option value="valid">Valid</option>
                                        <option value="used">Digunakan</option>
                                        <option value="expired">Kadaluarsa</option>
                                    </select>
                                </div>
                            </div>
                        </div>
                        <div class="card-body">
                            <div class="table-responsive">
                                <table class="table table-hover">
                                    <thead>
                                        <tr>
                                            <th>Kode</th>
                                            <th>Destinasi</th>
                                            <th>Jenis</th>
                                            <th>Harga</th>
                                            <th>Tanggal</th>
                                            <th>Status</th>
                                            <th>Aksi</th>
                                        </tr>
                                    </thead>
                                    <tbody id="ticketTableBody">
                                        <!-- Tickets will be loaded here -->
                                    </tbody>
                                </table>
                            </div>
                            <nav aria-label="Page navigation" class="mt-3">
                                <ul class="pagination justify-content-center">
                                    <li class="page-item disabled">
                                        <a class="page-link" href="#" tabindex="-1">Previous</a>
                                    </li>
                                    <li class="page-item active"><a class="page-link" href="#">1</a></li>
                                    <li class="page-item"><a class="page-link" href="#">2</a></li>
                                    <li class="page-item"><a class="page-link" href="#">3</a></li>
                                    <li class="page-item">
                                        <a class="page-link" href="#">Next</a>
                                    </li>
                                </ul>
                            </nav>
                        </div>
                    </div>
                </div>

                <!-- Reports Section -->
                <div id="reports-section" style="display: none;">
                    <div class="d-flex justify-content-between align-items-center mb-4">
                        <h3>Laporan</h3>
                        <div>
                            <button class="btn btn-primary me-2" onclick="generateDailyReport()">
                                <i class="fas fa-file-pdf me-1"></i> Cetak Laporan
                            </button>
                            <button class="btn btn-success" onclick="exportReportData()">
                                <i class="fas fa-file-excel me-1"></i> Export Data
                            </button>
                        </div>
                    </div>

                    <div class="card">
                        <div class="card-header">
                            <h5 class="card-title mb-0">Filter Laporan</h5>
                        </div>
                        <div class="card-body">
                            <div class="row">
                                <div class="col-md-3">
                                    <div class="mb-3">
                                        <label class="form-label">Tanggal Mulai</label>
                                        <input type="date" class="form-control" id="reportStartDate">
                                    </div>
                                </div>
                                <div class="col-md-3">
                                    <div class="mb-3">
                                        <label class="form-label">Tanggal Akhir</label>
                                        <input type="date" class="form-control" id="reportEndDate">
                                    </div>
                                </div>
                                <div class="col-md-3">
                                    <div class="mb-3">
                                        <label class="form-label">Jenis Karcis</label>
                                        <select class="form-select" id="reportTicketType">
                                            <option value="all">Semua Jenis</option>
                                            <option value="regular">Reguler</option>
                                            <option value="vip">VIP</option>
                                            <option value="group">Grup</option>
                                            <option value="student">Pelajar/Mahasiswa</option>
                                            <option value="foreigner">Warga Asing</option>
                                        </select>
                                    </div>
                                </div>
                                <div class="col-md-3">
                                    <div class="mb-3">
                                        <label class="form-label">Destinasi</label>
                                        <select class="form-select" id="reportDestination">
                                            <option value="all">Semua Destinasi</option>
                                            <!-- Options will be loaded from products -->
                                        </select>
                                    </div>
                                </div>
                            </div>
                            <button class="btn btn-primary" onclick="loadReportData()">
                                <i class="fas fa-filter me-1"></i> Filter Data
                            </button>
                        </div>
                    </div>

                    <div class="card mt-4">
                        <div class="card-header">
                            <h5 class="card-title mb-0">Statistik Penjualan</h5>
                        </div>
                        <div class="card-body">
                            <canvas id="reportChart" height="300"></canvas>
                        </div>
                    </div>

                    <div class="card mt-4">
                        <div class="card-header">
                            <h5 class="card-title mb-0">Detail Transaksi</h5>
                        </div>
                        <div class="card-body">
                            <div class="table-responsive">
                                <table class="table table-hover">
                                    <thead>
                                        <tr>
                                            <th>ID Transaksi</th>
                                            <th>Tanggal</th>
                                            <th>Karcis</th>
                                            <th>Jumlah</th>
                                            <th>Harga</th>
                                            <th>Total</th>
                                            <th>Kasir</th>
                                        </tr>
                                    </thead>
                                    <tbody id="reportTableBody">
                                        <!-- Report data will be loaded here -->
                                    </tbody>
                                </table>
                            </div>
                            <nav aria-label="Page navigation" class="mt-3">
                                <ul class="pagination justify-content-center">
                                    <li class="page-item disabled">
                                        <a class="page-link" href="#" tabindex="-1">Previous</a>
                                    </li>
                                    <li class="page-item active"><a class="page-link" href="#">1</a></li>
                                    <li class="page-item"><a class="page-link" href="#">2</a></li>
                                    <li class="page-item"><a class="page-link" href="#">3</a></li>
                                    <li class="page-item">
                                        <a class="page-link" href="#">Next</a>
                                    </li>
                                </ul>
                            </nav>
                        </div>
                    </div>
                </div>

                <!-- Products Section -->
                <div id="products-section" style="display: none;">
                    <div class="d-flex justify-content-between align-items-center mb-4">
                        <h3>Produk Wisata</h3>
                        <button class="btn btn-primary" onclick="showAddProductModal()">
                            <i class="fas fa-plus me-1"></i> Tambah Produk
                        </button>
                    </div>

                    <div class="card">
                        <div class="card-header">
                            <div class="d-flex justify-content-between align-items-center">
                                <h5 class="card-title mb-0">Daftar Produk Wisata</h5>
                                <div class="search-box">
                                    <i class="fas fa-search"></i>
                                    <input type="text" class="form-control form-control-sm" placeholder="Cari produk..." id="productSearch" onkeyup="searchProducts()">
                                </div>
                            </div>
                        </div>
                        <div class="card-body">
                            <div class="table-responsive">
                                <table class="table table-hover">
                                    <thead>
                                        <tr>
                                            <th>Kode</th>
                                            <th>Nama</th>
                                            <th>Lokasi</th>
                                            <th>Harga Reguler</th>
                                            <th>Status</th>
                                            <th>Aksi</th>
                                        </tr>
                                    </thead>
                                    <tbody id="productTableBody">
                                        <!-- Products will be loaded here -->
                                    </tbody>
                                </table>
                            </div>
                            <nav aria-label="Page navigation" class="mt-3">
                                <ul class="pagination justify-content-center">
                                    <li class="page-item disabled">
                                        <a class="page-link" href="#" tabindex="-1">Previous</a>
                                    </li>
                                    <li class="page-item active"><a class="page-link" href="#">1</a></li>
                                    <li class="page-item"><a class="page-link" href="#">2</a></li>
                                    <li class="page-item"><a class="page-link" href="#">3</a></li>
                                    <li class="page-item">
                                        <a class="page-link" href="#">Next</a>
                                    </li>
                                </ul>
                            </nav>
                        </div>
                    </div>
                </div>

                <!-- Users Section -->
                <div id="users-section" style="display: none;">
                    <div class="d-flex justify-content-between align-items-center mb-4">
                        <h3>Manajemen Pengguna</h3>
                        <button class="btn btn-primary" onclick="showAddUserModal()">
                            <i class="fas fa-plus me-1"></i> Tambah Pengguna
                        </button>
                    </div>

                    <div class="card">
                        <div class="card-header">
                            <div class="d-flex justify-content-between align-items-center">
                                <h5 class="card-title mb-0">Daftar Pengguna</h5>
                                <div class="search-box">
                                    <i class="fas fa-search"></i>
                                    <input type="text" class="form-control form-control-sm" placeholder="Cari pengguna..." id="userSearch" onkeyup="searchUsers()">
                                </div>
                            </div>
                        </div>
                        <div class="card-body">
                            <div class="table-responsive">
                                <table class="table table-hover">
                                    <thead>
                                        <tr>
                                            <th>Nama</th>
                                            <th>Username</th>
                                            <th>Role</th>
                                            <th>Status</th>
                                            <th>Terakhir Login</th>
                                            <th>Aksi</th>
                                        </tr>
                                    </thead>
                                    <tbody id="userTableBody">
                                        <!-- Users will be loaded here -->
                                    </tbody>
                                </table>
                            </div>
                            <nav aria-label="Page navigation" class="mt-3">
                                <ul class="pagination justify-content-center">
                                    <li class="page-item disabled">
                                        <a class="page-link" href="#" tabindex="-1">Previous</a>
                                    </li>
                                    <li class="page-item active"><a class="page-link" href="#">1</a></li>
                                    <li class="page-item"><a class="page-link" href="#">2</a></li>
                                    <li class="page-item"><a class="page-link" href="#">3</a></li>
                                    <li class="page-item">
                                        <a class="page-link" href="#">Next</a>
                                    </li>
                                </ul>
                            </nav>
                        </div>
                    </div>
                </div>

                <!-- Settings Section -->
                <div id="settings-section" style="display: none;">
                    <div class="d-flex justify-content-between align-items-center mb-4">
                        <h3>Pengaturan Sistem</h3>
                        <button class="btn btn-primary" onclick="saveSettings()">
                            <i class="fas fa-save me-1"></i> Simpan Pengaturan
                        </button>
                    </div>

                    <div class="row">
                        <div class="col-md-6">
                            <div class="card">
                                <div class="card-header">
                                    <h5 class="card-title mb-0">Pengaturan Umum</h5>
                                </div>
                                <div class="card-body">
                                    <form id="generalSettingsForm">
                                        <div class="mb-3">
                                            <label class="form-label">Nama Aplikasi</label>
                                            <input type="text" class="form-control" id="appName" value="TourTick">
                                        </div>
                                        <div class="mb-3">
                                            <label class="form-label">Timezone</label>
                                            <select class="form-select" id="timezone">
                                                <option value="Asia/Jakarta">WIB (Asia/Jakarta)</option>
                                                <option value="Asia/Makassar">WITA (Asia/Makassar)</option>
                                                <option value="Asia/Jayapura">WIT (Asia/Jayapura)</option>
                                            </select>
                                        </div>
                                        <div class="mb-3 form-check">
                                            <input type="checkbox" class="form-check-input" id="enableTax">
                                            <label class="form-check-label" for="enableTax">Aktifkan Pajak</label>
                                        </div>
                                        <div class="mb-3" id="taxRateContainer" style="display: none;">
                                            <label class="form-label">Persentase Pajak (%)</label>
                                            <input type="number" class="form-control" id="taxRate" value="10" min="0" max="100">
                                        </div>
                                    </form>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="card">
                                <div class="card-header">
                                    <h5 class="card-title mb-0">Pengaturan Cetak</h5>
                                </div>
                                <div class="card-body">
                                    <form id="printSettingsForm">
                                        <div class="mb-3">
                                            <label class="form-label">Header Struk</label>
                                            <textarea class="form-control" id="receiptHeader" rows="2">Terima kasih telah berkunjung</textarea>
                                        </div>
                                        <div class="mb-3">
                                            <label class="form-label">Footer Struk</label>
                                            <textarea class="form-control" id="receiptFooter" rows="2">Barang yang sudah dibeli tidak dapat dikembalikan</textarea>
                                        </div>
                                        <div class="mb-3 form-check">
                                            <input type="checkbox" class="form-check-input" id="printLogo" checked>
                                            <label class="form-check-label" for="printLogo">Cetak Logo pada Struk</label>
                                        </div>
                                        <div class="mb-3 form-check">
                                            <input type="checkbox" class="form-check-input" id="printAddress" checked>
                                            <label class="form-check-label" for="printAddress">Cetak Alamat pada Struk</label>
                                        </div>
                                    </form>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="card mt-4">
                        <div class="card-header">
                            <h5 class="card-title mb-0">Preview Struk</h5>
                        </div>
                        <div class="card-body">
                            <div class="receipt" id="receiptPreview">
                                <div class="header">
                                    <img src="https://raw.githubusercontent.com/LKS-88/anekamarket/refs/heads/main/Logo-Anekamarketku.png" alt="TourTick Logo" style="max-width: 100px; margin-bottom: 10px;">
                                    <h5 id="previewReceiptTitle">TourTick</h5>
                                    <small id="previewReceiptAddress">Jl. Raya Wisata No. 123, Kota Pariwisata</small>
                                </div>
                                <div class="divider"></div>
                                <div class="item">
                                    <span>Karcis Reguler</span>
                                    <span>Rp50.000</span>
                                </div>
                                <div class="item">
                                    <span>Karcis Pelajar</span>
                                    <span>Rp30.000</span>
                                </div>
                                <div class="divider"></div>
                                <div class="item">
                                    <span>Subtotal</span>
                                    <span>Rp80.000</span>
                                </div>
                                <div class="item">
                                    <span>Pajak (10%)</span>
                                    <span>Rp8.000</span>
                                </div>
                                <div class="item fw-bold">
                                    <span>Total</span>
                                    <span>Rp88.000</span>
                                </div>
                                <div class="divider"></div>
                                <div class="receipt-barcode">
                                    <svg id="receiptBarcode"></svg>
                                </div>
                                <div class="footer">
                                    <p id="previewReceiptFooter">Terima kasih telah berkunjung</p>
                                    <small>12 Jun 2023 14:30:45</small>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Role Permissions Section -->
                    <div class="card mt-4">
                        <div class="card-header">
                            <h5 class="card-title mb-0">Pengaturan Hak Akses Role</h5>
                        </div>
                        <div class="card-body">
                            <div class="alert alert-warning">
                                <i class="fas fa-exclamation-triangle me-2"></i>
                                <strong>Perhatian!</strong> Masukkan password admin untuk mengubah pengaturan hak akses.
                            </div>
                            <div class="mb-3">
                                <label class="form-label">Password Admin</label>
                                <input type="password" class="form-control" id="adminPasswordForPermissions" placeholder="Masukkan password admin">
                            </div>
                            <div class="mb-3">
                                <label class="form-label">Pilih Role</label>
                                <select class="form-select" id="roleSelector" onchange="loadRolePermissions()">
                                    <option value="admin">Admin</option>
                                    <option value="manager">Manager</option>
                                    <option value="cashier">Kasir</option>
                                    <option value="operator">Operator</option>
                                </select>
                            </div>
                            <div id="permissionsContainer">
                                <div class="permission-group">
                                    <h6>Hak Akses Menu</h6>
                                    <div class="permission-item">
                                        <input type="checkbox" class="permission-checkbox" id="permDashboard" checked disabled>
                                        <label for="permDashboard">Dashboard</label>
                                    </div>
                                    <div class="permission-item">
                                        <input type="checkbox" class="permission-checkbox" id="permTicketSales">
                                        <label for="permTicketSales">Penjualan Karcis</label>
                                    </div>
                                    <div class="permission-item">
                                        <input type="checkbox" class="permission-checkbox" id="permGenerateTicket">
                                        <label for="permGenerateTicket">Generate Karcis</label>
                                    </div>
                                    <div class="permission-item">
                                        <input type="checkbox" class="permission-checkbox" id="permTicketList">
                                        <label for="permTicketList">Daftar Karcis</label>
                                    </div>
                                    <div class="permission-item">
                                        <input type="checkbox" class="permission-checkbox" id="permReports">
                                        <label for="permReports">Laporan</label>
                                    </div>
                                    <div class="permission-item">
                                        <input type="checkbox" class="permission-checkbox" id="permProducts">
                                        <label for="permProducts">Produk Wisata</label>
                                    </div>
                                    <div class="permission-item">
                                        <input type="checkbox" class="permission-checkbox" id="permUsers">
                                        <label for="permUsers">Pengguna</label>
                                    </div>
                                    <div class="permission-item">
                                        <input type="checkbox" class="permission-checkbox" id="permSettings">
                                        <label for="permSettings">Pengaturan</label>
                                    </div>
                                    <div class="permission-item">
                                        <input type="checkbox" class="permission-checkbox" id="permBackup">
                                        <label for="permBackup">Backup Data</label>
                                    </div>
                                </div>
                                
                                <div class="permission-group mt-3">
                                    <h6>Hak Akses Fitur</h6>
                                    <div class="permission-item">
                                        <input type="checkbox" class="permission-checkbox" id="permRestore">
                                        <label for="permRestore">Restore Data</label>
                                    </div>
                                    <div class="permission-item">
                                        <input type="checkbox" class="permission-checkbox" id="permReset">
                                        <label for="permReset">Reset Data</label>
                                    </div>
                                    <div class="permission-item">
                                        <input type="checkbox" class="permission-checkbox" id="permDeleteTicket">
                                        <label for="permDeleteTicket">Hapus Karcis</label>
                                    </div>
                                    <div class="permission-item">
                                        <input type="checkbox" class="permission-checkbox" id="permDeleteProduct">
                                        <label for="permDeleteProduct">Hapus Produk</label>
                                    </div>
                                    <div class="permission-item">
                                        <input type="checkbox" class="permission-checkbox" id="permDeleteUser">
                                        <label for="permDeleteUser">Hapus Pengguna</label>
                                    </div>
                                </div>
                                
                                <button class="btn btn-primary mt-3" onclick="saveRolePermissions()">
                                    <i class="fas fa-save me-1"></i> Simpan Hak Akses
                                </button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Backup Section -->
                <div id="backup-section" style="display: none;">
                    <div class="d-flex justify-content-between align-items-center mb-4">
                        <h3>Backup & Restore Data</h3>
                        <div id="adminBackupButtons">
                            <button class="btn btn-danger me-2" onclick="showResetConfirmation()">
                                <i class="fas fa-trash-restore me-1"></i> Reset Data
                            </button>
                            <button class="btn btn-warning me-2" onclick="showRestoreModal()">
                                <i class="fas fa-upload me-1"></i> Restore Data
                            </button>
                            <button class="btn btn-primary" onclick="backupData()">
                                <i class="fas fa-download me-1"></i> Backup Data
                            </button>
                        </div>
                    </div>

                    <div class="row">
                        <div class="col-md-4">
                            <div class="card backup-card text-center p-4" onclick="backupData()">
                                <i class="fas fa-download backup-icon text-primary"></i>
                                <h5>Backup Data</h5>
                                <p class="text-muted">Simpan semua data ke file JSON</p>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="card backup-card text-center p-4" onclick="showRestoreModal()" id="restoreCard">
                                <i class="fas fa-upload backup-icon text-warning"></i>
                                <h5>Restore Data</h5>
                                <p class="text-muted">Muat data dari file backup</p>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="card backup-card text-center p-4" onclick="showResetConfirmation()" id="resetCard">
                                <i class="fas fa-trash-restore backup-icon text-danger"></i>
                                <h5>Reset Data</h5>
                                <p class="text-muted">Kembalikan ke data awal</p>
                            </div>
                        </div>
                    </div>

                    <div class="card mt-4">
                        <div class="card-header">
                            <h5 class="card-title mb-0">Riwayat Backup</h5>
                        </div>
                        <div class="card-body">
                            <div class="table-responsive">
                                <table class="table table-hover">
                                    <thead>
                                        <tr>
                                            <th>Tanggal</th>
                                            <th>Jenis</th>
                                            <th>Ukuran</th>
                                            <th>Oleh</th>
                                            <th>Aksi</th>
                                        </tr>
                                    </thead>
                                    <tbody id="backupHistoryTable">
                                        <!-- Backup history will be loaded here -->
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>

                    <div class="app-footer mt-4">
                        <p>&copy; 2025 Lentera Karya Situbondo. All rights reserved.</p>
                        <p>
                            <a href="https://www.anekamarket.my.id" target="_blank">www.anekamarket.my.id</a> | 
                            <a href="mailto:admin@anekamarket.my.id">admin@anekamarket.my.id</a>
                        </p>
                    </div>
                </div>

                <!-- Access Denied Section -->
                <div id="access-denied-section" style="display: none;">
                    <div class="access-denied">
                        <i class="fas fa-ban"></i>
                        <h3>Akses Ditolak</h3>
                        <p>Anda tidak memiliki izin untuk mengakses halaman ini.</p>
                        <button class="btn btn-primary" onclick="showSection('dashboard')">
                            <i class="fas fa-home me-1"></i> Kembali ke Dashboard
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Add Product Modal -->
    <div class="modal fade" id="addProductModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Tambah Produk Wisata</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <form id="addProductForm">
                        <div class="mb-3">
                            <label class="form-label">Kode Produk</label>
                            <input type="text" class="form-control" id="productCode" required>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Nama Produk</label>
                            <input type="text" class="form-control" id="productName" required>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Lokasi</label>
                            <textarea class="form-control" id="productLocation" rows="2" required></textarea>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Deskripsi</label>
                            <textarea class="form-control" id="productDescription" rows="3"></textarea>
                        </div>
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label class="form-label">Harga Reguler</label>
                                    <input type="number" class="form-control" id="productRegularPrice" required>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label class="form-label">Harga VIP</label>
                                    <input type="number" class="form-control" id="productVipPrice">
                                </div>
                            </div>
                        </div>
                        <div class="mb-3 form-check">
                            <input type="checkbox" class="form-check-input" id="productStatus" checked>
                            <label class="form-check-label" for="productStatus">Aktif</label>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Batal</button>
                    <button type="button" class="btn btn-primary" onclick="saveProduct()">Simpan</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Add User Modal -->
    <div class="modal fade" id="addUserModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Tambah Pengguna</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <form id="addUserForm">
                        <div class="mb-3">
                            <label class="form-label">Nama Lengkap</label>
                            <input type="text" class="form-control" id="userFullName" required>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Username</label>
                            <input type="text" class="form-control" id="userUsername" required>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Password</label>
                            <input type="password" class="form-control" id="userPassword" required>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Role</label>
                            <select class="form-select" id="userRole" required>
                                <option value="admin">Admin</option>
                                <option value="cashier">Kasir</option>
                                <option value="operator">Operator</option>
                                <option value="manager">Manager</option>
                            </select>
                        </div>
                        <div class="mb-3 form-check">
                            <input type="checkbox" class="form-check-input" id="userStatus" checked>
                            <label class="form-check-label" for="userStatus">Aktif</label>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Batal</button>
                    <button type="button" class="btn btn-primary" onclick="saveUser()">Simpan</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Import Tickets Modal -->
    <div class="modal fade" id="importTicketsModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Import Karcis</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-3">
                        <label class="form-label">Pilih File Excel (.xlsx)</label>
                        <input type="file" class="form-control" id="ticketImportFile" accept=".xlsx">
                    </div>
                    <div class="alert alert-info">
                        <i class="fas fa-info-circle me-2"></i>
                        Pastikan format file sesuai dengan template yang disediakan.
                        <a href="#" onclick="downloadImportTemplate()">Download template</a>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Batal</button>
                    <button type="button" class="btn btn-primary" onclick="importTickets()">Import</button>
                </div>
            </div>
        </div>
    </div>

    <!-- View Ticket Modal -->
    <div class="modal fade" id="viewTicketModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Detail Karcis</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div class="ticket-preview text-center">
                        <h4 id="viewTicketDestination">Taman Wisata Alam</h4>
                        <p id="viewTicketAddress">Jl. Raya Wisata No. 123, Kota Pariwisata</p>
                        <hr>
                        <div class="barcode-container">
                            <svg id="viewTicketBarcode"></svg>
                        </div>
                        <div class="d-flex justify-content-between">
                            <div class="text-start">
                                <small class="text-muted">Jenis</small>
                                <p class="mb-0 fw-bold" id="viewTicketType">Reguler</p>
                            </div>
                            <div class="text-end">
                                <small class="text-muted">Kode</small>
                                <p class="mb-0 fw-bold" id="viewTicketCode">TWA-001</p>
                            </div>
                        </div>
                        <hr>
                        <div class="d-flex justify-content-between">
                            <div class="text-start">
                                <small class="text-muted">Tanggal</small>
                                <p class="mb-0 fw-bold" id="viewTicketDate">10 Jun 2023</p>
                            </div>
                            <div class="text-end">
                                <small class="text-muted">Harga</small>
                                <p class="mb-0 fw-bold" id="viewTicketPrice">Rp50.000</p>
                            </div>
                        </div>
                        <div class="mt-3">
                            <small class="text-muted">Status</small>
                            <p class="mb-0 fw-bold text-success" id="viewTicketStatus">Belum Digunakan</p>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Tutup</button>
                    <button type="button" class="btn btn-primary" onclick="printSingleTicket()">
                        <i class="fas fa-print me-1"></i> Cetak
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Restore Data Modal -->
    <div class="modal fade" id="restoreModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Restore Data</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-3">
                        <label class="form-label">Pilih File Backup (.json)</label>
                        <input type="file" class="form-control" id="restoreFile" accept=".json">
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Password Admin</label>
                        <input type="password" class="form-control" id="adminPassword" placeholder="Masukkan password admin">
                    </div>
                    <div class="alert alert-warning">
                        <i class="fas fa-exclamation-triangle me-2"></i>
                        <strong>Peringatan!</strong> Restore data akan menggantikan semua data saat ini dengan data dari file backup.
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Batal</button>
                    <button type="button" class="btn btn-primary" onclick="restoreData()">Restore Data</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Reset Confirmation Modal -->
    <div class="modal fade" id="resetConfirmationModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Konfirmasi Reset Data</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-3">
                        <label class="form-label">Password Admin</label>
                        <input type="password" class="form-control" id="resetAdminPassword" placeholder="Masukkan password admin">
                    </div>
                    <div class="alert alert-danger">
                        <i class="fas fa-exclamation-triangle me-2"></i>
                        <strong>Peringatan!</strong> Ini akan menghapus semua data dan mengembalikan ke pengaturan awal. Tindakan ini tidak dapat dibatalkan!
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Batal</button>
                    <button type="button" class="btn btn-danger" onclick="resetData()">Reset Data</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Loading Modal -->
    <div class="modal fade" id="loadingModal" tabindex="-1" aria-hidden="true" data-bs-backdrop="static" data-bs-keyboard="false">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content border-0 bg-transparent">
                <div class="modal-body text-center">
                    <div class="loading-spinner text-primary" style="width: 3rem; height: 3rem;"></div>
                    <p class="mt-3">Memproses...</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Bootstrap JS Bundle with Popper -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    
    <!-- Custom JavaScript -->
    <script>
        // Global variables
        let currentUser = null;
        let tickets = [];
        let products = [];
        let users = [];
        let transactions = [];
        let cart = [];
        let backupHistory = [];
        
        // Permission structure
        const PERMISSIONS = {
            // Menu permissions
            MENU_DASHBOARD: 'dashboard',
            MENU_TICKET_SALES: 'ticket-sales',
            MENU_GENERATE_TICKET: 'generate-ticket',
            MENU_TICKET_LIST: 'ticket-list',
            MENU_REPORTS: 'reports',
            MENU_PRODUCTS: 'products',
            MENU_USERS: 'users',
            MENU_SETTINGS: 'settings',
            MENU_BACKUP: 'backup',
            
            // Feature permissions
            FEATURE_CREATE_TICKET: 'create-ticket',
            FEATURE_DELETE_TICKET: 'delete-ticket',
            FEATURE_IMPORT_TICKET: 'import-ticket',
            FEATURE_EXPORT_TICKET: 'export-ticket',
            FEATURE_CREATE_PRODUCT: 'create-product',
            FEATURE_EDIT_PRODUCT: 'edit-product',
            FEATURE_DELETE_PRODUCT: 'delete-product',
            FEATURE_CREATE_USER: 'create-user',
            FEATURE_EDIT_USER: 'edit-user',
            FEATURE_DELETE_USER: 'delete-user',
            FEATURE_BACKUP: 'backup',
            FEATURE_RESTORE: 'restore',
            FEATURE_RESET: 'reset',
            FEATURE_UPDATE_SETTINGS: 'update-settings',
            FEATURE_MANAGE_PERMISSIONS: 'manage-permissions'
        };
        
        // Default role permissions
        const DEFAULT_ROLE_PERMISSIONS = {
            admin: {
                // Menu permissions
                [PERMISSIONS.MENU_DASHBOARD]: true,
                [PERMISSIONS.MENU_TICKET_SALES]: true,
                [PERMISSIONS.MENU_GENERATE_TICKET]: true,
                [PERMISSIONS.MENU_TICKET_LIST]: true,
                [PERMISSIONS.MENU_REPORTS]: true,
                [PERMISSIONS.MENU_PRODUCTS]: true,
                [PERMISSIONS.MENU_USERS]: true,
                [PERMISSIONS.MENU_SETTINGS]: true,
                [PERMISSIONS.MENU_BACKUP]: true,
                
                // Feature permissions
                [PERMISSIONS.FEATURE_CREATE_TICKET]: true,
                [PERMISSIONS.FEATURE_DELETE_TICKET]: true,
                [PERMISSIONS.FEATURE_IMPORT_TICKET]: true,
                [PERMISSIONS.FEATURE_EXPORT_TICKET]: true,
                [PERMISSIONS.FEATURE_CREATE_PRODUCT]: true,
                [PERMISSIONS.FEATURE_EDIT_PRODUCT]: true,
                [PERMISSIONS.FEATURE_DELETE_PRODUCT]: true,
                [PERMISSIONS.FEATURE_CREATE_USER]: true,
                [PERMISSIONS.FEATURE_EDIT_USER]: true,
                [PERMISSIONS.FEATURE_DELETE_USER]: true,
                [PERMISSIONS.FEATURE_BACKUP]: true,
                [PERMISSIONS.FEATURE_RESTORE]: true,
                [PERMISSIONS.FEATURE_RESET]: true,
                [PERMISSIONS.FEATURE_UPDATE_SETTINGS]: true,
                [PERMISSIONS.FEATURE_MANAGE_PERMISSIONS]: true
            },
            manager: {
                // Menu permissions
                [PERMISSIONS.MENU_DASHBOARD]: true,
                [PERMISSIONS.MENU_TICKET_SALES]: true,
                [PERMISSIONS.MENU_GENERATE_TICKET]: true,
                [PERMISSIONS.MENU_TICKET_LIST]: true,
                [PERMISSIONS.MENU_REPORTS]: true,
                [PERMISSIONS.MENU_PRODUCTS]: true,
                [PERMISSIONS.MENU_USERS]: false,
                [PERMISSIONS.MENU_SETTINGS]: true,
                [PERMISSIONS.MENU_BACKUP]: true,
                
                // Feature permissions
                [PERMISSIONS.FEATURE_CREATE_TICKET]: true,
                [PERMISSIONS.FEATURE_DELETE_TICKET]: true,
                [PERMISSIONS.FEATURE_IMPORT_TICKET]: true,
                [PERMISSIONS.FEATURE_EXPORT_TICKET]: true,
                [PERMISSIONS.FEATURE_CREATE_PRODUCT]: true,
                [PERMISSIONS.FEATURE_EDIT_PRODUCT]: true,
                [PERMISSIONS.FEATURE_DELETE_PRODUCT]: true,
                [PERMISSIONS.FEATURE_CREATE_USER]: false,
                [PERMISSIONS.FEATURE_EDIT_USER]: false,
                [PERMISSIONS.FEATURE_DELETE_USER]: false,
                [PERMISSIONS.FEATURE_BACKUP]: true,
                [PERMISSIONS.FEATURE_RESTORE]: false,
                [PERMISSIONS.FEATURE_RESET]: false,
                [PERMISSIONS.FEATURE_UPDATE_SETTINGS]: true,
                [PERMISSIONS.FEATURE_MANAGE_PERMISSIONS]: false
            },
            cashier: {
                // Menu permissions
                [PERMISSIONS.MENU_DASHBOARD]: true,
                [PERMISSIONS.MENU_TICKET_SALES]: true,
                [PERMISSIONS.MENU_GENERATE_TICKET]: true,
                [PERMISSIONS.MENU_TICKET_LIST]: true,
                [PERMISSIONS.MENU_REPORTS]: false,
                [PERMISSIONS.MENU_PRODUCTS]: false,
                [PERMISSIONS.MENU_USERS]: false,
                [PERMISSIONS.MENU_SETTINGS]: false,
                [PERMISSIONS.MENU_BACKUP]: false,
                
                // Feature permissions
                [PERMISSIONS.FEATURE_CREATE_TICKET]: true,
                [PERMISSIONS.FEATURE_DELETE_TICKET]: false,
                [PERMISSIONS.FEATURE_IMPORT_TICKET]: false,
                [PERMISSIONS.FEATURE_EXPORT_TICKET]: false,
                [PERMISSIONS.FEATURE_CREATE_PRODUCT]: false,
                [PERMISSIONS.FEATURE_EDIT_PRODUCT]: false,
                [PERMISSIONS.FEATURE_DELETE_PRODUCT]: false,
                [PERMISSIONS.FEATURE_CREATE_USER]: false,
                [PERMISSIONS.FEATURE_EDIT_USER]: false,
                [PERMISSIONS.FEATURE_DELETE_USER]: false,
                [PERMISSIONS.FEATURE_BACKUP]: false,
                [PERMISSIONS.FEATURE_RESTORE]: false,
                [PERMISSIONS.FEATURE_RESET]: false,
                [PERMISSIONS.FEATURE_UPDATE_SETTINGS]: false,
                [PERMISSIONS.FEATURE_MANAGE_PERMISSIONS]: false
            },
            operator: {
                // Menu permissions
                [PERMISSIONS.MENU_DASHBOARD]: true,
                [PERMISSIONS.MENU_TICKET_SALES]: false,
                [PERMISSIONS.MENU_GENERATE_TICKET]: true,
                [PERMISSIONS.MENU_TICKET_LIST]: true,
                [PERMISSIONS.MENU_REPORTS]: false,
                [PERMISSIONS.MENU_PRODUCTS]: true,
                [PERMISSIONS.MENU_USERS]: false,
                [PERMISSIONS.MENU_SETTINGS]: false,
                [PERMISSIONS.MENU_BACKUP]: false,
                
                // Feature permissions
                [PERMISSIONS.FEATURE_CREATE_TICKET]: true,
                [PERMISSIONS.FEATURE_DELETE_TICKET]: false,
                [PERMISSIONS.FEATURE_IMPORT_TICKET]: false,
                [PERMISSIONS.FEATURE_EXPORT_TICKET]: false,
                [PERMISSIONS.FEATURE_CREATE_PRODUCT]: true,
                [PERMISSIONS.FEATURE_EDIT_PRODUCT]: true,
                [PERMISSIONS.FEATURE_DELETE_PRODUCT]: false,
                [PERMISSIONS.FEATURE_CREATE_USER]: false,
                [PERMISSIONS.FEATURE_EDIT_USER]: false,
                [PERMISSIONS.FEATURE_DELETE_USER]: false,
                [PERMISSIONS.FEATURE_BACKUP]: false,
                [PERMISSIONS.FEATURE_RESTORE]: false,
                [PERMISSIONS.FEATURE_RESET]: false,
                [PERMISSIONS.FEATURE_UPDATE_SETTINGS]: false,
                [PERMISSIONS.FEATURE_MANAGE_PERMISSIONS]: false
            }
        };
        
        // Initialize the application when DOM is loaded
        document.addEventListener('DOMContentLoaded', function() {
            // Initialize modals
            const loginModal = new bootstrap.Modal(document.getElementById('loginModal'), {backdrop: 'static'});
            loginModal.show();
            
            // Set today's date as default for ticket validity
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('validDate').value = today;
            document.getElementById('reportStartDate').value = today;
            document.getElementById('reportEndDate').value = today;
            
            // Load sample data
            loadSampleData();
            
            // Set up event listeners
            document.getElementById('loginForm').addEventListener('submit', handleLogin);
            document.getElementById('enableTax').addEventListener('change', function() {
                document.getElementById('taxRateContainer').style.display = this.checked ? 'block' : 'none';
            });
            
            // Generate initial barcode
            updateTicketCode();
            
            // Initialize receipt barcode
            JsBarcode('#receiptBarcode', 'TRX-123456', {
                format: 'CODE128',
                lineColor: '#000',
                width: 1,
                height: 30,
                displayValue: false
            });
        });
        
        // Sample data loading (for demo purposes)
        function loadSampleData() {
            // Sample products
            products = [
                {code: 'TWA', name: 'Taman Wisata Alam', location: 'Jl. Raya Wisata No. 123', regularPrice: 50000, vipPrice: 75000, status: 'active'},
                {code: 'MB', name: 'Museum Bahari', location: 'Jl. Pasar Ikan No. 1', regularPrice: 30000, vipPrice: 50000, status: 'active'},
                {code: 'KB', name: 'Kebun Binatang', location: 'Jl. Margasatwa No. 100', regularPrice: 40000, vipPrice: 60000, status: 'active'}
            ];
            
            // Populate destination dropdowns
            populateDestinationDropdowns();
            
            // Sample tickets
            tickets = [
                {code: 'TWA-001', type: 'regular', destination: 'Taman Wisata Alam', price: 50000, validDate: '2023-06-10', status: 'valid'},
                {code: 'MB-001', type: 'student', destination: 'Museum Bahari', price: 20000, validDate: '2023-06-11', status: 'valid'},
                {code: 'KB-001', type: 'vip', destination: 'Kebun Binatang', price: 60000, validDate: '2023-06-09', status: 'used'},
                {code: 'TWA-002', type: 'regular', destination: 'Taman Wisata Alam', price: 50000, validDate: '2023-06-08', status: 'expired'}
            ];
            
            // Sample users with permissions
            users = [
                {
                    fullName: 'Admin', 
                    username: 'admin', 
                    password: CryptoJS.SHA256('password').toString(), 
                    role: 'admin', 
                    lastLogin: '2023-06-10 14:30:00', 
                    status: 'active',
                    permissions: DEFAULT_ROLE_PERMISSIONS.admin
                },
                {
                    fullName: 'Kasir 1', 
                    username: 'kasir1', 
                    password: CryptoJS.SHA256('password').toString(), 
                    role: 'cashier', 
                    lastLogin: '2023-06-10 10:15:00', 
                    status: 'active',
                    permissions: DEFAULT_ROLE_PERMISSIONS.cashier
                },
                {
                    fullName: 'Manager', 
                    username: 'manager', 
                    password: CryptoJS.SHA256('password').toString(), 
                    role: 'manager', 
                    lastLogin: '2023-06-09 16:45:00', 
                    status: 'active',
                    permissions: DEFAULT_ROLE_PERMISSIONS.manager
                },
                {
                    fullName: 'Operator', 
                    username: 'operator', 
                    password: CryptoJS.SHA256('password').toString(), 
                    role: 'operator', 
                    lastLogin: '2023-06-09 09:20:00', 
                    status: 'active',
                    permissions: DEFAULT_ROLE_PERMISSIONS.operator
                }
            ];

            // Sample transactions
            transactions = [
                {id: generateTransactionId(), date: '2023-06-10 10:30:00', items: [{ticket: 'TWA-001', price: 50000}], total: 50000, cashier: 'Kasir 1', paymentMethod: 'cash', transactionCode: generateTransactionCode()},
                {id: generateTransactionId(), date: '2023-06-10 11:45:00', items: [{ticket: 'MB-001', price: 20000}, {ticket: 'KB-001', price: 60000}], total: 80000, cashier: 'Kasir 1', paymentMethod: 'cash', transactionCode: generateTransactionCode()},
                {id: generateTransactionId(), date: '2023-06-09 15:20:00', items: [{ticket: 'TWA-002', price: 50000}], total: 50000, cashier: 'Manager', paymentMethod: 'cash', transactionCode: generateTransactionCode()}
            ];

            // Sample backup history
            backupHistory = [
                {date: '2023-06-10 10:00:00', type: 'automatic', size: '15 KB', by: 'System'},
                {date: '2023-06-09 18:00:00', type: 'manual', size: '12 KB', by: 'Admin'}
            ];
            
            // Update dashboard
            refreshDashboard();
        }

        // Generate unique transaction ID with timestamp
        function generateTransactionId() {
            const now = new Date();
            const timestamp = now.getTime().toString();
            const random = Math.floor(Math.random() * 1000).toString().padStart(3, '0');
            return `TRX-${timestamp}-${random}`;
        }

        // Generate unique transaction code for barcode
        function generateTransactionCode() {
            const chars = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789';
            let result = '';
            for (let i = 0; i < 10; i++) {
                result += chars.charAt(Math.floor(Math.random() * chars.length));
            }
            return result;
        }
        
        // Populate destination dropdowns
        function populateDestinationDropdowns() {
            const destinationDropdowns = [
                document.getElementById('destination'),
                document.getElementById('reportDestination')
            ];
            
            destinationDropdowns.forEach(dropdown => {
                if (dropdown) {
                    dropdown.innerHTML = '<option value="">Pilih Destinasi</option>' + 
                        products.map(product => 
                            `<option value="${product.code}">${product.name}</option>`
                        ).join('');
                }
            });
        }
        
        // Handle login
        function handleLogin(e) {
            e.preventDefault();
            
            const username = document.getElementById('loginUsername').value;
            const password = document.getElementById('loginPassword').value;
            
            // Show loading
            const loadingModal = new bootstrap.Modal(document.getElementById('loadingModal'));
            loadingModal.show();
            
            // Simulate API call
            setTimeout(() => {
                const user = users.find(u => u.username === username);
                const hashedPassword = CryptoJS.SHA256(password).toString();
                
                if (user && user.password === hashedPassword) {
                    currentUser = user;
                    
                    // Update last login
                    const now = new Date();
                    user.lastLogin = now.toISOString().split('T')[0] + ' ' + now.toTimeString().split(' ')[0];
                    
                    // Hide login modal and show app
                    bootstrap.Modal.getInstance(document.getElementById('loginModal')).hide();
                    document.getElementById('appContainer').style.display = 'block';
                    
                    // Update user info in sidebar
                    document.getElementById('userName').textContent = user.fullName;
                    document.getElementById('userRole').textContent = 
                        user.role === 'admin' ? 'Super User' : 
                        user.role === 'cashier' ? 'Kasir' : 
                        user.role === 'manager' ? 'Manager' : 'Operator';
                    
                    // Update menu items based on permissions
                    updateMenuItems();
                    
                    // Close loading modal
                    loadingModal.hide();
                    
                    // Show dashboard by default
                    showSection('dashboard');
                } else {
                    loadingModal.hide();
                    alert('Login gagal. Username atau password salah.');
                }
            }, 1000);
        }
        
        // Check if user has permission
        function hasPermission(permission) {
            if (!currentUser) return false;
            return currentUser.permissions[permission] || false;
        }
        
        // Update menu items based on user permissions
        function updateMenuItems() {
            if (!currentUser) return;
            
            // Get all menu items
            const menuItems = document.querySelectorAll('#sidebarMenu .nav-link');
            
            // Hide all menu items first
            menuItems.forEach(item => {
                item.parentElement.style.display = 'none';
            });
            
            // Show menu items based on permissions
            menuItems.forEach(item => {
                const sectionId = item.getAttribute('onclick').match(/showSection\('(.+?)'\)/)[1];
                const permissionKey = `MENU_${sectionId.replace('-', '_').toUpperCase()}`;
                
                if (hasPermission(permissionKey)) {
                    item.parentElement.style.display = 'block';
                }
            });
            
            // Show/hide backup buttons based on permissions
            document.getElementById('adminBackupButtons').style.display = 
                hasPermission(PERMISSIONS.FEATURE_BACKUP) || 
                hasPermission(PERMISSIONS.FEATURE_RESTORE) || 
                hasPermission(PERMISSIONS.FEATURE_RESET) ? 'flex' : 'none';
                
            document.getElementById('restoreCard').style.display = 
                hasPermission(PERMISSIONS.FEATURE_RESTORE) ? 'block' : 'none';
                
            document.getElementById('resetCard').style.display = 
                hasPermission(PERMISSIONS.FEATURE_RESET) ? 'block' : 'none';
        }
        
        // Logout function
        function logout() {
            currentUser = null;
            document.getElementById('appContainer').style.display = 'none';
            document.getElementById('loginUsername').value = '';
            document.getElementById('loginPassword').value = '';
            
            // Show login modal
            const loginModal = new bootstrap.Modal(document.getElementById('loginModal'));
            loginModal.show();
        }
        
        // Show section function with permission check
        function showSection(sectionId) {
            // Hide all sections first
            document.querySelectorAll('[id$="-section"]').forEach(section => {
                section.style.display = 'none';
            });
            
            // Check permissions
            const permissionKey = `MENU_${sectionId.replace('-', '_').toUpperCase()}`;
            if (!currentUser || !hasPermission(permissionKey)) {
                document.getElementById('access-denied-section').style.display = 'block';
                return;
            }
            
            // Show the selected section
            document.getElementById(`${sectionId}-section`).style.display = 'block';
            
            // Update active menu item
            document.querySelectorAll('.sidebar .nav-link').forEach(link => {
                link.classList.remove('active');
            });
            
            // Find and activate the corresponding menu item
            const menuItem = document.querySelector(`.sidebar .nav-link[onclick="showSection('${sectionId}')"]`);
            if (menuItem) {
                menuItem.classList.add('active');
            }
            
            // Load section-specific data
            switch(sectionId) {
                case 'dashboard':
                    refreshDashboard();
                    break;
                case 'ticket-sales':
                    loadAvailableTickets();
                    break;
                case 'generate-ticket':
                    updateTicketCode();
                    break;
                case 'ticket-list':
                    loadTicketList();
                    break;
                case 'reports':
                    loadReportData();
                    break;
                case 'products':
                    loadProducts();
                    break;
                case 'users':
                    loadUsers();
                    break;
                case 'settings':
                    loadSettings();
                    break;
                case 'backup':
                    loadBackupHistory();
                    break;
            }
        }

        // Load settings
        function loadSettings() {
            // In a real app, this would load settings from database
            document.getElementById('enableTax').addEventListener('change', function() {
                document.getElementById('taxRateContainer').style.display = this.checked ? 'block' : 'none';
            });
            
            // Load role permissions
            loadRolePermissions();
        }
        
        // Refresh dashboard data
        function refreshDashboard() {
            // Update summary cards
            document.getElementById('todaySales').textContent = transactions.length;
            document.getElementById('todayRevenue').textContent = `Rp${transactions.reduce((sum, trx) => sum + trx.total, 0).toLocaleString()}`;
            document.getElementById('todayVisitors').textContent = tickets.filter(t => t.status === 'used').length;
            document.getElementById('availableTickets').textContent = tickets.filter(t => t.status === 'valid').length;
            
            // Load recent transactions
            const recentTransactions = document.getElementById('recentTransactions');
            recentTransactions.innerHTML = transactions.slice(0, 5).map(trx => `
                <tr>
                    <td>${trx.id}</td>
                    <td>${trx.date.split(' ')[0]}</td>
                    <td>${trx.items.length}</td>
                    <td>Rp${trx.total.toLocaleString()}</td>
                </tr>
            `).join('');
            
            // Load recent activities
            const recentActivities = document.getElementById('recentActivities');
            recentActivities.innerHTML = [
                {user: 'Admin', action: 'membuat 10 karcis baru', time: '2 menit lalu'},
                {user: 'Kasir 1', action: 'melakukan transaksi TRX004', time: '15 menit lalu'},
                {user: 'Manager', action: 'mengupdate harga produk', time: '1 jam lalu'},
                {user: 'Kasir 1', action: 'melakukan transaksi TRX003', time: '2 jam lalu'},
                {user: 'Admin', action: 'menambahkan pengguna baru', time: '5 jam lalu'}
            ].map(activity => `
                <div class="list-group-item">
                    <div class="d-flex justify-content-between">
                        <span><strong>${activity.user}</strong> ${activity.action}</span>
                        <small class="text-muted">${activity.time}</small>
                    </div>
                </div>
            `).join('');
            
            // Initialize charts
            initDashboardCharts();
        }
        
        // Initialize dashboard charts
        function initDashboardCharts() {
            // Sales chart
            const salesCtx = document.getElementById('salesChart').getContext('2d');
            const salesChart = new Chart(salesCtx, {
                type: 'line',
                data: {
                    labels: ['Sen', 'Sel', 'Rab', 'Kam', 'Jum', 'Sab', 'Min'],
                    datasets: [{
                        label: 'Penjualan',
                        data: [12, 19, 15, 22, 18, 25, 30],
                        backgroundColor: 'rgba(52, 152, 219, 0.2)',
                        borderColor: 'rgba(52, 152, 219, 1)',
                        borderWidth: 2,
                        tension: 0.4,
                        fill: true
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        legend: {
                            display: false
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true
                        }
                    }
                }
            });
            
            // Top products chart
            const topProductsCtx = document.getElementById('topProductsChart').getContext('2d');
            const topProductsChart = new Chart(topProductsCtx, {
                type: 'doughnut',
                data: {
                    labels: ['Taman Wisata', 'Museum', 'Kebun Binatang'],
                    datasets: [{
                        data: [45, 30, 25],
                        backgroundColor: [
                            'rgba(52, 152, 219, 0.7)',
                            'rgba(46, 204, 113, 0.7)',
                            'rgba(155, 89, 182, 0.7)'
                        ],
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        legend: {
                            position: 'bottom'
                        }
                    }
                }
            });
        }
        
        // Load available tickets for sales
        function loadAvailableTickets() {
            const availableTicketsTable = document.getElementById('availableTicketsTable');
            const validTickets = tickets.filter(t => t.status === 'valid');
            
            availableTicketsTable.innerHTML = validTickets.map(ticket => `
                <tr>
                    <td>${ticket.code}</td>
                    <td>${ticket.destination}</td>
                    <td>${ticket.type === 'regular' ? 'Reguler' : 
                         ticket.type === 'vip' ? 'VIP' : 
                         ticket.type === 'student' ? 'Pelajar' : 
                         ticket.type === 'foreigner' ? 'WNA' : 'Grup'}</td>
                    <td>Rp${ticket.price.toLocaleString()}</td>
                    <td>${new Date(ticket.validDate).toLocaleDateString('id-ID')}</td>
                    <td>
                        <button class="btn btn-sm btn-primary" onclick="addToCart('${ticket.code}')">
                            <i class="fas fa-plus"></i> Tambah
                        </button>
                    </td>
                </tr>
            `).join('');
        }
        
        // Add ticket to cart
        function addToCart(ticketCode) {
            if (!hasPermission(PERMISSIONS.FEATURE_CREATE_TICKET)) {
                alert('Anda tidak memiliki izin untuk menambahkan karcis ke keranjang!');
                return;
            }
            
            const ticket = tickets.find(t => t.code === ticketCode);
            if (ticket) {
                cart.push(ticket);
                updateCart();
            }
        }
        
        // Update cart display
        function updateCart() {
            const cartItems = document.getElementById('cartItems');
            const totalElement = document.getElementById('total');
            
            cartItems.innerHTML = cart.map(ticket => `
                <tr>
                    <td>${ticket.destination} (${ticket.type === 'regular' ? 'Reguler' : 
                                                  ticket.type === 'vip' ? 'VIP' : 
                                                  ticket.type === 'student' ? 'Pelajar' : 
                                                  ticket.type === 'foreigner' ? 'WNA' : 'Grup'})</td>
                    <td>Rp${ticket.price.toLocaleString()}</td>
                    <td class="text-end">
                        <button class="btn btn-sm btn-danger" onclick="removeFromCart('${ticket.code}')">
                            <i class="fas fa-trash"></i>
                        </button>
                    </td>
                </tr>
            `).join('');
            
            const total = cart.reduce((sum, ticket) => sum + ticket.price, 0);
            totalElement.textContent = `Rp${total.toLocaleString()}`;
            
            // Update ticket preview
            if (cart.length > 0) {
                const firstTicket = cart[0];
                document.getElementById('barcode-preview').innerHTML = '';
                JsBarcode('#barcode-preview', firstTicket.code, {
                    format: 'CODE128',
                    lineColor: '#000',
                    width: 2,
                    height: 50,
                    displayValue: true
                });
                
                document.querySelector('#ticketPreviewContent h4').textContent = firstTicket.destination;
                document.querySelector('#ticketPreviewContent p').textContent = products.find(p => p.name === firstTicket.destination)?.location || '';
                document.querySelectorAll('#ticketPreviewContent p.fw-bold')[0].textContent = firstTicket.code;
                document.querySelectorAll('#ticketPreviewContent p.fw-bold')[1].textContent = new Date(firstTicket.validDate).toLocaleDateString('id-ID', {day: 'numeric', month: 'short', year: 'numeric'});
                document.querySelectorAll('#ticketPreviewContent p.fw-bold')[2].textContent = `Rp${firstTicket.price.toLocaleString()}`;
            }
            
            // Update change amount
            updateChangeAmount();
        }
        
        // Remove item from cart
        function removeFromCart(ticketCode) {
            cart = cart.filter(ticket => ticket.code !== ticketCode);
            updateCart();
        }

        // Clear cart
        function clearCart() {
            cart = [];
            updateCart();
        }

        // Update change amount based on cash received
        function updateChangeAmount() {
            const total = cart.reduce((sum, ticket) => sum + ticket.price, 0);
            const cashReceived = parseFloat(document.getElementById('cashReceived').value) || 0;
            const change = cashReceived - total;
            
            document.getElementById('changeAmount').value = `Rp${change >= 0 ? change.toLocaleString() : '0'}`;
        }

        // Update payment method
        function updatePaymentMethod() {
            const method = document.getElementById('paymentMethod').value;
            document.getElementById('cashInputContainer').style.display = method === 'cash' ? 'block' : 'none';
        }

        // Complete transaction
        function completeTransaction() {
            if (!hasPermission(PERMISSIONS.FEATURE_CREATE_TICKET)) {
                alert('Anda tidak memiliki izin untuk menyelesaikan transaksi!');
                return;
            }
            
            if (cart.length === 0) {
                alert('Keranjang belanja kosong!');
                return;
            }

            const paymentMethod = document.getElementById('paymentMethod').value;
            const cashReceived = parseFloat(document.getElementById('cashReceived').value) || 0;
            const total = cart.reduce((sum, ticket) => sum + ticket.price, 0);

            if (paymentMethod === 'cash' && cashReceived < total) {
                alert('Uang yang diterima kurang dari total pembayaran!');
                return;
            }

            // Generate transaction ID and code
            const transactionId = generateTransactionId();
            const transactionCode = generateTransactionCode();
            const now = new Date();
            const transactionDate = now.toISOString().split('T')[0] + ' ' + now.toTimeString().split(' ')[0];

            // Create transaction
            const transaction = {
                id: transactionId,
                date: transactionDate,
                items: cart.map(ticket => ({ ticket: ticket.code, price: ticket.price })),
                total: total,
                cashier: currentUser.fullName,
                paymentMethod: paymentMethod,
                transactionCode: transactionCode
            };

            // Add to transactions
            transactions.push(transaction);

            // Update ticket status
            cart.forEach(ticket => {
                const t = tickets.find(t => t.code === ticket.code);
                if (t) t.status = 'used';
            });

            // Show receipt
            printReceipt(transaction);

            // Clear cart
            clearCart();
            document.getElementById('cashReceived').value = '0';

            // Refresh dashboard
            refreshDashboard();

            alert('Transaksi berhasil disimpan!');
        }

        // Print receipt
        function printReceipt(transaction) {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF({
                orientation: 'portrait',
                unit: 'mm',
                format: [80, 150] // Small receipt size
            });

            // Set font
            doc.setFont('helvetica', 'normal');
            
            // Add logo if enabled
            if (document.getElementById('printLogo').checked) {
                try {
                    const logoUrl = 'https://raw.githubusercontent.com/LKS-88/anekamarket/refs/heads/main/Logo-Anekamarketku.png';
                    doc.addImage(logoUrl, 'PNG', 25, 5, 30, 10);
                } catch (e) {
                    console.error('Error loading logo:', e);
                }
            }
            
            // Add header
            doc.setFontSize(12);
            doc.setTextColor(0, 0, 0);
            doc.text(document.getElementById('appName').value || 'TourTick', 40, 20, { align: 'center' });
            
            // Add address if enabled
            if (document.getElementById('printAddress').checked) {
                doc.setFontSize(8);
                doc.text('Jl. Raya Wisata No. 123, Kota Pariwisata', 40, 25, { align: 'center' });
            }
            
            // Add divider
            doc.setDrawColor(0, 0, 0);
            doc.line(5, 30, 75, 30);
            
            // Add transaction info
            doc.setFontSize(8);
            doc.text(`ID: ${transaction.id}`, 5, 35);
            doc.text(`Tanggal: ${transaction.date}`, 5, 40);
            doc.text(`Kasir: ${transaction.cashier}`, 5, 45);
            
            // Add divider
            doc.line(5, 50, 75, 50);
            
            // Add items
            let y = 55;
            transaction.items.forEach(item => {
                const ticket = tickets.find(t => t.code === item.ticket);
                const productName = ticket?.destination || 'Unknown';
                const ticketType = ticket?.type === 'regular' ? 'Reguler' : 
                                 ticket?.type === 'vip' ? 'VIP' : 
                                 ticket?.type === 'student' ? 'Pelajar' : 
                                 ticket?.type === 'foreigner' ? 'WNA' : 'Grup';
                
                doc.text(`${productName} (${ticketType})`, 5, y);
                doc.text(`Rp${item.price.toLocaleString()}`, 65, y, { align: 'right' });
                y += 5;
            });
            
            // Add divider
            doc.line(5, y, 75, y);
            y += 5;
            
            // Add totals
            doc.text('Subtotal:', 5, y);
            doc.text(`Rp${transaction.total.toLocaleString()}`, 65, y, { align: 'right' });
            y += 5;

            if (document.getElementById('enableTax').checked) {
                const taxRate = parseFloat(document.getElementById('taxRate').value) || 0;
                const taxAmount = transaction.total * (taxRate / 100);
                doc.text(`Pajak (${taxRate}%):`, 5, y);
                doc.text(`Rp${taxAmount.toLocaleString()}`, 65, y, { align: 'right' });
                y += 5;
                
                doc.text('Total:', 5, y);
                doc.setFontStyle('bold');
                doc.text(`Rp${(transaction.total + taxAmount).toLocaleString()}`, 65, y, { align: 'right' });
                doc.setFontStyle('normal');
                y += 5;
            } else {
                doc.text('Total:', 5, y);
                doc.setFontStyle('bold');
                doc.text(`Rp${transaction.total.toLocaleString()}`, 65, y, { align: 'right' });
                doc.setFontStyle('normal');
                y += 5;
            }
            
            // Add divider
            doc.line(5, y, 75, y);
            y += 5;
            
            // Add payment info
            doc.text(`Metode: ${transaction.paymentMethod === 'cash' ? 'Tunai' : 
                              transaction.paymentMethod === 'transfer' ? 'Transfer' : 
                              transaction.paymentMethod === 'qris' ? 'QRIS' : 'Kartu Debit'}`, 5, y);
            y += 5;
            
            if (transaction.paymentMethod === 'cash') {
                const cashReceived = parseFloat(document.getElementById('cashReceived').value) || 0;
                const change = cashReceived - transaction.total;
                
                doc.text(`Tunai: Rp${cashReceived.toLocaleString()}`, 5, y);
                y += 5;
                doc.text(`Kembalian: Rp${change.toLocaleString()}`, 5, y);
                y += 5;
            }
            
            // Add transaction barcode
            y += 5;
            doc.text('Kode Transaksi:', 40, y, { align: 'center' });
            y += 5;
            doc.text(transaction.transactionCode, 40, y, { align: 'center' });
            
                       // Add footer
            y += 20;
            doc.setFontSize(8);
            doc.text(document.getElementById('receiptFooter').value || 'Terima kasih telah berkunjung', 40, y, { align: 'center' });
            
            // Save PDF
            doc.save(`receipt_${transaction.id}.pdf`);
        }

        // Print ticket
        function printTicket() {
            if (cart.length === 0) {
                alert('Tidak ada tiket yang dipilih untuk dicetak!');
                return;
            }
            
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF({
                orientation: 'portrait',
                unit: 'mm',
                format: [80, 100] // Ticket size
            });

            // Set font
            doc.setFont('helvetica', 'normal');
            
            // Add logo
            try {
                const logoUrl = 'https://raw.githubusercontent.com/LKS-88/anekamarket/refs/heads/main/Logo-Anekamarketku.png';
                doc.addImage(logoUrl, 'PNG', 25, 5, 30, 10);
            } catch (e) {
                console.error('Error loading logo:', e);
            }
            
            // Add header
            doc.setFontSize(12);
            doc.setTextColor(0, 0, 0);
            doc.text('TourTick - Tiket Wisata', 40, 20, { align: 'center' });
            
            // Add ticket info
            const ticket = cart[0];
            doc.setFontSize(8);
            doc.text(`Destinasi: ${ticket.destination}`, 5, 30);
            doc.text(`Jenis: ${ticket.type === 'regular' ? 'Reguler' : 
                                   ticket.type === 'vip' ? 'VIP' : 
                                   ticket.type === 'student' ? 'Pelajar' : 
                                   ticket.type === 'foreigner' ? 'WNA' : 'Grup'}`, 5, 35);
            doc.text(`Harga: Rp${ticket.price.toLocaleString()}`, 5, 40);
            doc.text(`Tanggal: ${new Date(ticket.validDate).toLocaleDateString('id-ID')}`, 5, 45);
            
            // Add barcode
            const barcodeWidth = 60;
            const barcodeHeight = 20;
            const barcodeX = (80 - barcodeWidth) / 2;
            const barcodeY = 50;
            
            // Generate barcode image
            const canvas = document.createElement('canvas');
            JsBarcode(canvas, ticket.code, {
                format: 'CODE128',
                lineColor: '#000',
                width: 2,
                height: 30,
                displayValue: true
            });
            
            // Add barcode to PDF
            doc.addImage(canvas, 'PNG', barcodeX, barcodeY, barcodeWidth, barcodeHeight);
            
            // Add footer
            doc.setFontSize(6);
            doc.text('Tiket ini hanya berlaku untuk 1 orang pada tanggal yang tertera', 40, 85, { align: 'center' });
            
            // Save PDF
            doc.save(`ticket_${ticket.code}.pdf`);
        }

        // Generate barcode for new ticket
        function generateBarcode() {
            const code = document.getElementById('previewCode').textContent;
            JsBarcode('#barcode', code, {
                format: 'CODE128',
                lineColor: '#000',
                width: 2,
                height: 50,
                displayValue: true
            });
        }

        // Update ticket code based on selections
        function updateTicketCode() {
            const destination = document.getElementById('destination').value;
            const type = document.getElementById('ticketType').value;
            
            if (destination && type) {
                // Find the product
                const product = products.find(p => p.code === destination);
                if (product) {
                    // Generate a random 3-digit number
                    const randomNum = Math.floor(Math.random() * 900) + 100;
                    const code = `${product.code}-${randomNum}`;
                    
                    // Update preview
                    document.getElementById('previewCode').textContent = code;
                    document.getElementById('previewDestination').textContent = product.name;
                    document.getElementById('previewAddress').textContent = product.location;
                    
                    // Update type
                    document.getElementById('previewType').textContent = 
                        type === 'regular' ? 'Reguler' : 
                        type === 'vip' ? 'VIP' : 
                        type === 'student' ? 'Pelajar' : 
                        type === 'foreigner' ? 'WNA' : 'Grup';
                    
                    // Update price based on type
                    let price = 0;
                    if (type === 'regular') price = product.regularPrice;
                    else if (type === 'vip') price = product.vipPrice || product.regularPrice * 1.5;
                    else if (type === 'student') price = product.regularPrice * 0.6;
                    else if (type === 'foreigner') price = product.regularPrice * 2;
                    else if (type === 'group') price = product.regularPrice * 0.8;
                    
                    document.getElementById('previewPrice').textContent = `Rp${price.toLocaleString()}`;
                    document.getElementById('ticketPrice').value = price;
                    
                    // Update date
                    const validDate = document.getElementById('validDate').value;
                    if (validDate) {
                        const dateObj = new Date(validDate);
                        document.getElementById('previewDate').textContent = 
                            dateObj.toLocaleDateString('id-ID', {day: 'numeric', month: 'short', year: 'numeric'});
                    }
                    
                    // Generate barcode
                    generateBarcode();
                }
            }
        }

        // Update destination details when selected
        function updateDestinationDetails() {
            const destination = document.getElementById('destination').value;
            if (destination) {
                const product = products.find(p => p.code === destination);
                if (product) {
                    document.getElementById('previewDestination').textContent = product.name;
                    document.getElementById('previewAddress').textContent = product.location;
                    
                    // Update price based on selected type
                    const type = document.getElementById('ticketType').value;
                    if (type) {
                        let price = 0;
                        if (type === 'regular') price = product.regularPrice;
                        else if (type === 'vip') price = product.vipPrice || product.regularPrice * 1.5;
                        else if (type === 'student') price = product.regularPrice * 0.6;
                        else if (type === 'foreigner') price = product.regularPrice * 2;
                        else if (type === 'group') price = product.regularPrice * 0.8;
                        
                        document.getElementById('previewPrice').textContent = `Rp${price.toLocaleString()}`;
                        document.getElementById('ticketPrice').value = price;
                    }
                    
                    // Update ticket code
                    updateTicketCode();
                }
            }
        }

        // Save ticket to database
        function saveTicket(e) {
            e.preventDefault();
            
            if (!hasPermission(PERMISSIONS.FEATURE_CREATE_TICKET)) {
                alert('Anda tidak memiliki izin untuk membuat tiket baru!');
                return;
            }
            
            const type = document.getElementById('ticketType').value;
            const destination = document.getElementById('destination').value;
            const price = parseFloat(document.getElementById('ticketPrice').value);
            const quantity = parseInt(document.getElementById('ticketQuantity').value);
            const validDate = document.getElementById('validDate').value;
            const includeTax = document.getElementById('includeTax').checked;
            
            if (!type || !destination || !price || !quantity || !validDate) {
                alert('Harap lengkapi semua field!');
                return;
            }
            
            // Find the product
            const product = products.find(p => p.code === destination);
            if (!product) {
                alert('Destinasi tidak valid!');
                return;
            }
            
            // Create tickets
            const newTickets = [];
            for (let i = 0; i < quantity; i++) {
                const randomNum = Math.floor(Math.random() * 900) + 100;
                const code = `${product.code}-${randomNum}`;
                
                newTickets.push({
                    code: code,
                    type: type,
                    destination: product.name,
                    price: price,
                    validDate: validDate,
                    status: 'valid'
                });
            }
            
            // Add to tickets array
            tickets = [...tickets, ...newTickets];
            
            // Show success message
            alert(`${quantity} tiket berhasil dibuat!`);
            
            // Reset form
            document.getElementById('ticketForm').reset();
            document.getElementById('validDate').value = new Date().toISOString().split('T')[0];
            
            // Update ticket code
            updateTicketCode();
            
            // Refresh ticket list
            loadTicketList();
        }

        // Print generated ticket
        function printGeneratedTicket() {
            const code = document.getElementById('previewCode').textContent;
            const destination = document.getElementById('previewDestination').textContent;
            const type = document.getElementById('previewType').textContent;
            const price = document.getElementById('previewPrice').textContent;
            const date = document.getElementById('previewDate').textContent;
            
            if (!code || code === 'TWA-001') {
                alert('Harap generate tiket terlebih dahulu!');
                return;
            }
            
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF({
                orientation: 'portrait',
                unit: 'mm',
                format: [80, 100] // Ticket size
            });

            // Set font
            doc.setFont('helvetica', 'normal');
            
            // Add logo
            try {
                const logoUrl = 'https://raw.githubusercontent.com/LKS-88/anekamarket/refs/heads/main/Logo-Anekamarketku.png';
                doc.addImage(logoUrl, 'PNG', 25, 5, 30, 10);
            } catch (e) {
                console.error('Error loading logo:', e);
            }
            
            // Add header
            doc.setFontSize(12);
            doc.setTextColor(0, 0, 0);
            doc.text('TourTick - Tiket Wisata', 40, 20, { align: 'center' });
            
            // Add ticket info
            doc.setFontSize(8);
            doc.text(`Destinasi: ${destination}`, 5, 30);
            doc.text(`Jenis: ${type}`, 5, 35);
            doc.text(`Harga: ${price}`, 5, 40);
            doc.text(`Tanggal: ${date}`, 5, 45);
            
            // Add barcode
            const barcodeWidth = 60;
            const barcodeHeight = 20;
            const barcodeX = (80 - barcodeWidth) / 2;
            const barcodeY = 50;
            
            // Generate barcode image
            const canvas = document.createElement('canvas');
            JsBarcode(canvas, code, {
                format: 'CODE128',
                lineColor: '#000',
                width: 2,
                height: 30,
                displayValue: true
            });
            
            // Add barcode to PDF
            doc.addImage(canvas, 'PNG', barcodeX, barcodeY, barcodeWidth, barcodeHeight);
            
            // Add footer
            doc.setFontSize(6);
            doc.text('Tiket ini hanya berlaku untuk 1 orang pada tanggal yang tertera', 40, 85, { align: 'center' });
            
            // Save PDF
            doc.save(`ticket_${code}.pdf`);
        }

        // Load ticket list
        function loadTicketList() {
            const ticketTableBody = document.getElementById('ticketTableBody');
            const filter = document.getElementById('ticketFilter').value;
            
            let filteredTickets = [...tickets];
            
            if (filter === 'valid') {
                filteredTickets = filteredTickets.filter(t => t.status === 'valid');
            } else if (filter === 'used') {
                filteredTickets = filteredTickets.filter(t => t.status === 'used');
            } else if (filter === 'expired') {
                filteredTickets = filteredTickets.filter(t => t.status === 'expired');
            }
            
            ticketTableBody.innerHTML = filteredTickets.map(ticket => `
                <tr>
                    <td>${ticket.code}</td>
                    <td>${ticket.destination}</td>
                    <td>${ticket.type === 'regular' ? 'Reguler' : 
                         ticket.type === 'vip' ? 'VIP' : 
                         ticket.type === 'student' ? 'Pelajar' : 
                         ticket.type === 'foreigner' ? 'WNA' : 'Grup'}</td>
                    <td>Rp${ticket.price.toLocaleString()}</td>
                    <td>${new Date(ticket.validDate).toLocaleDateString('id-ID')}</td>
                    <td>
                        <span class="badge ${ticket.status === 'valid' ? 'badge-valid' : 
                                          ticket.status === 'used' ? 'badge-used' : 'badge-expired'}">
                            ${ticket.status === 'valid' ? 'Valid' : 
                             ticket.status === 'used' ? 'Digunakan' : 'Kadaluarsa'}
                        </span>
                    </td>
                    <td>
                        <button class="btn btn-sm btn-primary" onclick="viewTicket('${ticket.code}')">
                            <i class="fas fa-eye"></i>
                        </button>
                        ${hasPermission(PERMISSIONS.FEATURE_DELETE_TICKET) ? `
                        <button class="btn btn-sm btn-danger" onclick="deleteTicket('${ticket.code}')">
                            <i class="fas fa-trash"></i>
                        </button>
                        ` : ''}
                    </td>
                </tr>
            `).join('');
        }

        // View ticket details
        function viewTicket(ticketCode) {
            const ticket = tickets.find(t => t.code === ticketCode);
            if (!ticket) return;
            
            // Update modal content
            document.getElementById('viewTicketDestination').textContent = ticket.destination;
            document.getElementById('viewTicketAddress').textContent = products.find(p => p.name === ticket.destination)?.location || '';
            document.getElementById('viewTicketType').textContent = 
                ticket.type === 'regular' ? 'Reguler' : 
                ticket.type === 'vip' ? 'VIP' : 
                ticket.type === 'student' ? 'Pelajar' : 
                ticket.type === 'foreigner' ? 'WNA' : 'Grup';
            document.getElementById('viewTicketCode').textContent = ticket.code;
            document.getElementById('viewTicketDate').textContent = new Date(ticket.validDate).toLocaleDateString('id-ID');
            document.getElementById('viewTicketPrice').textContent = `Rp${ticket.price.toLocaleString()}`;
            document.getElementById('viewTicketStatus').textContent = 
                ticket.status === 'valid' ? 'Belum Digunakan' : 
                ticket.status === 'used' ? 'Sudah Digunakan' : 'Kadaluarsa';
            document.getElementById('viewTicketStatus').className = 
                `mb-0 fw-bold ${ticket.status === 'valid' ? 'text-success' : 
                               ticket.status === 'used' ? 'text-info' : 'text-danger'}`;
            
            // Generate barcode
            document.getElementById('viewTicketBarcode').innerHTML = '';
            JsBarcode('#viewTicketBarcode', ticket.code, {
                format: 'CODE128',
                lineColor: '#000',
                width: 2,
                height: 50,
                displayValue: true
            });
            
            // Show modal
            const viewTicketModal = new bootstrap.Modal(document.getElementById('viewTicketModal'));
            viewTicketModal.show();
        }

        // Delete ticket
        function deleteTicket(ticketCode) {
            if (!hasPermission(PERMISSIONS.FEATURE_DELETE_TICKET)) {
                alert('Anda tidak memiliki izin untuk menghapus tiket!');
                return;
            }
            
            if (confirm('Apakah Anda yakin ingin menghapus tiket ini?')) {
                tickets = tickets.filter(t => t.code !== ticketCode);
                loadTicketList();
                alert('Tiket berhasil dihapus!');
            }
        }

        // Search tickets
        function searchTickets() {
            const searchTerm = document.getElementById('ticketSearch').value.toLowerCase();
            const rows = document.getElementById('ticketTableBody').querySelectorAll('tr');
            
            rows.forEach(row => {
                const text = row.textContent.toLowerCase();
                row.style.display = text.includes(searchTerm) ? '' : 'none';
            });
        }

        // Filter tickets
        function filterTickets() {
            loadTicketList();
        }

        // Export tickets to Excel
        function exportTickets() {
            if (!hasPermission(PERMISSIONS.FEATURE_EXPORT_TICKET)) {
                alert('Anda tidak memiliki izin untuk mengekspor tiket!');
                return;
            }
            
            const filter = document.getElementById('ticketFilter').value;
            let filteredTickets = [...tickets];
            
            if (filter === 'valid') {
                filteredTickets = filteredTickets.filter(t => t.status === 'valid');
            } else if (filter === 'used') {
                filteredTickets = filteredTickets.filter(t => t.status === 'used');
            } else if (filter === 'expired') {
                filteredTickets = filteredTickets.filter(t => t.status === 'expired');
            }
            
            // Prepare data
            const data = filteredTickets.map(ticket => ({
                'Kode Tiket': ticket.code,
                'Destinasi': ticket.destination,
                'Jenis': ticket.type === 'regular' ? 'Reguler' : 
                        ticket.type === 'vip' ? 'VIP' : 
                        ticket.type === 'student' ? 'Pelajar' : 
                        ticket.type === 'foreigner' ? 'WNA' : 'Grup',
                'Harga': ticket.price,
                'Tanggal Berlaku': ticket.validDate,
                'Status': ticket.status === 'valid' ? 'Valid' : 
                         ticket.status === 'used' ? 'Digunakan' : 'Kadaluarsa'
            }));
            
            // Create worksheet
            const ws = XLSX.utils.json_to_sheet(data);
            
            // Create workbook
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, 'Daftar Tiket');
            
            // Export to file
            XLSX.writeFile(wb, 'daftar_tiket.xlsx');
        }

        // Show import modal
        function showImportModal() {
            if (!hasPermission(PERMISSIONS.FEATURE_IMPORT_TICKET)) {
                alert('Anda tidak memiliki izin untuk mengimpor tiket!');
                return;
            }
            
            const importModal = new bootstrap.Modal(document.getElementById('importTicketsModal'));
            importModal.show();
        }

        // Download import template
        function downloadImportTemplate() {
            // Sample data for template
            const templateData = [{
                'Kode Tiket': 'TWA-001',
                'Destinasi': 'Taman Wisata Alam',
                'Jenis': 'regular',
                'Harga': 50000,
                'Tanggal Berlaku': '2023-06-10',
                'Status': 'valid'
            }];
            
            // Create worksheet
            const ws = XLSX.utils.json_to_sheet(templateData);
            
            // Create workbook
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, 'Template Tiket');
            
            // Export to file
            XLSX.writeFile(wb, 'template_import_tiket.xlsx');
        }

        // Import tickets from Excel
        function importTickets() {
            const fileInput = document.getElementById('ticketImportFile');
            const file = fileInput.files[0];
            
            if (!file) {
                alert('Pilih file terlebih dahulu!');
                return;
            }
            
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const data = new Uint8Array(e.target.result);
                    const workbook = XLSX.read(data, { type: 'array' });
                    
                    // Get first sheet
                    const firstSheet = workbook.Sheets[workbook.SheetNames[0]];
                    
                    // Convert to JSON
                    const jsonData = XLSX.utils.sheet_to_json(firstSheet);
                    
                    // Validate and process data
                    const newTickets = [];
                    const errors = [];
                    
                    jsonData.forEach((row, index) => {
                        // Validate required fields
                        if (!row['Kode Tiket'] || !row['Destinasi'] || !row['Jenis'] || !row['Harga'] || !row['Tanggal Berlaku']) {
                            errors.push(`Baris ${index + 2}: Data tidak lengkap`);
                            return;
                        }
                        
                        // Validate ticket type
                        const validTypes = ['regular', 'vip', 'student', 'foreigner', 'group'];
                        if (!validTypes.includes(row['Jenis'].toLowerCase())) {
                            errors.push(`Baris ${index + 2}: Jenis tiket tidak valid`);
                            return;
                        }
                        
                        // Validate price
                        if (isNaN(row['Harga']) {
                            errors.push(`Baris ${index + 2}: Harga harus berupa angka`);
                            return;
                        }
                        
                        // Validate date
                        if (isNaN(new Date(row['Tanggal Berlaku']).getTime())) {
                            errors.push(`Baris ${index + 2}: Format tanggal tidak valid`);
                            return;
                        }
                        
                        // Validate status if provided
                        let status = 'valid';
                        if (row['Status']) {
                            const validStatuses = ['valid', 'used', 'expired'];
                            if (validStatuses.includes(row['Status'].toLowerCase())) {
                                status = row['Status'].toLowerCase();
                            } else {
                                errors.push(`Baris ${index + 2}: Status tidak valid, menggunakan default 'valid'`);
                            }
                        }
                        
                        // Add to new tickets
                        newTickets.push({
                            code: row['Kode Tiket'],
                            type: row['Jenis'].toLowerCase(),
                            destination: row['Destinasi'],
                            price: parseFloat(row['Harga']),
                            validDate: new Date(row['Tanggal Berlaku']).toISOString().split('T')[0],
                            status: status
                        });
                    });
                    
                    if (errors.length > 0) {
                        alert(`Beberapa data tidak valid:\n${errors.join('\n')}`);
                    }
                    
                    if (newTickets.length > 0) {
                        // Add to tickets array
                        tickets = [...tickets, ...newTickets];
                        
                        // Show success message
                        alert(`${newTickets.length} tiket berhasil diimpor!`);
                        
                        // Close modal
                        bootstrap.Modal.getInstance(document.getElementById('importTicketsModal')).hide();
                        
                        // Refresh ticket list
                        loadTicketList();
                    } else {
                        alert('Tidak ada tiket yang berhasil diimpor!');
                    }
                } catch (error) {
                    console.error('Error importing tickets:', error);
                    alert('Terjadi kesalahan saat mengimpor tiket!');
                }
            };
            
            reader.readAsArrayBuffer(file);
        }

        // Print single ticket
        function printSingleTicket() {
            const code = document.getElementById('viewTicketCode').textContent;
            const destination = document.getElementById('viewTicketDestination').textContent;
            const type = document.getElementById('viewTicketType').textContent;
            const price = document.getElementById('viewTicketPrice').textContent;
            const date = document.getElementById('viewTicketDate').textContent;
            
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF({
                orientation: 'portrait',
                unit: 'mm',
                format: [80, 100] // Ticket size
            });

            // Set font
            doc.setFont('helvetica', 'normal');
            
            // Add logo
            try {
                const logoUrl = 'https://raw.githubusercontent.com/LKS-88/anekamarket/refs/heads/main/Logo-Anekamarketku.png';
                doc.addImage(logoUrl, 'PNG', 25, 5, 30, 10);
            } catch (e) {
                console.error('Error loading logo:', e);
            }
            
            // Add header
            doc.setFontSize(12);
            doc.setTextColor(0, 0, 0);
            doc.text('TourTick - Tiket Wisata', 40, 20, { align: 'center' });
            
            // Add ticket info
            doc.setFontSize(8);
            doc.text(`Destinasi: ${destination}`, 5, 30);
            doc.text(`Jenis: ${type}`, 5, 35);
            doc.text(`Harga: ${price}`, 5, 40);
            doc.text(`Tanggal: ${date}`, 5, 45);
            
            // Add barcode
            const barcodeWidth = 60;
            const barcodeHeight = 20;
            const barcodeX = (80 - barcodeWidth) / 2;
            const barcodeY = 50;
            
            // Generate barcode image
            const canvas = document.createElement('canvas');
            JsBarcode(canvas, code, {
                format: 'CODE128',
                lineColor: '#000',
                width: 2,
                height: 30,
                displayValue: true
            });
            
            // Add barcode to PDF
            doc.addImage(canvas, 'PNG', barcodeX, barcodeY, barcodeWidth, barcodeHeight);
            
            // Add footer
            doc.setFontSize(6);
            doc.text('Tiket ini hanya berlaku untuk 1 orang pada tanggal yang tertera', 40, 85, { align: 'center' });
            
            // Save PDF
            doc.save(`ticket_${code}.pdf`);
            
            // Close modal
            bootstrap.Modal.getInstance(document.getElementById('viewTicketModal')).hide();
        }

        // Load report data
        function loadReportData() {
            const startDate = document.getElementById('reportStartDate').value;
            const endDate = document.getElementById('reportEndDate').value;
            const ticketType = document.getElementById('reportTicketType').value;
            const destination = document.getElementById('reportDestination').value;
            
            // Filter transactions
            let filteredTransactions = [...transactions];
            
            // Filter by date range
            if (startDate && endDate) {
                filteredTransactions = filteredTransactions.filter(trx => {
                    const trxDate = trx.date.split(' ')[0];
                    return trxDate >= startDate && trxDate <= endDate;
                });
            }
            
            // Filter by ticket type
            if (ticketType !== 'all') {
                filteredTransactions = filteredTransactions.filter(trx => {
                    return trx.items.some(item => {
                        const ticket = tickets.find(t => t.code === item.ticket);
                        return ticket && ticket.type === ticketType;
                    });
                });
            }
            
            // Filter by destination
            if (destination !== 'all') {
                filteredTransactions = filteredTransactions.filter(trx => {
                    return trx.items.some(item => {
                        const ticket = tickets.find(t => t.code === item.ticket);
                        const product = products.find(p => p.name === ticket?.destination);
                        return product && product.code === destination;
                    });
                });
            }
            
            // Update report table
            const reportTableBody = document.getElementById('reportTableBody');
            reportTableBody.innerHTML = filteredTransactions.map(trx => `
                <tr>
                    <td>${trx.id}</td>
                    <td>${trx.date}</td>
                    <td>
                        ${trx.items.map(item => {
                            const ticket = tickets.find(t => t.code === item.ticket);
                            return `${ticket?.destination || 'Unknown'} (${ticket?.type === 'regular' ? 'Reguler' : 
                                                                      ticket?.type === 'vip' ? 'VIP' : 
                                                                      ticket?.type === 'student' ? 'Pelajar' : 
                                                                      ticket?.type === 'foreigner' ? 'WNA' : 'Grup'})`;
                        }).join(', ')}
                    </td>
                    <td>${trx.items.length}</td>
                    <td>Rp${trx.items.reduce((sum, item) => sum + item.price, 0).toLocaleString()}</td>
                    <td>Rp${trx.total.toLocaleString()}</td>
                    <td>${trx.cashier}</td>
                </tr>
            `).join('');
            
            // Initialize report chart
            initReportChart(filteredTransactions);
        }

        // Initialize report chart
        function initReportChart(transactions) {
            // Group by date
            const salesByDate = {};
            
            transactions.forEach(trx => {
                const date = trx.date.split(' ')[0];
                if (!salesByDate[date]) {
                    salesByDate[date] = 0;
                }
                salesByDate[date] += trx.total;
            });
            
            const dates = Object.keys(salesByDate).sort();
            const amounts = dates.map(date => salesByDate[date]);
            
            // Get chart context
            const reportCtx = document.getElementById('reportChart').getContext('2d');
            
            // Destroy previous chart if exists
            if (window.reportChart) {
                window.reportChart.destroy();
            }
            
            // Create new chart
            window.reportChart = new Chart(reportCtx, {
                type: 'bar',
                data: {
                    labels: dates,
                    datasets: [{
                        label: 'Pendapatan',
                        data: amounts,
                        backgroundColor: 'rgba(52, 152, 219, 0.7)',
                        borderColor: 'rgba(52, 152, 219, 1)',
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        legend: {
                            display: false
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                callback: function(value) {
                                    return 'Rp' + value.toLocaleString();
                                }
                            }
                        }
                    }
                }
            });
        }

        // Generate daily report as PDF
        function generateDailyReport() {
            if (!hasPermission(PERMISSIONS.FEATURE_EXPORT_TICKET)) {
                alert('Anda tidak memiliki izin untuk membuat laporan!');
                return;
            }
            
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();
            
            // Set font
            doc.setFont('helvetica', 'normal');
            
            // Add logo
            try {
                const logoUrl = 'https://raw.githubusercontent.com/LKS-88/anekamarket/refs/heads/main/Logo-Anekamarketku.png';
                doc.addImage(logoUrl, 'PNG', 10, 10, 30, 10);
            } catch (e) {
                console.error('Error loading logo:', e);
            }
            
            // Add title
            doc.setFontSize(16);
            doc.setTextColor(0, 0, 0);
            doc.text('Laporan Harian Penjualan Tiket', 105, 20, { align: 'center' });
            
            // Add date range
            doc.setFontSize(12);
            const startDate = document.getElementById('reportStartDate').value;
            const endDate = document.getElementById('reportEndDate').value;
            doc.text(`Periode: ${startDate} s/d ${endDate}`, 105, 30, { align: 'center' });
            
            // Add generated date
            const now = new Date();
            doc.text(`Dibuat pada: ${now.toLocaleDateString('id-ID')} ${now.toLocaleTimeString('id-ID')}`, 105, 35, { align: 'center' });
            
            // Add divider
            doc.setDrawColor(0, 0, 0);
            doc.line(10, 40, 200, 40);
            
            // Add summary
            doc.setFontSize(14);
            doc.text('Ringkasan', 10, 50);
            
            doc.setFontSize(10);
            let y = 60;
            
            // Total transactions
            const filteredTransactions = getFilteredTransactions();
            doc.text(`Total Transaksi: ${filteredTransactions.length}`, 10, y);
            y += 10;
            
            // Total revenue
            const totalRevenue = filteredTransactions.reduce((sum, trx) => sum + trx.total, 0);
            doc.text(`Total Pendapatan: Rp${totalRevenue.toLocaleString()}`, 10, y);
            y += 10;
            
            // Tickets sold
            const ticketsSold = filteredTransactions.reduce((sum, trx) => sum + trx.items.length, 0);
            doc.text(`Tiket Terjual: ${ticketsSold}`, 10, y);
            y += 10;
            
            // Add divider
            doc.line(10, y, 200, y);
            y += 15;
            
            // Add transaction details header
            doc.setFontSize(12);
            doc.text('Detail Transaksi', 10, y);
            y += 10;
            
            // Create table headers
            doc.setFontSize(10);
            doc.setFontStyle('bold');
            doc.text('ID Transaksi', 10, y);
            doc.text('Tanggal', 50, y);
            doc.text('Kasir', 90, y);
            doc.text('Jumlah', 130, y);
            doc.text('Total', 170, y);
            
            // Add table rows
            doc.setFontStyle('normal');
            y += 7;
            
            filteredTransactions.forEach(trx => {
                if (y > 270) {
                    doc.addPage();
                    y = 20;
                }
                
                doc.text(trx.id, 10, y);
                doc.text(trx.date, 50, y);
                doc.text(trx.cashier, 90, y);
                doc.text(trx.items.length.toString(), 130, y);
                doc.text(`Rp${trx.total.toLocaleString()}`, 170, y);
                
                y += 7;
            });
            
            // Save PDF
            doc.save(`laporan_penjualan_${startDate}_${endDate}.pdf`);
        }

        // Export report data to Excel
        function exportReportData() {
            if (!hasPermission(PERMISSIONS.FEATURE_EXPORT_TICKET)) {
                alert('Anda tidak memiliki izin untuk mengekspor data laporan!');
                return;
            }
            
            const filteredTransactions = getFilteredTransactions();
            
            // Prepare data
            const data = filteredTransactions.map(trx => ({
                'ID Transaksi': trx.id,
                'Tanggal': trx.date,
                'Kasir': trx.cashier,
                'Jumlah Tiket': trx.items.length,
                'Total': trx.total,
                'Metode Pembayaran': trx.paymentMethod === 'cash' ? 'Tunai' : 
                                    trx.paymentMethod === 'transfer' ? 'Transfer' : 
                                    trx.paymentMethod === 'qris' ? 'QRIS' : 'Kartu Debit',
                'Detail Tiket': trx.items.map(item => {
                    const ticket = tickets.find(t => t.code === item.ticket);
                    return `${ticket?.destination || 'Unknown'} (${ticket?.type === 'regular' ? 'Reguler' : 
                                                                  ticket?.type === 'vip' ? 'VIP' : 
                                                                  ticket?.type === 'student' ? 'Pelajar' : 
                                                                  ticket?.type === 'foreigner' ? 'WNA' : 'Grup'}) - Rp${item.price.toLocaleString()}`;
                }).join(', ')
            }));
            
            // Create worksheet
            const ws = XLSX.utils.json_to_sheet(data);
            
            // Create workbook
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, 'Laporan Penjualan');
            
            // Export to file
            XLSX.writeFile(wb, 'laporan_penjualan.xlsx');
        }

        // Get filtered transactions based on report filters
        function getFilteredTransactions() {
            const startDate = document.getElementById('reportStartDate').value;
            const endDate = document.getElementById('reportEndDate').value;
            const ticketType = document.getElementById('reportTicketType').value;
            const destination = document.getElementById('reportDestination').value;
            
            // Filter transactions
            let filteredTransactions = [...transactions];
            
            // Filter by date range
            if (startDate && endDate) {
                filteredTransactions = filteredTransactions.filter(trx => {
                    const trxDate = trx.date.split(' ')[0];
                    return trxDate >= startDate && trxDate <= endDate;
                });
            }
            
            // Filter by ticket type
            if (ticketType !== 'all') {
                filteredTransactions = filteredTransactions.filter(trx => {
                    return trx.items.some(item => {
                        const ticket = tickets.find(t => t.code === item.ticket);
                        return ticket && ticket.type === ticketType;
                    });
                });
            }
            
            // Filter by destination
            if (destination !== 'all') {
                filteredTransactions = filteredTransactions.filter(trx => {
                    return trx.items.some(item => {
                        const ticket = tickets.find(t => t.code === item.ticket);
                        const product = products.find(p => p.name === ticket?.destination);
                        return product && product.code === destination;
                    });
                });
            }
            
            return filteredTransactions;
        }

        // Load products
        function loadProducts() {
            if (!hasPermission(PERMISSIONS.MENU_PRODUCTS)) {
                showSection('access-denied');
                return;
            }
            
            const productTableBody = document.getElementById('productTableBody');
            productTableBody.innerHTML = products.map(product => `
                <tr>
                    <td>${product.code}</td>
                    <td>${product.name}</td>
                    <td>${product.location}</td>
                    <td>Rp${product.regularPrice.toLocaleString()}</td>
                    <td>
                        <span class="badge ${product.status === 'active' ? 'badge-valid' : 'badge-expired'}">
                            ${product.status === 'active' ? 'Aktif' : 'Nonaktif'}
                        </span>
                    </td>
                    <td>
                        <button class="btn btn-sm btn-primary me-1" onclick="editProduct('${product.code}')">
                            <i class="fas fa-edit"></i>
                        </button>
                        ${hasPermission(PERMISSIONS.FEATURE_DELETE_PRODUCT) ? `
                        <button class="btn btn-sm btn-danger" onclick="deleteProduct('${product.code}')">
                            <i class="fas fa-trash"></i>
                        </button>
                        ` : ''}
                    </td>
                </tr>
            `).join('');
        }

        // Show add product modal
        function showAddProductModal() {
            if (!hasPermission(PERMISSIONS.FEATURE_CREATE_PRODUCT)) {
                alert('Anda tidak memiliki izin untuk menambahkan produk!');
                return;
            }
            
            // Reset form
            document.getElementById('addProductForm').reset();
            
            // Show modal
            const addProductModal = new bootstrap.Modal(document.getElementById('addProductModal'));
            addProductModal.show();
        }

        // Edit product
        function editProduct(productCode) {
            if (!hasPermission(PERMISSIONS.FEATURE_EDIT_PRODUCT)) {
                alert('Anda tidak memiliki izin untuk mengedit produk!');
                return;
            }
            
            const product = products.find(p => p.code === productCode);
            if (!product) return;
            
            // Fill form
            document.getElementById('productCode').value = product.code;
            document.getElementById('productName').value = product.name;
            document.getElementById('productLocation').value = product.location;
            document.getElementById('productDescription').value = product.description || '';
            document.getElementById('productRegularPrice').value = product.regularPrice;
            document.getElementById('productVipPrice').value = product.vipPrice || '';
            document.getElementById('productStatus').checked = product.status === 'active';
            
            // Change modal title
            document.querySelector('#addProductModal .modal-title').textContent = 'Edit Produk Wisata';
            
            // Add hidden field for edit mode
            if (!document.getElementById('editProductId')) {
                const input = document.createElement('input');
                input.type = 'hidden';
                input.id = 'editProductId';
                input.value = product.code;
                document.getElementById('addProductForm').appendChild(input);
            } else {
                document.getElementById('editProductId').value = product.code;
            }
            
            // Show modal
            const addProductModal = new bootstrap.Modal(document.getElementById('addProductModal'));
            addProductModal.show();
        }

        // Save product
        function saveProduct() {
            const code = document.getElementById('productCode').value;
            const name = document.getElementById('productName').value;
            const location = document.getElementById('productLocation').value;
            const description = document.getElementById('productDescription').value;
            const regularPrice = parseFloat(document.getElementById('productRegularPrice').value);
            const vipPrice = parseFloat(document.getElementById('productVipPrice').value) || null;
            const status = document.getElementById('productStatus').checked ? 'active' : 'inactive';
            
            if (!code || !name || !location || isNaN(regularPrice)) {
                alert('Harap lengkapi semua field yang diperlukan!');
                return;
            }
            
            // Check if editing existing product
            const editProductId = document.getElementById('editProductId')?.value;
            
            if (editProductId) {
                // Update existing product
                const productIndex = products.findIndex(p => p.code === editProductId);
                if (productIndex !== -1) {
                    products[productIndex] = {
                        ...products[productIndex],
                        code,
                        name,
                        location,
                        description,
                        regularPrice,
                        vipPrice,
                        status
                    };
                }
                
                // Remove hidden field
                document.getElementById('editProductId').remove();
            } else {
                // Add new product
                products.push({
                    code,
                    name,
                    location,
                    description,
                    regularPrice,
                    vipPrice,
                    status
                });
            }
            
            // Show success message
            alert(`Produk ${name} berhasil disimpan!`);
            
            // Close modal
            bootstrap.Modal.getInstance(document.getElementById('addProductModal')).hide();
            
            // Refresh product list
            loadProducts();
            
            // Update destination dropdowns
            populateDestinationDropdowns();
        }

        // Delete product
        function deleteProduct(productCode) {
            if (!hasPermission(PERMISSIONS.FEATURE_DELETE_PRODUCT)) {
                alert('Anda tidak memiliki izin untuk menghapus produk!');
                return;
            }
            
            if (confirm('Apakah Anda yakin ingin menghapus produk ini?')) {
                products = products.filter(p => p.code !== productCode);
                loadProducts();
                populateDestinationDropdowns();
                alert('Produk berhasil dihapus!');
            }
        }

        // Search products
        function searchProducts() {
            const searchTerm = document.getElementById('productSearch').value.toLowerCase();
            const rows = document.getElementById('productTableBody').querySelectorAll('tr');
            
            rows.forEach(row => {
                const text = row.textContent.toLowerCase();
                row.style.display = text.includes(searchTerm) ? '' : 'none';
            });
        }

        // Load users
        function loadUsers() {
            if (!hasPermission(PERMISSIONS.MENU_USERS)) {
                showSection('access-denied');
                return;
            }
            
            const userTableBody = document.getElementById('userTableBody');
            userTableBody.innerHTML = users.map(user => `
                <tr>
                    <td>${user.fullName}</td>
                    <td>${user.username}</td>
                    <td>
                        ${user.role === 'admin' ? 'Admin' : 
                         user.role === 'cashier' ? 'Kasir' : 
                         user.role === 'manager' ? 'Manager' : 'Operator'}
                    </td>
                    <td>
                        <span class="badge ${user.status === 'active' ? 'badge-valid' : 'badge-expired'}">
                            ${user.status === 'active' ? 'Aktif' : 'Nonaktif'}
                        </span>
                    </td>
                    <td>${user.lastLogin || '-'}</td>
                    <td>
                        <button class="btn btn-sm btn-primary me-1" onclick="editUser('${user.username}')">
                            <i class="fas fa-edit"></i>
                        </button>
                        ${hasPermission(PERMISSIONS.FEATURE_DELETE_USER) && user.username !== currentUser.username ? `
                        <button class="btn btn-sm btn-danger" onclick="deleteUser('${user.username}')">
                            <i class="fas fa-trash"></i>
                        </button>
                        ` : ''}
                    </td>
                </tr>
            `).join('');
        }

        // Show add user modal
        function showAddUserModal() {
            if (!hasPermission(PERMISSIONS.FEATURE_CREATE_USER)) {
                alert('Anda tidak memiliki izin untuk menambahkan pengguna!');
                return;
            }
            
            // Reset form
            document.getElementById('addUserForm').reset();
            
            // Show modal
            const addUserModal = new bootstrap.Modal(document.getElementById('addUserModal'));
            addUserModal.show();
        }

        // Edit user
        function editUser(username) {
            if (!hasPermission(PERMISSIONS.FEATURE_EDIT_USER)) {
                alert('Anda tidak memiliki izin untuk mengedit pengguna!');
                return;
            }
            
            const user = users.find(u => u.username === username);
            if (!user) return;
            
            // Fill form
            document.getElementById('userFullName').value = user.fullName;
            document.getElementById('userUsername').value = user.username;
            document.getElementById('userPassword').value = '';
            document.getElementById('userRole').value = user.role;
            document.getElementById('userStatus').checked = user.status === 'active';
            
            // Change modal title
            document.querySelector('#addUserModal .modal-title').textContent = 'Edit Pengguna';
            
            // Add hidden field for edit mode
            if (!document.getElementById('editUserId')) {
                const input = document.createElement('input');
                input.type = 'hidden';
                input.id = 'editUserId';
                input.value = user.username;
                document.getElementById('addUserForm').appendChild(input);
            } else {
                document.getElementById('editUserId').value = user.username;
            }
            
            // Show modal
            const addUserModal = new bootstrap.Modal(document.getElementById('addUserModal'));
            addUserModal.show();
        }

        // Save user
        function saveUser() {
            const fullName = document.getElementById('userFullName').value;
            const username = document.getElementById('userUsername').value;
            const password = document.getElementById('userPassword').value;
            const role = document.getElementById('userRole').value;
            const status = document.getElementById('userStatus').checked ? 'active' : 'inactive';
            
            if (!fullName || !username || !role) {
                alert('Harap lengkapi semua field yang diperlukan!');
                return;
            }
            
            // Check if editing existing user
            const editUserId = document.getElementById('editUserId')?.value;
            
            if (editUserId) {
                // Update existing user
                const userIndex = users.findIndex(u => u.username === editUserId);
                if (userIndex !== -1) {
                    users[userIndex] = {
                        ...users[userIndex],
                        fullName,
                        username,
                        role,
                        status,
                        // Only update password if provided
                        password: password ? CryptoJS.SHA256(password).toString() : users[userIndex].password
                    };
                }
                
                // Remove hidden field
                document.getElementById('editUserId').remove();
            } else {
                // Check password for new user
                if (!password) {
                    alert('Harap masukkan password untuk pengguna baru!');
                    return;
                }
                
                // Check if username already exists
                if (users.some(u => u.username === username)) {
                    alert('Username sudah digunakan!');
                    return;
                }
                
                // Add new user
                users.push({
                    fullName,
                    username,
                    password: CryptoJS.SHA256(password).toString(),
                    role,
                    status,
                    lastLogin: null,
                    permissions: DEFAULT_ROLE_PERMISSIONS[role] || {}
                });
            }
            
            // Show success message
            alert(`Pengguna ${fullName} berhasil disimpan!`);
            
            // Close modal
            bootstrap.Modal.getInstance(document.getElementById('addUserModal')).hide();
            
            // Refresh user list
            loadUsers();
        }

        // Delete user
        function deleteUser(username) {
            if (!hasPermission(PERMISSIONS.FEATURE_DELETE_USER)) {
                alert('Anda tidak memiliki izin untuk menghapus pengguna!');
                return;
            }
            
            if (username === currentUser.username) {
                alert('Anda tidak dapat menghapus akun sendiri!');
                return;
            }
            
            if (confirm('Apakah Anda yakin ingin menghapus pengguna ini?')) {
                users = users.filter(u => u.username !== username);
                loadUsers();
                alert('Pengguna berhasil dihapus!');
            }
        }

        // Search users
        function searchUsers() {
            const searchTerm = document.getElementById('userSearch').value.toLowerCase();
            const rows = document.getElementById('userTableBody').querySelectorAll('tr');
            
            rows.forEach(row => {
                const text = row.textContent.toLowerCase();
                row.style.display = text.includes(searchTerm) ? '' : 'none';
            });
        }

        // Load role permissions
        function loadRolePermissions() {
            const role = document.getElementById('roleSelector').value;
            const rolePermissions = DEFAULT_ROLE_PERMISSIONS[role] || {};
            
            // Menu permissions
            document.getElementById('permDashboard').checked = rolePermissions[PERMISSIONS.MENU_DASHBOARD] || false;
            document.getElementById('permTicketSales').checked = rolePermissions[PERMISSIONS.MENU_TICKET_SALES] || false;
            document.getElementById('permGenerateTicket').checked = rolePermissions[PERMISSIONS.MENU_GENERATE_TICKET] || false;
            document.getElementById('permTicketList').checked = rolePermissions[PERMISSIONS.MENU_TICKET_LIST] || false;
            document.getElementById('permReports').checked = rolePermissions[PERMISSIONS.MENU_REPORTS] || false;
            document.getElementById('permProducts').checked = rolePermissions[PERMISSIONS.MENU_PRODUCTS] || false;
            document.getElementById('permUsers').checked = rolePermissions[PERMISSIONS.MENU_USERS] || false;
            document.getElementById('permSettings').checked = rolePermissions[PERMISSIONS.MENU_SETTINGS] || false;
            document.getElementById('permBackup').checked = rolePermissions[PERMISSIONS.MENU_BACKUP] || false;
            
            // Feature permissions
            document.getElementById('permRestore').checked = rolePermissions[PERMISSIONS.FEATURE_RESTORE] || false;
            document.getElementById('permReset').checked = rolePermissions[PERMISSIONS.FEATURE_RESET] || false;
            document.getElementById('permDeleteTicket').checked = rolePermissions[PERMISSIONS.FEATURE_DELETE_TICKET] || false;
            document.getElementById('permDeleteProduct').checked = rolePermissions[PERMISSIONS.FEATURE_DELETE_PRODUCT] || false;
            document.getElementById('permDeleteUser').checked = rolePermissions[PERMISSIONS.FEATURE_DELETE_USER] || false;
        }

        // Save role permissions
        function saveRolePermissions() {
            const password = document.getElementById('adminPasswordForPermissions').value;
            if (!password) {
                alert('Harap masukkan password admin!');
                return;
            }
            
            // Verify admin password
            const adminUser = users.find(u => u.role === 'admin');
            if (!adminUser || adminUser.password !== CryptoJS.SHA256(password).toString()) {
                alert('Password admin salah!');
                return;
            }
            
            const role = document.getElementById('roleSelector').value;
            
            // Update permissions for the role
            DEFAULT_ROLE_PERMISSIONS[role] = {
                // Menu permissions
                [PERMISSIONS.MENU_DASHBOARD]: document.getElementById('permDashboard').checked,
                [PERMISSIONS.MENU_TICKET_SALES]: document.getElementById('permTicketSales').checked,
                [PERMISSIONS.MENU_GENERATE_TICKET]: document.getElementById('permGenerateTicket').checked,
                [PERMISSIONS.MENU_TICKET_LIST]: document.getElementById('permTicketList').checked,
                [PERMISSIONS.MENU_REPORTS]: document.getElementById('permReports').checked,
                [PERMISSIONS.MENU_PRODUCTS]: document.getElementById('permProducts').checked,
                [PERMISSIONS.MENU_USERS]: document.getElementById('permUsers').checked,
                [PERMISSIONS.MENU_SETTINGS]: document.getElementById('permSettings').checked,
                [PERMISSIONS.MENU_BACKUP]: document.getElementById('permBackup').checked,
                
                // Feature permissions
                [PERMISSIONS.FEATURE_RESTORE]: document.getElementById('permRestore').checked,
                [PERMISSIONS.FEATURE_RESET]: document.getElementById('permReset').checked,
                [PERMISSIONS.FEATURE_DELETE_TICKET]: document.getElementById('permDeleteTicket').checked,
                [PERMISSIONS.FEATURE_DELETE_PRODUCT]: document.getElementById('permDeleteProduct').checked,
                [PERMISSIONS.FEATURE_DELETE_USER]: document.getElementById('permDeleteUser').checked
            };
            
            // Update permissions for all users with this role
            users.forEach(user => {
                if (user.role === role) {
                    user.permissions = DEFAULT_ROLE_PERMISSIONS[role];
                }
            });
            
            alert('Hak akses role berhasil diperbarui!');
        }

        // Backup data
        function backupData() {
            if (!hasPermission(PERMISSIONS.FEATURE_BACKUP)) {
                alert('Anda tidak memiliki izin untuk melakukan backup data!');
                return;
            }
            
            const backup = {
                timestamp: new Date().toISOString(),
                data: {
                    tickets,
                    products,
                    users,
                    transactions,
                    backupHistory
                }
            };
            
            // Create blob
            const blob = new Blob([JSON.stringify(backup, null, 2)], { type: 'application/json' });
            
            // Create download link
            const a = document.createElement('a');
            a.href = URL.createObjectURL(blob);
            a.download = `tourtick_backup_${new Date().toISOString().split('T')[0]}.json`;
            
            // Trigger download
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            
            // Add to backup history
            backupHistory.push({
                date: new Date().toISOString(),
                type: 'manual',
                size: `${Math.round(blob.size / 1024)} KB`,
                by: currentUser.fullName
            });
            
            // Refresh backup history
            loadBackupHistory();
            
            alert('Backup data berhasil dilakukan!');
        }

        // Show restore modal
        function showRestoreModal() {
            if (!hasPermission(PERMISSIONS.FEATURE_RESTORE)) {
                alert('Anda tidak memiliki izin untuk melakukan restore data!');
                return;
            }
            
            // Reset form
            document.getElementById('restoreFile').value = '';
            document.getElementById('adminPassword').value = '';
            
            // Show modal
            const restoreModal = new bootstrap.Modal(document.getElementById('restoreModal'));
            restoreModal.show();
        }

        // Restore data from backup
        function restoreData() {
            const fileInput = document.getElementById('restoreFile');
            const file = fileInput.files[0];
            const password = document.getElementById('adminPassword').value;
            
            if (!file) {
                alert('Pilih file backup terlebih dahulu!');
                return;
            }
            
            if (!password) {
                alert('Harap masukkan password admin!');
                return;
            }
            
            // Verify admin password
            const adminUser = users.find(u => u.role === 'admin');
            if (!adminUser || adminUser.password !== CryptoJS.SHA256(password).toString()) {
                alert('Password admin salah!');
                return;
            }
            
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const backup = JSON.parse(e.target.result);
                    
                    if (!backup.data || !backup.data.tickets || !backup.data.products || !backup.data.users) {
                        alert('Format file backup tidak valid!');
                        return;
                    }
                    
                    // Confirm restore
                    if (!confirm('PERINGATAN: Ini akan menggantikan semua data saat ini dengan data dari backup. Lanjutkan?')) {
                        return;
                    }
                    
                    // Restore data
                    tickets = backup.data.tickets;
                    products = backup.data.products;
                    users = backup.data.users;
                    transactions = backup.data.transactions || [];
                    backupHistory = backup.data.backupHistory || [];
                    
                    // Add restore record to history
                    backupHistory.push({
                        date: new Date().toISOString(),
                        type: 'restore',
                        size: `${Math.round(file.size / 1024)} KB`,
                        by: currentUser.fullName
                    });
                    
                    // Close modal
                    bootstrap.Modal.getInstance(document.getElementById('restoreModal')).hide();
                    
                    // Refresh all sections
                    refreshDashboard();
                    loadTicketList();
                    loadProducts();
                    loadUsers();
                    populateDestinationDropdowns();
                    
                    alert('Restore data berhasil dilakukan!');
                } catch (error) {
                    console.error('Error restoring backup:', error);
                    alert('Terjadi kesalahan saat memproses file backup!');
                }
            };
            
            reader.readAsText(file);
        }

        // Show reset confirmation modal
        function showResetConfirmation() {
            if (!hasPermission(PERMISSIONS.FEATURE_RESET)) {
                alert('Anda tidak memiliki izin untuk melakukan reset data!');
                return;
            }
            
            // Reset form
            document.getElementById('resetAdminPassword').value = '';
            
            // Show modal
            const resetModal = new bootstrap.Modal(document.getElementById('resetConfirmationModal'));
            resetModal.show();
        }

        // Reset data to initial state
        function resetData() {
            const password = document.getElementById('resetAdminPassword').value;
            
            if (!password) {
                alert('Harap masukkan password admin!');
                return;
            }
            
            // Verify admin password
            const adminUser = users.find(u => u.role === 'admin');
            if (!adminUser || adminUser.password !== CryptoJS.SHA256(password).toString()) {
                alert('Password admin salah!');
                return;
            }
            
            // Confirm reset
            if (!confirm('PERINGATAN: Ini akan menghapus semua data dan mengembalikan ke pengaturan awal. Lanjutkan?')) {
                return;
            }
            
            // Close modal
            bootstrap.Modal.getInstance(document.getElementById('resetConfirmationModal')).hide();
            
            // Reset data
            loadSampleData();
            
            // Add reset record to history
            backupHistory.push({
                date: new Date().toISOString(),
                type: 'reset',
                size: '0 KB',
                by: currentUser.fullName
            });
            
            // Refresh all sections
            refreshDashboard();
            loadTicketList();
            loadProducts();
            loadUsers();
            populateDestinationDropdowns();
            
            alert('Reset data berhasil dilakukan!');
        }

        // Load backup history
        function loadBackupHistory() {
            const backupHistoryTable = document.getElementById('backupHistoryTable');
            
            backupHistoryTable.innerHTML = backupHistory.map(backup => `
                <tr>
                    <td>${new Date(backup.date).toLocaleString('id-ID')}</td>
                    <td>
                        ${backup.type === 'manual' ? 'Manual' : 
                         backup.type === 'automatic' ? 'Otomatis' : 
                         backup.type === 'restore' ? 'Restore' : 'Reset'}
                    </td>
                    <td>${backup.size}</td>
                    <td>${backup.by}</td>
                    <td>
                        ${backup.type !== 'restore' && backup.type !== 'reset' ? `
                        <button class="btn btn-sm btn-primary" onclick="downloadBackup('${backup.date}')">
                            <i class="fas fa-download"></i>
                        </button>
                        ` : '-'}
                    </td>
                </tr>
            `).join('');
        }

        // Download specific backup (not implemented fully as we don't store the actual backup data)
        function downloadBackup(date) {
            alert('Fitur download backup spesifik belum diimplementasikan. Gunakan backup manual untuk membuat backup saat ini.');
        }
    </script>
</body>
</html>
